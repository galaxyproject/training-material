<!DOCTYPE html>

<html>
<head>
<meta charset="UTF-8">

<title>galaxy-help-news.sh - RDoc Documentation</title>

<script type="text/javascript">
  var rdoc_rel_prefix = "../";
  var index_rel_prefix = "../";
</script>

<script src="../js/navigation.js" defer></script>
<script src="../js/search.js" defer></script>
<script src="../js/search_index.js" defer></script>
<script src="../js/searcher.js" defer></script>
<script src="../js/darkfish.js" defer></script>

<link href="../css/fonts.css" rel="stylesheet">
<link href="../css/rdoc.css" rel="stylesheet">


<body id="top" role="document" class="file">
<nav role="navigation">
  <div id="project-navigation">
    <div id="home-section" role="region" title="Quick navigation" class="nav-section">
  <h2>
    <a href="../index.html" rel="home">Home</a>
  </h2>

  <div id="table-of-contents-navigation">
    <a href="../table_of_contents.html#pages">Pages</a>
    <a href="../table_of_contents.html#classes">Classes</a>
    <a href="../table_of_contents.html#methods">Methods</a>
  </div>
</div>

    <div id="search-section" role="search" class="project-section initially-hidden">
  <form action="#" method="get" accept-charset="utf-8">
    <div id="search-field-wrapper">
      <input id="search-field" role="combobox" aria-label="Search"
             aria-autocomplete="list" aria-controls="search-results"
             type="text" name="search" placeholder="Search" spellcheck="false"
             title="Type to search, Up and Down to navigate, Enter to load">
    </div>

    <ul id="search-results" aria-label="Search Results"
        aria-busy="false" aria-expanded="false"
        aria-atomic="false" class="initially-hidden"></ul>
  </form>
</div>

  </div>

  

  <div id="project-metadata">
    
<div id="fileindex-section" class="nav-section">
  <h3>Pages</h3>

  <ul class="link-list">
    <li><details open><summary>bin</summary>
    <ul class="link-list">
      <li><a href="../bin/add_galaxy_instance_badges_py.html">add_galaxy_instance_badges.py</a>
      <li><a href="../bin/ari-gen-sample-audio_sh.html">ari-gen-sample-audio.sh</a>
      <li><a href="../bin/ari-make_sh.html">ari-make.sh</a>
      <li><a href="../bin/ari-quick_sh.html">ari-quick.sh</a>
      <li><a href="../bin/ari_sh.html">ari.sh</a>
      <li><a href="../bin/check-broken-boxes_py.html">check-broken-boxes.py</a>
      <li><a href="../bin/check-redirects_sh.html">check-redirects.sh</a>
      <li><a href="../bin/check-url-persistence_sh.html">check-url-persistence.sh</a>
      <li><a href="../bin/data-library-update_sh.html">data-library-update.sh</a>
      <li><a href="../bin/data_libarary_download_sh.html">data_libarary_download.sh</a>
      <li><a href="../bin/docker-install-tutorials_sh.html">docker-install-tutorials.sh</a>
      <li><a href="../bin/galaxy-help-news_sh.html">galaxy-help-news.sh</a>
      <li><a href="../bin/gtn-fix_sh.html">gtn-fix.sh</a>
      <li><a href="../bin/install_topic_requirements_sh.html">install_topic_requirements.sh</a>
      <li><a href="../bin/install_tutorial_requirements_sh.html">install_tutorial_requirements.sh</a>
      <li><a href="../bin/knit-automated_sh.html">knit-automated.sh</a>
      <li><a href="../bin/knit-frog_py.html">knit-frog.py</a>
      <li><a href="../bin/knit_py.html">knit.py</a>
      <li><a href="../bin/knittingneedles_py.html">knittingneedles.py</a>
      <li><a href="../bin/lint-diffs_py.html">lint-diffs.py</a>
      <li><a href="../bin/lunr-index_js.html">lunr-index.js</a>
      <li><a href="../bin/lunr-search_js.html">lunr-search.js</a>
      <li><a href="../bin/mergeyaml_py.html">mergeyaml.py</a>
      <li><a href="../bin/pdf2slides_py.html">pdf2slides.py</a>
      <li><a href="../bin/prepare_docker_checks_py.html">prepare_docker_checks.py</a>
      <li><a href="../bin/publish-archive.html">publish-archive</a>
      <li><a href="../bin/schema-contributors_yaml.html">schema-contributors.yaml</a>
      <li><a href="../bin/schema-event-external_yaml.html">schema-event-external.yaml</a>
      <li><a href="../bin/schema-event_yaml.html">schema-event.yaml</a>
      <li><a href="../bin/schema-faq_yaml.html">schema-faq.yaml</a>
      <li><a href="../bin/schema-grants_yaml.html">schema-grants.yaml</a>
      <li><a href="../bin/schema-learning-pathway_yaml.html">schema-learning-pathway.yaml</a>
      <li><a href="../bin/schema-news_yaml.html">schema-news.yaml</a>
      <li><a href="../bin/schema-organisations_yaml.html">schema-organisations.yaml</a>
      <li><a href="../bin/schema-quiz_yaml.html">schema-quiz.yaml</a>
      <li><a href="../bin/schema-requirement-external_yaml.html">schema-requirement-external.yaml</a>
      <li><a href="../bin/schema-requirement-internal_yaml.html">schema-requirement-internal.yaml</a>
      <li><a href="../bin/schema-slides_yaml.html">schema-slides.yaml</a>
      <li><a href="../bin/schema-topic_yaml.html">schema-topic.yaml</a>
      <li><a href="../bin/schema-tutorial_yaml.html">schema-tutorial.yaml</a>
      <li><a href="../bin/setup_training_content_py.html">setup_training_content.py</a>
      <li><a href="../bin/slides-fix_css.html">slides-fix.css</a>
      <li><a href="../bin/social-cards_py.html">social-cards.py</a>
      <li><a href="../bin/supported-fetch_py.html">supported-fetch.py</a>
      <li><a href="../bin/validate-has-workflow_sh.html">validate-has-workflow.sh</a>
      <li><a href="../bin/video-browser-recorder_js.html">video-browser-recorder.js</a>
      <li><a href="../bin/video-builder_py.html">video-builder.py</a>
      <li><a href="../bin/video-diffplayer_py.html">video-diffplayer.py</a>
      <li><a href="../bin/video-extract-script_py.html">video-extract-script.py</a>
      <li><a href="../bin/video-term-demo-magic_sh.html">video-term-demo-magic.sh</a>
      <li><a href="../bin/video-term-recorder_sh.html">video-term-recorder.sh</a>
      <li><a href="../bin/wfh-upload_py.html">wfh-upload.py</a>
      <li><a href="../bin/yaml2json_py.html">yaml2json.py</a>
    </ul></details>
  </ul>
</div>

  </div>
</nav>

<main role="main" aria-label="Page bin/galaxy-help-news.sh">

<p>!/bin/bash</p>

<p>MATRIX_SERVER=${MATRIX_SERVER:-“<a href="https://matrix.org">matrix.org</a>”} ROOM_ID=${ROOM_ID:-‘!TJRLNvfcbWbSRoUNpl:matrix.org’}  ## GTN Single Cell Maintainers WANTED_TAGS=${WANTED_TAGS:-“scrna scrna-seq”} MAX_REPLIES=${MAX_REPLIES:-1} HTML_TYPE=${HTML_TYPE:-“bullets”}  ## “table”</p>

<p>## Result filters OPTS=${OPTS:-“?ascending=true&amp;order=activity”}</p>

<p>if [ -z “$MATRIX_ACCESS_TOKEN” ]; then</p>

<pre>echo &quot;</pre>

<p>This is a Matrix bot that scrapes Galaxy Help for certain tags and posts to a Room for topics that have less than X replies. Run this maybe once a month.</p>

<p>Example Usage:</p>

<pre>MATRIX_ACCESS_TOKEN=&#39;123_123_123&#39; \\
  MATRIX_SERVER=&#39;https://matrix.org&#39; \\
  ROOM_ID=&#39;!123_132_123:matrix.org&#39; \\
  WANTED_TAGS=&#39;tag1 tag2&#39; \\
  MAX_REPLIES=1 \\
  HTML_TYPE=&#39;bullets&#39; \\
  bash $0</pre>

<p>Where:</p>

<pre>MATRIX_ACCESS_TOKEN  Can be found in your Matrix profile under
                     &#39;All settings&#39; -&gt; &#39;Help &amp; About&#39; -&gt; &#39;Access Token&#39;

MATRIX_SERVER        The name or base address of the Matrix server to
                     post to. Default is &#39;$MATRIX_SERVER&#39;

ROOM_ID              The Room ID can be found in the URL of the room
                     usually following format &#39;!123123123:matrix.org&#39;.
                     Default is &#39;$ROOM_ID&#39;
                     NOTE: Single quotes are very important here.

WANTED_TAGS          A space separated list of valid tags to find posts
                     at https://help.galaxyproject.org/
                     Default is \&quot;$WANTED_TAGS\&quot;

MAX_REPLIES          Filter for posts that have less than or equal to
                     this many replies. Default is \&quot;$MAX_REPLIES\&quot;

HTML_TYPE            Render either a &#39;table&#39; or &#39;bullets&#39;. HTML tables
                     look great in the browser but don&#39;t render well on
                     mobile. Default is \&quot;$HTML_TYPE\&quot;

OPTS                 Extra arguments to append to help.galaxyproject.org
                     URL. Default is \&quot;$OPTS\&quot;
 &quot; &gt;&amp;2
  exit 255</pre>

<p>fi</p>

<p>function tag_to_tsv {</p>

<pre>## For a given TAG, fetch from the help forum, extract and parse
## the table and produce a 4-column TSV output of Link, Title,
## Replies, Views.
##
## TODO: Add date too?
local tag=&quot;$1&quot;
curl -s &quot;https://help.galaxyproject.org/tag/${tag}${OPTS}&quot; \
    | xmllint --noblanks --html --xpath &#39;//tr[@class=&quot;topic-list-item&quot;]/td/span&#39; - 2&gt;/dev/null \
    | sed -r &#39;s|&lt;span class[^&gt;]+&gt;||; s|&lt;/span&gt;||; s|\s*&lt;a.*href=\&quot;([^\&quot;]*)\&quot; [^&gt;]+&gt;([^&lt;]+)&lt;.*|_ROW_\1\t\2|&#39; \
    | tr &#39;\n&#39; &#39;\t&#39; \
    | sed -r &#39;s|\s\s\s*|\t|g; s|_ROW_|\n|g&#39;</pre>

<p>}</p>

<p>function alltags_to_tsv {</p>

<pre>## For all wanted tags, populate a 4-column TSV output of Link,
## Title, Replies, Views, and return the path of the table.
local fetch_tags=$WANTED_TAGS
local tmp_tsv
tmp_tsv=$(mktemp --suffix=&quot;.tsv&quot;)
for tag in ${fetch_tags}; do
    tag_to_tsv &quot;$tag&quot; &gt;&gt; &quot;$tmp_tsv&quot;;
done
## No duplicates, no blanks, no duplicate delimiters,
## and sort by ascending reply count
grep -v &quot;^\s*$&quot; &quot;${tmp_tsv}&quot; | sed &#39;s|\t\t|\t|g&#39; \
    | sort | uniq | sort -t $&#39;\t&#39; -nk 3 &gt; &quot;${tmp_tsv}&quot;.temp
echo -e &quot;Link\tTitle\tReplies\tViews&quot; &gt; &quot;${tmp_tsv}&quot;
cat &quot;${tmp_tsv}&quot;.temp  &gt;&gt; &quot;${tmp_tsv}&quot;
rm &quot;${tmp_tsv}&quot;.temp
echo &quot;${tmp_tsv}&quot;</pre>

<p>}</p>

<p>function filter_tsv {</p>

<pre>## Filter a TSV file for maximum replies and then return the path
## of the new filtered table
local tsv=&quot;$1&quot;
local tmp_tsv
tmp_tsv=$(mktemp --suffix=&quot;.tsv&quot;)
awk -F$&#39;\t&#39; -v replies=&quot;$MAX_REPLIES&quot; &#39;$3 &lt;= replies&#39; &quot;${tsv}&quot; &gt; &quot;${tmp_tsv}&quot;
echo &quot;${tmp_tsv}&quot;</pre>

<p>}</p>

<p>function tsv_to_html {</p>

<pre>## Convert a TSV table into HTML text that can be fed into a JSON
local tsv=&quot;$1&quot;
if [ &quot;$HTML_TYPE&quot; = &quot;table&quot; ]; then
    awk -F$&#39;\t&#39; -v subtitle=&quot;Recent posts matching: &lt;b&gt;${WANTED_TAGS}&lt;/b&gt;, with replies &amp;le; ${MAX_REPLIES}&quot; &#39;\</pre>

<p>BEGIN { print “&lt;h1&gt;Updates from Galaxy Help&lt;/h1&gt;”subtitle“n&lt;table&gt;n&lt;thead&gt;&lt;tr&gt;&lt;th&gt;Topic&lt;/th&gt;&lt;th&gt;Replies&lt;/th&gt;&lt;th&gt;Views&lt;/th&gt;&lt;/tr&gt;&lt;/thead&gt;n&lt;tbody&gt;”} \ END { print “&lt;/tbody&gt;n&lt;/table&gt;”} \ NR &gt; 0 {print “&lt;tr&gt;&lt;td&gt;&lt;a href=&quot;”$1“&quot;&gt;”$2“&lt;/a&gt;&lt;/td&gt;&lt;td&gt;”$3“&lt;/td&gt;&lt;td&gt;”$4“&lt;/td&gt;&lt;/tr&gt;”}‘ \</p>

<pre>        &quot;${tsv}&quot; | tr &#39;\n&#39; &#39; &#39; | sed &#39;s|&quot;|\\&quot;|g&#39;
else  ## bullets
    awk -F$&#39;\t&#39; -v subtitle=&quot;Recent posts matching: &lt;b&gt;${WANTED_TAGS}&lt;/b&gt;, with replies &amp;le; ${MAX_REPLIES}&quot; &#39;\</pre>

<p>BEGIN { print “&lt;h1&gt;Updates from Galaxy Help&lt;/h1&gt;&lt;br/&gt;&lt;p&gt;”subtitle“&lt;/p&gt;&lt;ol&gt;n”} \ END { print “n&lt;/ol&gt;”} \ NR &gt; 0 {print “&lt;li&gt;&lt;a href=&quot;”$1“&quot;&gt;”$2“&lt;/a&gt;&lt;ul&gt;&lt;li&gt;Replies: ”$3“ and Views: ”$4“&lt;/li&gt;&lt;/ul&gt;&lt;/li&gt;”}‘ \</p>

<pre>        &quot;${tsv}&quot; | tr &#39;\n&#39; &#39; &#39; | sed &#39;s|&quot;|\\&quot;|g&#39;
fi</pre>

<p>}</p>

<p>function tsv_to_markdown {</p>

<pre>## Convert a TSV table into Markdown text that can be fed into a JSON
local tsv=&quot;$1&quot;
awk -F$&#39;\t&#39; -v subtitle=&quot;Recent posts matching: **${WANTED_TAGS}**, with replies ≤ ${MAX_REPLIES}&quot; &#39;\</pre>

<p>BEGIN { print “## Updates from Galaxy Help\n***”subtitle“***\n”} \ NR &gt; 0 {print “* [”$2“](”$1“)\n   * ”$3“ replies and ”$4“ views\n”}‘ \</p>

<pre>&quot;${tsv}&quot; | tr &#39;\n&#39; &#39; &#39; | sed &#39;s|&quot;|\\&quot;|g&#39;</pre>

<p>}</p>

<p>function md_and_html_to_json {</p>

<pre>## Stuff the Markdown and HTML text content into a JSON.
local md_text=&quot;$1&quot;
local html_text=&quot;$2&quot;
local tmp_json;
tmp_json=$(mktemp --suffix=&quot;.json&quot;)
## See: https://spec.matrix.org/legacy/r0.0.0/client_server.html
##      &quot;put-matrix-client-r0-rooms-roomid-send-eventtype-txnid&quot;
echo &quot;{\</pre>

<p>"msgtype&quot;:&quot;m.notice&quot;, \ "format&quot;:&quot;org.matrix.custom.html&quot;, \ "body&quot;: "${md_text}&quot;, \ "formatted_body&quot;: "${html_text}&quot;}“ &gt; ”${tmp_json}“</p>

<pre class="ruby"><span class="ruby-identifier">echo</span> <span class="ruby-string">&quot;${tmp_json}&quot;</span>
</pre>

<p>}</p>

<p>function post_json_to_matrix {</p>

<pre>local json_file=&quot;$1&quot;
local txnid post_url
txnid=$(date &quot;+%Y%m%d%H%M${RANDOM:1:3}&quot;)   ## date-specific transaction ID
MATRIX_SERVER=${MATRIX_SERVER%/}           ## remove trailing slash, if any
## Build curl
post_url=&quot;${MATRIX_SERVER}/_matrix/client/r0/rooms/&quot;
post_url=&quot;${post_url}&quot;${ROOM_ID}&quot;/send/m.room.message/${txnid}&quot;
post_url=&quot;${post_url}?access_token=${MATRIX_ACCESS_TOKEN}&quot;
## DEBUG:
## - curl &quot;$post_url&quot; -X PUT --data &#39;{&quot;msgtype&quot;:&quot;m.text&quot;,&quot;body&quot;:&quot;hello&quot;}&#39;
curl &quot;$post_url&quot; -X PUT --data &quot;$(cat ${json_file})&quot;</pre>

<p>}</p>

<p>function sanity_check {</p>

<pre>## Assert that required binaries are in PATH
local required_progs=( cat curl xmllint awk sed grep tr jq )
local miss=&quot;&quot;
for prog in &quot;${required_progs[@]}&quot;; do
    if ! which &quot;${prog}&quot; 2&gt;/dev/null &gt;&amp;2; then
        miss=&quot;$miss $prog&quot;
    fi
done
if [ &quot;$miss&quot; != &quot;&quot; ]; then
    echo &quot;Cannot run without:$miss&quot;
    exit 255
fi</pre>

<p>}</p>

<p>## MAIN ## sanity_check</p>

<p>main_tsv=$(filter_tsv “$(alltags_to_tsv)” ) if [[ $(wc -l &lt; “${main_tsv}”) == 0 ]]; then</p>

<pre>echo &quot;Nothing new to post, aborting.&quot;  &gt;&amp;2
exit 0</pre>

<p>fi</p>

<p>main_mdwn_text=$(tsv_to_markdown “${main_tsv}”) main_html_text=$(tsv_to_html “${main_tsv}”)</p>

<p>main_json_file=$(md_and_html_to_json “${main_mdwn_text}” “${main_html_text}”) if ! jq &lt; “${main_json_file}” 2&gt; /dev/null &gt;&amp;2; then</p>

<pre>echo &quot;This is not a valid JSON, aborting.&quot; &gt;&amp;2
echo &quot;See: ${main_json_file}&quot;  &gt;&amp;2
exit 255</pre>

<p>fi</p>

<p>post_json_to_matrix “${main_json_file}”</p>

</main>



<footer id="validator-badges" role="contentinfo">
  <p><a href="https://validator.w3.org/check/referer">Validate</a>
  <p>Generated by <a href="https://ruby.github.io/rdoc/">RDoc</a> 6.5.1.1.
  <p>Based on <a href="http://deveiate.org/projects/Darkfish-RDoc/">Darkfish</a> by <a href="http://deveiate.org">Michael Granger</a>.
</footer>

