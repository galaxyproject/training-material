<!DOCTYPE html>

<html>
<head>
<meta charset="UTF-8">

<title>knit-frog.py - RDoc Documentation</title>

<script type="text/javascript">
  var rdoc_rel_prefix = "../";
  var index_rel_prefix = "../";
</script>

<script src="../js/navigation.js" defer></script>
<script src="../js/search.js" defer></script>
<script src="../js/search_index.js" defer></script>
<script src="../js/searcher.js" defer></script>
<script src="../js/darkfish.js" defer></script>

<link href="../css/fonts.css" rel="stylesheet">
<link href="../css/rdoc.css" rel="stylesheet">




<body id="top" role="document" class="file">
<nav role="navigation">
  <div id="project-navigation">
    <div id="home-section" role="region" title="Quick navigation" class="nav-section">
  <h2>
    <a href="../index.html" rel="home">Home</a>
  </h2>

  <div id="table-of-contents-navigation">
    <a href="../table_of_contents.html#pages">Pages</a>
    <a href="../table_of_contents.html#classes">Classes</a>
    <a href="../table_of_contents.html#methods">Methods</a>
  </div>
</div>

    <div id="search-section" role="search" class="project-section initially-hidden">
  <form action="#" method="get" accept-charset="utf-8">
    <div id="search-field-wrapper">
      <input id="search-field" role="combobox" aria-label="Search"
             aria-autocomplete="list" aria-controls="search-results"
             type="text" name="search" placeholder="Search" spellcheck="false"
             title="Type to search, Up and Down to navigate, Enter to load">
    </div>

    <ul id="search-results" aria-label="Search Results"
        aria-busy="false" aria-expanded="false"
        aria-atomic="false" class="initially-hidden"></ul>
  </form>
</div>

  </div>

  

  <div id="project-metadata">
    <div id="fileindex-section" class="nav-section">
  <h3>Pages</h3>

  <ul class="link-list">
  
    <li><a href="../bin/add_galaxy_instance_annotations_py.html">add_galaxy_instance_annotations.py</a>
  
    <li><a href="../bin/add_galaxy_instance_badges_py.html">add_galaxy_instance_badges.py</a>
  
    <li><a href="../bin/ari-make_sh.html">ari-make.sh</a>
  
    <li><a href="../bin/ari-quick_sh.html">ari-quick.sh</a>
  
    <li><a href="../bin/ari_sh.html">ari.sh</a>
  
    <li><a href="../bin/check-broken-boxes_py.html">check-broken-boxes.py</a>
  
    <li><a href="../bin/check_instance_py.html">check_instance.py</a>
  
    <li><a href="../bin/data-library-update_sh.html">data-library-update.sh</a>
  
    <li><a href="../bin/data_libarary_download_sh.html">data_libarary_download.sh</a>
  
    <li><a href="../bin/docker-install-tutorials_sh.html">docker-install-tutorials.sh</a>
  
    <li><a href="../bin/gtn-fix_sh.html">gtn-fix.sh</a>
  
    <li><a href="../bin/install_topic_requirements_sh.html">install_topic_requirements.sh</a>
  
    <li><a href="../bin/install_tutorial_requirements_sh.html">install_tutorial_requirements.sh</a>
  
    <li><a href="../bin/knit-automated_sh.html">knit-automated.sh</a>
  
    <li><a href="../bin/knit-frog_py.html">knit-frog.py</a>
  
    <li><a href="../bin/knit_py.html">knit.py</a>
  
    <li><a href="../bin/knittingneedles_py.html">knittingneedles.py</a>
  
    <li><a href="../bin/lint-diffs_py.html">lint-diffs.py</a>
  
    <li><a href="../bin/lunr-index_js.html">lunr-index.js</a>
  
    <li><a href="../bin/lunr-search_js.html">lunr-search.js</a>
  
    <li><a href="../bin/mergeyaml_py.html">mergeyaml.py</a>
  
    <li><a href="../bin/prepare_docker_checks_py.html">prepare_docker_checks.py</a>
  
    <li><a href="../bin/publish-archive.html">publish-archive</a>
  
    <li><a href="../bin/schema-contributors_yaml.html">schema-contributors.yaml</a>
  
    <li><a href="../bin/schema-faq_yaml.html">schema-faq.yaml</a>
  
    <li><a href="../bin/schema-quiz_yaml.html">schema-quiz.yaml</a>
  
    <li><a href="../bin/schema-requirement-external_yaml.html">schema-requirement-external.yaml</a>
  
    <li><a href="../bin/schema-requirement-internal_yaml.html">schema-requirement-internal.yaml</a>
  
    <li><a href="../bin/schema-slides_yaml.html">schema-slides.yaml</a>
  
    <li><a href="../bin/schema-topic_yaml.html">schema-topic.yaml</a>
  
    <li><a href="../bin/schema-tutorial_yaml.html">schema-tutorial.yaml</a>
  
    <li><a href="../bin/setup_training_content_py.html">setup_training_content.py</a>
  
    <li><a href="../bin/slides-fix_css.html">slides-fix.css</a>
  
    <li><a href="../bin/validate-has-workflow_sh.html">validate-has-workflow.sh</a>
  
    <li><a href="../bin/video-browser-recorder_js.html">video-browser-recorder.js</a>
  
    <li><a href="../bin/video-builder_py.html">video-builder.py</a>
  
    <li><a href="../bin/video-diffplayer_py.html">video-diffplayer.py</a>
  
    <li><a href="../bin/video-extract-script_py.html">video-extract-script.py</a>
  
    <li><a href="../bin/video-term-demo-magic_sh.html">video-term-demo-magic.sh</a>
  
    <li><a href="../bin/video-term-recorder_sh.html">video-term-recorder.sh</a>
  
    <li><a href="../bin/workflow_to_tool_yaml_sh.html">workflow_to_tool_yaml.sh</a>
  
    <li><a href="../bin/yaml2json_py.html">yaml2json.py</a>
  
  </ul>
</div>

  </div>
</nav>

<main role="main" aria-label="Page bin/knit-frog.py">

<p>#!/usr/bin/env python import shutil import os import argparse import re import sys import knittingneedles as knit</p>

<p># read in a tutorial, and check the structure of it. parser = argparse.ArgumentParser(</p>

<pre class="ruby"><span class="ruby-identifier">description</span>=<span class="ruby-string">&quot;Extract specially formatted diffs from tutorials as a series of patches to apply&quot;</span>
</pre>

<p>) parser.add_argument(“tutorial”, type=argparse.FileType(“r”), help=“Input tutorial”) parser.add_argument(</p>

<pre>&quot;prefix&quot;, help=&quot;Some prefix for the output commit files to keep them separate&quot;</pre>

<p>) args = parser.parse_args()</p>

<p>fnparts = args.tutorial.name.split(&#39;/&#39;) fn_topic = fnparts[fnparts.index(&#39;tutorials&#39;) - 1] fn_tutorial = fnparts[fnparts.index(&#39;tutorials&#39;) + 1]</p>

<p>diffs = [] current = None currentCmd = None currentTest = None for line, text in enumerate(args.tutorial.read().split(“n”)):</p>

<pre>m = re.match(knit.BOXES, text)
if m:
    depth = m.group(1).count(&quot;&gt;&quot;)
else:
    depth = 0

(unprefixed, prefix) = knit.stripN(text, depth)
m1 = re.match(knit.BOX_OPEN, unprefixed)
m2 = re.match(knit.BOX_CLOSE, unprefixed)
c1 = re.match(knit.CMD_OPEN, unprefixed)
c2 = re.match(knit.CMD_CLOSE, unprefixed)
t1 = re.match(knit.TEST_OPEN, unprefixed)
t2 = re.match(knit.TEST_CLOSE, unprefixed)

if m1:
    if current is not None:
        diffs.append(current)
    current = []
elif current is not None:
    current.append(unprefixed)

if c1:
    if currentCmd is not None:
        diffs.append(currentCmd)
    currentCmd = []
elif currentCmd is not None:
    currentCmd.append(unprefixed)

if t1:
    if currentTest is not None:
        diffs.append(currentTest)
    currentTest = []
elif currentTest is not None:
    currentTest.append(unprefixed)

if current and len(current) &gt; 2 and current[-2].strip() == &quot;```&quot; and not m2:
    current = None

if currentCmd and len(currentCmd) &gt; 2 and currentCmd[-2].strip() == &quot;```&quot; and not c2:
    currentCmd = None

if currentTest and len(currentTest) &gt; 2 and currentTest[-2].strip() == &quot;```&quot; and not t2:
    currentTest = None

# Tests are known short, same with commands. If we haven&#39;t exited by now, it&#39;s an issue..
if currentTest and len(currentTest) &gt; 4:
    currentTest = None

# interesting = (t1, t2, currentCmd, currentTest)
# if any([x is not None for x in interesting]):
    # print(*interesting)

if m2:
    diffs.append(current)
    current = None

if c2:
    diffs.append(currentCmd)
    currentCmd = None

if t2:
    diffs.append(currentTest)
    currentTest = None</pre>

<p>postfix = [“–”, “2.25.1”, “”, “”]</p>

<p># import sys; sys.exit()</p>

<p>GITGAT = os.path.dirname(args.prefix) BASE = os.path.basename(args.prefix) BASE_PARTS = BASE.split(&#39;-&#39;)</p>

<p>cmdhandle = open(f“{GITGAT}/.scripts/{BASE}-run.sh”, &#39;w&#39;) cmdhandle.write(“#!/bin/bashn”) cmdhandle.write(“set -exnn”) cmdhandle.write(“# Install dependencies before changing commitsn”) cmdhandle.write(f“find .scripts -name requirements.txt | xargs –no-run-if-empty -n 1 pip install -rn”) cmdhandle.write(“echo &#39;[galaxyservers]&#39; &gt; ~/.hostsn”) cmdhandle.write(&#39;echo “$(hostname -f) ansible_connection=local ansible_user=$(whoami)”  &gt;&gt; ~/.hostsn&#39;) cmdhandle.write(“echo &#39;[pulsarservers]&#39; &gt;&gt; ~/.hostsn”) cmdhandle.write(&#39;echo “$(hostname -f) ansible_connection=local ansible_user=$(whoami)”  &gt;&gt; ~/.hostsn&#39;) cmdhandle.write(&#39;export GALAXY_HOSTNAME=“$(hostname -f)”n&#39;) cmdhandle.write(&#39;export GALAXY_API_KEY=adminkeyn&#39;) cmdhandle.write(“## The students should use a random password, we override with &#39;password&#39; for reproducibilityn”) cmdhandle.write(“echo &#39;password&#39; &gt; ~/.vault-password.txt;n”) cmdhandle.write(“## And one in this directory, it can contain garbagen”) cmdhandle.write(“echo &#39;garbage&#39; &gt; ./.vault-password.txt;n”) # If it&#39;s after the ansible-galaxy tutorial if <a href="0">int(BASE_PARTS</a>) &gt; 10:</p>

<pre class="ruby"><span class="ruby-identifier">cmdhandle</span>.<span class="ruby-identifier">write</span>(<span class="ruby-string">&quot;## Ensure the galaxy user is setup\n&quot;</span>)
<span class="ruby-identifier">cmdhandle</span>.<span class="ruby-identifier">write</span>(<span class="ruby-string">&quot;sudo -u galaxy /srv/galaxy/venv/bin/python /usr/bin/galaxy-create-user -c /srv/galaxy/config/galaxy.yml --user admin@example.org --password password --key adminkey --username admin\n&quot;</span>)
</pre>

<p>lastCommit = None for idx, diff in enumerate(diffs):</p>

<pre>if &#39;data-commit&#39; in diff[-1]:
    commit_msg = knit.extractCommitMsg(diff)
    safe_commit = re.sub(&quot;[^a-z0-9-]&quot;, &quot;-&quot;, commit_msg.lower())

    prefix = [
        &quot;From: The Galaxy Training Network &lt;galaxytrainingnetwork@gmail.com&gt;&quot;,
        &quot;Date: Mon, 15 Feb 2021 14:06:56 +0100&quot;,
        f&quot;Subject: {fn_topic}/{fn_tutorial}/{idx:04d}: {commit_msg}&quot;,
        &quot;&quot;,
        &quot;&quot;,
    ]

    lastCommit = f&quot;{fn_topic}/{fn_tutorial}/{idx:04d}&quot;

    (_, diff) = knit.removeWhitespacePrefix(diff)

    patch_id = diff[-1]
    # Remove patch id, ```
    diff = diff[0:-2]
    if diff[-1] == &quot;{% endraw %}&quot;:
        diff = diff[0:-1]

    fn = f&quot;{args.prefix}-commit-{idx:04d}-{safe_commit}.patch&quot;
    with open(fn, &quot;w&quot;) as handle:
        print(fn)
        handle.write(&quot;\n&quot;.join(prefix + diff + postfix))
elif &#39;data-cmd&#39; in diff[-1]:
    cmdhandle.write(&quot;\n# CMD\n&quot;)
    if lastCommit is not None:
        cmdhandle.write(f&#39;## Checkout\ngit checkout $(git log main --pretty=oneline | grep &quot;{lastCommit}&quot; | cut -c1-40)\n&#39;)
    for line in diff[0:-2]:
        cmdhandle.write(&quot;## Run command\n&quot;)
        if &#39;ansible-playbook&#39; in line:
            cmdhandle.write(&quot;if [[ -z ${GALAXY_VERSION} ]]; then\n&quot;)
            cmdhandle.write(line.strip() + &quot; -i ~/.hosts --vault-password-file ~/.vault-password.txt\n&quot;)
            cmdhandle.write(&quot;else\n&quot;)
            cmdhandle.write(line.strip() + &quot; -i ~/.hosts --vault-password-file ~/.vault-password.txt -e galaxy_commit_id=${GALAXY_VERSION}\n&quot;)
            cmdhandle.write(&quot;fi\n&quot;)
        else:
            line = line.strip()
            line = line.replace(&#39;https://your-galaxy&#39;, &#39;https://$(hostname -f)&#39;)
            line = line.replace(&#39;&lt;api-key&gt;&#39;, &#39;adminkey&#39;)
            cmdhandle.write(line + &quot;\n&quot;)
elif &#39;data-test&#39; in diff[-1]:
    cmdhandle.write(&quot;\n# TEST\n&quot;)
    if lastCommit is not None:
        cmdhandle.write(f&#39;## Checkout\ngit checkout $(git log main --pretty=oneline | grep &quot;{lastCommit}&quot; | cut -c1-40)\n&#39;)
    for line in diff[0:-2]:
        testdir = f&quot;topics/{fn_topic}/tutorials/{fn_tutorial}/tests&quot;
        gittestdir = f&quot;{GITGAT}/.scripts/{BASE}-test&quot;
        if os.path.exists(testdir) and not os.path.exists(gittestdir):
            shutil.copytree(testdir, gittestdir)

        cmdhandle.write(&quot;## Run test case\n&quot;)
        cmdhandle.write(f&quot;./.scripts/{BASE}-test/{line.strip()}\n&quot;)
else:
    print(&quot;Unknown!&quot;)</pre>

<p>cmdhandle.write(“# Done!ngit checkout mainn”)</p>

</main>



<footer id="validator-badges" role="contentinfo">
  <p><a href="https://validator.w3.org/check/referer">Validate</a>
  <p>Generated by <a href="https://ruby.github.io/rdoc/">RDoc</a> 6.2.1.1.
  <p>Based on <a href="http://deveiate.org/projects/Darkfish-RDoc/">Darkfish</a> by <a href="http://deveiate.org">Michael Granger</a>.
</footer>

