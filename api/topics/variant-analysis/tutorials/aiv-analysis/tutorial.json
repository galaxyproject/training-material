{"layout":"tutorial_hands_on","title":"Avian influenza viral strain analysis from gene segment sequencing data","subtopic":"one-health","level":"Intermediate","questions":["With reassortment of gene segments being a common event in avian influenza virus (AIV) evolution, does it make sense to use a reference-based mapping approach for constructing consensus genome sequences for AIV samples?","Is it possible to reuse existing tools and workflows developed for the analysis of sequencing data from other viruses?","How can we obtain meaningful phylogenetic insight from AIV consensus sequences?"],"objectives":["Determine how reassortment impacts reference-based mapping approaches","Use a collection of per-segment reference sequences to construct a hybrid reference genome that is sufficiently close to a sequenced sample to be useful as a reference for mapping","Construct a sample consensus genome from mapped reads","Generate per-segment phylogenetic trees of AIV consensus sequences"],"time_estimation":"4H","key_points":["Reassortment of gene segments makes reference-based mapping of influenza sequencing data challenging","An alternative to *de-novo* assembly can be mapping to a dynamically chosen reference genome","Variant calling and consensus genome construction can follow workflows used also for other viral sequence data","Standard phylogenetic tools can be used to find relationships between influenza samples but should be used on a per-segment basis"],"contributors":[{"name":"Wolfgang Maier","orcid":"0000-0002-9464-6640","matrix":"wm75:matrix.org","joined":"2017-09","elixir_node":"de","fediverse":"https://scholar.social/@zerodivision","fediverse_flavor":"mastodon","affiliations":["by-covid","uni-freiburg","elixir-europe"],"id":"wm75","url":"https://training.galaxyproject.org/training-material/api/contributors/wm75.json","page":"https://training.galaxyproject.org/training-material/hall-of-fame/wm75/"}],"tags":["virology","one-health"],"js_requirements":{"mathjax":null,"mermaid":false},"short_id":"T00308","url":"/topics/variant-analysis/tutorials/aiv-analysis/tutorial.html","topic_name":"variant-analysis","tutorial_name":"aiv-analysis","dir":"topics/variant-analysis/tutorials/aiv-analysis","symlink":null,"id":"variant-analysis/aiv-analysis","ref_tutorials":["<p>Of the four species of influenza viruses (Influenza A-D), <em>Influenza A</em> is the most virulent in human hosts and subtypes of it have been responsible for all historic flu pandemics.</p>\n\n<p>The different influenza species infect distinct animal hosts (though all of them can infect humans and pigs) and the most important natural reservoir for <em>Influenza A</em> are birds (in particular, wild aquatic birds), in which it causes <strong>Avian influenza</strong>.</p>\n\n<p>Importantly, all flu pandemics of the last century have been triggered by <strong>reassortment</strong> events between avian and human <em>Influenza A</em> strains (although at least the 2009 swine flu pandemic involved an additional mixing event with an <em>Influenza A</em> strain from pigs).</p>\n\n<p>Reassortment events are a key trait of <em>Influenza A</em> made possible by its wide range of natural hosts combined with two molecular characteristics of the species:</p>\n\n<ol>\n  <li>the linear negative-sense single-stranded RNA genomes of influenza viruses (and of all viruses of the <em>Orthomyxoviridae</em> family) are segmented, i.e. consist of several (eight in the case of <em>Influenza A</em> and <em>B</em>) distinct pieces of RNA, which typically encode just one, sometimes two viral proteins.</li>\n  <li>the mutation rate in the genome is high in influenza viruses, and particularly high in <em>Influenza A</em>, since their RNA polymerase lacks exonuclease activity necessary for proof-reading.</li>\n</ol>\n\n<p>Together these characteristics enable <em>Influenza A</em> to evolve relatively rapidly in non-human hosts, then re-adapt to humans through exchange of segments (reassortment) in a host co-infected with a human and, <em>e.g.</em>, an avian strain. If such a reassortment introduces new variants of the two most antigenic proteins of influenza, HA (hemagglutinin) and NA (neuraminidase), this antigenic shift provides the reassorted strain with immune escape potential, which, if it happens in a genetic background compatible with efficient transmission in humans, can trigger an unusually strong wave of influenza or even a new pandemic.</p>\n\n<p>In order to estimate the likelihood of an epidemic or pandemic influenza event in the near future it is, therefor, important to monitor closely the genome composition of circulating Avian Influenza strains in wild and domestic birds and the huge technological advances over the last decade make it possible to use next-generation sequencing for this purpose.</p>\n\n<p>At the same time, the segmented nature of their genomes combined with high genetic variability, especially in the HA and NA genes, requires rather specialized bioinformatics workflows for the analysis of data from influenza viruses compared to other viruses with similar genome size (like, <em>e.g.</em> SARS-CoV-2):</p>\n\n<p>The viral surface proteins HA and (to a lesser extent) NA are the main targets of the host antibody response and are, thus, under constant selection pressure to mutate into forms capable of evading an existing host immune response. As a consequence, these segments have evolved into a much richer panel of sequence variants than the other segments, to the point that sequences of the HA segment can, at present, be classified into 18 distinct subfamilies, H1-H18, while there are 11 recognized subfamilies of NA, and <em>Influenza A</em> strains are subtyped (as, for example, H5N1, H3N2, etc.) according to the combination of HA- and NA-encoding segments they are carrying.</p>\n\n<p>Importantly, the sequence diversity of HA and (again to a lesser extent) of NA segments is big enough to prevent a naive approach of mapping sequenced reads to one specific agreed-upon <em>Influenza A</em> reference sequence. While this would work for the other six segments, mapping software would regularly fail to find enough plausible mappings for sequenced reads of HA and NA origin to continue analysis with. This is why, in this tutorial we are going to explore an alternative approach, which is also mapping-based but chooses a suitable reference for each segment dynamically based on the input sequencing data.</p>\n\n<blockquote class=\"agenda\">\n  <agenda-title></agenda-title>\n\n  <p>In this tutorial, we will cover:</p>\n\n<ol id=\"markdown-toc\">\n  <li><a href=\"#prepare-analysis-history-and-data\" id=\"markdown-toc-prepare-analysis-history-and-data\">Prepare analysis history and data</a></li>\n  <li><a href=\"#get-a-history-with-reference-data\" id=\"markdown-toc-get-a-history-with-reference-data\">Get a history with reference data</a>    <ol>\n      <li><a href=\"#get-the-sequencing-data\" id=\"markdown-toc-get-the-sequencing-data\">Get the sequencing data</a></li>\n      <li><a href=\"#inspect-the-reference-data\" id=\"markdown-toc-inspect-the-reference-data\">Inspect the reference data</a></li>\n    </ol>\n  </li>\n  <li><a href=\"#quality-control\" id=\"markdown-toc-quality-control\">Quality control</a></li>\n  <li><a href=\"#per-segment-subtyping-and-hybrid-reference-construction\" id=\"markdown-toc-per-segment-subtyping-and-hybrid-reference-construction\">Per-segment subtyping and hybrid reference construction</a></li>\n  <li><a href=\"#mapping-to-a-hybrid-reference\" id=\"markdown-toc-mapping-to-a-hybrid-reference\">Mapping to a hybrid reference</a></li>\n  <li><a href=\"#consensus-sequence-construction\" id=\"markdown-toc-consensus-sequence-construction\">Consensus sequence construction</a></li>\n  <li><a href=\"#placing-segments-on-a-phylogenetic-tree\" id=\"markdown-toc-placing-segments-on-a-phylogenetic-tree\">Placing segments on a phylogenetic tree</a></li>\n  <li><a href=\"#conclusion\" id=\"markdown-toc-conclusion\">Conclusion</a></li>\n</ol>\n\n</blockquote>\n\n<h1 id=\"prepare-analysis-history-and-data\">Prepare analysis history and data</h1>\n\n<p>In this tutorial you are going to work on a single avian influenza sample sequenced in paired-end mode on the Illumina platform, <em>i.e.</em> we are going to download two datasets of sequenced reads for that sample.</p>\n\n<p>In addition, we are going to base the analysis on a small collection of multiple reference sequences for each influenza gene segment. We prepared this collection for you from public <a href=\"https://insaflu.insa.pt/dashboard/\">INSAFlu</a> <a href=\"https://insaflu.readthedocs.io/en/latest/uploading_data.html?highlight=references#uploading-reference-data\">data</a>.</p>\n\n<p>If you have your own curated collection of reference sequences, you should be able to use it to follow this tutorial without any problem. Note, however, that the analysis results referred to in many of the questions will be different if you are exchanging the reference collection.\nIf you want to learn how you can create a Galaxy collection from your own references that is structured like the default we are suggesting here, you may want to follow the dedicated tutorial on <a href=\"/training-material/topics/galaxy-interface/tutorials/collections/tutorial.html\">Using dataset collections</a>.</p>\n\n<h1 id=\"get-a-history-with-reference-data\">Get a history with reference data</h1>\n\n<p>Any analysis should get its own Galaxy history, but in this tutorial we <em>won’t</em> start with creating one.</p>\n\n<p>Instead, to save some time, you can copy an existing shared history on Galaxy Europe.</p>\n\n<blockquote class=\"hands_on\">\n  <hands-on-title>Prepare the Galaxy history</hands-on-title>\n\n  <ol>\n    <li>\n      <p>Open the <a href=\"https://usegalaxy.eu/u/wolfgang-maier/h/influenza-resources\">shared history</a> with pre-prepared INSAFlu reference data</p>\n    </li>\n    <li>\n      <p>Rename the history</p>\n\n      <!--SNIPPET-->\n      <blockquote class=\"tip\">   <div class=\"box-title tip-title\" id=\"tip-renaming-a-history\"><button class=\"gtn-boxify-button tip\" type=\"button\" aria-controls=\"tip-renaming-a-history\" aria-expanded=\"true\"><i class=\"far fa-lightbulb\" aria-hidden=\"true\"></i> <span>Tip: Renaming a history</span><span class=\"fold-unfold fa fa-minus-square\"></span></button></div>   <ol>   <li>Click on <i class=\"fas fa-pencil-alt\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">galaxy-pencil</span> (<strong>Edit</strong>) next to the history name (which by default is “Unnamed history”)</li>   <li>Type the new name: <code class=\"language-plaintext highlighter-rouge\">Avian influenza tutorial</code></li>   <li>Click on <strong>Save</strong></li> </ol>   <p>If you do not have the <i class=\"fas fa-pencil-alt\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">galaxy-pencil</span> (<strong>Edit</strong>) next to the history name:</p>   <ol>   <li>Click on <strong>Unnamed history</strong> (or the current name of the history) (<strong>Click to rename history</strong>) at the top of your history panel</li>   <li>Type the new name: <code class=\"language-plaintext highlighter-rouge\">Avian influenza tutorial</code></li>   <li>Press <kbd>Enter</kbd></li> </ol> </blockquote>\n      <p><!--END_SNIPPET--></p>\n    </li>\n  </ol>\n\n</blockquote>\n\n<h2 id=\"get-the-sequencing-data\">Get the sequencing data</h2>\n\n<blockquote class=\"hands_on\">\n  <hands-on-title>Get the data</hands-on-title>\n\n  <ol>\n    <li>\n      <p>Import the forward and reverse reads of the sequenced sample into your history and organize them into a <em>Paired Collection</em>.</p>\n\n      <div class=\"language-plaintext highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>https://usegalaxy.eu/api/datasets/4838ba20a6d86765171e4f201205515c/display?to_ext=fastqsanger.gz\nhttps://usegalaxy.eu/api/datasets/4838ba20a6d867657d09280baae4e1ec/display?to_ext=fastqsanger.gz\n</code></pre></div>      </div>\n\n      <ol>\n        <li>Copy the links above</li>\n        <li>Open the <span class=\"tool\" data-tool=\"upload1\" title=\"Upload tool\" aria-role=\"button\"><i class=\"fas fa-wrench\" aria-hidden=\"true\"></i> <strong>Upload</strong></span> Manager</li>\n        <li>In the top row of tabs select <strong>Collection</strong></li>\n        <li>Configure the drop-down select boxes on that tab like this:\n          <ul>\n            <li><em>“Collection Type”</em>: <code class=\"language-plaintext highlighter-rouge\">Pair</code></li>\n            <li><em>“File Type”</em>: <code class=\"language-plaintext highlighter-rouge\">fastqsanger.gz</code></li>\n          </ul>\n        </li>\n        <li>Click on <strong>Paste/Fetch data</strong> and paste the links you copied into the empty text box</li>\n        <li>Press <strong>Start</strong></li>\n        <li>Wait for the <strong>Build</strong> button to become enabled, click it, and, in the next dialogue, give a suitable <strong>Name</strong>, like <code class=\"language-plaintext highlighter-rouge\">Sequencing data</code>, to the new collection.</li>\n        <li>Click on <strong>Create collection</strong></li>\n      </ol>\n    </li>\n  </ol>\n\n</blockquote>\n\n<h2 id=\"inspect-the-reference-data\">Inspect the reference data</h2>\n\n<blockquote class=\"hands_on\">\n  <hands-on-title>What is in the reference collection?</hands-on-title>\n\n  <ol>\n    <li>Step inside the imported reference collection by clicking on it.</li>\n    <li>Expand individual elements of the collection by clicking on them to reveal more details about them.</li>\n    <li>\n      <p>View the content of any element by clicking its <i class=\"far fa-eye\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">galaxy-eye</span>.</p>\n\n      <p>You can then scroll through the data and use your browser’s search function to look for particular sequences.</p>\n\n      <blockquote class=\"question\">\n        <question-title>Questions</question-title>\n\n        <ol>\n          <li>How many elements are in the collection? What do they represent?</li>\n          <li>How many sequences are stored in each element?</li>\n          <li>Are all subtypes of HA and NA represented in the sequences?</li>\n          <li>Are there sequences of non-A Influenza species?</li>\n        </ol>\n\n        <blockquote class=\"solution\">\n          <solution-title>Answers</solution-title>\n\n          <ol>\n            <li>The collection consists of eight elements and each element provides reference sequences for one genome segment.</li>\n            <li>Each element has data for 56 sequences (Galaxy knows how to interpret the fasta format of the sequencing data and counts sequences for you; you can see the count for any of the elements by expanding it).</li>\n            <li>The collection has reference sequence data for H1-H18 (with the exception of H11) and for N1-N11. For many of those subtypes, however, there is only one reference, i.e., within-subtype variation is not captured well by the collection.</li>\n            <li>There are 6 <em>Influenza B</em> references in the collection. Since <em>Influenza B</em> is not normally seen in birds and we are going to analyze an avian influenza sample here, these can be considered controls: if we get an <em>Influenza B</em> assignment for the sample at any step in our analysis, we know something is very suspicious. This also means that we only have 50 <em>informative</em> references in the collection.</li>\n          </ol>\n\n        </blockquote>\n      </blockquote>\n    </li>\n  </ol>\n\n</blockquote>\n\n<p><i class=\"fas fa-info-circle\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">galaxy-info</span> There are lots of text processing and filtering tools for Galaxy, of which this tutorial is going to introduce just a small subset. You could use them to extract statistics about which subtypes are found how many times in the collection of references instead of relying on scrolling and searching. If you are interested and have the time, you may want to try the <a href=\"/training-material/topics/introduction/tutorials/data-manipulation-olympics/tutorial.html\">Data Manipulation Olympics</a> to learn more about available such tools and how to combine them.</p>\n\n<h1 id=\"quality-control\">Quality control</h1>\n\n<p>As a very first step, we would like to make sure that we base our analysis only on the high-quality parts of the sequenced reads.</p>\n\n<p>NGS reads often have lower base calling quality near their ends, so here we are going to trim low-quality stretches of bases from both ends. In addition, we are going to discard reads shorter than 30 bases after trimming. This is reasonable since our next step will involve extracting all possible 21-mers from the reads and there are very few possibilities for a read shorter than 30 bases.</p>\n\n<p>The tool <strong>fastp</strong> lets us perform these tasks and obtain a nice quality report for our reads before and after processing in one go, but many other options exist to perform sequenced reads quality control and trimming/filtering in Galaxy and the dedicated tutorial on <a href=\"/training-material/topics/sequence-analysis/tutorials/quality-control/tutorial.html\">quality control</a> introduces more of them.</p>\n\n<blockquote class=\"hands_on\">\n  <hands-on-title>QC and read trimming/filtering with fastp</hands-on-title>\n\n  <ol>\n    <li><span class=\"tool\" data-tool=\"toolshed.g2.bx.psu.edu/repos/iuc/fastp/fastp/0.23.2+galaxy0\" title=\"fastp tool\" aria-role=\"button\"><i class=\"fas fa-wrench\" aria-hidden=\"true\"></i> <strong>fastp</strong> (<i class=\"fas fa-cubes\" aria-hidden=\"true\"></i> Galaxy version 0.23.2+galaxy0)</span>\n      <ul>\n        <li><em>“Single-end or paired reads”</em>: <code class=\"language-plaintext highlighter-rouge\">Paired Collection</code></li>\n        <li><em>“Select paired collection(s)”</em>: the uploaded paired collection of sequenced reads</li>\n        <li>In <em>“Filter Options”</em> under <em>“Length filtering options”</em>:\n          <ul>\n            <li><em>“Length required”</em>: <code class=\"language-plaintext highlighter-rouge\">30</code></li>\n          </ul>\n        </li>\n        <li>In <em>“Read Modification Options”</em> under <em>“Per read cutting by quality options”</em>:\n          <ul>\n            <li><em>“Cut by quality in front (5’)”</em>: <code class=\"language-plaintext highlighter-rouge\">Yes</code></li>\n            <li><em>“Cut by quality in tail (3’)”</em>: <code class=\"language-plaintext highlighter-rouge\">Yes</code></li>\n            <li><em>“Cutting mean quality”</em>: <code class=\"language-plaintext highlighter-rouge\">30</code></li>\n          </ul>\n        </li>\n      </ul>\n\n      <blockquote class=\"details\">\n        <details-title>fastp default settings</details-title>\n\n        <p>fastp comes with basic default settings for some of its many parameters.\nIn particular, with no explicit parameter specifications, the tool will still remove reads that</p>\n        <ul>\n          <li>have base qualities &lt; 15 for more than 40% of their bases</li>\n          <li>have more than 5 Ns in their sequence</li>\n          <li>\n            <p>have a length &lt; 15 bases (after removing poly-G tails from Illumina reads)</p>\n\n            <p>Because our input data has far longer MiSeq-generated reads, we can increase this length threshold to 30 bases as done above.</p>\n          </li>\n        </ul>\n\n        <p>These are very relaxed criteria that will only remove the least usable reads, but still assure minimal\nquality standards that are good enough for many (including training) purposes.</p>\n      </blockquote>\n\n      <p>Running the tool will result in two outputs. One is a new paired collection with the processed reads, the other one is a report of initial quality, the processing actions performed and their effect on key quality metrics.</p>\n    </li>\n    <li>\n      <p><i class=\"far fa-eye\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">galaxy-eye</span> <strong>Inspect</strong> the report and try to answer the following questions:</p>\n\n      <blockquote class=\"question\">\n        <question-title>Questions</question-title>\n\n        <ol>\n          <li>Which set of reads (forward or reverse reads) did profit most quality-wise from our low-quality base trimming?</li>\n          <li>What percentage of reads got discarded completely with our settings, and what percentage of bases?</li>\n          <li>Why, according to the Filtering result, have some reads been discarded because of too many Ns?</li>\n        </ol>\n\n        <blockquote class=\"solution\">\n          <solution-title>Answers</solution-title>\n\n          <ol>\n            <li>The forward reads were of worse quality in particular near their 3’-ends than the reverse reads and, consequently, were affected more strongly by trimming (see the different “quality” plots in the report).</li>\n            <li>Less than 2% of reads got discarded completely (the “Filtering result” section of the report says 98.03% of all reads were retained). In contrast, around 10% of all bases got discarded (compare total bases before and after filtering) so most reads got trimmed but not discarded.</li>\n            <li>As explained in the “fastp default settings” box above, <strong>fastp</strong> is a tool with many hidden default actions in its various sections.\nInside the <em>Filter Options</em> inspect <em>Quality filtering options</em> and the various defaults mentioned in the parameters help therein. One of these defaults is to discard reads with more than 5 Ns. These defaults are often reasonable, but it’s good to be aware of them.</li>\n          </ol>\n\n        </blockquote>\n      </blockquote>\n    </li>\n  </ol>\n\n</blockquote>\n\n<h1 id=\"per-segment-subtyping-and-hybrid-reference-construction\">Per-segment subtyping and hybrid reference construction</h1>\n\n<p>Our goal at this step is to find best matches between our sequencing data and the reference sequences of each genome segment. This will:</p>\n<ul>\n  <li>give us preliminary subtyping results with regard to the HA and NA segments for the sequenced sample</li>\n  <li>suggest the best reference to map the sequencing data to for each segment.</li>\n</ul>\n\n<p>We are then going to combine the best reference of each segment into a hybrid reference genome to use for mapping our sequenced reads against.</p>\n\n<p>To identify the best matching reference segments, we are going to run the tool <strong>VAPOR</strong> asking it to report the stats for any hits it identifies.</p>\n\n<blockquote class=\"hands_on\">\n  <hands-on-title>Exploring best-matching reference segment scores</hands-on-title>\n\n  <ol>\n    <li><span class=\"tool\" data-tool=\"toolshed.g2.bx.psu.edu/repos/iuc/vapor/vapor/1.0.2+galaxy3\" title=\"VAPOR tool\" aria-role=\"button\"><i class=\"fas fa-wrench\" aria-hidden=\"true\"></i> <strong>VAPOR</strong> (<i class=\"fas fa-cubes\" aria-hidden=\"true\"></i> Galaxy version 1.0.2+galaxy3)</span>\n      <ul>\n        <li><i class=\"far fa-folder\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">param-collection</span> <em>“Reference sequences”</em>: <code class=\"language-plaintext highlighter-rouge\">References per segment (INSAFlu)</code></li>\n        <li><em>“Type of sequencing data”</em>: <code class=\"language-plaintext highlighter-rouge\">Paired-end as collection</code></li>\n        <li><em>“Paired collection of sequenced reads”</em>: quality-trimmed reads; output of <strong>fastp</strong></li>\n        <li><em>“Desired output”</em>: <code class=\"language-plaintext highlighter-rouge\">Return scores of best matches</code></li>\n        <li><em>“Limit number of reported matches to”</em>: <code class=\"language-plaintext highlighter-rouge\">0</code></li>\n        <li>In <em>“Optional arguments”</em>:\n          <ul>\n            <li><em>“Read kmer filtering threshold”</em>: <code class=\"language-plaintext highlighter-rouge\">0.1</code></li>\n            <li><em>“Minimum k-mer proportion”</em>: <code class=\"language-plaintext highlighter-rouge\">0.0</code></li>\n          </ul>\n        </li>\n      </ul>\n    </li>\n    <li>\n      <p><i class=\"far fa-eye\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">galaxy-eye</span> Explore the output collection produced by the tool</p>\n\n      <blockquote class=\"question\">\n        <question-title>Questions</question-title>\n\n        <ol>\n          <li>Is there a difference between the results for segment 4 (encoding HA), segment 6 (encoding NA) and those for the remaining segments?</li>\n          <li>According to the tool, what is the likely subtype with regard to HA and NA of the sample?</li>\n        </ol>\n\n        <blockquote class=\"solution\">\n          <solution-title>Answers</solution-title>\n\n          <ol>\n            <li>The values for <code class=\"language-plaintext highlighter-rouge\">% of query bases in reads</code> and for <code class=\"language-plaintext highlighter-rouge\">Total score</code> are drastically lower for the HA and somewhat lower for the NA segment than for any of the other segments. This could be due to the structure of the collection of references we have used, but also fits very well with the higher selection pressure on NA and, in particular on HA, as the main antigenic proteins of the virus, which leads to higher variability in these segments than in the others.</li>\n            <li>\n              <p>The best match (assigned an almost 2x higher score than the second-best match) found for the HA segment is from an H4N6 strain. The top two matches with regard to the NA segment (again assigned ~ 2x higher scores than the next best matches) are from strains with the N6 subtype of NA.</p>\n\n              <p>The most likely subtype of the sample, thus, appears to be H4N6.</p>\n            </li>\n          </ol>\n\n        </blockquote>\n      </blockquote>\n    </li>\n  </ol>\n\n</blockquote>\n\n<p>Now that we have established that things <em>may</em> make sense, we can use the output of <strong>VAPOR</strong> to extract the actual sequence of the top hit for each reference segment. We then concatenate these best matches into a hybrid reference genome for mapping.</p>\n\n<blockquote class=\"hands_on\">\n  <hands-on-title>Obtaining sequences of top hits identified by VAPOR</hands-on-title>\n\n  <ol>\n    <li><span class=\"tool\" data-tool=\"toolshed.g2.bx.psu.edu/repos/bgruening/text_processing/tp_find_and_replace/1.1.4\" title=\"Replace parts of text tool\" aria-role=\"button\"><i class=\"fas fa-wrench\" aria-hidden=\"true\"></i> <strong>Replace parts of text</strong> (<i class=\"fas fa-cubes\" aria-hidden=\"true\"></i> Galaxy version 1.1.4)</span> to extract just the name of the sequence from each line of VAPOR’s output\n      <ul>\n        <li><i class=\"far fa-folder\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">param-collection</span> <em>“File to process”</em>: collection of score outputs of <strong>VAPOR</strong></li>\n        <li>In <i class=\"far fa-plus-square\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">param-repeat</span> <em>“1. Find and Replace”</em>:\n          <ul>\n            <li><em>“Find pattern”</em>: <code class=\"language-plaintext highlighter-rouge\">^.+\\t&gt;(.+)$</code></li>\n            <li><em>“Replace with”</em>: <code class=\"language-plaintext highlighter-rouge\">$1</code></li>\n            <li><em>“Find-Pattern is a regular expression”</em>: <code class=\"language-plaintext highlighter-rouge\">Yes</code></li>\n          </ul>\n        </li>\n      </ul>\n    </li>\n    <li><span class=\"tool\" data-tool=\"Show beginning1\" title=\"Select first lines from a dataset tool\" aria-role=\"button\"><i class=\"fas fa-wrench\" aria-hidden=\"true\"></i> <strong>Select first lines from a dataset</strong></span> to get the first line, i.e. the best match from VAPOR’s output\n      <ul>\n        <li><em>“Select first”</em>: <code class=\"language-plaintext highlighter-rouge\">1</code> lines</li>\n        <li><i class=\"far fa-folder\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">param-collection</span> <em>“from”</em>: output of <strong>Replace</strong></li>\n      </ul>\n    </li>\n    <li><span class=\"tool\" data-tool=\"toolshed.g2.bx.psu.edu/repos/iuc/seqtk/seqtk_subseq/1.3.1\" title=\"seqtk_subseq tool\" aria-role=\"button\"><i class=\"fas fa-wrench\" aria-hidden=\"true\"></i> <strong>seqtk_subseq</strong> (<i class=\"fas fa-cubes\" aria-hidden=\"true\"></i> Galaxy version 1.3.1)</span> to extract the reference sequences based on their names reported by VAPOR\n      <ul>\n        <li><i class=\"far fa-folder\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">param-collection</span> <em>“Input FASTA/Q file”</em>: <code class=\"language-plaintext highlighter-rouge\">References per segment (INSAFlu)</code></li>\n        <li><em>“Select source of sequence choices”</em>: <code class=\"language-plaintext highlighter-rouge\">FASTA/Q ID list</code></li>\n        <li><i class=\"far fa-folder\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">param-collection</span> <em>“Input ID list”</em>: the collection output of <strong>Select first</strong></li>\n      </ul>\n    </li>\n    <li><span class=\"tool\" data-tool=\"toolshed.g2.bx.psu.edu/repos/nml/collapse_collections/collapse_dataset/5.1.0\" title=\"Collapse Collection tool\" aria-role=\"button\"><i class=\"fas fa-wrench\" aria-hidden=\"true\"></i> <strong>Collapse Collection</strong> (<i class=\"fas fa-cubes\" aria-hidden=\"true\"></i> Galaxy version 5.1.0)</span> to combine the best-matching sequence of each segment into one dataset\n      <ul>\n        <li><i class=\"far fa-folder\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">param-collection</span> <em>“Collection of files to collapse into single dataset”</em>: the selected sequences collection produced by <strong>seqtk_subseq</strong></li>\n      </ul>\n    </li>\n  </ol>\n\n</blockquote>\n\n<p>At this point, you may want to <i class=\"far fa-eye\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">galaxy-eye</span> inspect the output of the last step to see if it is an eight-segments reference genome as expected, and if the segments correspond to the top hits found by VAPOR.</p>\n\n<h1 id=\"mapping-to-a-hybrid-reference\">Mapping to a hybrid reference</h1>\n\n<p>If things went well, the hybrid reference we just obtained should be close enough across all segments to our sample to allow successful mapping of reads. Before we start the mapping we may want to truncate the segment names in our hybrid reference genome though because currently these names still reflect the full origin of the segment sequences, but from now on we are fine with just the segment ID. We can use the <strong>Replace</strong> tool from before again to truncate the names.</p>\n\n<blockquote class=\"hands_on\">\n  <hands-on-title>Shortening sequence titles</hands-on-title>\n\n  <ol>\n    <li><span class=\"tool\" data-tool=\"toolshed.g2.bx.psu.edu/repos/bgruening/text_processing/tp_find_and_replace/1.1.4\" title=\"Replace parts of text tool\" aria-role=\"button\"><i class=\"fas fa-wrench\" aria-hidden=\"true\"></i> <strong>Replace parts of text</strong> (<i class=\"fas fa-cubes\" aria-hidden=\"true\"></i> Galaxy version 1.1.4)</span>\n      <ul>\n        <li><i class=\"far fa-file\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">param-file</span> <em>“File to process”</em>: the hybrid reference genome; output of <strong>Collapse Collection</strong></li>\n        <li>In <i class=\"far fa-plus-square\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">param-repeat</span> <em>“1. Find and Replace”</em>:\n          <ul>\n            <li><em>“Find pattern”</em>: <code class=\"language-plaintext highlighter-rouge\">^&gt;([^|]+).+$</code></li>\n            <li><em>“Replace with”</em>: <code class=\"language-plaintext highlighter-rouge\">&gt;$1</code></li>\n            <li><em>“Find-Pattern is a regular expression”</em>: <code class=\"language-plaintext highlighter-rouge\">Yes</code></li>\n          </ul>\n        </li>\n      </ul>\n    </li>\n    <li>\n      <p>Add a tag to the output dataset</p>\n\n      <p>This is the hybrid reference genome that we are going to use for mapping now.\nIt is an important intermediate result, to which we will need to return later, and to make that easier we are going to add a tag to it now for extra visibility in the history.</p>\n\n      <ol>\n        <li>Click on the dataset to expand it</li>\n        <li>Click on <i class=\"fas fa-tags\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">galaxy-tags</span> <strong>Add Tags</strong></li>\n        <li>Enter a tag like <code class=\"language-plaintext highlighter-rouge\">HybridRef</code> (tags have to consist of a single word)</li>\n        <li>Confirm your choice by pressing Enter on the keyboard or clicking on the new name.</li>\n      </ol>\n    </li>\n  </ol>\n\n</blockquote>\n\n<p>Having polished the titles of the segments in our hybrid reference genome we are finally ready for mapping, which we will carry out with <strong>BWA-MEM</strong>, clean up a bit with <strong>Samtools view</strong> and produce a quality report for with <strong>QualiMap BamQC</strong>.</p>\n\n<blockquote class=\"hands_on\">\n  <hands-on-title>Read mapping and quality control</hands-on-title>\n\n  <ol>\n    <li><span class=\"tool\" data-tool=\"toolshed.g2.bx.psu.edu/repos/devteam/bwa/bwa_mem/0.7.17.2\" title=\"Map with BWA-MEM tool\" aria-role=\"button\"><i class=\"fas fa-wrench\" aria-hidden=\"true\"></i> <strong>Map with BWA-MEM</strong> (<i class=\"fas fa-cubes\" aria-hidden=\"true\"></i> Galaxy version 0.7.17.2)</span>\n      <ul>\n        <li><em>“Will you select a reference genome from your history or use a built-in index?”</em>: <code class=\"language-plaintext highlighter-rouge\">Use a genome from history and build index</code></li>\n        <li><i class=\"far fa-file\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">param-file</span> <em>“Use the following dataset as the reference sequence”</em>: hybrid reference genome with shortened names; output of <strong>Replace</strong></li>\n        <li><em>“Single or Paired-end reads”</em>: <code class=\"language-plaintext highlighter-rouge\">Paired Collection</code></li>\n        <li><em>“Select a paired collection”</em>: quality-trimmed reads; output of <strong>fastp</strong> in QC and Trimming</li>\n      </ul>\n    </li>\n    <li><span class=\"tool\" data-tool=\"toolshed.g2.bx.psu.edu/repos/iuc/samtools_view/samtools_view/1.15.1+galaxy0\" title=\"Samtools view tool\" aria-role=\"button\"><i class=\"fas fa-wrench\" aria-hidden=\"true\"></i> <strong>Samtools view</strong> (<i class=\"fas fa-cubes\" aria-hidden=\"true\"></i> Galaxy version 1.15.1+galaxy0)</span>\n      <ul>\n        <li><i class=\"far fa-file\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">param-file</span> <em>“SAM/BAM/CRAM data set”</em>: mapped reads BAM dataset; output of <strong>BWA-MEM</strong></li>\n        <li><em>“What would you like to look at?”</em>: <code class=\"language-plaintext highlighter-rouge\">A filtered/subsampled selection of reads</code></li>\n        <li>In <em>“Configure filters”</em>:\n          <ul>\n            <li><em>“Filter by quality”</em>: <code class=\"language-plaintext highlighter-rouge\">20</code></li>\n            <li><em>“Require that these flags are set”</em>: <code class=\"language-plaintext highlighter-rouge\">Read is paired</code> and <code class=\"language-plaintext highlighter-rouge\">Read is mapped in a proper pair</code></li>\n          </ul>\n        </li>\n      </ul>\n    </li>\n    <li><span class=\"tool\" data-tool=\"toolshed.g2.bx.psu.edu/repos/iuc/qualimap_bamqc/qualimap_bamqc/2.2.2d+galaxy3\" title=\"QualiMap BamQC tool\" aria-role=\"button\"><i class=\"fas fa-wrench\" aria-hidden=\"true\"></i> <strong>QualiMap BamQC</strong> (<i class=\"fas fa-cubes\" aria-hidden=\"true\"></i> Galaxy version 2.2.2d+galaxy3)</span>\n      <ul>\n        <li><i class=\"far fa-file\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">param-file</span> <em>“Mapped reads input dataset”</em>: filtered mapped reads BAM dataset; output of <strong>Samtools view</strong></li>\n        <li><em>“Skip duplicate reads”</em>: <code class=\"language-plaintext highlighter-rouge\">Unselect all</code></li>\n        <li>In <em>“Settings affecting specific plots”</em>:\n          <ul>\n            <li><em>“Number of bins to use in across-reference plots”</em>: <code class=\"language-plaintext highlighter-rouge\">40</code></li>\n          </ul>\n        </li>\n      </ul>\n    </li>\n    <li>\n      <p><i class=\"far fa-eye\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">galaxy-eye</span> Study the report generated with QualiMap</p>\n\n      <blockquote class=\"question\">\n        <question-title>Questions</question-title>\n\n        <ol>\n          <li>What is the coverage of each segment by the sequenced reads, and is it uniform?</li>\n          <li>Look for a plot showing read mapping quality across the reference. What can you conclude?</li>\n        </ol>\n\n        <blockquote class=\"solution\">\n          <solution-title>Answers</solution-title>\n\n          <ol>\n            <li>Coverage is rather different for the different segments. Looking at “Mean coverage” and its “Standard deviation” in the “Chromosome stats” table and at the “Coverage across reference” plot, coverage of the HA segment seems to be most critical since it approaches zero in some regions.</li>\n            <li>Mapping quality is almost constant at or very near 60 (which happens to be the maximum mapping quality value emitted by BWA-MEM) across all segments with the exception of HA.</li>\n          </ol>\n\n          <p>These two observations combined with the VAPOR statistics for HA show again that even the best matching reference for this segment is not exactly close to the sequence of our sample. The read mapper had difficulties placing the sequenced reads on that sub-optimal reference and it looks as if we might have very little sequence information for some HA regions.</p>\n\n        </blockquote>\n      </blockquote>\n    </li>\n  </ol>\n\n</blockquote>\n\n<h1 id=\"consensus-sequence-construction\">Consensus sequence construction</h1>\n\n<p>From the polished mapping of reads to our custom reference we can now construct the consensus sequence of our sample.</p>\n\n<p>Unfortunately, the tool we are going to use for this, <strong>ivar consensus</strong>, is not capable of working with more than one reference name at a time, but because this is influenza data we have mappings to 8 different segments described in our data. So we need to take a little detour and split the mapped reads data into a collection of datasets each containing the mappings for just one segment first again, then perform the consensus construction for all of them in parallel.</p>\n\n<blockquote class=\"hands_on\">\n  <hands-on-title>Splitting mapped reads by genome segment</hands-on-title>\n\n  <ol>\n    <li><span class=\"tool\" data-tool=\"toolshed.g2.bx.psu.edu/repos/iuc/bamtools_split_ref/bamtools_split_ref/2.5.2+galaxy1\" title=\"Split BAM by Reference tool\" aria-role=\"button\"><i class=\"fas fa-wrench\" aria-hidden=\"true\"></i> <strong>Split BAM by Reference</strong> (<i class=\"fas fa-cubes\" aria-hidden=\"true\"></i> Galaxy version 2.5.2+galaxy1)</span>\n      <ul>\n        <li><i class=\"far fa-file\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">param-file</span> <em>“BAM dataset to split by reference”</em>: filtered mapped reads; output of <strong>Samtools view</strong></li>\n      </ul>\n    </li>\n  </ol>\n\n</blockquote>\n\n<p>The output from this step has the desired collection structure, but the names of the collection elements are not the nicest. Ideally, we would just reuse the segment names, which are already provided in our mapping reference genome. So lets extract these names again and use them as new element labels</p>\n\n<blockquote class=\"hands_on\">\n  <hands-on-title>Relabeling collection elements</hands-on-title>\n\n  <ol>\n    <li><span class=\"tool\" data-tool=\"Grep1\" title=\"Select lines that match an expression tool\" aria-role=\"button\"><i class=\"fas fa-wrench\" aria-hidden=\"true\"></i> <strong>Select lines that match an expression</strong></span>\n      <ul>\n        <li>\n          <p><i class=\"far fa-file\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">param-file</span> <em>“Select lines from”</em>: the mapping reference; output of <strong>Replace</strong> in Mapping to a hybrid reference</p>\n\n          <p><i class=\"far fa-lightbulb\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">tip</span> This is the dataset you should have <i class=\"fas fa-tags\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">galaxy-tags</span> tagged before. Lets hope you did!</p>\n        </li>\n        <li><em>“that”</em>: <code class=\"language-plaintext highlighter-rouge\">Matching</code></li>\n        <li><em>“the pattern”</em>: <code class=\"language-plaintext highlighter-rouge\">^&gt;.+</code></li>\n      </ul>\n    </li>\n    <li><span class=\"tool\" data-tool=\"toolshed.g2.bx.psu.edu/repos/bgruening/text_processing/tp_find_and_replace/1.1.4\" title=\"Replace parts of text tool\" aria-role=\"button\"><i class=\"fas fa-wrench\" aria-hidden=\"true\"></i> <strong>Replace parts of text</strong> (<i class=\"fas fa-cubes\" aria-hidden=\"true\"></i> Galaxy version 1.1.4)</span>\n      <ul>\n        <li><i class=\"far fa-file\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">param-file</span> <em>“File to process”</em>: output of <strong>Select</strong></li>\n        <li>In <i class=\"far fa-plus-square\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">param-repeat</span> <em>“1. Find and Replace”</em>:\n          <ul>\n            <li><em>“Find pattern”</em>: <code class=\"language-plaintext highlighter-rouge\">^&gt;(.+)$</code></li>\n            <li><em>“Replace with”</em>: <code class=\"language-plaintext highlighter-rouge\">$1</code></li>\n            <li><em>“Find-Pattern is a regular expression”</em>: <code class=\"language-plaintext highlighter-rouge\">Yes</code></li>\n          </ul>\n        </li>\n      </ul>\n    </li>\n    <li><span class=\"tool\" data-tool=\"__RELABEL_FROM_FILE__\" title=\"Relabel identifiers tool\" aria-role=\"button\"><i class=\"fas fa-wrench\" aria-hidden=\"true\"></i> <strong>Relabel identifiers</strong></span>\n      <ul>\n        <li><i class=\"far fa-file\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">param-file</span> <em>“Input collection”</em>: the split mappings; output of <strong>Split BAM by Reference</strong></li>\n        <li><em>“How should the new labels be specified?”</em>: <code class=\"language-plaintext highlighter-rouge\">Using lines in a simple text file.</code></li>\n        <li><i class=\"far fa-file\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">param-file</span> <em>“New Identifiers”</em>: output of <strong>Replace</strong></li>\n        <li><em>“Ensure strict mapping”</em>: <code class=\"language-plaintext highlighter-rouge\">Yes</code></li>\n      </ul>\n    </li>\n  </ol>\n\n</blockquote>\n\n<p>And with that we are ready for consensus sequence generation!</p>\n\n<p>To accept any base suggested by the mapped sequenced reads as the consensus base for the corresponding genome position, we ask for the following requirements to be fulfilled:</p>\n\n<ul>\n  <li>at least ten sequenced reads have to provide information about the base in question</li>\n  <li>at a minimum, 70% of these reads have to agree on the base at this position.</li>\n</ul>\n\n<p>To avoid getting misled too much by sequencing errors, we are also going to ignore bases with a base calling quality less than 20 in the above counts (i.e., we are going to base our decisions only on bases in sequenced reads that the basecaller of the sequencer was reasonably sure about.</p>\n\n<p>Now what if we cannot obtain a consensus base for a position with the above criteria? In such cases of uncertainty we want to insert an N (i.e. an unknown base) to express that we either did not have enough information about the position or that this information was ambiguous.</p>\n\n<p><i class=\"fas fa-info-circle\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">galaxy-info</span> All of the above limits for consensus base calling are arbitrary to some degree, and depend somewhat on the quality of the sequencing data. With very high overall coverage, for example, it is possible to increase the coverage threshold, but if you increase that threshold too much, you may end up with a consensus sequence consisting mostly of Ns.</p>\n\n<blockquote class=\"hands_on\">\n  <hands-on-title>Per-segment consensus construction</hands-on-title>\n\n  <ol>\n    <li><span class=\"tool\" data-tool=\"toolshed.g2.bx.psu.edu/repos/iuc/ivar_consensus/ivar_consensus/1.4.2+galaxy0\" title=\"ivar consensus tool\" aria-role=\"button\"><i class=\"fas fa-wrench\" aria-hidden=\"true\"></i> <strong>ivar consensus</strong> (<i class=\"fas fa-cubes\" aria-hidden=\"true\"></i> Galaxy version 1.4.2+galaxy0)</span>\n      <ul>\n        <li><i class=\"far fa-folder\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">param-collection</span> <em>“Bam file”</em>: the relabeled collection of mapped reads; output of <strong>Relabel identifiers</strong></li>\n        <li><em>“Minimum quality score threshold to count base”</em>: <code class=\"language-plaintext highlighter-rouge\">20</code></li>\n        <li><em>“Minimum frequency threshold”</em>: <code class=\"language-plaintext highlighter-rouge\">0.7</code></li>\n        <li><em>“Minimum indel frequency threshold”</em>: <code class=\"language-plaintext highlighter-rouge\">0.8</code></li>\n        <li><em>“Minimum depth to call consensus”</em>: <code class=\"language-plaintext highlighter-rouge\">10</code></li>\n        <li><em>“How to represent positions with coverage less than the minimum depth threshold”</em>: <code class=\"language-plaintext highlighter-rouge\">Represent as N (-n N)</code></li>\n      </ul>\n\n      <p>The output is a consensus sequence in FASTA format, one per segment, with\nthe names just providing a bit too much detail for our purpose.</p>\n    </li>\n    <li><span class=\"tool\" data-tool=\"toolshed.g2.bx.psu.edu/repos/bgruening/text_processing/tp_find_and_replace/1.1.4\" title=\"Replace parts of text tool\" aria-role=\"button\"><i class=\"fas fa-wrench\" aria-hidden=\"true\"></i> <strong>Replace parts of text</strong> (<i class=\"fas fa-cubes\" aria-hidden=\"true\"></i> Galaxy version 1.1.4)</span>\n      <ul>\n        <li><i class=\"far fa-folder\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">param-collection</span> <em>“File to process”</em>: consensus sequences; output of <strong>ivar consensus</strong></li>\n        <li>In <i class=\"far fa-plus-square\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">param-repeat</span> <em>“1: Find and Replace”</em>:\n          <ul>\n            <li><em>“Find pattern”</em>: <code class=\"language-plaintext highlighter-rouge\">^&gt;Consensus_(.*)_threshold_.*</code></li>\n            <li><em>“Replace with”</em>: <code class=\"language-plaintext highlighter-rouge\">&gt;$1</code></li>\n            <li><em>“Find-Pattern is a regular expression”</em>: <code class=\"language-plaintext highlighter-rouge\">Yes</code></li>\n          </ul>\n        </li>\n      </ul>\n    </li>\n    <li>\n      <p><i class=\"far fa-eye\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">galaxy-eye</span> Inspect each consensus sequence generated for the different segments</p>\n\n      <blockquote class=\"question\">\n        <question-title></question-title>\n\n        <p>Does everything look ok?</p>\n\n        <blockquote class=\"solution\">\n          <solution-title>Answer</solution-title>\n\n          <p>As expected from the findings so far, the consensus sequence for the HA segment has stretches of Ns in it, which likely reflect the mapping issues and associated loss of coverage caused by our insufficiently sized collection of references.</p>\n\n        </blockquote>\n      </blockquote>\n    </li>\n  </ol>\n\n</blockquote>\n\n<h1 id=\"placing-segments-on-a-phylogenetic-tree\">Placing segments on a phylogenetic tree</h1>\n\n<p>The next logical step after obtaining the consensus sequences of segments of our sample is to explore how those sequences are related to the sequences in our reference collection.\nTo do so, we are going to combine the reference sequences of all segments with their corresponding consensus sequence into one multiple sequence alignment (MSA) per segment, and use these to generate phylogenetic trees, again one per segment. We are going to use two rather standard tools, <strong>MAFFT</strong> and <strong>IQTree</strong>, for generating MSAs and trees, respectively.</p>\n\n<blockquote class=\"hands_on\">\n  <hands-on-title>Exploring phylogeny</hands-on-title>\n\n  <ol>\n    <li><span class=\"tool\" data-tool=\"toolshed.g2.bx.psu.edu/repos/rnateam/mafft/rbc_mafft/7.520+galaxy0\" title=\"MAFFT tool\" aria-role=\"button\"><i class=\"fas fa-wrench\" aria-hidden=\"true\"></i> <strong>MAFFT</strong> (<i class=\"fas fa-cubes\" aria-hidden=\"true\"></i> Galaxy version 7.520+galaxy0)</span>\n      <ul>\n        <li><em>“For multiple inputs generate”</em>: <code class=\"language-plaintext highlighter-rouge\">one or several MSAs depending on input structure</code>\n          <ul>\n            <li>In <em>“Input batch”</em>:\n              <ul>\n                <li><i class=\"far fa-plus-square\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">param-repeat</span> <em>“1: Input batch”</em>\n                  <ul>\n                    <li><i class=\"far fa-folder\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">param-collection</span> <em>“Sequences to align”</em>: collection of <code class=\"language-plaintext highlighter-rouge\">References per segment (INSAFlu)</code></li>\n                  </ul>\n                </li>\n                <li><i class=\"far fa-plus-square\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">param-repeat</span> <em>“2: Input batch”</em>\n                  <ul>\n                    <li><i class=\"far fa-folder\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">param-collection</span> <em>“Sequences to align”</em>: collection of renamed consensus sequences; output of <strong>Replace</strong> on consensus sequences</li>\n                  </ul>\n                </li>\n              </ul>\n            </li>\n          </ul>\n        </li>\n        <li><em>“Type of sequences”</em>: <code class=\"language-plaintext highlighter-rouge\">Nucleic acids</code></li>\n      </ul>\n\n      <p>Because both input batches are collections of eight elements each, the result is also a collection of eight MSAs, each aligning all reference sequences of one genome segment plus the consensus sequence we have obtained for that segment against each other.</p>\n    </li>\n    <li><span class=\"tool\" data-tool=\"toolshed.g2.bx.psu.edu/repos/iuc/iqtree/iqtree/2.1.2+galaxy2\" title=\"IQ-TREE tool\" aria-role=\"button\"><i class=\"fas fa-wrench\" aria-hidden=\"true\"></i> <strong>IQ-TREE</strong> (<i class=\"fas fa-cubes\" aria-hidden=\"true\"></i> Galaxy version 2.1.2+galaxy2)</span>\n      <ul>\n        <li><i class=\"far fa-folder\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">param-collection</span> <em>“Specify input alignment file in PHYLIP, FASTA, NEXUS, CLUSTAL or MSF format.”</em>: output of <strong>MAFFT</strong></li>\n        <li><em>“Specify sequence type …“</em>: <code class=\"language-plaintext highlighter-rouge\">DNA</code></li>\n      </ul>\n    </li>\n    <li>\n      <p><i class=\"far fa-eye\" aria-hidden=\"true\"></i><span class=\"visually-hidden\">galaxy-eye</span> Explore each of the final trees produced by IQTree for the different segments</p>\n\n      <blockquote class=\"question\">\n        <question-title></question-title>\n\n        <p>What are your conclusions about the sample in general and its HA and NA segments in particular?</p>\n\n        <blockquote class=\"solution\">\n          <solution-title>Answers</solution-title>\n\n          <ul>\n            <li>For most of its segments the sample resembles relatively recent (from the last decade) Eurasian reference sequences.</li>\n            <li>For HA and NA the sample clusters with the few available samples of the corresponding subtype.</li>\n            <li>None of the references closest to the sample with respect to HA and NA are close to the recent Eurasian reference cluster for their remaining segments.</li>\n            <li>A plausible explanation is that the H4 and N6 segments of the sample have been brought into the recent Eurasian background through a reassortment event. Caveat: interpretations like this can be heavily influenced by the size of the reference collection!</li>\n          </ul>\n\n        </blockquote>\n      </blockquote>\n    </li>\n  </ol>\n\n</blockquote>\n\n<h1 id=\"conclusion\">Conclusion</h1>\n\n<p>Analysis workflows for influenza whole-genome sequencing data need to take into account the specific characteristics of the viral genome. Due to their higher natural variability this is especially true for avian influenza samples and for the HA- and NA-encoding segments of the genome.</p>\n\n<p>Nevertheless, it looks possible, with carefully chosen reference segment sequences and bioinformatic tools, to avoid a computationally expensive de-novo assembly approach and to use mapping against a dynamically compiled reference genome instead.</p>\n\n<p>The rather small reference segment collection suggested for this tutorial consists of 56 different samples, of which only a single one has the H4N6 subtype of the sample analyzed here. Still it allowed us to perform subtyping of the sample, to construct complete consensus sequences for 7 segments including NA, and to draw valuable conclusions about the origin of the sample. It is conceivable that a larger collection of references chosen to capture several strains from each HA subtype could solve the remaining issue of the incomplete HA consensus sequence.</p>\n"],"ref_slides":[],"hands_on":true,"slides":false,"mod_date":"2024-03-20 15:09:06 +0000","pub_date":"2022-11-21 16:45:21 +0000","version":16,"api":"https://training.galaxyproject.org/training-material/api/topics/variant-analysis/tutorials/aiv-analysis/tutorial.json","tools":["Grep1","Show beginning1","__RELABEL_FROM_FILE__","toolshed.g2.bx.psu.edu/repos/bgruening/text_processing/tp_find_and_replace/1.1.4","toolshed.g2.bx.psu.edu/repos/devteam/bwa/bwa_mem/0.7.17.2","toolshed.g2.bx.psu.edu/repos/iuc/bamtools_split_ref/bamtools_split_ref/2.5.2+galaxy1","toolshed.g2.bx.psu.edu/repos/iuc/fastp/fastp/0.23.2+galaxy0","toolshed.g2.bx.psu.edu/repos/iuc/iqtree/iqtree/2.1.2+galaxy2","toolshed.g2.bx.psu.edu/repos/iuc/ivar_consensus/ivar_consensus/1.4.2+galaxy0","toolshed.g2.bx.psu.edu/repos/iuc/qualimap_bamqc/qualimap_bamqc/2.2.2d+galaxy3","toolshed.g2.bx.psu.edu/repos/iuc/samtools_view/samtools_view/1.15.1+galaxy0","toolshed.g2.bx.psu.edu/repos/iuc/seqtk/seqtk_subseq/1.3.1","toolshed.g2.bx.psu.edu/repos/iuc/vapor/vapor/1.0.2+galaxy3","toolshed.g2.bx.psu.edu/repos/nml/collapse_collections/collapse_dataset/5.1.0","toolshed.g2.bx.psu.edu/repos/rnateam/mafft/rbc_mafft/7.520+galaxy0","upload1"],"supported_servers":{"exact":[{"url":"https://usegalaxy.eu","name":"UseGalaxy.eu","usegalaxy":true},{"url":"https://usegalaxy.org","name":"UseGalaxy.org (Main)","usegalaxy":true}],"inexact":[{"url":"https://usegalaxy.cz/","name":"UseGalaxy.cz","usegalaxy":false}]},"topic_name_human":"Variant Analysis","admin_install":{"install_tool_dependencies":true,"install_repository_dependencies":true,"install_resolver_dependencies":true,"tools":[{"name":"text_processing","owner":"bgruening","revisions":"d698c222f354","tool_panel_section_label":"Text Manipulation","tool_shed_url":"https://toolshed.g2.bx.psu.edu/"},{"name":"bwa","owner":"devteam","revisions":"e188dc7a68e6","tool_panel_section_label":"Mapping","tool_shed_url":"https://toolshed.g2.bx.psu.edu/"},{"name":"bamtools_split_ref","owner":"iuc","revisions":"9b520009db81","tool_panel_section_label":"SAM/BAM","tool_shed_url":"https://toolshed.g2.bx.psu.edu/"},{"name":"fastp","owner":"iuc","revisions":"65b93b623c77","tool_panel_section_label":"FASTA/FASTQ","tool_shed_url":"https://toolshed.g2.bx.psu.edu/"},{"name":"iqtree","owner":"iuc","revisions":"24d024316465","tool_panel_section_label":"Evolution","tool_shed_url":"https://toolshed.g2.bx.psu.edu/"},{"name":"ivar_consensus","owner":"iuc","revisions":"40737febe339","tool_panel_section_label":"Virology","tool_shed_url":"https://toolshed.g2.bx.psu.edu/"},{"name":"qualimap_bamqc","owner":"iuc","revisions":"19ece8afbaab","tool_panel_section_label":"SAM/BAM","tool_shed_url":"https://toolshed.g2.bx.psu.edu/"},{"name":"samtools_view","owner":"iuc","revisions":"5826298f6a73","tool_panel_section_label":"SAM/BAM","tool_shed_url":"https://toolshed.g2.bx.psu.edu/"},{"name":"seqtk","owner":"iuc","revisions":"3da72230c066","tool_panel_section_label":"FASTA/FASTQ","tool_shed_url":"https://toolshed.g2.bx.psu.edu/"},{"name":"vapor","owner":"iuc","revisions":"244812f5bd1f","tool_panel_section_label":"Metagenomic Analysis","tool_shed_url":"https://toolshed.g2.bx.psu.edu/"},{"name":"collapse_collections","owner":"nml","revisions":"90981f86000f","tool_panel_section_label":"Collection Operations","tool_shed_url":"https://toolshed.g2.bx.psu.edu/"},{"name":"mafft","owner":"rnateam","revisions":"bf28a8cff401","tool_panel_section_label":"Multiple Alignments","tool_shed_url":"https://toolshed.g2.bx.psu.edu/"}]},"admin_install_yaml":"---\ninstall_tool_dependencies: true\ninstall_repository_dependencies: true\ninstall_resolver_dependencies: true\ntools:\n- name: text_processing\n  owner: bgruening\n  revisions: d698c222f354\n  tool_panel_section_label: Text Manipulation\n  tool_shed_url: https://toolshed.g2.bx.psu.edu/\n- name: bwa\n  owner: devteam\n  revisions: e188dc7a68e6\n  tool_panel_section_label: Mapping\n  tool_shed_url: https://toolshed.g2.bx.psu.edu/\n- name: bamtools_split_ref\n  owner: iuc\n  revisions: 9b520009db81\n  tool_panel_section_label: SAM/BAM\n  tool_shed_url: https://toolshed.g2.bx.psu.edu/\n- name: fastp\n  owner: iuc\n  revisions: 65b93b623c77\n  tool_panel_section_label: FASTA/FASTQ\n  tool_shed_url: https://toolshed.g2.bx.psu.edu/\n- name: iqtree\n  owner: iuc\n  revisions: 24d024316465\n  tool_panel_section_label: Evolution\n  tool_shed_url: https://toolshed.g2.bx.psu.edu/\n- name: ivar_consensus\n  owner: iuc\n  revisions: 40737febe339\n  tool_panel_section_label: Virology\n  tool_shed_url: https://toolshed.g2.bx.psu.edu/\n- name: qualimap_bamqc\n  owner: iuc\n  revisions: 19ece8afbaab\n  tool_panel_section_label: SAM/BAM\n  tool_shed_url: https://toolshed.g2.bx.psu.edu/\n- name: samtools_view\n  owner: iuc\n  revisions: 5826298f6a73\n  tool_panel_section_label: SAM/BAM\n  tool_shed_url: https://toolshed.g2.bx.psu.edu/\n- name: seqtk\n  owner: iuc\n  revisions: 3da72230c066\n  tool_panel_section_label: FASTA/FASTQ\n  tool_shed_url: https://toolshed.g2.bx.psu.edu/\n- name: vapor\n  owner: iuc\n  revisions: 244812f5bd1f\n  tool_panel_section_label: Metagenomic Analysis\n  tool_shed_url: https://toolshed.g2.bx.psu.edu/\n- name: collapse_collections\n  owner: nml\n  revisions: 90981f86000f\n  tool_panel_section_label: Collection Operations\n  tool_shed_url: https://toolshed.g2.bx.psu.edu/\n- name: mafft\n  owner: rnateam\n  revisions: bf28a8cff401\n  tool_panel_section_label: Multiple Alignments\n  tool_shed_url: https://toolshed.g2.bx.psu.edu/\n","tours":false,"video":false,"slides_recordings":false,"translations":{"tutorial":[],"slides":[],"video":false},"license":"CC-BY-4.0","type":"tutorial"}