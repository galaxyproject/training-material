{"layout":"tutorial_hands_on","title":"Ansible","zenodo_link":"","questions":["Why Ansible?","How and when to use Ansible?","How to write a role?","How to leverage community build roles?"],"objectives":["Learn Ansible basics","Write a simple role","Install a role from Ansible Galaxy (repository unrelated to the Galaxy Project)"],"time_estimation":"60m","key_points":["Ansible lets you do system administration at scale","Many system administration, software installation, and software management tasks are already available as Ansible tasks or roles"],"contributions":{"authorship":["hexylena","shiltemann"],"testing":["vladvisan"]},"subtopic":"core","tags":["ansible"],"recordings":[{"captioners":["martenson"],"date":"2021-02-15","galaxy_version":"21.01","length":"61M","youtube_id":"2KdT0sYKUeE","speakers":["martenson"]}],"js_requirements":{"mathjax":null,"mermaid":false},"short_id":"T00000","url":"/topics/admin/tutorials/ansible/tutorial.html","topic_name":"admin","tutorial_name":"ansible","dir":"topics/admin/tutorials/ansible","symlink":null,"id":"admin/ansible","ref_tutorials":["<h1 id=\"overview\">Overview</h1>\n\n<p>In this tutorial we will briefly cover what Ansible is and how to understand what it does. This guide is not meant to make you an expert on Ansible, but perhaps give you enough that you can debug broken roles and modify them to suit your needs. Maybe even <a href=\"/training-material/topics/admin/tutorials/ansible-galaxy/tutorial.html\">install Galaxy using Ansible</a> or contribute to the <a href=\"https://github.com/galaxyproject?q=ansible\">Galaxy Project‚Äôs Ansible roles</a>.</p>\n\n<p>This will be a very practical training with emphasis on looking at examples from modules and becoming self sufficient.</p>\n\n<blockquote class=\"agenda\">\n  <agenda-title></agenda-title>\n\n<ol id=\"markdown-toc\">\n  <li><a href=\"#overview\" id=\"markdown-toc-overview\">Overview</a></li>\n  <li><a href=\"#what-is-ansible\" id=\"markdown-toc-what-is-ansible\">What is Ansible?</a>    <ol>\n      <li><a href=\"#inventory-file\" id=\"markdown-toc-inventory-file\">Inventory file</a></li>\n      <li><a href=\"#roles\" id=\"markdown-toc-roles\">Roles</a></li>\n      <li><a href=\"#modules-and-tasks\" id=\"markdown-toc-modules-and-tasks\">Modules and Tasks</a></li>\n      <li><a href=\"#playbooks\" id=\"markdown-toc-playbooks\">Playbooks</a></li>\n      <li><a href=\"#variables\" id=\"markdown-toc-variables\">Variables</a></li>\n      <li><a href=\"#vaults\" id=\"markdown-toc-vaults\">Vaults</a></li>\n    </ol>\n  </li>\n  <li><a href=\"#your-first-playbook-and-first-role\" id=\"markdown-toc-your-first-playbook-and-first-role\">Your First Playbook and First Role</a>    <ol>\n      <li><a href=\"#a-basic-role\" id=\"markdown-toc-a-basic-role\">A Basic Role</a></li>\n      <li><a href=\"#facts\" id=\"markdown-toc-facts\">Facts</a></li>\n      <li><a href=\"#templates\" id=\"markdown-toc-templates\">Templates</a></li>\n    </ol>\n  </li>\n  <li><a href=\"#ansible-galaxy\" id=\"markdown-toc-ansible-galaxy\">Ansible Galaxy</a>    <ol>\n      <li><a href=\"#choosing-a-role\" id=\"markdown-toc-choosing-a-role\">Choosing a Role</a></li>\n    </ol>\n  </li>\n  <li><a href=\"#ansible-vault\" id=\"markdown-toc-ansible-vault\">Ansible Vault</a></li>\n  <li><a href=\"#other-stuff\" id=\"markdown-toc-other-stuff\">Other Stuff</a>    <ol>\n      <li><a href=\"#with-items\" id=\"markdown-toc-with-items\">With Items</a></li>\n      <li><a href=\"#when-changed\" id=\"markdown-toc-when-changed\">When Changed</a></li>\n      <li><a href=\"#notifying-handlers\" id=\"markdown-toc-notifying-handlers\">Notifying Handlers</a></li>\n    </ol>\n  </li>\n</ol>\n\n</blockquote>\n\n<!--SNIPPET-->\n<blockquote class=\"tip\">   <div class=\"box-title tip-title\" id=\"tip-operating-system-compatibility\"><button class=\"gtn-boxify-button tip\" type=\"button\" aria-controls=\"tip-operating-system-compatibility\" aria-expanded=\"true\"><i class=\"far fa-lightbulb\" aria-hidden=\"true\"></i> <span>Tip: Operating system compatibility</span><span class=\"fold-unfold fa fa-minus-square\"></span></button></div>   <p>These Ansible roles and training materials were last tested on Centos 7 and Ubuntu 18.04, but will probably work on other RHEL and Debian variants.</p>   <p>The roles that are used in these training are currently used by <code class=\"language-plaintext highlighter-rouge\">usegalaxy.*</code>, and other, servers in maintaining their infrastructure. (<a href=\"https://github.com/galaxyproject/infrastructure-playbook/\">US</a>, <a href=\"https://github.com/usegalaxy-eu/infrastructure-playbook\">EU</a>, both are running CentOS 7)</p>   <p>If you have an issue running these trainings on your OS flavour, please report <a href=\"https://github.com/galaxyproject/training-material/issues/new\">the issue</a> in the training material and we can see if it is possible to solve.</p> </blockquote>\n<p><!--END_SNIPPET--></p>\n\n<h1 id=\"what-is-ansible\">What is Ansible?</h1>\n\n<p>Ansible runs commands on local or remote computers. It can move files around, create files from templates, and run command line tools. Primarily used for system administration tasks at scale. It has a push model rather than a pull model like Puppet. If you‚Äôve used Puppet, Ansible doesn‚Äôt evaluate what changes need to be made and make those, it just runs through all of commands every time.</p>\n\n<p>Some terms that you should know first:</p>\n\n<dl>\n  <dt>Inventory file</dt>\n  <dd>An Ansible-specific file that defines the systems (‚Äúhosts‚Äù) and groups of hosts on which Ansible should operate.</dd>\n  <dt>Ansible module</dt>\n  <dd>A piece of Python code that converts some parameters into an invocation. An example would be the <code class=\"language-plaintext highlighter-rouge\">command</code> module which converts parameters like <code class=\"language-plaintext highlighter-rouge\">command: ls</code> into a command line that is executed. There are pre-built modules for just about everything.</dd>\n  <dt>Task</dt>\n  <dd>A call to an Ansible module that should be executed and the configuration for this module.</dd>\n  <dt>Role</dt>\n  <dd>A folder containing some tasks, templates, files, and default values for variables, with a predefined directory structure. People share roles on <a href=\"https://galaxy.ansible.com/\">‚ÄúAnsible Galaxy‚Äù</a> (repository unrelated to the Galaxy Project).</dd>\n  <dt>Playbook</dt>\n  <dd>A YAML file listing a set of tasks and/or roles that should be applied to a group of hosts.</dd>\n  <dt>Vault</dt>\n  <dd>An encrypted YAML file. You put your secrets here and then you can use them in tasks, roles and playbooks.</dd>\n</dl>\n\n<p>Looking at each of these briefly:</p>\n\n<h2 id=\"inventory-file\">Inventory file</h2>\n\n<div class=\"language-ini highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"nn\">[webservers]</span>\n<span class=\"err\">192.0.2.0</span>\n<span class=\"err\">192.0.2.1</span>\n\n<span class=\"nn\">[databases]</span>\n<span class=\"err\">192.0.2.3</span> <span class=\"py\">ansible_user</span><span class=\"p\">=</span><span class=\"s\">root</span>\n</code></pre></div></div>\n\n<p>Here we‚Äôve defined two groups of computers, <code class=\"language-plaintext highlighter-rouge\">webservers</code> and <code class=\"language-plaintext highlighter-rouge\">databases</code>. <code class=\"language-plaintext highlighter-rouge\">ansible_user</code> is used to\nspecify which user to connect with (you need to specify that if you SSH in with a username different\nthan your current local user account‚Äôs name).</p>\n\n<p>As you can see, in this inventory we connect to multiple remote machines. This is common practice;\nAnsible playbooks are stored on your laptop or a build server, and from there Ansible connects out to the\nremote machines that are managed. The advantage of running remotely is that you can manage dozens of\nmachines simultaneously, rather than just the local machine. This scaling out to N machines is one of\nthe strengths of Ansible.</p>\n\n<p>Additionally, playbooks are often stored in Git or other version control repositories to ensure that\nif anything happens to the infrastructure you manage, you‚Äôll still have a copy of the information\nrequired to rebuild everything with Ansible.</p>\n\n<blockquote class=\"details\">\n  <details-title>Ansible Inventory Documentation (Do you connect with a different user? Password? SSH key?)</details-title>\n  <p>For more advanced features of the inventory file, check out <a href=\"https://docs.ansible.com/ansible/2.9/user_guide/intro_inventory.html\">the official documentation on this topic</a>.</p>\n</blockquote>\n\n<h2 id=\"roles\">Roles</h2>\n\n<p>We can look at the <a href=\"https://github.com/galaxyproject/ansible-cvmfs\">ansible-cvmfs role</a> as an example for the layout of a role:</p>\n\n<div class=\"language-plaintext highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>‚îú‚îÄ‚îÄ defaults\n‚îÇ   ‚îî‚îÄ‚îÄ main.yml\n‚îú‚îÄ‚îÄ files\n‚îÇ   ‚îú‚îÄ‚îÄ cvmfs_remount_sync.c\n‚îÇ   ‚îú‚îÄ‚îÄ cvmfs_remount_sync.centos_6\n‚îÇ   ‚îú‚îÄ‚îÄ cvmfs_remount_sync.centos_7\n‚îÇ   ‚îî‚îÄ‚îÄ ...\n‚îú‚îÄ‚îÄ handlers\n‚îÇ   ‚îî‚îÄ‚îÄ main.yml\n‚îú‚îÄ‚îÄ meta\n‚îÇ   ‚îî‚îÄ‚îÄ main.yml\n‚îú‚îÄ‚îÄ tasks\n‚îÇ   ‚îú‚îÄ‚îÄ apache.yml\n‚îÇ   ‚îú‚îÄ‚îÄ ...\n‚îÇ   ‚îú‚îÄ‚îÄ main.yml\n‚îÇ   ‚îî‚îÄ‚îÄ ...\n‚îú‚îÄ‚îÄ templates\n‚îÇ   ‚îú‚îÄ‚îÄ ...\n‚îÇ   ‚îî‚îÄ‚îÄ stratum1_squid.conf.j2\n‚îî‚îÄ‚îÄ vars\n    ‚îú‚îÄ‚îÄ ...\n    ‚îú‚îÄ‚îÄ main.yml\n    ‚îî‚îÄ‚îÄ ...\n</code></pre></div></div>\n\n<p>These are the folders that are included in many complex roles. Simpler roles will often not need all of the folders.</p>\n\n<table>\n  <thead>\n    <tr>\n      <th>Folder</th>\n      <th>Usage</th>\n    </tr>\n  </thead>\n  <tbody>\n    <tr>\n      <td>defaults</td>\n      <td>Default values for variables the user can set (e.g. ‚Äúversion of software to install‚Äù).</td>\n    </tr>\n    <tr>\n      <td>files</td>\n      <td>These are files which should be copied as-is over to the remote location.</td>\n    </tr>\n    <tr>\n      <td>handlers</td>\n      <td>This is typically used for restarting processes.</td>\n    </tr>\n    <tr>\n      <td>meta</td>\n      <td>Only needed to publish your role to Ansible Galaxy (repository unrelated to the Galaxy Project).</td>\n    </tr>\n    <tr>\n      <td>tasks</td>\n      <td><strong>Always start reading here</strong>. This is the most important folder and the best place to start when trying to understand what an unfamiliar role does. Anything that is loaded will be referenced here (e.g. variables to load, handlers, files, templates).</td>\n    </tr>\n    <tr>\n      <td>templates</td>\n      <td>Files that are templated out with variables before being copied.</td>\n    </tr>\n    <tr>\n      <td>vars</td>\n      <td>Default values for variables the user should normally not change (e.g. name of a package in different Linux distributions).</td>\n    </tr>\n  </tbody>\n</table>\n\n<blockquote class=\"details\">\n  <details-title>Ansible Role Documentation</details-title>\n\n  <p>For more information check out <a href=\"https://docs.ansible.com/ansible/2.9/user_guide/playbooks_reuse_roles.html\">the official documentation on this topic</a>.</p>\n</blockquote>\n\n<h2 id=\"modules-and-tasks\">Modules and Tasks</h2>\n\n<p>A <code class=\"language-plaintext highlighter-rouge\">tasks/main.yml</code> file calls multiple Ansible modules to accomplish its goal. A typical tasks file looks like:</p>\n\n<div class=\"language-yaml highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"nn\">---</span>\n<span class=\"pi\">-</span> <span class=\"na\">name</span><span class=\"pi\">:</span> <span class=\"s\">Download cvmfs_preload utility when desired</span>\n  <span class=\"na\">get_url</span><span class=\"pi\">:</span>\n    <span class=\"na\">url</span><span class=\"pi\">:</span> <span class=\"s\">https://cvmrepo.web.cern.ch/cvmrepo/preload/cvmfs_preload</span>\n    <span class=\"na\">dest</span><span class=\"pi\">:</span> <span class=\"s2\">\"</span><span class=\"s\">{{</span><span class=\"nv\"> </span><span class=\"s\">cvmfs_preload_path</span><span class=\"nv\"> </span><span class=\"s\">}}/cvmfs_preload\"</span>\n    <span class=\"na\">owner</span><span class=\"pi\">:</span> <span class=\"s\">root</span>\n    <span class=\"na\">group</span><span class=\"pi\">:</span> <span class=\"s\">root</span>\n    <span class=\"na\">mode</span><span class=\"pi\">:</span> <span class=\"m\">755</span>\n  <span class=\"na\">when</span><span class=\"pi\">:</span> <span class=\"s\">cvmfs_preload_install | bool</span>\n\n<span class=\"pi\">-</span> <span class=\"na\">name</span><span class=\"pi\">:</span> <span class=\"s\">Ensure AutoFS is enabled + running</span>\n  <span class=\"na\">service</span><span class=\"pi\">:</span>\n    <span class=\"na\">name</span><span class=\"pi\">:</span> <span class=\"s\">autofs</span>\n    <span class=\"na\">enabled</span><span class=\"pi\">:</span> <span class=\"s\">yes</span>\n    <span class=\"na\">state</span><span class=\"pi\">:</span> <span class=\"s\">started</span>\n</code></pre></div></div>\n\n<p>Here we have two tasks. Each has a <code class=\"language-plaintext highlighter-rouge\">name</code> that will be shown to the person running the playbook.</p>\n\n<p>The first example invokes the <a href=\"https://docs.ansible.com/ansible/2.9/modules/get_url_module.html\"><code class=\"language-plaintext highlighter-rouge\">get_url</code></a> module with 5 arguments (<code class=\"language-plaintext highlighter-rouge\">url</code>, <code class=\"language-plaintext highlighter-rouge\">dest</code>, <code class=\"language-plaintext highlighter-rouge\">owner</code>, <code class=\"language-plaintext highlighter-rouge\">group</code> and <code class=\"language-plaintext highlighter-rouge\">mode</code>). This will download a file from the location indicated in <code class=\"language-plaintext highlighter-rouge\">url</code> to the directory specified by <code class=\"language-plaintext highlighter-rouge\">dest</code>, change user and group ownerships to <code class=\"language-plaintext highlighter-rouge\">root</code>, and change file permissions to <code class=\"language-plaintext highlighter-rouge\">755</code> (as assigned by the <code class=\"language-plaintext highlighter-rouge\">mode</code> argument). The <code class=\"language-plaintext highlighter-rouge\">dest</code> parameter uses a <a href=\"http://jinja.pocoo.org/\">Jinja2</a> template to evaluate the value of the variable <code class=\"language-plaintext highlighter-rouge\">cvmfs_preload_path</code>. We can <a href=\"https://github.com/galaxyproject/ansible-cvmfs/search?q=cvmfs_preload_path\">grep through</a> the repository and see that <code class=\"language-plaintext highlighter-rouge\">defaults/main.yml</code> sets that to <code class=\"language-plaintext highlighter-rouge\">/usr/bin</code> by default. We can override this if we need, we‚Äôll come back to that later. The first task also has a <code class=\"language-plaintext highlighter-rouge\">when</code> condition to ensure it only runs when the <code class=\"language-plaintext highlighter-rouge\">cvmfs_preload_install</code> variable is set.</p>\n\n<p>The second invokes the <a href=\"https://docs.ansible.com/ansible/2.9/modules/service_module.html\"><code class=\"language-plaintext highlighter-rouge\">service</code></a> module. The arguments to this one are quite legible and the functionality can be inferred from the names for the most part: The service <code class=\"language-plaintext highlighter-rouge\">name: autofs</code> will be <code class=\"language-plaintext highlighter-rouge\">enabled</code> and its <code class=\"language-plaintext highlighter-rouge\">state</code> should be <code class=\"language-plaintext highlighter-rouge\">started</code>.</p>\n\n<p><a href=\"https://docs.ansible.com/ansible/2.9/modules/modules_by_category.html\">Many modules</a> are available for you to use.</p>\n\n<h3 id=\"stylistic-choices\">Stylistic Choices</h3>\n\n<p>Ansible accepts two ways to format tasks:</p>\n\n<p>YAML style:</p>\n\n<div class=\"language-yaml highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"pi\">-</span> <span class=\"na\">package</span><span class=\"pi\">:</span>\n    <span class=\"na\">name</span><span class=\"pi\">:</span> <span class=\"s2\">\"</span><span class=\"s\">{{</span><span class=\"nv\"> </span><span class=\"s\">package_name</span><span class=\"nv\"> </span><span class=\"s\">}}\"</span>\n    <span class=\"na\">state</span><span class=\"pi\">:</span> <span class=\"s2\">\"</span><span class=\"s\">{{</span><span class=\"nv\"> </span><span class=\"s\">package_state</span><span class=\"nv\"> </span><span class=\"s\">}}\"</span>\n</code></pre></div></div>\n\n<p>And an inline style.</p>\n\n<div class=\"language-yaml highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"pi\">-</span> <span class=\"s\">package name={{ package_name }} state={{ package_state }}</span>\n</code></pre></div></div>\n\n<p>Some groups prefer one style or another. You can mix both of these but you probably shouldn‚Äôt. In the YAML style the templated value needs to be quoted if the value after the colon starts with a <code class=\"language-plaintext highlighter-rouge\">{</code> (see <a href=\"https://docs.ansible.com/ansible/9/playbook_guide/playbooks_variables.html#when-to-quote-variables-a-yaml-gotcha\">this page</a> for more details ). The inline style does not require quoting of templated values.</p>\n\n<h2 id=\"playbooks\">Playbooks</h2>\n\n<div class=\"language-yaml highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"pi\">-</span> <span class=\"na\">name</span><span class=\"pi\">:</span> <span class=\"s\">CVMFS</span>\n  <span class=\"na\">hosts</span><span class=\"pi\">:</span> <span class=\"s\">webservers</span>\n  <span class=\"na\">vars</span><span class=\"pi\">:</span>\n    <span class=\"na\">cvmfs_numfiles</span><span class=\"pi\">:</span> <span class=\"m\">4096</span>\n  <span class=\"na\">roles</span><span class=\"pi\">:</span>\n    <span class=\"pi\">-</span> <span class=\"s\">galaxyproject.cvmfs</span>\n</code></pre></div></div>\n\n<p>This is a quite minimal playbook. It selects a <code class=\"language-plaintext highlighter-rouge\">hosts</code> group named <code class=\"language-plaintext highlighter-rouge\">webservers</code>, overrides the variable <code class=\"language-plaintext highlighter-rouge\">cvmfs_numfiles</code>, and then says the following set of roles will be executed for this group of hosts. Ansible makes it easy to collect tasks that should apply to a group of hosts and run a playbook for all of those hosts. Some good uses of this are things like ensuring a certain set of users are installed on all of your managed machines, or using one of the package autoupdating roles to make sure your machines are up-to-date.</p>\n\n<blockquote class=\"details\">\n  <details-title>Ansible Playbook Documentation</details-title>\n\n  <p>For more information check out <a href=\"https://docs.ansible.com/ansible/2.9/user_guide/playbooks_intro.html\">the official documentation on this topic</a>.</p>\n</blockquote>\n\n<h3 id=\"philosophies\">Philosophies</h3>\n\n<p>Different groups use playbooks differently. Here is a non-exhaustive list of ways that the author has seen playbooks used:</p>\n\n<table>\n  <thead>\n    <tr>\n      <th>Strategy</th>\n      <th>Use Cases</th>\n    </tr>\n  </thead>\n  <tbody>\n    <tr>\n      <td>A single playbook that does everything</td>\n      <td>Works well in cloud use cases where you would rather terminate a VM and just restart from nothing. If 100% of the tasks are idempotent (can be re-run without causing problems) then this can also work well for ensuring all machines that are managed are meeting your compliance standards.</td>\n    </tr>\n    <tr>\n      <td>Playbooks that execute one-off commands</td>\n      <td>Works well when you have commands that cannot safely be re-run (e.g. you are managing a repository on a remote machine and executing a ‚Äòcommit‚Äô action.) Also works if you have multiple people who are responsible for managing a machine but you want to ensure exactly the same commands are run each time a task needs to be done, with no variation.</td>\n    </tr>\n  </tbody>\n</table>\n\n<h2 id=\"variables\">Variables</h2>\n\n<p>There are a bunch of places variables can be set. <a href=\"https://docs.ansible.com/ansible/2.9/user_guide/playbooks_variables.html#variable-precedence-where-should-i-put-a-variable\">The list is ridiculous.</a> Try and find a convention within your group and stick to that to help manage the chaos.</p>\n\n<p>There are some special places you can put variables that will be loaded automatically:</p>\n\n<ul>\n  <li><code class=\"language-plaintext highlighter-rouge\">group_vars/&lt;group_name&gt;.yml</code>: if you run a playbook which has <code class=\"language-plaintext highlighter-rouge\">hosts: webservers</code>, and <code class=\"language-plaintext highlighter-rouge\">group_vars/webservers.yml</code> exists, it will be loaded.</li>\n  <li><code class=\"language-plaintext highlighter-rouge\">host_vars/&lt;host_name&gt;.yml</code>: if you run a playbook and it affects host (e.g.) <code class=\"language-plaintext highlighter-rouge\">api01</code>, and <code class=\"language-plaintext highlighter-rouge\">host_vars/api01.yml</code> exists, it will be loaded automatically.</li>\n</ul>\n\n<p>For a real-life example, UseGalaxy.eu <a href=\"https://github.com/usegalaxy-eu/infrastructure-playbook\">generally attempts</a> to put variables in an appropriately named <code class=\"language-plaintext highlighter-rouge\">group_vars/</code> file.</p>\n\n<h2 id=\"vaults\">Vaults</h2>\n\n<p><a href=\"https://docs.ansible.com/ansible/2.9/user_guide/vault.html\"><code class=\"language-plaintext highlighter-rouge\">ansible-vault</code></a> is a super useful tool that lets you encrypt secrets for your group using a pre-shared key. This allows you to commit ALL of your Ansible playbooks and variables to source control, without the concern of leaking secrets. E.g. <a href=\"https://github.com/usegalaxy-eu/infrastructure-playbook/blob/master/secret_group_vars/all.yml\">UseGalaxy.eu</a>‚Äôs vault file. The encrypted version is not very interesting to look at, but it is mostly to show that we confidently place an encrypted copy of our secrets online, under configuration management. This has made our life a lot easier.</p>\n\n<h1 id=\"your-first-playbook-and-first-role\">Your First Playbook and First Role</h1>\n\n<p>The above introduction was certainly not enough for you to feel confident in Ansible, so we will now build a small role and a playbook to run this role.</p>\n\n<blockquote class=\"warning\">\n  <warning-title>Safety First</warning-title>\n\n  <p>Many of the things you can do with Ansible can be quite dangerous. As dangerous as normally being at the command line, but scaled across N machines. Be very careful with the changes you plan to make.\nAnsible provides some flags which can help you identify changes before they‚Äôre made to production systems:</p>\n\n  <dl>\n    <dt><strong><code class=\"language-plaintext highlighter-rouge\">--diff</code></strong></dt>\n    <dd>This will show the difference whenever a file is changed.</dd>\n    <dt><strong><code class=\"language-plaintext highlighter-rouge\">--check</code></strong></dt>\n    <dd>Will do a dry-run of the playbook, attempting to show you which tasks will execute, which files will be updated. Not all actions can be predicted because commands are not run, if a downstream task depends on the result of a command execution task, Ansible has no way of knowing whether or not it will execute.</dd>\n  </dl>\n\n  <p>In this tutorial we will write to files in <code class=\"language-plaintext highlighter-rouge\">/tmp</code> as that is a <em>relatively</em> safe thing to do. The training material community does not have the resources to test this tutorial across all of the platforms you might want to run it on. Additionally we do not want to be responsible if you accidentally cause permanent damage by following this tutorial.</p>\n\n</blockquote>\n\n<blockquote class=\"comment\">\n  <comment-title>Requirements for Running This Tutorial</comment-title>\n\n  <ol>\n    <li>\n      <p>You have <a href=\"https://docs.ansible.com/ansible/2.9/installation_guide/intro_installation.html\">Ansible installed</a> on the machine you will run this tutorial from</p>\n\n      <blockquote class=\"comment\">\n        <comment-title>Running Ansible on remote machine</comment-title>\n        <p>It is possible to have Ansible installed on your laptop/local machine and run it against some remote hosts as well. We will <strong>not</strong> do that in this training.</p>\n      </blockquote>\n    </li>\n    <li>\n      <p>Your <code class=\"language-plaintext highlighter-rouge\">ansible</code> version is <code class=\"language-plaintext highlighter-rouge\">&gt;=2.7</code>, you can check this by running <code class=\"language-plaintext highlighter-rouge\">ansible --version</code></p>\n    </li>\n  </ol>\n\n</blockquote>\n\n<h2 id=\"a-basic-role\">A Basic Role</h2>\n\n<blockquote class=\"hands_on\">\n  <hands-on-title>Setting up our workspace</hands-on-title>\n\n  <ol>\n    <li>\n      <p>In this training we will run Ansible on the machine it will modify. This is not best practice, but it is convenient for trainings. You should probably run this in a VM either on the Cloud or in VirtualBox or similar</p>\n\n      <p>All of the steps are the same, no matter which machine Ansible will manage and where you run it. The only difference is the connection setup</p>\n    </li>\n    <li>\n      <p><strong>Create a directory named <code class=\"language-plaintext highlighter-rouge\">intro</code> and <code class=\"language-plaintext highlighter-rouge\">cd</code> into it.</strong></p>\n\n      <p>It‚Äôs good practice to keep your deployments separated.</p>\n    </li>\n    <li>\n      <p>Create your inventory file (named <code class=\"language-plaintext highlighter-rouge\">hosts</code>) in this folder</p>\n\n      <ol>\n        <li>\n          <p>We will call our group <code class=\"language-plaintext highlighter-rouge\">my_hosts</code></p>\n        </li>\n        <li>\n          <p>Create <a href=\"https://docs.ansible.com/ansible/2.9/user_guide/intro_inventory.html\">an inventory file</a> with the group <code class=\"language-plaintext highlighter-rouge\">my_hosts</code> and <code class=\"language-plaintext highlighter-rouge\">localhost ansible_connection=local</code>, which tells Ansible to not use SSH, and just use the local connection. Additionally, you should explicitly set the <code class=\"language-plaintext highlighter-rouge\">ansible_user</code> variable to the username to use when connecting to the server. Ansible has changed its behaviour over time regarding whether or not <code class=\"language-plaintext highlighter-rouge\">ansible_user</code> is defined, and it is most effective to define it explicitly even when it can sometimes be inferred.</p>\n\n          <blockquote class=\"solution\">\n            <solution-title></solution-title>\n            <p>The file should look like:</p>\n\n            <div class=\"language-ini highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"nn\">[my_hosts]</span>\n<span class=\"err\">localhost</span> <span class=\"py\">ansible_connection</span><span class=\"p\">=</span><span class=\"s\">local ansible_user=ubuntu</span>\n</code></pre></div>            </div>\n          </blockquote>\n\n          <blockquote class=\"details\">\n            <details-title>For your own infrastructure, do you connect as a different user? Password? SSH key?</details-title>\n            <p>For more advanced features of the inventory file, check out <a href=\"https://docs.ansible.com/ansible/2.9/user_guide/intro_inventory.html\">the official documentation on this topic</a>.</p>\n          </blockquote>\n        </li>\n      </ol>\n    </li>\n    <li>\n      <p>Create the roles directory, your role, and the tasks folder: <code class=\"language-plaintext highlighter-rouge\">mkdir -p roles/my-role/tasks/</code></p>\n    </li>\n    <li>\n      <p>Create a YAML file in that directory, <code class=\"language-plaintext highlighter-rouge\">roles/my-role/tasks/main.yml</code> and open it for editing</p>\n    </li>\n    <li>\n      <p>Define a <code class=\"language-plaintext highlighter-rouge\">copy</code> task like below:</p>\n\n      <div class=\"language-yaml highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"nn\">---</span>\n<span class=\"pi\">-</span> <span class=\"na\">name</span><span class=\"pi\">:</span> <span class=\"s\">Copy a file to the remote host</span>\n  <span class=\"na\">copy</span><span class=\"pi\">:</span>\n    <span class=\"na\">src</span><span class=\"pi\">:</span> <span class=\"s\">test.txt</span>\n    <span class=\"na\">dest</span><span class=\"pi\">:</span> <span class=\"s\">/tmp/test.txt</span>\n</code></pre></div>      </div>\n\n      <p>You can read about all of the parameters available to the <a href=\"http://docs.ansible.com/ansible/2.9/modules/copy_module.html\"><code class=\"language-plaintext highlighter-rouge\">copy</code></a> module in Ansible‚Äôs documentation.</p>\n\n      <blockquote class=\"details\">\n        <details-title>Ansible Module Documentation</details-title>\n        <p>You can usually find a module for most commands you will run in a shell, e.g. by searching the internet for ‚Äúansible copy file to server‚Äù or ‚Äúansible restart service‚Äù. If you cannot find a module that does it, there is the <a href=\"http://docs.ansible.com/ansible/2.9/modules/command_module.html\"><code class=\"language-plaintext highlighter-rouge\">command</code></a> module, but this should be avoided if possible. Expect to have a browser session with 10-30 different Ansible module documentation tabs if you work with Ansible regularly, no one remembers what arguments are available to every module.</p>\n\n      </blockquote>\n    </li>\n    <li>\n      <p>Create a <code class=\"language-plaintext highlighter-rouge\">roles/my-role/files</code> folder, and within it a file named <code class=\"language-plaintext highlighter-rouge\">test.txt</code>, containing the content ‚ÄúHello, Galaxy üöÄ‚Äù</p>\n    </li>\n    <li>\n      <p>This is a complete role by itself and will copy the file <code class=\"language-plaintext highlighter-rouge\">test.txt</code> from the <code class=\"language-plaintext highlighter-rouge\">roles/my-role/files/</code> folder over to the target host and place it in <code class=\"language-plaintext highlighter-rouge\">/tmp</code>.</p>\n    </li>\n    <li>\n      <p>Create and open <code class=\"language-plaintext highlighter-rouge\">playbook.yml</code> file for editing in the <code class=\"language-plaintext highlighter-rouge\">intro</code> directory you created. Place the following content in there:</p>\n\n      <div class=\"language-yaml highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"nn\">---</span>\n<span class=\"pi\">-</span> <span class=\"na\">hosts</span><span class=\"pi\">:</span> <span class=\"s\">my_hosts</span>\n  <span class=\"na\">roles</span><span class=\"pi\">:</span>\n    <span class=\"pi\">-</span> <span class=\"s\">my-role</span>\n</code></pre></div>      </div>\n\n      <blockquote class=\"question\">\n        <question-title></question-title>\n\n        <p>How does your file tree look now? Use <code class=\"language-plaintext highlighter-rouge\">find</code> or <code class=\"language-plaintext highlighter-rouge\">tree</code>.</p>\n\n        <blockquote class=\"solution\">\n          <solution-title></solution-title>\n\n          <div class=\"language-plaintext highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>.\n‚îú‚îÄ‚îÄ hosts\n‚îú‚îÄ‚îÄ playbook.yml\n‚îî‚îÄ‚îÄ roles\n    ‚îî‚îÄ‚îÄ my-role\n        ‚îú‚îÄ‚îÄ files\n        ‚îÇ¬†¬† ‚îî‚îÄ‚îÄ test.txt\n        ‚îî‚îÄ‚îÄ tasks\n            ‚îî‚îÄ‚îÄ main.yml\n</code></pre></div>          </div>\n\n        </blockquote>\n      </blockquote>\n    </li>\n    <li>\n      <p>Run the playbook:</p>\n\n      <blockquote class=\"code-2col\">\n        <blockquote class=\"code-in\">\n          <code-in-title>Bash</code-in-title>\n          <div class=\"language-bash highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>ansible-playbook <span class=\"nt\">-i</span> hosts playbook.yml\n</code></pre></div>          </div>\n        </blockquote>\n\n        <blockquote class=\"code-out\">\n          <code-out-title>Bash</code-out-title>\n          <div class=\"language-plaintext highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>PLAY [my_hosts] ****************************************************************\nTASK [Gathering Facts] *********************************************************\nok: [localhost]\nTASK [my-role : Copy a file to the remote host] ********************************\nchanged: [localhost]\nPLAY RECAP *********************************************************************\nlocalhost                  : ok=2    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0\n</code></pre></div>          </div>\n        </blockquote>\n      </blockquote>\n    </li>\n    <li>\n      <p>Login to the appropriate host (unless your host was <code class=\"language-plaintext highlighter-rouge\">localhost</code>) and <code class=\"language-plaintext highlighter-rouge\">cat /tmp/test.txt</code> to see that the change was made.</p>\n    </li>\n  </ol>\n\n</blockquote>\n\n<p>Now that you‚Äôve done this, here are some starting points for exploration:</p>\n\n<ul>\n  <li>Add more hosts, watch as Ansible executes over all of them in parallel.</li>\n  <li>Identify a task you do regularly, e.g. restarting a service. Find the Ansible service module and add that to your playbook.</li>\n</ul>\n\n<blockquote class=\"comment\">\n  <comment-title>Too Many Cows?</comment-title>\n  <p>If you‚Äôve installed the <code class=\"language-plaintext highlighter-rouge\">cowsay</code> tool, Ansible (for some reason) will take advantage of that to output a lot of the output with cowsay. To disable this you can <code class=\"language-plaintext highlighter-rouge\">export ANSIBLE_NOCOWS=1</code> (Remember that exporting will only last as long as the current invocation of your terminal does, so consider adding this to your user profile if you wish to keep cowsay installed and still have legible output.)</p>\n\n  <div class=\"language-plaintext highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code> ________________\n&lt; PLAY [my_hosts] &gt;\n ----------------\n        \\   ^__^\n         \\  (oo)\\_______\n            (__)\\       )\\/\\\n                ||----w |\n                ||     ||\n ________________________\n&lt; TASK [Gathering Facts] &gt;\n ------------------------\n        \\   ^__^\n         \\  (oo)\\_______\n            (__)\\       )\\/\\\n                ||----w |\n                ||     ||\n</code></pre></div>  </div>\n</blockquote>\n\n<h2 id=\"facts\">Facts</h2>\n\n<p>In the last step of the last hands-on, you ran your playbook. The first <code class=\"language-plaintext highlighter-rouge\">TASK</code> that was executed was not one that you had written, it reads:</p>\n\n<div class=\"language-plaintext highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>TASK [Gathering Facts] *********************************************************\nok: [localhost]\n</code></pre></div></div>\n\n<p>The <a href=\"https://docs.ansible.com/ansible/2.9/modules/setup_module.html\"><code class=\"language-plaintext highlighter-rouge\">setup</code></a> module runs by default for every host and gathers facts about the host.</p>\n\n<blockquote class=\"hands_on\">\n  <hands-on-title>The Setup Module</hands-on-title>\n\n  <ol>\n    <li>\n      <p>Run the command <code class=\"language-plaintext highlighter-rouge\">ansible -i hosts -m setup my_hosts | less</code>.</p>\n\n      <p>The <code class=\"language-plaintext highlighter-rouge\">my_hosts</code> at the end of the command refers to the group we defined in our <code class=\"language-plaintext highlighter-rouge\">hosts</code> inventory file.</p>\n    </li>\n    <li>\n      <p>Investigate the output. See what sort of information is made available to you.</p>\n\n      <blockquote class=\"question\">\n        <question-title></question-title>\n\n        <ol>\n          <li>What variable stores the OS name?</li>\n          <li>Where are all of the places that you can find your machine‚Äôs IP (v4) addresses?</li>\n        </ol>\n\n        <blockquote class=\"solution\">\n          <solution-title></solution-title>\n\n          <ol>\n            <li>\n              <p>The OS name is stored in <code class=\"language-plaintext highlighter-rouge\">ansible_distribution</code>. We saw <code class=\"language-plaintext highlighter-rouge\">ansible_os_family</code> used above in the <code class=\"language-plaintext highlighter-rouge\">ansible-cvmfs</code> role. You can use these variables if you are writing a generic role but packages or commands are named different on different operating systems.</p>\n            </li>\n            <li>\n              <p>Ansible stores network information in quite a few places, sometimes one place is more convenient or more correct to use:</p>\n\n              <ul>\n                <li><code class=\"language-plaintext highlighter-rouge\">ansible_all_ipv4_addresses</code></li>\n                <li><code class=\"language-plaintext highlighter-rouge\">ansible_default_ipv4.address</code></li>\n                <li><code class=\"language-plaintext highlighter-rouge\">ansible_&lt;interface_name&gt;.ipv4</code></li>\n              </ul>\n            </li>\n          </ol>\n\n        </blockquote>\n\n      </blockquote>\n    </li>\n  </ol>\n\n</blockquote>\n\n<h2 id=\"templates\">Templates</h2>\n\n<p>Templates give you greater control over the files you are deploying to the target system. If you need to deploy a file to multiple hosts, but configure it differently on each host, you should use templates. For instance, deploying a service that should only listen on the correct IP address for that host would be a good use case for templates. All of the facts you discovered in the previous hands-on are available to you to use in templates, <code class=\"language-plaintext highlighter-rouge\">when</code> statements (like the <a href=\"#modules-and-tasks\">ansible-cvmfs example we saw earlier</a>). Additionally all of the variables you‚Äôve defined are available as well.</p>\n\n<blockquote class=\"details\">\n  <details-title>Template Syntax</details-title>\n  <p>Templates end with the <code class=\"language-plaintext highlighter-rouge\">.j2</code> suffix and use Jinja2 syntax. If you are not familiar with it, you should <a href=\"http://jinja.pocoo.org/docs/2.10/templates/\">read about it</a> first, before moving on with the tutorial. Ansible fills the templates with variable values and copies the file to its remote destination without the <code class=\"language-plaintext highlighter-rouge\">.j2</code> suffix.</p>\n</blockquote>\n\n<blockquote class=\"hands_on\">\n  <hands-on-title>Variables and Templates</hands-on-title>\n\n  <ol>\n    <li>\n      <p>Create the directories: <code class=\"language-plaintext highlighter-rouge\">roles/my-role/templates</code>, <code class=\"language-plaintext highlighter-rouge\">roles/my-role/defaults</code></p>\n    </li>\n    <li>\n      <p>Create and edit a file for your role‚Äôs variables, <code class=\"language-plaintext highlighter-rouge\">roles/my-role/defaults/main.yml</code></p>\n    </li>\n    <li>\n      <p>Insert the following content:</p>\n\n      <div class=\"language-yaml highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"nn\">---</span>\n<span class=\"na\">server_name</span><span class=\"pi\">:</span> <span class=\"s\">Cats!</span>\n</code></pre></div>      </div>\n\n      <p>This will define a variable <code class=\"language-plaintext highlighter-rouge\">server_name</code> that can then be used in templates.</p>\n    </li>\n    <li>\n      <p>Create and edit <code class=\"language-plaintext highlighter-rouge\">roles/my-role/templates/test.ini.j2</code></p>\n    </li>\n    <li>\n      <p>Insert the following content:</p>\n\n      <div class=\"language-ini highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"nn\">[example]</span>\n<span class=\"py\">server_name</span> <span class=\"p\">=</span> <span class=\"s\">{{ server_name }}</span>\n<span class=\"py\">listen</span> <span class=\"p\">=</span> <span class=\"s\">{{ ansible_default_ipv4.address }}</span>\n</code></pre></div>      </div>\n    </li>\n    <li>\n      <p>Edit <code class=\"language-plaintext highlighter-rouge\">roles/my-role/tasks/main.yml</code> and append a new task to the end to template this file:</p>\n\n      <div class=\"language-yaml highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"pi\">-</span> <span class=\"na\">name</span><span class=\"pi\">:</span> <span class=\"s\">Template the configuration file</span>\n  <span class=\"na\">template</span><span class=\"pi\">:</span>\n    <span class=\"na\">src</span><span class=\"pi\">:</span> <span class=\"s\">test.ini.j2</span>\n    <span class=\"na\">dest</span><span class=\"pi\">:</span> <span class=\"s\">/tmp/test.ini</span>\n</code></pre></div>      </div>\n    </li>\n    <li>\n      <p>Run the playbook again.</p>\n    </li>\n    <li>\n      <p>Check the contents of <code class=\"language-plaintext highlighter-rouge\">/tmp/test.ini</code></p>\n\n      <blockquote class=\"code-2col\">\n        <blockquote class=\"code-in\">\n          <code-in-title>Bash</code-in-title>\n          <div class=\"language-bash highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"nb\">cat</span> /tmp/test.ini\n</code></pre></div>          </div>\n        </blockquote>\n\n        <blockquote class=\"code-out\">\n          <code-out-title></code-out-title>\n\n          <p>The file should look like:</p>\n          <div class=\"language-plaintext highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>[example]\nserver_name = Cats!\nlisten = 192.168.0.2\n</code></pre></div>          </div>\n          <p>Where the last line has the machine‚Äôs IP address.</p>\n        </blockquote>\n      </blockquote>\n\n      <p>Now that this has worked successfully, we will setup a <code class=\"language-plaintext highlighter-rouge\">group_vars</code> folder\nto show how a person using <code class=\"language-plaintext highlighter-rouge\">my-role</code> would override the <code class=\"language-plaintext highlighter-rouge\">server_name</code> variable.</p>\n    </li>\n    <li>\n      <p>Create the folder <code class=\"language-plaintext highlighter-rouge\">group_vars/</code> (in the root of your directory)</p>\n    </li>\n    <li>\n      <p>Create and edit <code class=\"language-plaintext highlighter-rouge\">group_vars/my_hosts.yml</code></p>\n    </li>\n    <li>\n      <p>Insert the following:</p>\n\n      <div class=\"language-yaml highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"nn\">---</span>\n<span class=\"na\">server_name</span><span class=\"pi\">:</span> <span class=\"s\">Dogs!</span>\n</code></pre></div>      </div>\n\n      <!--SNIPPET-->\n      <blockquote class=\"tip\">   <div class=\"box-title tip-title\" id=\"tip-variable-connection\"><button class=\"gtn-boxify-button tip\" type=\"button\" aria-controls=\"tip-variable-connection\" aria-expanded=\"true\"><i class=\"far fa-lightbulb\" aria-hidden=\"true\"></i> <span>Tip: Variable connection</span><span class=\"fold-unfold fa fa-minus-square\"></span></button></div>   <p>When the playbook runs, as part of the setup, it collects any variables that are set. For a playbook affecting a group of hosts named <code class=\"language-plaintext highlighter-rouge\">my_hosts</code>, it checks many different places for variables, including ‚Äúgroup_vars/my_hosts.yml‚Äù. If there are variables there, they‚Äôre added to the collection of current variables. It also checks ‚Äúgroup_vars/all.yml‚Äù (for the built-in host group <code class=\"language-plaintext highlighter-rouge\">all</code>). There is a precedence order, but then these variables are available for roles and tasks to consume.</p> </blockquote>\n      <p><!--END_SNIPPET--></p>\n    </li>\n    <li>\n      <p>Run the playbook again, but imagine you are worried about this change, and supply the <code class=\"language-plaintext highlighter-rouge\">--check --diff</code> flag to see what changes are made before committing to make them.</p>\n\n      <blockquote class=\"code-in\">\n        <code-in-title>Bash</code-in-title>\n        <div class=\"language-bash highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>ansible-playbook <span class=\"nt\">-i</span> hosts playbook.yml <span class=\"nt\">--check</span> <span class=\"nt\">--diff</span>\n</code></pre></div>        </div>\n      </blockquote>\n\n      <!--SNIPPET-->\n      <blockquote class=\"tip\">   <div class=\"box-title tip-title\" id=\"tip-what-if-you-forget-diff\"><button class=\"gtn-boxify-button tip\" type=\"button\" aria-controls=\"tip-what-if-you-forget-diff\" aria-expanded=\"true\"><i class=\"far fa-lightbulb\" aria-hidden=\"true\"></i> <span>Tip: What if you forget `--diff`?</span><span class=\"fold-unfold fa fa-minus-square\"></span></button></div>   <p>If you forget to use <code class=\"language-plaintext highlighter-rouge\">--diff</code>, it is not easy to see what has changed. Some modules like the <code class=\"language-plaintext highlighter-rouge\">copy</code> and <code class=\"language-plaintext highlighter-rouge\">template</code> modules have a <code class=\"language-plaintext highlighter-rouge\">backup</code> option. If you set this option, then it will keep a backup copy next to the destination file.</p>   <p>However, most modules do not have such an option, so if you want to know what changes, always use <code class=\"language-plaintext highlighter-rouge\">--diff</code>.</p> </blockquote>\n      <p><!--END_SNIPPET--></p>\n\n      <blockquote class=\"code-out\">\n        <code-out-title></code-out-title>\n\n        <div class=\"language-plaintext highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>PLAY [my_hosts] ****************************************************************\nTASK [Gathering Facts] *********************************************************\nok: [localhost]\nTASK [my-role : Copy a file to the remote host] ********************************\nok: [localhost]\nTASK [my-role : Template the configuration file] *******************************\n--- before: /tmp/test.ini\n+++ after: /home/hxr/.ansible/tmp/ansible-local-1906887dr2u6j8n/tmptx9pdelg/test.ini.j2\n@@ -1,3 +1,3 @@\n [example]\n-server_name = Cats!\n+server_name = Dogs!\n listen = 192.168.0.25\nchanged: [localhost]\nPLAY RECAP **********************************************\nlocalhost                  : ok=3    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0\n</code></pre></div>        </div>\n        <p>Here you can see that the <code class=\"language-plaintext highlighter-rouge\">server_name</code> value will be changed. Despite Ansible reporting <code class=\"language-plaintext highlighter-rouge\">changed=1</code>, no changes have actually been applied to the system.</p>\n      </blockquote>\n    </li>\n    <li>\n      <p>Run the playbook again, without the <code class=\"language-plaintext highlighter-rouge\">--check</code> flag to apply your changes.</p>\n    </li>\n  </ol>\n</blockquote>\n\n<blockquote class=\"comment\">\n  <comment-title>Ansible Variable Templating</comment-title>\n  <p>In this hands-on we used some templated variables. We defined them in a template, but they are also commonly used in the group variables file. Our templated variable looked like: <code class=\"language-plaintext highlighter-rouge\">listen = {{ ansible_default_ipv4.address }}</code>.</p>\n\n  <p>It is common to see things like this in Ansible roles:</p>\n\n  <div class=\"language-yaml highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"s\">root_dir = /opt/my-app</span>\n<span class=\"s\">config_dir = \"{{ root_dir }}/config\"</span>\n</code></pre></div>  </div>\n\n  <p>When Ansible runs:</p>\n\n  <ol>\n    <li>It collects variables defined in group variables and other places</li>\n    <li>The first task for each machine is the <a href=\"https://docs.ansible.com/ansible/2.9/modules/setup_module.html\"><code class=\"language-plaintext highlighter-rouge\">setup</code> module</a> which gathers facts about the host, which are added to the available variables</li>\n    <li>When multiple roles execute in a playbook:\n      <ol>\n        <li>Their defaults are added to the set of variables (the group variables having precedence over these variables)</li>\n        <li>They can also dynamically define more variables which may not be set until that role is run</li>\n      </ol>\n    </li>\n    <li>Before use (in templates, commands, etc.), variables are resolved to their final value</li>\n  </ol>\n\n</blockquote>\n\n<h1 id=\"ansible-galaxy\">Ansible Galaxy</h1>\n\n<p>Now that you‚Äôve built a small role, you can imagine that building real roles that manage the full installation of a piece of software are not simple things. Ansible Galaxy (repository unrelated to the Galaxy Project) is the answer here. Many roles for common administration tasks, and software installation and setup are readily available on Ansible Galaxy.</p>\n\n<p><strong>Warning</strong>: This will install Memcached on the target machine.</p>\n\n<blockquote class=\"hands_on\">\n  <hands-on-title>Installing a module using ansible-galaxy</hands-on-title>\n\n  <ol>\n    <li>\n      <p>Install the geerlingguy.memcached role with ansible-galaxy into your roles folder:</p>\n\n      <blockquote class=\"code-2col\">\n        <blockquote class=\"code-in\">\n          <code-in-title>Bash</code-in-title>\n          <div class=\"language-bash highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>ansible-galaxy <span class=\"nb\">install</span> <span class=\"se\">\\</span>\n    <span class=\"nt\">-p</span> roles/ geerlingguy.memcached\n</code></pre></div>          </div>\n        </blockquote>\n\n        <blockquote class=\"code-out\">\n          <code-out-title></code-out-title>\n          <p>This will install the new role into your <code class=\"language-plaintext highlighter-rouge\">roles</code> folder, alongside your own role.</p>\n          <div class=\"language-plaintext highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>- downloading role 'memcached', owned by geerlingguy\n- downloading role from https://github.com/geerlingguy/ansible-role-memcached/archive/1.1.0.tar.gz\n- extracting geerlingguy.memcached to /home/ubuntu/ansible/intro/roles/geerlingguy.memcached\n- geerlingguy.memcached (1.1.0) was installed successfully\n</code></pre></div>          </div>\n        </blockquote>\n      </blockquote>\n    </li>\n    <li>\n      <p>Edit your playbook.yml and add the role <code class=\"language-plaintext highlighter-rouge\">geerlingguy.memcached</code> at the bottom, after <code class=\"language-plaintext highlighter-rouge\">my-role</code></p>\n    </li>\n    <li>\n      <p>Run the playbook</p>\n\n      <blockquote class=\"question\">\n        <question-title></question-title>\n\n        <p>Did something go wrong?</p>\n\n        <blockquote class=\"solution\">\n          <solution-title></solution-title>\n\n          <p>Since you have been running the playbook as a non-root user (or at least you should have been!), the step to install a package fails.\nThe solution to this is to set <code class=\"language-plaintext highlighter-rouge\">become: true</code>.</p>\n\n          <ol>\n            <li>Edit your playbook.yml\n              <ul>\n                <li>add <code class=\"language-plaintext highlighter-rouge\">become: true</code> just below <code class=\"language-plaintext highlighter-rouge\">hosts: my_hosts</code></li>\n              </ul>\n            </li>\n            <li>Run the playbook again</li>\n          </ol>\n\n          <p><code class=\"language-plaintext highlighter-rouge\">become</code> causes Ansible to attempt to become a different user (using sudo/su/whatever is appropriate), by default this is <code class=\"language-plaintext highlighter-rouge\">root</code>. If you want to become a different user, just set <code class=\"language-plaintext highlighter-rouge\">become_user</code>. Beware, the user should be able to privilege escalate without a password prompt. Otherwise when you execute the playbook you should set <code class=\"language-plaintext highlighter-rouge\">--ask-become-pass</code>, using the privilege escalation password for that host.</p>\n\n          <blockquote class=\"details\">\n            <details-title>Ansible Become</details-title>\n            <p>See the <a href=\"https://docs.ansible.com/ansible/2.9/user_guide/become.html\">documentation</a> if you need to control this behaviour differently. <code class=\"language-plaintext highlighter-rouge\">become</code> can be set either at the task level or the playbook level.</p>\n\n          </blockquote>\n\n          <blockquote class=\"tip\">\n            <tip-title>Should I use sudo or directly login as root?</tip-title>\n            <p>This is often site-specific policy. If your site doesn‚Äôt have a dictated policy, then it‚Äôs generally preferable to not allow direct login as root, and login as a separate user.</p>\n          </blockquote>\n\n        </blockquote>\n      </blockquote>\n    </li>\n  </ol>\n\n</blockquote>\n\n<h2 id=\"choosing-a-role\">Choosing a Role</h2>\n\n<p>Picking the best role for a task from Ansible Galaxy is not always a trivial task. Sometimes there will only be a single role doing what you need. Other times you‚Äôll have to choose between 20 different roles that all look more or less the same. Here are some tips to guide you in identifying appropriate and well-written roles:</p>\n\n<ul>\n  <li>The name should match the software you are using (I.e. ignore a role named <code class=\"language-plaintext highlighter-rouge\">stackstorm</code> when you are trying to set up <code class=\"language-plaintext highlighter-rouge\">rabbitmq</code>. Ansible Galaxy does not have perfect search.)</li>\n  <li><code class=\"language-plaintext highlighter-rouge\">geerlingguy</code> wrote a huge number of roles for many pieces of standard software. If there is a role from this person, this is usually a safe choice. In the same way we recommend <code class=\"language-plaintext highlighter-rouge\">galaxyproject</code> and <code class=\"language-plaintext highlighter-rouge\">usegalaxy_eu</code> roles.</li>\n  <li>Check the GitHub readme of each role you consider using. Look for:\n    <ul>\n      <li>Extensive documentation of all of the variables, their default values, and how they behave.</li>\n      <li>An example playbook using the role</li>\n    </ul>\n  </li>\n  <li>A large number of downloads is a good sign that other people found it useful</li>\n</ul>\n\n<p>These are usually good proxies for quality, but do not treat them as strict rules. For an example of a role meeting many of these qualities, <a href=\"https://github.com/galaxyproject/ansible-cvmfs\"><code class=\"language-plaintext highlighter-rouge\">ansible-cvmfs</code></a> is good; the variables are well documented and there are example playbooks that you can (more or less) copy-and-paste and run.</p>\n\n<p>Sometimes a role will accomplish 95% of what you need to do, but not everything. Once you have installed the role with <code class=\"language-plaintext highlighter-rouge\">ansible-galaxy install</code>, you can edit it locally to make any changes. In an ideal world you would contribute this back, but this is not always a high priority. Many projects copy roles directly into their repositories, e.g. <a href=\"https://github.com/galaxyproject/infrastructure-playbook/tree/master/roles\">galaxyproject</a> and <a href=\"https://github.com/usegalaxy-eu/infrastructure-playbook/tree/master/roles\">usegalaxy.eu</a></p>\n\n<!--SNIPPET-->\n<blockquote class=\"tip\">   <div class=\"box-title tip-title\" id=\"tip-how-do-i-know-what-i-can-do-with-a-role-what-variables-are-available\"><button class=\"gtn-boxify-button tip\" type=\"button\" aria-controls=\"tip-how-do-i-know-what-i-can-do-with-a-role-what-variables-are-available\" aria-expanded=\"true\"><i class=\"far fa-lightbulb\" aria-hidden=\"true\"></i> <span>Tip: How do I know what I can do with a role? What variables are available?</span><span class=\"fold-unfold fa fa-minus-square\"></span></button></div>   <p>You don‚Äôt. There is no standard way for reporting this, but well written roles by trusted authors (e.g. geerlingguy, galaxyproject) do it properly and write all of the variables in the README file of the repository. We try to pick sensible roles for you in this course, but, in real life it may not be that simple.</p>   <p>So, definitely check there first, but if they aren‚Äôt there, then you‚Äôll need to read through <code class=\"language-plaintext highlighter-rouge\">defaults/</code> and <code class=\"language-plaintext highlighter-rouge\">tasks/</code> and <code class=\"language-plaintext highlighter-rouge\">templates/</code> to figure out what the role does and how you can control and modify it to accomplish your goals.</p> </blockquote>\n<p><!--END_SNIPPET--></p>\n\n<h1 id=\"ansible-vault\">Ansible Vault</h1>\n\n<p>Now that you have a small role built up, you might start thinking about deploying larger and more complex services and infrastructure. One last common task we want to cover here is the inclusion of secrets. Ansible Vault is really useful to include encrypted secrets in your playbook repository.</p>\n\n<blockquote class=\"hands_on\">\n  <hands-on-title>Setting up secrets</hands-on-title>\n\n  <ol>\n    <li>\n      <p>Run <code class=\"language-plaintext highlighter-rouge\">mkdir -p secret_group_vars</code></p>\n    </li>\n    <li>\n      <p>Now we‚Äôll create a strong password: <code class=\"language-plaintext highlighter-rouge\">openssl rand -base64 24 &gt; vault-password.txt</code></p>\n    </li>\n    <li>\n      <p>Run <code class=\"language-plaintext highlighter-rouge\">ansible-vault create secret_group_vars/all.yml --vault-password-file=vault-password.txt</code></p>\n\n      <p>This will open <code class=\"language-plaintext highlighter-rouge\">secret_group_vars/all.yml</code> in your text editor.</p>\n    </li>\n    <li>\n      <p>In this file, enter the following contents and save it:</p>\n\n      <div class=\"language-yaml highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"na\">apikey</span><span class=\"pi\">:</span> <span class=\"s\">super-secret-api-key-wow!</span>\n</code></pre></div>      </div>\n\n      <blockquote class=\"question\">\n        <question-title></question-title>\n\n        <p>How does your file look? Is it readable? Run <code class=\"language-plaintext highlighter-rouge\">cat secret_group_vars/all.yml</code></p>\n\n        <blockquote class=\"solution\">\n          <solution-title></solution-title>\n\n          <p>The file will look like this, it is encrypted by Ansible Vault with AES256 encryption.</p>\n          <div class=\"language-plaintext highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>$ cat secret_group_vars/all.yml\n$ANSIBLE_VAULT;1.1;AES256\n64373665366130333437393639343534653134346538636239393363373062393830653333323966\n3134333366363130326139323162323131643763336236320a393262303938316262643764323862\n36393161666663353231366336613838633866323230303031313465646333613862363264323139\n3263383530626262370a666139666462663938343531656432353239346532316630366165376566\n34313765353766666330366632303836353863396430343264303032363739666139383830323565\n6133663637356331613062353834646561653366386665623930\n</code></pre></div>          </div>\n\n        </blockquote>\n      </blockquote>\n    </li>\n    <li>\n      <p>Use the new variable in our <code class=\"language-plaintext highlighter-rouge\">.ini</code> file from earlier. Edit <code class=\"language-plaintext highlighter-rouge\">roles/my-role/templates/test.ini.j2</code> and add the line <code class=\"language-plaintext highlighter-rouge\">apikey = {{ apikey }}</code></p>\n    </li>\n    <li>\n      <p>Add encrypted variable file to <code class=\"language-plaintext highlighter-rouge\">playbook.yml</code></p>\n\n      <div class=\"language-yaml highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"pi\">-</span> <span class=\"na\">hosts</span><span class=\"pi\">:</span> <span class=\"s\">my_hosts</span>\n  <span class=\"s\">...</span>\n  <span class=\"na\">vars_files</span><span class=\"pi\">:</span>\n   <span class=\"pi\">-</span> <span class=\"s\">secret_group_vars/all.yml</span>\n</code></pre></div>      </div>\n    </li>\n    <li>\n      <p>Tell ansible where to find the decryption file. Create file <code class=\"language-plaintext highlighter-rouge\">ansible.cfg</code> with content</p>\n\n      <div class=\"language-yaml highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"pi\">[</span><span class=\"nv\">defaults</span><span class=\"pi\">]</span>\n<span class=\"s\">vault_password_file=vault-password.txt</span>\n</code></pre></div>      </div>\n    </li>\n    <li>\n      <p>Run the playbook</p>\n    </li>\n    <li>\n      <p>Check the contents of <code class=\"language-plaintext highlighter-rouge\">/tmp/test.ini</code></p>\n\n      <blockquote class=\"code-2col\">\n        <blockquote class=\"code-in\">\n          <code-in-title>Bash</code-in-title>\n          <div class=\"language-bash highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"nb\">cat</span> /tmp/test.ini\n</code></pre></div>          </div>\n        </blockquote>\n\n        <blockquote class=\"code-out\">\n          <code-out-title></code-out-title>\n          <p>The file should look like:</p>\n\n          <div class=\"language-ini highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"nn\">[example]</span>\n<span class=\"py\">server_name</span> <span class=\"p\">=</span> <span class=\"s\">Dogs!</span>\n<span class=\"py\">listen</span> <span class=\"p\">=</span> <span class=\"s\">192.168.0.2</span>\n<span class=\"py\">apikey</span> <span class=\"p\">=</span> <span class=\"s\">super-secret-api-key-wow!</span>\n</code></pre></div>          </div>\n        </blockquote>\n      </blockquote>\n    </li>\n  </ol>\n\n</blockquote>\n\n<p>In real life scenarios where you are sharing your playbooks publicly, be sure to encrypt all secrets from the start (or remove any secrets from the git history if you ever committed them in plain text). If you are storing your vault password in a file, remember to add it to your <code class=\"language-plaintext highlighter-rouge\">.gitignore</code> (or VCS appropriate file.)</p>\n\n<h1 id=\"other-stuff\">Other Stuff</h1>\n\n<p>Ansible has a huge array of features and we can‚Äôt cover them all. Some commonly used features are documented below:</p>\n\n<h2 id=\"with-items\">With Items</h2>\n\n<p>Duplicating tasks ten times to install ten packages is not efficient, so Ansible provides <code class=\"language-plaintext highlighter-rouge\">loop</code> construct</p>\n\n<div class=\"language-yaml highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"pi\">-</span> <span class=\"na\">name</span><span class=\"pi\">:</span> <span class=\"s\">Install stuff</span>\n  <span class=\"na\">package</span><span class=\"pi\">:</span>\n    <span class=\"na\">name</span><span class=\"pi\">:</span> <span class=\"s2\">\"</span><span class=\"s\">{{</span><span class=\"nv\"> </span><span class=\"s\">item</span><span class=\"nv\"> </span><span class=\"s\">}}\"</span>\n    <span class=\"na\">state</span><span class=\"pi\">:</span> <span class=\"s\">installed</span>\n  <span class=\"na\">loop</span><span class=\"pi\">:</span>\n    <span class=\"pi\">-</span> <span class=\"s\">htop</span>\n    <span class=\"pi\">-</span> <span class=\"s\">git</span>\n    <span class=\"pi\">-</span> <span class=\"s\">vim</span>\n</code></pre></div></div>\n\n<p>This works for any task, not just package installation, if you have things you‚Äôd like to repeat.\nNote that for this task one would normally list multiple packages in the <code class=\"language-plaintext highlighter-rouge\">name</code> parameter of the package module.</p>\n\n<div class=\"language-yaml highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"pi\">-</span> <span class=\"na\">name</span><span class=\"pi\">:</span> <span class=\"s\">Install stuff</span>\n  <span class=\"na\">package</span><span class=\"pi\">:</span>\n    <span class=\"na\">name</span><span class=\"pi\">:</span>\n      <span class=\"pi\">-</span> <span class=\"s\">htop</span>\n      <span class=\"pi\">-</span> <span class=\"s\">git</span>\n      <span class=\"pi\">-</span> <span class=\"s\">vim</span>\n    <span class=\"na\">state</span><span class=\"pi\">:</span> <span class=\"s\">installed</span>\n</code></pre></div></div>\n\n<h2 id=\"when-changed\">When Changed</h2>\n\n<p>Doing something only when a task is in the ‚Äúchanged‚Äù state is a common pattern. This is often used for reloading a service when some configuration files have changed.</p>\n\n<div class=\"language-yaml highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"pi\">-</span> <span class=\"na\">name</span><span class=\"pi\">:</span> <span class=\"s\">Copy configuration file</span>\n  <span class=\"na\">copy</span><span class=\"pi\">:</span>\n    <span class=\"na\">src</span><span class=\"pi\">:</span> <span class=\"s\">main.conf</span>\n    <span class=\"na\">dest</span><span class=\"pi\">:</span> <span class=\"s\">/etc/service/main.conf</span>\n    <span class=\"na\">owner</span><span class=\"pi\">:</span> <span class=\"s\">root</span>\n    <span class=\"na\">group</span><span class=\"pi\">:</span> <span class=\"s\">root</span>\n    <span class=\"na\">mode</span><span class=\"pi\">:</span> <span class=\"m\">0644</span>\n  <span class=\"na\">register</span><span class=\"pi\">:</span> <span class=\"s\">service_conf</span>\n\n<span class=\"pi\">-</span> <span class=\"na\">name</span><span class=\"pi\">:</span> <span class=\"s\">Restart the service</span>\n  <span class=\"na\">service</span><span class=\"pi\">:</span>\n    <span class=\"na\">name</span><span class=\"pi\">:</span> <span class=\"s\">service</span>\n    <span class=\"na\">enabled</span><span class=\"pi\">:</span> <span class=\"s\">yes</span>\n    <span class=\"na\">state</span><span class=\"pi\">:</span> <span class=\"s\">restarted</span>\n  <span class=\"na\">when</span><span class=\"pi\">:</span> <span class=\"s\">service_conf is changed</span>\n</code></pre></div></div>\n\n<h2 id=\"notifying-handlers\">Notifying Handlers</h2>\n\n<p>Often you want to restart a service whenever something has changed, like above. But if you need to restart the service whenever one of many different tasks has changed, there is a simpler way than writing <code class=\"language-plaintext highlighter-rouge\">when: a.changed or b.changed or c.changed or ...</code></p>\n\n<p>First, move the restarting or reloading of the service into the <code class=\"language-plaintext highlighter-rouge\">handlers/main.yml</code></p>\n\n<div class=\"language-yaml highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"pi\">-</span> <span class=\"na\">name</span><span class=\"pi\">:</span> <span class=\"s\">restart service</span>\n  <span class=\"na\">service</span><span class=\"pi\">:</span>\n    <span class=\"na\">name</span><span class=\"pi\">:</span> <span class=\"s\">service</span>\n    <span class=\"na\">enabled</span><span class=\"pi\">:</span> <span class=\"s\">yes</span>\n    <span class=\"na\">state</span><span class=\"pi\">:</span> <span class=\"s\">restarted</span>\n\n<span class=\"pi\">-</span> <span class=\"na\">name</span><span class=\"pi\">:</span> <span class=\"s\">reload httpd</span>\n  <span class=\"na\">service</span><span class=\"pi\">:</span>\n    <span class=\"na\">name</span><span class=\"pi\">:</span> <span class=\"s\">httpd</span>\n    <span class=\"na\">enabled</span><span class=\"pi\">:</span> <span class=\"s\">yes</span>\n    <span class=\"na\">state</span><span class=\"pi\">:</span> <span class=\"s\">reloaded</span>\n</code></pre></div></div>\n\n<p>Now you can change your task definitions:</p>\n\n<div class=\"language-yaml highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"pi\">-</span> <span class=\"na\">name</span><span class=\"pi\">:</span> <span class=\"s\">Copy configuration file</span>\n  <span class=\"na\">copy</span><span class=\"pi\">:</span>\n    <span class=\"na\">src</span><span class=\"pi\">:</span> <span class=\"s\">main.conf</span>\n    <span class=\"na\">dest</span><span class=\"pi\">:</span> <span class=\"s2\">\"</span><span class=\"s\">/etc/service/main.conf</span>\n    <span class=\"s\">owner:</span><span class=\"nv\"> </span><span class=\"s\">\"root\"</span>\n    <span class=\"na\">group</span><span class=\"pi\">:</span> <span class=\"s2\">\"</span><span class=\"s\">root\"</span>\n    <span class=\"na\">mode</span><span class=\"pi\">:</span> <span class=\"s2\">\"</span><span class=\"s\">0644\"</span>\n  <span class=\"na\">notify</span><span class=\"pi\">:</span> <span class=\"s1\">'</span><span class=\"s\">restart</span><span class=\"nv\"> </span><span class=\"s\">service'</span>\n</code></pre></div></div>\n\n<p>We no longer <code class=\"language-plaintext highlighter-rouge\">register</code> the command, instead the <code class=\"language-plaintext highlighter-rouge\">notify</code> attribute automatically marks that the appropriate handler should be called <em>at the end of the playbook run</em>. Additionally, tasks from outside of this role can use the same <code class=\"language-plaintext highlighter-rouge\">notify</code>. So if you use a community built role for managing apache, and then have a custom role that builds the apache configuration, you can use changes there to reload the service using their definition of the reload/restart.</p>\n"],"ref_slides":["## Configuration Management\n\nManages the configuration of machines.\n\nSpecifies what software is installed, how it is configured\n\n\n???\n\n- Configuration management manages the configuration of machines.\n- It specifies what software should be installed, and how it should be configured\n\n---\n\n### Why Configuration Management?\n\n- Are you keeping track of config changes?\n- What if your server dies?\n- ... or your VM is accidentally deleted?\n- Can you recover? How quickly?\n\n???\n\n- So why do you want configuration management?\n- What do you do when things go wrong?\n- What if your server dies?\n- Did you backup your configuration?\n- Did you back up your webserver configuration?\n- Ansible provides an answer.\n\n---\n\n### Configuration Management goals\n\n- Reproducibility\n\n- Ensure 1000s of machines are correctly configured\n\n- Easily recover from bad situations\n\n???\n\n- The goals of using CM are reproducibility, uniformity, and recovery.\n\n---\n\n### Ansible\n\n- [Ansible](https://www.ansible.com/) is an open-source configuration management tool, sponsored by Red Hat\n\n- Several [alternatives](https://en.wikipedia.org/wiki/Comparison_of_open-source_configuration_management_software) are available (Chef, Puppet, Salt, etc)\n\n- It uses an agentless model: SSH into machine and executes commands\n\n- Very popular, especially among Galaxy admins!\n\n- Many modules for common tasks like copying files or managing users or services.\n\n???\n\n- Ansible is a very popular CM tool, sponsored by RedHat.\n- There are several alternatives, but Galaxy Project uses Ansible.\n- It uses an agent-less model. You SSH into machines and execute commands on them.\n- It has many popular pre-existing roles for common tasks.\n\n---\n\n## Important Terms\n\n???\n\n- Some important terms you should know\n\n---\n\n### Inventory File\n\nDefines the systems (called \"hosts\") against which Ansible will work.\n\n```ini\n[webservers]\n192.168.0.1\n192.168.0.2 ansible_user=ubuntu\n\n[databases]\ndb_1.example.org ansible_user=root\n```\n\n???\n\n- First is the Inventory File.\n- This file lists all of your hosts.\n- The group name is in square brackets.\n- Group names are used to select a set of systems, on which Ansible should operate.\n- It is possible to assign variables to hosts and groups.\n- Here we override the ansible user variable on two hosts.\n- This variable controls which user is used in login.\n\n---\n\n### Ansible Module and Tasks\n\nA **module** is a piece of code that Ansible can execute on a host, collecting return values.\n\nA **task** is an invocation of single module with its configuration.\n\n```yaml\n---\n- copy:\n    src: foo.conf\n    dest: /etc/foo.conf\n    owner: foo\n    group: foo\n    mode: 0644\n\n- package:\n    name: ntpdate\n    state: present\n```\n\n???\n\n- Here is an example of invoking the copy module and the package module.\n- Copy copies a file from source, on the local host to destination, on the remote host.\n- Then it sets some attributes about the file like the owner and mode.\n- Next we see an example of the package module. This is a generic OS package manager module.\n- It ensures that for the package named ntpdate, its state is present, i.e. installed.\n\n---\n\n### Role\n\n.pull-left[\nA collection of:\n\n- tasks\n- files\n- templates\n- variables\n- handlers\n\n]\n\n.pull-right[\nwith a predefined directory structure:\n```\n.\n‚îú‚îÄ‚îÄ defaults\n‚îÇ   ‚îî‚îÄ‚îÄ main.yml\n‚îú‚îÄ‚îÄ files\n‚îÇ   ‚îî‚îÄ‚îÄ cvmfs_wipecache.centos_7\n‚îú‚îÄ‚îÄ handlers\n‚îÇ   ‚îî‚îÄ‚îÄ main.yml\n‚îú‚îÄ‚îÄ meta\n‚îÇ   ‚îî‚îÄ‚îÄ main.yml\n‚îú‚îÄ‚îÄ README.md\n‚îú‚îÄ‚îÄ tasks\n‚îÇ   ‚îú‚îÄ‚îÄ apache.yml\n‚îÇ   ‚îú‚îÄ‚îÄ main.yml\n‚îÇ   ‚îî‚îÄ‚îÄ stratumN.yml\n‚îú‚îÄ‚îÄ templates\n‚îÇ   ‚îî‚îÄ‚îÄ stratum1_squid.conf.j2\n‚îú‚îÄ‚îÄ tests\n‚îÇ   ‚îú‚îÄ‚îÄ inventory\n‚îÇ   ‚îî‚îÄ‚îÄ test.yml\n‚îî‚îÄ‚îÄ vars\n    ‚îî‚îÄ‚îÄ main.yml\n\n```\n]\n\n???\n\n- A role is a collection of tasks, files, templates, variables, and handlers.\n- Tasks are things to be executed, like a copy task to add files to a remote machine.\n- Files have static, unchanging files that are used by the tasks.\n- The templates are like files, but they contain variables which will be replaced, when ansible deploys the file.\n- Variables contain definitions of variables for use in templates and tasks.\n- Handlers manage services, restarting them when configuration changes.\n\n---\n\n### Playbook\n\nA YAML file listing a set of tasks and/or roles that should be applied to a group of hosts.\n\n.pull-left[\n- We define a playbook which has a name\n- And applies to some group of hosts\n- We specify some additional variables\n- And then invoke some roles\n]\n\n\n.pull-right[\n```yaml\n- name: CVMFS\n  hosts: all\n  vars:\n    cvmfs_role: client\n    galaxy_cvmfs_repos_enabled: true\n  roles:\n    - geerlingguy.repo-epel\n    - galaxyproject.cvmfs\n```\n]\n\n\n???\n\n- This is an example playbook.\n- We give it a name, in this case CVMFS.\n- Then we select some hosts, i.e. all hosts known to our inventory file.\n- We specify some additional variables.\n- And then we invoke two roles.\n\n---\n\n### Vault\n\n- Ansible playbooks should be kept under **version control** (typically with Git)\n- Playbooks can be safely shared on public Git repositories (e.g. GitHub) by storing secrets like passwords in encrypted files called **vaults**\n\n```\n$ANSIBLE_VAULT;1.1;AES256\n63333238633033313664633437316231323932326531386266636637353037313335613563663934\n6639666536653631363739383639633165633337393334630a353233393938646539306362633738\n61613439366435336230636561663864323765303663666239613430323534333665636665643964\n6537376666323333660a663233343565393166373665366138306661343764623561343634656463\n31636265303430623731643766346434323565663436626466353765393465376533376366356463\n```\n\n???\n\n- If you have secrets like API keys or passwords, you need to use Vault.\n- Vault encrypts your secrets with a password, so you can include them in your playbooks.\n- This lets you collaborate on playbooks and infrastructure publicly with git.\n\n---\n\n## Ansible Philosophies\n\n- Some people write a single playbook that completely manages a machine (installing everything on a brand new machine)\n\n- Other people write playbooks for a single task (e.g. upgrading software / installing nginx)\n\n- Which one depends on your use case.\n\n???\n\n- There are multiple ways of designing playbooks, use one that fits your use case.\n- Some prefer a playbook which does everything, so no step can be forgotten.\n- Others prefer playbooks which do individual steps. These can be faster, and you can only run the ones that change.\n\n---\n\n## Ansible Galaxy\n\n- Public repository of roles\n\n- Many for common software deployment (nginx, apache, postgresql)\n\n- Different \"Galaxy\" than the bioinformatics tool server (but Ansible can be used to install that too!)\n\n???\n\n- Ansible has a repository for public roles.\n- There are a huge number of available roles for common tasks.\n- It is called Ansible Galaxy, but it is a different Galaxy.\n"],"hands_on":true,"slides":true,"mod_date":"2024-05-29 14:28:52 +0000","pub_date":"2018-07-11 08:27:13 +0000","version":105,"api":"https://training.galaxyproject.org/training-material/api/topics/admin/tutorials/ansible/tutorial.json","tools":[],"supported_servers":[],"topic_name_human":"Galaxy Server administration","admin_install":{"install_tool_dependencies":true,"install_repository_dependencies":true,"install_resolver_dependencies":true,"tools":[]},"admin_install_yaml":"---\ninstall_tool_dependencies: true\ninstall_repository_dependencies: true\ninstall_resolver_dependencies: true\ntools: []\n","tours":false,"video":true,"slides_recordings":[{"captioners":["martenson"],"date":"2021-02-15","galaxy_version":"21.01","length":"5M","youtube_id":"KFpbfmN0OTE","speakers":["jdavcs"]}],"translations":{"tutorial":[],"slides":[],"video":true},"license":"CC-BY-4.0","type":"tutorial","contributors":[{"name":"Helena Rasche","orcid":"0000-0001-9760-8992","maintainer_contact":"gitter","matrix":"hexylena:matrix.org","joined":"2017-09","elixir_node":"nl","affiliations":["gallantries","by-covid","erasmusmc","elixir-europe","elixir-converge"],"former_affiliations":["deNBI","avans-atgm","uni-freiburg"],"contact_for_training":false,"location":{"country":"NL","lat":51.91,"lon":4.46},"id":"hexylena","url":"https://training.galaxyproject.org/training-material/api/contributors/hexylena.json","page":"https://training.galaxyproject.org/training-material/hall-of-fame/hexylena/"},{"name":"Saskia Hiltemann","maintainer_contact":"gitter","email":"saskia.hiltemann@gmail.com","fediverse":"https://mstdn.science/@shiltemann","fediverse_flavor":"mastodon","bluesky":"shiltemann.bsky.social","linkedin":"shiltemann","matrix":"shiltemann:matrix.org","orcid":"0000-0003-3803-468X","joined":"2017-09","bio":"Researcher at Erasmus Medical Center","elixir_node":"nl","contact_for_training":true,"affiliations":["CINECA-Project","gallantries","erasmusmc","elixir-europe","uni-freiburg"],"location":{"country":"NL","lat":51.912,"lon":4.462},"id":"shiltemann","url":"https://training.galaxyproject.org/training-material/api/contributors/shiltemann.json","page":"https://training.galaxyproject.org/training-material/hall-of-fame/shiltemann/"},{"name":"Vlad Visan","email":"vlad.visan@gmail.com","matrix":"vlad.visan:matrix.org","orcid":"0009-0007-0529-1002","joined":"2023-02","affiliations":["uga"],"location":{"country":"FR","lat":45.19,"lon":5.76},"id":"vladvisan","url":"https://training.galaxyproject.org/training-material/api/contributors/vladvisan.json","page":"https://training.galaxyproject.org/training-material/hall-of-fame/vladvisan/"}]}