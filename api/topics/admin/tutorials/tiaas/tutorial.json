{"layout":"tutorial_hands_on","title":"Training Infrastructure as a Service (TIaaS)","zenodo_link":"","questions":["How to deploy EU's TIaaS"],"objectives":["Setup TIaaS","Request and manage trainings","Join a training"],"time_estimation":"30m","key_points":["TIaaS is an additional service you can deploy which can help you provide a better service to your users"],"contributors":[{"name":"Helena Rasche","orcid":"0000-0001-9760-8992","maintainer_contact":"gitter","matrix":"hexylena:matrix.org","joined":"2017-09","elixir_node":"nl","affiliations":["gallantries","by-covid","erasmusmc","elixir-europe","elixir-converge"],"former_affiliations":["deNBI","avans-atgm","uni-freiburg"],"contact_for_training":false,"location":{"country":"NL","lat":51.91,"lon":4.46},"id":"hexylena","url":"https://training.galaxyproject.org/training-material/api/contributors/hexylena.json","page":"https://training.galaxyproject.org/training-material/hall-of-fame/hexylena/"},{"name":"Saskia Hiltemann","maintainer_contact":"gitter","email":"saskia.hiltemann@gmail.com","fediverse":"https://mstdn.science/@shiltemann","fediverse_flavor":"mastodon","bluesky":"shiltemann.bsky.social","linkedin":"shiltemann","matrix":"shiltemann:matrix.org","orcid":"0000-0003-3803-468X","joined":"2017-09","bio":"Researcher at Erasmus Medical Center","elixir_node":"nl","contact_for_training":true,"affiliations":["CINECA-Project","gallantries","erasmusmc","elixir-europe","uni-freiburg"],"location":{"country":"NL","lat":51.912,"lon":4.462},"id":"shiltemann","url":"https://training.galaxyproject.org/training-material/api/contributors/shiltemann.json","page":"https://training.galaxyproject.org/training-material/hall-of-fame/shiltemann/"}],"subtopic":"features","tags":["ansible","training","jobs","git-gat"],"requirements":[{"type":"internal","topic_name":"admin","tutorials":["ansible","ansible-galaxy","connect-to-compute-cluster","job-destinations","pulsar"]}],"abbreviations":{"TIaaS":"Training Infrastructure as a Service"},"js_requirements":{"mathjax":null,"mermaid":false},"short_id":"T00022","url":"/topics/admin/tutorials/tiaas/tutorial.html","topic_name":"admin","tutorial_name":"tiaas","dir":"topics/admin/tutorials/tiaas","symlink":null,"id":"admin/tiaas","ref_tutorials":["<p>Galaxy is widely used for teaching. In order to facilitate instructors, the Galaxy Project has developed Training Infrastructure as a Service (TIaaS).\nWorkshop instructors can apply for <abbr title=\"Training Infrastructure as a Service\">TIaaS</abbr>, and on the day of their workshop, their participants will be placed in a special group and use dedicated\nresources, thus reducing queue times on the day of the training.</p>\n\n<figure id=\"figure-1\" style=\"max-width: 90%;\"><img src=\"../../images/tiaas/tiaas_intro.png\" alt=\"TIaaS concept. \" width=\"1917\" height=\"1665\" loading=\"lazy\" /><a target=\"_blank\" href=\"../../images/tiaas/tiaas_intro.png\" rel=\"noopener noreferrer\"><small>Open image in new tab</small></a><br /><br /><figcaption><span class=\"figcaption-prefix\"><strong>Figure 1</strong>:</span> With TIaaS, all of your users visit the same server. In the background, the scheduler recognises which users are training users, and directs their jobs to special resources. In the EU deployment of TIaaS jobs preferentially use private resources, but can spill over to the main queue if there is not enough space available.</figcaption></figure>\n\n<p>This tutorial will go cover how to set up such a service on your own Galaxy server.</p>\n\n<blockquote class=\"agenda\">\n  <agenda-title></agenda-title>\n\n<ol id=\"markdown-toc\">\n  <li><a href=\"#setting-up-tiaas\" id=\"markdown-toc-setting-up-tiaas\">Setting up TIaaS</a></li>\n  <li><a href=\"#job-configuration\" id=\"markdown-toc-job-configuration\">Job Configuration</a></li>\n</ol>\n\n</blockquote>\n\n<!--SNIPPET-->\n<blockquote class=\"comment\">   <div class=\"box-title comment-title\" id=\"comment-galaxy-admin-training-path\"><i class=\"far fa-comment-dots\" aria-hidden=\"true\"></i> Comment: Galaxy Admin Training Path</div>   <p>The yearly Galaxy Admin Training follows a specific ordering of tutorials. Use this timeline to help keep track of where you are in Galaxy Admin Training.</p>   <ol id=\"git-gat-timeline\">                    <li class=\"disabled\">         <a href=\"/training-material/topics/admin/tutorials/ansible-galaxy/tutorial.html\">             <div>Step 1</div>             <div>ansible-galaxy</div>         </a>     </li>               <span aria-hidden=\"true\">         <i class=\"fas fa-arrow-right\" aria-hidden=\"true\"></i>     </span>                         <li class=\"disabled\">         <a href=\"/training-material/topics/admin/tutorials/backup-cleanup/tutorial.html\">             <div>Step 2</div>             <div>backup-cleanup</div>         </a>     </li>               <span aria-hidden=\"true\">         <i class=\"fas fa-arrow-right\" aria-hidden=\"true\"></i>     </span>                         <li class=\"disabled\">         <a href=\"/training-material/topics/admin/tutorials/customization/tutorial.html\">             <div>Step 3</div>             <div>customization</div>         </a>     </li>               <span aria-hidden=\"true\">         <i class=\"fas fa-arrow-right\" aria-hidden=\"true\"></i>     </span>                         <li class=\"disabled\">         <a href=\"/training-material/topics/admin/tutorials/tus/tutorial.html\">             <div>Step 4</div>             <div>tus</div>         </a>     </li>               <span aria-hidden=\"true\">         <i class=\"fas fa-arrow-right\" aria-hidden=\"true\"></i>     </span>                         <li class=\"disabled\">         <a href=\"/training-material/topics/admin/tutorials/cvmfs/tutorial.html\">             <div>Step 5</div>             <div>cvmfs</div>         </a>     </li>               <span aria-hidden=\"true\">         <i class=\"fas fa-arrow-right\" aria-hidden=\"true\"></i>     </span>                         <li class=\"disabled\">         <a href=\"/training-material/topics/admin/tutorials/apptainer/tutorial.html\">             <div>Step 6</div>             <div>apptainer</div>         </a>     </li>               <span aria-hidden=\"true\">         <i class=\"fas fa-arrow-right\" aria-hidden=\"true\"></i>     </span>                         <li class=\"disabled\">         <a href=\"/training-material/topics/admin/tutorials/tool-management/tutorial.html\">             <div>Step 7</div>             <div>tool-management</div>         </a>     </li>               <span aria-hidden=\"true\">         <i class=\"fas fa-arrow-right\" aria-hidden=\"true\"></i>     </span>                         <li class=\"disabled\">         <a href=\"/training-material/topics/admin/tutorials/reference-genomes/tutorial.html\">             <div>Step 8</div>             <div>reference-genomes</div>         </a>     </li>               <span aria-hidden=\"true\">         <i class=\"fas fa-arrow-right\" aria-hidden=\"true\"></i>     </span>                         <li class=\"disabled\">         <a href=\"/training-material/topics/admin/tutorials/data-library/tutorial.html\">             <div>Step 9</div>             <div>data-library</div>         </a>     </li>               <span aria-hidden=\"true\">         <i class=\"fas fa-arrow-right\" aria-hidden=\"true\"></i>     </span>                         <li class=\"disabled\">         <a href=\"/training-material/topics/dev/tutorials/bioblend-api/tutorial.html\">             <div>Step 10</div>             <div>dev/bioblend-api</div>         </a>     </li>               <span aria-hidden=\"true\">         <i class=\"fas fa-arrow-right\" aria-hidden=\"true\"></i>     </span>                         <li class=\"disabled\">         <a href=\"/training-material/topics/admin/tutorials/connect-to-compute-cluster/tutorial.html\">             <div>Step 11</div>             <div>connect-to-compute-cluster</div>         </a>     </li>               <span aria-hidden=\"true\">         <i class=\"fas fa-arrow-right\" aria-hidden=\"true\"></i>     </span>                         <li class=\"disabled\">         <a href=\"/training-material/topics/admin/tutorials/job-destinations/tutorial.html\">             <div>Step 12</div>             <div>job-destinations</div>         </a>     </li>               <span aria-hidden=\"true\">         <i class=\"fas fa-arrow-right\" aria-hidden=\"true\"></i>     </span>                         <li class=\"disabled\">         <a href=\"/training-material/topics/admin/tutorials/pulsar/tutorial.html\">             <div>Step 13</div>             <div>pulsar</div>         </a>     </li>               <span aria-hidden=\"true\">         <i class=\"fas fa-arrow-right\" aria-hidden=\"true\"></i>     </span>                         <li class=\"disabled\">         <a href=\"/training-material/topics/admin/tutorials/celery/tutorial.html\">             <div>Step 14</div>             <div>celery</div>         </a>     </li>               <span aria-hidden=\"true\">         <i class=\"fas fa-arrow-right\" aria-hidden=\"true\"></i>     </span>                         <li class=\"disabled\">         <a href=\"/training-material/topics/admin/tutorials/gxadmin/tutorial.html\">             <div>Step 15</div>             <div>gxadmin</div>         </a>     </li>               <span aria-hidden=\"true\">         <i class=\"fas fa-arrow-right\" aria-hidden=\"true\"></i>     </span>                         <li class=\"disabled\">         <a href=\"/training-material/topics/admin/tutorials/reports/tutorial.html\">             <div>Step 16</div>             <div>reports</div>         </a>     </li>               <span aria-hidden=\"true\">         <i class=\"fas fa-arrow-right\" aria-hidden=\"true\"></i>     </span>                         <li class=\"disabled\">         <a href=\"/training-material/topics/admin/tutorials/monitoring/tutorial.html\">             <div>Step 17</div>             <div>monitoring</div>         </a>     </li>               <span aria-hidden=\"true\">         <i class=\"fas fa-arrow-right\" aria-hidden=\"true\"></i>     </span>                         <li class=\"active\">         <a href=\"/training-material/topics/admin/tutorials/tiaas/tutorial.html\">             <div>Step 18</div>             <div>tiaas</div>         </a>     </li>               <span aria-hidden=\"true\">         <i class=\"fas fa-arrow-right\" aria-hidden=\"true\"></i>     </span>                         <li class=\"\">         <a href=\"/training-material/topics/admin/tutorials/sentry/tutorial.html\">             <div>Step 19</div>             <div>sentry</div>         </a>     </li>               <span aria-hidden=\"true\">         <i class=\"fas fa-arrow-right\" aria-hidden=\"true\"></i>     </span>                         <li class=\"\">         <a href=\"/training-material/topics/admin/tutorials/ftp/tutorial.html\">             <div>Step 20</div>             <div>ftp</div>         </a>     </li>               <span aria-hidden=\"true\">         <i class=\"fas fa-arrow-right\" aria-hidden=\"true\"></i>     </span>                         <li class=\"\">         <a href=\"/training-material/topics/admin/tutorials/beacon/tutorial.html\">             <div>Step 21</div>             <div>beacon</div>         </a>     </li>           </ol> </blockquote>\n<p><!--END_SNIPPET--></p>\n\n<h1 id=\"setting-up-tiaas\">Setting up TIaaS</h1>\n\n<blockquote class=\"hands_on\">\n  <hands-on-title>Setup TIaaS</hands-on-title>\n\n  <ol>\n    <li>\n      <p>In your <code class=\"language-plaintext highlighter-rouge\">requirements.yml</code> add the <abbr title=\"Training Infrastructure as a Service\">TIaaS</abbr> ansible role:</p>\n\n      <div data-commit=\"Add tiaas2 requirement\" class=\"language-diff highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"gd\">--- a/requirements.yml\n</span><span class=\"gi\">+++ b/requirements.yml\n</span><span class=\"p\">@@ -51,3 +51,6 @@</span>\n   version: 6f6fdf7f5ead491560783d52528b79e9e088bd5b\n - src: cloudalchemy.grafana\n   version: 0.14.2\n<span class=\"gi\">+# Training Infrastructure as a Service\n+- src: galaxyproject.tiaas2\n+  version: 2.1.5\n</span>   \n</code></pre></div>      </div>\n\n      <p>And run the install step:</p>\n\n      <blockquote class=\"code-in\">\n        <code-in-title>Bash</code-in-title>\n        <div data-cmd=\"true\" class=\"language-bash highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>ansible-galaxy <span class=\"nb\">install</span> <span class=\"nt\">-p</span> roles <span class=\"nt\">-r</span> requirements.yml\n</code></pre></div>        </div>\n      </blockquote>\n\n      <!--SNIPPET-->\n      <blockquote class=\"tip\">   <div class=\"box-title tip-title\" id=\"tip-how-to-read-a-diff\"><button class=\"gtn-boxify-button tip\" type=\"button\" aria-controls=\"tip-how-to-read-a-diff\" aria-expanded=\"true\"><i class=\"far fa-lightbulb\" aria-hidden=\"true\"></i> <span>Tip: How to read a Diff</span><span class=\"fold-unfold fa fa-minus-square\"></span></button></div>   <p>If you haven‚Äôt worked with diffs before, this can be something quite new or different.</p>   <p>If we have two files, let‚Äôs say a grocery list, in two files. We‚Äôll call them ‚Äòa‚Äô and ‚Äòb‚Äô.</p>   <blockquote class=\"code-2col\">   <blockquote class=\"code-in\">     <code-in-title>Old</code-in-title>     <div class=\"language-plaintext highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>$ cat old<br />üçé<br />üçê<br />üçä<br />üçã<br />üçí<br />ü•ë<br /></code></pre></div>    </div>   </blockquote>   <blockquote class=\"code-out\">     <code-out-title>New</code-out-title>     <div class=\"language-plaintext highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>$ cat new<br />üçé<br />üçê<br />üçä<br />üçã<br />üçç<br />ü•ë<br /></code></pre></div>    </div>   </blockquote> </blockquote>   <p>We can see that they have some different entries. We‚Äôve removed üçí because they‚Äôre awful, and replaced them with an üçç</p>   <p>Diff lets us compare these files</p>   <div class=\"language-bash highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"nv\">$ </span>diff old new<br />5c5<br />&lt; üçí<br /><span class=\"nt\">---</span><br /><span class=\"o\">&gt;</span> üçç<br /></code></pre></div></div>   <p>Here we see that üçí is only in a, and üçç is only in b. But otherwise the files are identical.</p>   <p>There are a couple different formats to diffs, one is the ‚Äòunified diff‚Äô</p>   <div class=\"language-bash highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"nv\">$ </span>diff <span class=\"nt\">-U2</span> old new<br /><span class=\"nt\">---</span> old\t2022-02-16 14:06:19.697132568 +0100<br />+++ new\t2022-02-16 14:06:36.340962616 +0100<br />@@ <span class=\"nt\">-3</span>,4 +3,4 @@<br /> üçä<br /> üçã<br />-üçí<br />+üçç<br /> ü•ë<br /></code></pre></div></div>   <p>This is basically what you see in the training materials which gives you a lot of context about the changes:</p>   <ul>   <li><code class=\"language-plaintext highlighter-rouge\">--- old</code> is the ‚Äòold‚Äô file in our view</li>   <li><code class=\"language-plaintext highlighter-rouge\">+++ new</code> is the ‚Äònew‚Äô file</li>   <li>@@ these lines tell us where the change occurs and how many lines are added or removed.</li>   <li>Lines starting with a - are removed from our ‚Äònew‚Äô file</li>   <li>Lines with a + have been added.</li> </ul>   <p>So when you go to apply these diffs to your files in the training:</p>   <ol>   <li>Ignore the header</li>   <li>Remove lines starting with - from your file</li>   <li>Add lines starting with + to your file</li> </ol>   <p>The other lines (üçä/üçã and ü•ë) above just provide ‚Äúcontext‚Äù, they help you know where a change belongs in a file, but <strong>should not be edited</strong> when you‚Äôre making the above change. Given the above diff, you would find a line with a üçí, and replace it with a üçç</p>   <h4 id=\"added--removed-lines\">Added &amp; Removed Lines</h4>   <p>Removals are very easy to spot, we just have removed lines</p>   <div class=\"language-bash highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"nt\">---</span> old\t2022-02-16 14:06:19.697132568 +0100<br />+++ new\t2022-02-16 14:10:14.370722802 +0100<br />@@ <span class=\"nt\">-4</span>,3 +4,2 @@<br /> üçã<br /> üçí<br />-ü•ë<br /></code></pre></div></div>   <p>And additions likewise are very easy, just add a new line, between the other lines in your file.</p>   <div class=\"language-bash highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"nt\">---</span> old\t2022-02-16 14:06:19.697132568 +0100<br />+++ new\t2022-02-16 14:11:11.422135393 +0100<br />@@ <span class=\"nt\">-1</span>,3 +1,4 @@<br /> üçé<br />+üçç<br /> üçê<br /> üçä<br /></code></pre></div></div>   <h4 id=\"completely-new-files\">Completely new files</h4>   <p>Completely new files look a bit different, there the ‚Äúold‚Äù file is <code class=\"language-plaintext highlighter-rouge\">/dev/null</code>, the empty file in a Linux machine.</p>   <div class=\"language-bash highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"nv\">$ </span>diff <span class=\"nt\">-U2</span> /dev/null old<br /><span class=\"nt\">---</span> /dev/null\t2022-02-15 11:47:16.100000270 +0100<br />+++ old\t2022-02-16 14:06:19.697132568 +0100<br />@@ <span class=\"nt\">-0</span>,0 +1,6 @@<br />+üçé<br />+üçê<br />+üçä<br />+üçã<br />+üçí<br />+ü•ë<br /></code></pre></div></div>   <p>And removed files are similar, except with the new file being /dev/null</p>   <div class=\"language-bash highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"nt\">---</span> old\t2022-02-16 14:06:19.697132568 +0100<br />+++ /dev/null\t2022-02-15 11:47:16.100000270 +0100<br />@@ <span class=\"nt\">-1</span>,6 +0,0 @@<br />-üçé<br />-üçê<br />-üçä<br />-üçã<br />-üçí<br />-ü•ë<br /></code></pre></div></div> </blockquote>\n      <p><!--END_SNIPPET--></p>\n    </li>\n    <li>\n      <p>In your <code class=\"language-plaintext highlighter-rouge\">galaxyservers</code> group variables file, add the following:</p>\n\n      <div data-commit=\"Configure tiaas\" class=\"language-diff highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"gd\">--- a/group_vars/galaxyservers.yml\n</span><span class=\"gi\">+++ b/group_vars/galaxyservers.yml\n</span><span class=\"p\">@@ -349,3 +349,8 @@</span> telegraf_plugins_extra:\n       - timeout = \"10s\"\n       - data_format = \"influx\"\n       - interval = \"15s\"\n<span class=\"gi\">+\n+# TIaaS setup\n+tiaas_dir: /srv/tiaas\n+tiaas_admin_user: admin\n+tiaas_admin_pass: changeme\n</span>   \n</code></pre></div>      </div>\n    </li>\n    <li>\n      <p>In the <code class=\"language-plaintext highlighter-rouge\">galaxyservers</code> group variables file, we also need to set the database permissions correctly for TIaaS. It needs to be able to access some Galaxy tables, and we will carefully define only the ones we really need:</p>\n\n      <div data-commit=\"Add database privileges for TIaaS\" class=\"language-diff highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"gd\">--- a/group_vars/dbservers.yml\n</span><span class=\"gi\">+++ b/group_vars/dbservers.yml\n</span><span class=\"p\">@@ -3,6 +3,7 @@</span>\n postgresql_objects_users:\n   - name: \"{{ galaxy_user_name }}\"\n   - name: telegraf\n<span class=\"gi\">+  - name: tiaas\n</span> postgresql_objects_databases:\n   - name: \"{{ galaxy_db_name }}\"\n     owner: \"{{ galaxy_user_name }}\"\n<span class=\"p\">@@ -11,7 +12,26 @@</span> postgresql_objects_privileges:\n     roles: telegraf\n     privs: SELECT\n     objs: ALL_IN_SCHEMA\n<span class=\"gd\">-\n</span><span class=\"gi\">+  - database: galaxy\n+    roles: tiaas\n+    objs: galaxy_user,galaxy_session,job,history,workflow,workflow_invocation\n+    type: table\n+    privs: SELECT\n+  - database: galaxy\n+    roles: tiaas\n+    objs: user_group_association,galaxy_group,role,group_role_association\n+    type: table\n+    privs: SELECT,INSERT\n+  - database: galaxy\n+    roles: tiaas\n+    objs: group_role_association\n+    type: table\n+    privs: DELETE\n+  - database: galaxy\n+    roles: tiaas\n+    objs: role_id_seq,galaxy_group_id_seq,group_role_association_id_seq,user_group_association_id_seq\n+    type: sequence\n+    privs: USAGE,SELECT\n</span>    \n # PostgreSQL Backups\n postgresql_backup_dir: /data/backups\n   \n</code></pre></div>      </div>\n\n      <blockquote class=\"tip\">\n        <tip-title>Why does TIaaS get `DELETE` privileges on Galaxy's Database?</tip-title>\n        <p>The <code class=\"language-plaintext highlighter-rouge\">DELETE</code> privilege is limited in scope to one table: <code class=\"language-plaintext highlighter-rouge\">group_role_association</code>. This allows TIaaS to\ndisassociate training groups from roles in the Galaxy database after the training event date has passed, so that\nusers who participated in a training return to using normal (non-training) resources after the training ends.</p>\n\n        <p>The <code class=\"language-plaintext highlighter-rouge\">galaxyproject.tiaas2</code> role will create a <a href=\"https://manpages.debian.org/stable/cron/cron.8.en.html\">cron</a> job\nto perform this process every night at midnight. You can control when this runs (or disable it) using\n<a href=\"https://github.com/galaxyproject/ansible-tiaas2/blob/d5be2a064c49e010f67bfcea18e36812da23d7d8/defaults/main.yml#L20\">the tiaas_disassociate_training_roles variable</a>.</p>\n\n      </blockquote>\n\n      <blockquote class=\"tip\">\n        <tip-title>Running the playbook from scratch</tip-title>\n        <p>This is one of the few statements we‚Äôve provided that presents difficulties when running the playbook completely from scratch on a blank machine. Setting postgresql roles is one of the first steps in our playbook, but the rules we‚Äôve provided above depend on the Galaxy tables existing in that database. If those tables aren‚Äôt there, it will fail. If you do someday run this from scratch, you‚Äôll find that you need to comment out those roles.</p>\n      </blockquote>\n    </li>\n    <li>\n      <p>We need to add the <code class=\"language-plaintext highlighter-rouge\">galaxyproject.tiaas2</code> role before the <code class=\"language-plaintext highlighter-rouge\">nginx</code> role, as TIaaS defines variables that Nginx needs.</p>\n\n      <div data-commit=\"Add TIaaS role to the Galaxy playbook\" class=\"language-diff highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"gd\">--- a/galaxy.yml\n</span><span class=\"gi\">+++ b/galaxy.yml\n</span><span class=\"p\">@@ -47,6 +47,7 @@</span>\n     - galaxyproject.nginx\n     - geerlingguy.docker\n     - usegalaxy_eu.rabbitmqserver\n<span class=\"gi\">+    - galaxyproject.tiaas2\n</span>     - galaxyproject.gxadmin\n     - galaxyproject.cvmfs\n     - dj-wasabi.telegraf\n   \n</code></pre></div>      </div>\n    </li>\n    <li>\n      <p>Lastly we should add the routes for TIaaS to the NGINX template for Galaxy. TIaaS provides a set of default nginx routes that can be used.</p>\n\n      <div data-commit=\"Add nginx routes for TIaaS\" class=\"language-diff highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"gd\">--- a/templates/nginx/galaxy.j2\n</span><span class=\"gi\">+++ b/templates/nginx/galaxy.j2\n</span><span class=\"p\">@@ -113,4 +113,6 @@</span> server {\n \t\tproxy_set_header Host $http_host;\n \t}\n    \n<span class=\"gi\">+\t{{ tiaas_nginx_routes }}\n+\n</span> }\n   \n</code></pre></div>      </div>\n    </li>\n    <li>\n      <p>Run the playbook</p>\n\n      <blockquote class=\"code-in\">\n        <code-in-title>Bash</code-in-title>\n        <div data-cmd=\"true\" class=\"language-bash highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>ansible-playbook galaxy.yml\n</code></pre></div>        </div>\n      </blockquote>\n    </li>\n  </ol>\n\n</blockquote>\n\n<blockquote class=\"hidden\">\n  <div data-test=\"true\" class=\"language-bash highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>1.sh\n</code></pre></div>  </div>\n</blockquote>\n\n<p><abbr title=\"Training Infrastructure as a Service\">TIaaS</abbr> should be available now! The following routes on your server are now configured (we will run through these in the next section)</p>\n\n<table>\n  <thead>\n    <tr>\n      <th style=\"text-align: left\">URL</th>\n      <th>Use</th>\n      <th>Audience</th>\n    </tr>\n  </thead>\n  <tbody>\n    <tr>\n      <td style=\"text-align: left\"><a href=\"https://my.gat.galaxy.training/?path=/tiaas/new/\">/tiaas/new/</a></td>\n      <td>Request a new TIaaS training</td>\n      <td>Instructors</td>\n    </tr>\n    <tr>\n      <td style=\"text-align: left\"><a href=\"https://my.gat.galaxy.training/?path=/tiaas/admin/\">/tiaas/admin/</a></td>\n      <td>Approve and Manage requests</td>\n      <td>Admin</td>\n    </tr>\n    <tr>\n      <td style=\"text-align: left\"><a href=\"https://my.gat.galaxy.training/?path=/tiaas/stats/\">/tiaas/stats/</a></td>\n      <td>Overall TIaaS statistics (<a href=\"https://usegalaxy.eu/tiaas/stats/\">EU Stats</a>)</td>\n      <td>Admins, Funding Agencies</td>\n    </tr>\n    <tr>\n      <td style=\"text-align: left\"><a href=\"https://my.gat.galaxy.training/?path=/tiaas/calendar/\">/tiaas/calendar/</a></td>\n      <td>Calendar of trainings (<a href=\"https://usegalaxy.eu/tiaas/calendar/\">EU Calendar</a>)</td>\n      <td>Admins, Funding Agencies</td>\n    </tr>\n    <tr>\n      <td style=\"text-align: left\"><a href=\"https://my.gat.galaxy.training/?path=/join-training/ID\">/join-training/ID</a></td>\n      <td>Join an TIaaS training</td>\n      <td>Participants</td>\n    </tr>\n    <tr>\n      <td style=\"text-align: left\"><a href=\"https://my.gat.galaxy.training/?path=/join-training/ID/status\">/join-training/ID/status</a></td>\n      <td>Dashboard with job states of trainees.</td>\n      <td>Instructors</td>\n    </tr>\n  </tbody>\n</table>\n\n<p>Let‚Äôs see it in action!</p>\n\n<blockquote class=\"hands_on\">\n  <hands-on-title>Using TIaaS</hands-on-title>\n\n  <ol>\n    <li><strong>Create a new TIaaS request</strong>\n      <ul>\n        <li>Go to <a href=\"https://my.gat.galaxy.training/?path=/tiaas/new\">/tiaas/new</a></li>\n        <li>Here you will find the request form users will fill in to request TIaaS:\n<a href=\"../../images/tiaas/tiaas_request_form.png\" rel=\"noopener noreferrer\"><img src=\"../../images/tiaas/tiaas_request_form.png\" alt=\"TIaaS request form. \" width=\"880\" height=\"627\" loading=\"lazy\" /></a></li>\n        <li>For <em>‚ÄúTraining Identifier‚Äù</em>, fill in <code class=\"language-plaintext highlighter-rouge\">gat</code>\n          <ul>\n            <li>This is the <code class=\"language-plaintext highlighter-rouge\">&lt;training-id&gt;</code> used in the URLs listed above used for:\n              <ol>\n                <li>Workshop participants to join the tiaas group</li>\n                <li>Workshop instructors to monitor the progress of their participants.</li>\n              </ol>\n            </li>\n          </ul>\n        </li>\n        <li>Fill in the rest of the form as you like</li>\n        <li>Submit the form and you should see a confirmation dialog:\n<a href=\"../../images/tiaas/tiaas_request_form_submitted.png\" rel=\"noopener noreferrer\"><img src=\"../../images/tiaas/tiaas_request_form_submitted.png\" alt=\"TIaaS requested successfully. \" width=\"613\" height=\"170\" loading=\"lazy\" /></a></li>\n      </ul>\n    </li>\n    <li><strong>Approve TIaaS request</strong>\n      <ul>\n        <li>Next, the request will have to be approved by an admin</li>\n        <li>Go to <a href=\"https://my.gat.galaxy.training/?path=/tiaas/admin\">/tiaas/admin</a></li>\n        <li><strong>Log in</strong> using the values you configured <code class=\"language-plaintext highlighter-rouge\">tiaas_admin_user</code> and <code class=\"language-plaintext highlighter-rouge\">tiaas_admin_pass</code> in your group variables file\n          <ul>\n            <li>Default values were <code class=\"language-plaintext highlighter-rouge\">admin:changeme</code></li>\n          </ul>\n        </li>\n        <li>You should now see the admin panel:\n<a href=\"../../images/tiaas/tiaas_admin_console.png\" rel=\"noopener noreferrer\"><img src=\"../../images/tiaas/tiaas_admin_console.png\" alt=\"TIaaS admin console. \" width=\"731\" height=\"352\" loading=\"lazy\" /></a></li>\n        <li>Click on <strong>Trainings</strong>, you should see the TIaaS request listed here:\n<a href=\"../../images/tiaas/tiaas_request_list.png\" rel=\"noopener noreferrer\"><img src=\"../../images/tiaas/tiaas_request_list.png\" alt=\"TIaaS request list. \" width=\"737\" height=\"314\" loading=\"lazy\" /></a></li>\n        <li><strong>Approve the request</strong>\n          <ul>\n            <li>Click on the training</li>\n            <li>Scroll down to the bottom</li>\n            <li>Change <em>‚ÄúProcessed‚Äù</em> to <code class=\"language-plaintext highlighter-rouge\">Approved</code> and <strong>Save</strong>\n<a href=\"../../images/tiaas/tiaas_request_approve.png\" rel=\"noopener noreferrer\"><img src=\"../../images/tiaas/tiaas_request_approve.png\" alt=\"Approve TIaaS. \" width=\"698\" height=\"207\" loading=\"lazy\" /></a></li>\n          </ul>\n        </li>\n        <li>At this point, you would likely email the person who made the request to inform them of approval</li>\n      </ul>\n    </li>\n    <li><strong>Join TIaaS Training</strong>\n      <ul>\n        <li>Make sure you are logged in to Galaxy</li>\n        <li>On the day of the workshop, participants will visit a following URL to join the TIaaS group\n          <ul>\n            <li><a href=\"https://my.gat.galaxy.training/?path=/join-training/gat\">/join-training/gat</a></li>\n            <li>A confirmation dialog should appear if all went well:\n<a href=\"../../images/tiaas/tiaas_join_training.png\" rel=\"noopener noreferrer\"><img src=\"../../images/tiaas/tiaas_join_training.png\" alt=\"Join TIaaS. \" width=\"587\" height=\"153\" loading=\"lazy\" /></a></li>\n          </ul>\n        </li>\n      </ul>\n    </li>\n    <li><strong>Monitor TIaaS status</strong>\n      <ul>\n        <li>This is very useful for instructors to monitor the job state of their participants</li>\n        <li>Go to <a href=\"https://my.gat.galaxy.training/?path=/join-training/gat\">/join-training/gat</a></li>\n        <li>In the Dasboard you should see that one user (you) has joined the training \\</li>\n        <li>Run some jobs to see the dashboard in action\n<a href=\"../../images/tiaas/tiaas_dashboard.png\" rel=\"noopener noreferrer\"><img src=\"../../images/tiaas/tiaas_dashboard.png\" alt=\"TIaaS dashboard. \" width=\"1206\" height=\"685\" loading=\"lazy\" /></a></li>\n        <li>Scroll down to get some more information on a per-user level (anonymized)\n          <ul>\n            <li>Every user designated by their own identifier and colour, but no personal information\n<a href=\"../../images/tiaas/tiaas_dashboard2.png\" rel=\"noopener noreferrer\"><img src=\"../../images/tiaas/tiaas_dashboard2.png\" alt=\"TIaaS dashboard. \" width=\"1348\" height=\"640\" loading=\"lazy\" /></a></li>\n          </ul>\n        </li>\n      </ul>\n    </li>\n  </ol>\n\n</blockquote>\n\n<blockquote class=\"comment\">\n  <comment-title>Note: GDPR assistance</comment-title>\n\n  <p>Since this setup tracks additional personal information (submitter name &amp; email, users in the queue view), TIaaS includes some always-on features to assist with your GDPR compliance.</p>\n\n  <ul>\n    <li>Users in public status dashboard are only visible by an anonymized identifier and colour</li>\n    <li>Email addressses in the TIaaS admin panel will be automatically expunged 60 days after a training event</li>\n  </ul>\n\n  <p>Of course you need to review any GDPR compliance concerns with your group‚Äôs legal representative(s), this only attempts to ensure some protections exist for the users of the system.</p>\n\n</blockquote>\n\n<h1 id=\"job-configuration\">Job Configuration</h1>\n\n<p>While observability for teachers or trainers is already a huge benefit, one of the primary benefits of <abbr title=\"Training Infrastructure as a Service\">TIaaS</abbr> is that your jobs get sent to dedicated compute resources, which won‚Äôt be used by anyone else, during the period of the training. We will send all of the training jobs to pulsar if you have completed that tutorial, or one of the slurm destinations from the job configuration training.</p>\n\n<p>In order to achieve this, we first need some way to sort the jobs of the training users into these private queues, while letting the other jobs continue on. So let‚Äôs create a <em>traffic controller</em> to figure out where jobs belong.</p>\n\n<blockquote class=\"hands_on\">\n  <hands-on-title>Writing a dynamic job destination</hands-on-title>\n\n  <ol>\n    <li>\n      <p>This destination will check that the <code class=\"language-plaintext highlighter-rouge\">user_email</code> is in a training group (role starting with <code class=\"language-plaintext highlighter-rouge\">training-</code>).</p>\n\n      <div data-commit=\"Add to list of deployed rules\" class=\"language-diff highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"gd\">--- a/files/galaxy/config/tpv_rules_local.yml\n</span><span class=\"gi\">+++ b/files/galaxy/config/tpv_rules_local.yml\n</span><span class=\"p\">@@ -35,6 +35,15 @@</span> tools:\n       require:\n         - pulsar\n    \n<span class=\"gi\">+roles:\n+  training.*:\n+    max_cores: 2\n+    max_mem: max_cores * 3.8  # TODO check multiplier\n+    scheduling:\n+      require:\n+        - slurm\n+        - training\n+\n</span> destinations:\n   local_env:\n     runner: local_runner\n<span class=\"p\">@@ -62,6 +71,19 @@</span> destinations:\n     max_mem: 8\n     params:\n       native_specification: --nodes=1 --ntasks=1 --cpus-per-task={cores} --time={params['walltime']}:00:00\n<span class=\"gi\">+  slurm-training:\n+    inherits: singularity\n+    runner: slurm\n+    max_accepted_cores: 12\n+    max_accepted_mem: 120\n+    max_cores: 2 # Limit the cores\n+    max_mem: 8 # Limit the memory\n+    params:\n+      native_specification: --nodes=1 --ntasks=1 --mem={round(mem*1024)} --cpus-per-task={cores} --time=00:30:00\n+    scheduling:\n+      require:\n+        - slurm\n+        - training\n</span>    \n   pulsar:\n     runner: pulsar_runner\n   \n</code></pre></div>      </div>\n    </li>\n    <li>\n      <p>Run the playbook</p>\n\n      <blockquote class=\"code-in\">\n        <code-in-title>Bash</code-in-title>\n        <div data-cmd=\"true\" class=\"language-bash highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>ansible-playbook galaxy.yml\n</code></pre></div>        </div>\n      </blockquote>\n    </li>\n    <li>\n      <p>Ensure your user is joined to a training</p>\n    </li>\n    <li>\n      <p>Run a job and observe the logs to see where it goes (<code class=\"language-plaintext highlighter-rouge\">journalctl -u galaxy -f</code>)</p>\n    </li>\n  </ol>\n\n</blockquote>\n\n<p>Congratulations! you have now set up <abbr title=\"Training Infrastructure as a Service\">TIaaS</abbr> on your Galaxy server.</p>\n\n<blockquote class=\"hidden\">\n  <div data-test=\"true\" class=\"language-bash highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>2.sh\n</code></pre></div>  </div>\n</blockquote>\n\n<!--SNIPPET-->\n<blockquote class=\"hands_on\">   <div class=\"box-title hands_on-title\" id=\"hands-on-time-to-git-commit\"><i class=\"fas fa-pencil-alt\" aria-hidden=\"true\"></i> Hands-on: Time to git commit</div>   <p>It‚Äôs time to commit your work! Check the status with</p>   <div class=\"language-plaintext highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>git status<br /></code></pre></div></div>   <p>Add your changed files with</p>   <div class=\"language-plaintext highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>git add ... # any files you see that are changed<br /></code></pre></div></div>   <p>And then commit it!</p>   <div class=\"language-plaintext highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>git commit -m 'Finished Training Infrastructure as a Service (TIaaS)'<br /></code></pre></div></div> </blockquote>\n<p><!--END_SNIPPET--></p>\n\n<!--SNIPPET-->\n<blockquote class=\"comment\">   <div class=\"box-title comment-title\" id=\"comment-got-lost-along-the-way\"><i class=\"far fa-comment-dots\" aria-hidden=\"true\"></i> Comment: Got lost along the way?</div>   <p>If you missed any steps, you can compare against the <a href=\"https://github.com/hexylena/git-gat/tree/step-14\">reference files</a>, or see what changed since <a href=\"https://github.com/hexylena/git-gat/compare/step-13...step-14#files_bucket\">the previous tutorial</a>.</p>   <p>If you‚Äôre using <code class=\"language-plaintext highlighter-rouge\">git</code> to track your progress, remember to add your changes and commit with a good commit message!</p> </blockquote>\n<p><!--END_SNIPPET--></p>\n\n<!--SNIPPET-->\n<blockquote class=\"comment\">   <div class=\"box-title comment-title\" id=\"comment-galaxy-admin-training-path-1\"><i class=\"far fa-comment-dots\" aria-hidden=\"true\"></i> Comment: Galaxy Admin Training Path</div>   <p>The yearly Galaxy Admin Training follows a specific ordering of tutorials. Use this timeline to help keep track of where you are in Galaxy Admin Training.</p>   <ol id=\"git-gat-timeline\">                    <li class=\"disabled\">         <a href=\"/training-material/topics/admin/tutorials/ansible-galaxy/tutorial.html\">             <div>Step 1</div>             <div>ansible-galaxy</div>         </a>     </li>               <span aria-hidden=\"true\">         <i class=\"fas fa-arrow-right\" aria-hidden=\"true\"></i>     </span>                         <li class=\"disabled\">         <a href=\"/training-material/topics/admin/tutorials/backup-cleanup/tutorial.html\">             <div>Step 2</div>             <div>backup-cleanup</div>         </a>     </li>               <span aria-hidden=\"true\">         <i class=\"fas fa-arrow-right\" aria-hidden=\"true\"></i>     </span>                         <li class=\"disabled\">         <a href=\"/training-material/topics/admin/tutorials/customization/tutorial.html\">             <div>Step 3</div>             <div>customization</div>         </a>     </li>               <span aria-hidden=\"true\">         <i class=\"fas fa-arrow-right\" aria-hidden=\"true\"></i>     </span>                         <li class=\"disabled\">         <a href=\"/training-material/topics/admin/tutorials/tus/tutorial.html\">             <div>Step 4</div>             <div>tus</div>         </a>     </li>               <span aria-hidden=\"true\">         <i class=\"fas fa-arrow-right\" aria-hidden=\"true\"></i>     </span>                         <li class=\"disabled\">         <a href=\"/training-material/topics/admin/tutorials/cvmfs/tutorial.html\">             <div>Step 5</div>             <div>cvmfs</div>         </a>     </li>               <span aria-hidden=\"true\">         <i class=\"fas fa-arrow-right\" aria-hidden=\"true\"></i>     </span>                         <li class=\"disabled\">         <a href=\"/training-material/topics/admin/tutorials/apptainer/tutorial.html\">             <div>Step 6</div>             <div>apptainer</div>         </a>     </li>               <span aria-hidden=\"true\">         <i class=\"fas fa-arrow-right\" aria-hidden=\"true\"></i>     </span>                         <li class=\"disabled\">         <a href=\"/training-material/topics/admin/tutorials/tool-management/tutorial.html\">             <div>Step 7</div>             <div>tool-management</div>         </a>     </li>               <span aria-hidden=\"true\">         <i class=\"fas fa-arrow-right\" aria-hidden=\"true\"></i>     </span>                         <li class=\"disabled\">         <a href=\"/training-material/topics/admin/tutorials/reference-genomes/tutorial.html\">             <div>Step 8</div>             <div>reference-genomes</div>         </a>     </li>               <span aria-hidden=\"true\">         <i class=\"fas fa-arrow-right\" aria-hidden=\"true\"></i>     </span>                         <li class=\"disabled\">         <a href=\"/training-material/topics/admin/tutorials/data-library/tutorial.html\">             <div>Step 9</div>             <div>data-library</div>         </a>     </li>               <span aria-hidden=\"true\">         <i class=\"fas fa-arrow-right\" aria-hidden=\"true\"></i>     </span>                         <li class=\"disabled\">         <a href=\"/training-material/topics/dev/tutorials/bioblend-api/tutorial.html\">             <div>Step 10</div>             <div>dev/bioblend-api</div>         </a>     </li>               <span aria-hidden=\"true\">         <i class=\"fas fa-arrow-right\" aria-hidden=\"true\"></i>     </span>                         <li class=\"disabled\">         <a href=\"/training-material/topics/admin/tutorials/connect-to-compute-cluster/tutorial.html\">             <div>Step 11</div>             <div>connect-to-compute-cluster</div>         </a>     </li>               <span aria-hidden=\"true\">         <i class=\"fas fa-arrow-right\" aria-hidden=\"true\"></i>     </span>                         <li class=\"disabled\">         <a href=\"/training-material/topics/admin/tutorials/job-destinations/tutorial.html\">             <div>Step 12</div>             <div>job-destinations</div>         </a>     </li>               <span aria-hidden=\"true\">         <i class=\"fas fa-arrow-right\" aria-hidden=\"true\"></i>     </span>                         <li class=\"disabled\">         <a href=\"/training-material/topics/admin/tutorials/pulsar/tutorial.html\">             <div>Step 13</div>             <div>pulsar</div>         </a>     </li>               <span aria-hidden=\"true\">         <i class=\"fas fa-arrow-right\" aria-hidden=\"true\"></i>     </span>                         <li class=\"disabled\">         <a href=\"/training-material/topics/admin/tutorials/celery/tutorial.html\">             <div>Step 14</div>             <div>celery</div>         </a>     </li>               <span aria-hidden=\"true\">         <i class=\"fas fa-arrow-right\" aria-hidden=\"true\"></i>     </span>                         <li class=\"disabled\">         <a href=\"/training-material/topics/admin/tutorials/gxadmin/tutorial.html\">             <div>Step 15</div>             <div>gxadmin</div>         </a>     </li>               <span aria-hidden=\"true\">         <i class=\"fas fa-arrow-right\" aria-hidden=\"true\"></i>     </span>                         <li class=\"disabled\">         <a href=\"/training-material/topics/admin/tutorials/reports/tutorial.html\">             <div>Step 16</div>             <div>reports</div>         </a>     </li>               <span aria-hidden=\"true\">         <i class=\"fas fa-arrow-right\" aria-hidden=\"true\"></i>     </span>                         <li class=\"disabled\">         <a href=\"/training-material/topics/admin/tutorials/monitoring/tutorial.html\">             <div>Step 17</div>             <div>monitoring</div>         </a>     </li>               <span aria-hidden=\"true\">         <i class=\"fas fa-arrow-right\" aria-hidden=\"true\"></i>     </span>                         <li class=\"active\">         <a href=\"/training-material/topics/admin/tutorials/tiaas/tutorial.html\">             <div>Step 18</div>             <div>tiaas</div>         </a>     </li>               <span aria-hidden=\"true\">         <i class=\"fas fa-arrow-right\" aria-hidden=\"true\"></i>     </span>                         <li class=\"\">         <a href=\"/training-material/topics/admin/tutorials/sentry/tutorial.html\">             <div>Step 19</div>             <div>sentry</div>         </a>     </li>               <span aria-hidden=\"true\">         <i class=\"fas fa-arrow-right\" aria-hidden=\"true\"></i>     </span>                         <li class=\"\">         <a href=\"/training-material/topics/admin/tutorials/ftp/tutorial.html\">             <div>Step 20</div>             <div>ftp</div>         </a>     </li>               <span aria-hidden=\"true\">         <i class=\"fas fa-arrow-right\" aria-hidden=\"true\"></i>     </span>                         <li class=\"\">         <a href=\"/training-material/topics/admin/tutorials/beacon/tutorial.html\">             <div>Step 21</div>             <div>beacon</div>         </a>     </li>           </ol> </blockquote>\n<p><!--END_SNIPPET--></p>\n"],"ref_slides":[],"video_library":{"tutorial":{"description":null,"materials":[{"link":"topics/admin/tutorials/tiaas/tutorial.html","type":"Tutorial"}],"tags":["admin"],"type":"Tutorial","versions":[{"captions":["hexylena","shiltemann"],"date":"2021-02-15","galaxy_version":"21.01","length":"24M","link":"tz0ZbK_8Vcc","speakers":["hexylena"]}],"gtn_id":"admin/tiaas","title":"Training Infrastructure as a Service (TIaaS)","captioned":true},"slides":null,"demo":null,"both":null,"session":null},"hands_on":true,"slides":false,"mod_date":"2024-01-31 16:33:56 +0000","pub_date":"2020-02-12 14:46:40 +0000","version":102,"api":"https://training.galaxyproject.org/training-material/api/topics/admin/tutorials/tiaas/tutorial.json","tools":[],"supported_servers":[],"topic_name_human":"Galaxy Server administration","admin_install":{"install_tool_dependencies":true,"install_repository_dependencies":true,"install_resolver_dependencies":true,"tools":[]},"admin_install_yaml":"---\ninstall_tool_dependencies: true\ninstall_repository_dependencies: true\ninstall_resolver_dependencies: true\ntools: []\n","tours":false,"video":false,"translations":{"tutorial":[],"slides":[],"video":false},"license":"CC-BY-4.0","type":"tutorial"}