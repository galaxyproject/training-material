<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
        <title>Galaxy Monitoring with Telegraf and Grafana</title>
        <link rel="stylesheet" href="/training-material/assets/css/bootstrap.min.css?v=3">
        <link rel="stylesheet" href="/training-material/assets/css/bootstrap-toc.min.css">
        <link rel="stylesheet" href="/training-material/assets/css/main.css?v=2">
        <script src="https://kit.fontawesome.com/67b3f98409.js" crossorigin="anonymous"></script>
        <link rel="stylesheet" href="/training-material/assets/css/academicons.css">
        <link rel="stylesheet" href="/training-material/assets/css/syntax_highlighting.css">
        <link rel="shortcut icon" href="/training-material/favicon.ico" type="image/x-icon" />

        
        
        
        
        
        <meta name="description" content="Resources related to configuration and maintenance of Gal..." />
        <meta property="og:title" content="Galaxy Training: Galaxy Monitoring with Telegraf and Grafana" />
        <meta property="og:description" content="Resources related to configuration and maintenance of Gal..." />
        <meta property="og:image" content="/training-material/assets/images/GTNLogo1000.png" />
    </head>
    <body data-spy="scroll" data-target="#toc">
        











<!-- Gitter -->


<script>
  ((window.gitter = {}).chat = {}).options = {
  room: 'galaxyproject/admins'
  };
</script>
<script src="https://sidecar.gitter.im/dist/sidecar.v1.js" async defer></script>

<header>
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand" href="/training-material/">
                <img src="/training-material/assets/images/GTN-60px.png" height="30" alt="Galaxy Training Network logo">
                Galaxy Training!
            </a>

            <button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse" data-target="#top-navbar" aria-controls="top-navbar" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="top-navbar">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="/training-material/topics/admin" title="Go back to list of tutorials">
                            <i class="far fa-folder" aria-hidden="true"></i><span class="visually-hidden">topic</span> Galaxy Server administration
                        </a>
                    </li>

                    <li class="nav-item dropdown">
                        <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown" aria-expanded="false" title="Language Selector">
                            <i class="fas fa-language" aria-hidden="true"></i><span class="visually-hidden">language</span> Language
                        </a>
                        <div class="dropdown-menu">
                            
                            <a class="dropdown-item" href="https://translate.google.com/translate?hl=jp&sl=en&tl=fr&u=https%3A%2F%2Ftraining.galaxyproject.org%2Ftopics%2Fadmin%2Ftutorials%2Fmonitoring%2Ftutorial.html&edit-text=&act=url" title="">
                                Fran√ßais
                            </a>
                            
                            <a class="dropdown-item" href="https://translate.google.com/translate?hl=jp&sl=en&tl=ja&u=https%3A%2F%2Ftraining.galaxyproject.org%2Ftopics%2Fadmin%2Ftutorials%2Fmonitoring%2Ftutorial.html&edit-text=&act=url" title="">
                                Êó•Êú¨Ë™û
                            </a>
                            
                            <a class="dropdown-item" href="https://translate.google.com/translate?hl=jp&sl=en&tl=es&u=https%3A%2F%2Ftraining.galaxyproject.org%2Ftopics%2Fadmin%2Ftutorials%2Fmonitoring%2Ftutorial.html&edit-text=&act=url" title="">
                                Espa√±ol
                            </a>
                            
                            <a class="dropdown-item" href="https://translate.google.com/translate?hl=jp&sl=en&tl=pt&u=https%3A%2F%2Ftraining.galaxyproject.org%2Ftopics%2Fadmin%2Ftutorials%2Fmonitoring%2Ftutorial.html&edit-text=&act=url" title="">
                                Portugu√™s
                            </a>
                            
                            <a class="dropdown-item" href="https://translate.google.com/translate?hl=jp&sl=en&tl=ar&u=https%3A%2F%2Ftraining.galaxyproject.org%2Ftopics%2Fadmin%2Ftutorials%2Fmonitoring%2Ftutorial.html&edit-text=&act=url" title="">
                                ÿßŸÑÿπÿ±ÿ®Ÿäÿ©
                            </a>
                            
                            <a class="dropdown-item" href="https://translate.google.com/translate?hl=jp&sl=en&tl=&u=https%3A%2F%2Ftraining.galaxyproject.org%2Ftopics%2Fadmin%2Ftutorials%2Fmonitoring%2Ftutorial.html&edit-text=&act=url" title="">
                                And more!
                            </a>
                        </div>
                    </li>

                    <li class="nav-item dropdown">
    <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown" aria-expanded="false" title="Help">
        <i class="far fa-question-circle" aria-hidden="true"></i><span class="visually-hidden">help</span> Help
    </a>
    <div class="dropdown-menu dropdown-menu-right">
        <form method="get" action="https://tess.elixir-europe.org/materials">
            <input type="text" id="search" name="q" value="" style="margin-left: 0.5em;/*! border-radius: 0px; */">
            <input type="hidden" value="Galaxy Training" name="content_provider">
            <input type="submit" value="Search on TeSS" style="width: 92%;border-radius: 0px;margin: 0.5em;background: #f47d20;border: 0px;padding: 0.25em;" class="">
        </form>

        <div class="dropdown-divider"></div>
        <a class="dropdown-item" href="/training-material/faq" title="Check our FAQ">
            FAQ
        </a>
        <a class="dropdown-item" href="https://help.galaxyproject.org/" title="Discuss on Galaxy Help">
            Discuss on Galaxy Help
        </a>

        <div class="dropdown-item">
            <div>
                Theme
            </div>

            <div id="theme-selector" data-toggle="buttons">
                <label data-value="default" class="btn btn-secondary">
                    <input type="radio" name="options" id="default" autocomplete="off"> Default
                </label>
                <label data-value="night" class="btn btn-secondary">
                    <input type="radio" name="options" id="night" autocomplete="off"> Night
                </label>
                <label data-value="midnight" class="btn btn-secondary">
                    <input type="radio" name="options" id="midnight" autocomplete="off"> Midnight
                </label>
                <label data-value="rainbow" class="btn btn-secondary">
                    <input type="radio" name="options" id="rainbow" autocomplete="off"> Rainbow
                </label>
                <label data-value="halloween" class="btn btn-secondary">
                    <input type="radio" name="options" id="halloween" autocomplete="off"> üéÉ
                </label>
            </div>

        </div>
    </div>
</li>


                    <li class="nav-item">
                        <a class="nav-link" href="https://github.com/galaxyproject/training-material/edit/master/topics/admin/tutorials/monitoring/tutorial.md">
                            <i class="fab fa-github" aria-hidden="true"></i><span class="visually-hidden">github</span> Edit
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>
</header>

<div class="container main-content">
    <script type="application/ld+json">
        


{
  "@context": "http://schema.org",
  "@type": "Course",
  "accessMode": [
    "textual",
    "visual"
  ],
  "accessModeSufficient": [
    "textual",
    "visual"
  ],
  "accessibilityControl": [
    "fullKeyboardControl",
    "fullMouseControl"
  ],
  "accessibilityFeature": [
    "alternativeText",
    "tableOfContents"
  ],
  "accessibilitySummary": "Short descriptions are present but long descriptions will be needed for non-visual users",
  "audience": {
    "@type": "EducationalAudience",
    "educationalRole": "students"
  },
  "citation": {
    "@type": "CreativeWork",
    "name": "Community-Driven Data Analysis Training for Biology",
    "url": "https://doi.org/10.1016/j.cels.2018.05.012"
  },
  "copyrightHolder": {
    "@type": "Organization",
    "email": "galaxytrainingnetwork@gmail.com",
    "name": "Galaxy Training Network",
    "url": "https://galaxyproject.org/teach/gtn/"
  },
  "discussionUrl": "https://gitter.im/Galaxy-Training-Network/Lobby",
  "headline": "Galaxy Monitoring with Telegraf and Grafana",
  "inLanguage": {
    "@type": "Language",
    "name": "English",
    "alternateName": "en"
  },
  "interactivityType": "mixed",
  "isAccessibleForFree": true,
  "license": "https://github.com/galaxyproject/training-material/blob/master/LICENSE.md",
  "producer": {
    "@type": "Organization",
    "email": "galaxytrainingnetwork@gmail.com",
    "name": "Galaxy Training Network",
    "url": "https://galaxyproject.org/teach/gtn/"
  },
  "provider": {
    "@type": "Organization",
    "email": "galaxytrainingnetwork@gmail.com",
    "name": "Galaxy Training Network",
    "url": "https://galaxyproject.org/teach/gtn/"
  },
  "sourceOrganization": {
    "@type": "Organization",
    "email": "galaxytrainingnetwork@gmail.com",
    "name": "Galaxy Training Network",
    "url": "https://galaxyproject.org/teach/gtn/"
  },
  "isPartOf": {
    "@type": "CreativeWork",
    "name": "Galaxy Server administration",
    "description": "Resources related to configuration and maintenance of Galaxy servers",
    "url": "https://training.galaxyproject.org//training-material/topics/admin/"
  },
  "courseCode": "admin / monitoring / hands-on",
  "learningResourceType": "hands-on tutorial",
  "name": "Hands-on for 'Galaxy Monitoring with Telegraf and Grafana' tutorial",
  "url": "https://training.galaxyproject.org//training-material/topics/admin/tutorials/monitoring/tutorial.html",
  "timeRequired": "PT2H",
  "keywords": "monitoring",
  "description": "The questions this  addresses are:\n - How to monitor Galaxy with Telegraf\n - How do I set up InfluxDB\n - How can I make graphs in Grafana?\n - How can I best alert on important metrics?\n\n\\nThe objectives are:\n - Setup InfluxDB\n - Setup Telegraf\n - Setup Grafana\n - Create several charts\n\n",
  "coursePrerequisites": [
    {
      "@type": "Course",
      "url": "https://training.galaxyproject.org//training-material/topics/admin/tutorials/ansible/slides.html",
      "name": "Ansible",
      "description": "Slides for 'Ansible' tutorial",
      "learningResourceType": "slides",
      "interactivityType": "expositive",
      "provider": {
        "@type": "Organization",
        "email": "galaxytrainingnetwork@gmail.com",
        "name": "Galaxy Training Network",
        "url": "https://galaxyproject.org/teach/gtn/"
      }
    },
    {
      "@type": "Course",
      "url": "https://training.galaxyproject.org//training-material/topics/admin/tutorials/ansible/tutorial.html",
      "name": "Ansible",
      "description": "Hands-on for 'Ansible' tutorial",
      "learningResourceType": "hands-on tutorial",
      "interactivityType": "expositive",
      "provider": {
        "@type": "Organization",
        "email": "galaxytrainingnetwork@gmail.com",
        "name": "Galaxy Training Network",
        "url": "https://galaxyproject.org/teach/gtn/"
      }
    },
    {
      "@type": "Course",
      "url": "https://training.galaxyproject.org//training-material/topics/admin/tutorials/ansible-galaxy/slides.html",
      "name": "Galaxy Installation with Ansible",
      "description": "Slides for 'Galaxy Installation with Ansible' tutorial",
      "learningResourceType": "slides",
      "interactivityType": "expositive",
      "provider": {
        "@type": "Organization",
        "email": "galaxytrainingnetwork@gmail.com",
        "name": "Galaxy Training Network",
        "url": "https://galaxyproject.org/teach/gtn/"
      }
    },
    {
      "@type": "Course",
      "url": "https://training.galaxyproject.org//training-material/topics/admin/tutorials/ansible-galaxy/tutorial.html",
      "name": "Galaxy Installation with Ansible",
      "description": "Hands-on for 'Galaxy Installation with Ansible' tutorial",
      "learningResourceType": "hands-on tutorial",
      "interactivityType": "expositive",
      "provider": {
        "@type": "Organization",
        "email": "galaxytrainingnetwork@gmail.com",
        "name": "Galaxy Training Network",
        "url": "https://galaxyproject.org/teach/gtn/"
      }
    },
    {
      "@type": "Course",
      "url": "https://training.galaxyproject.org//training-material/topics/admin/tutorials/gxadmin/slides.html",
      "name": "Galaxy Monitoring with gxadmin",
      "description": "Slides for 'Galaxy Monitoring with gxadmin' tutorial",
      "learningResourceType": "slides",
      "interactivityType": "expositive",
      "provider": {
        "@type": "Organization",
        "email": "galaxytrainingnetwork@gmail.com",
        "name": "Galaxy Training Network",
        "url": "https://galaxyproject.org/teach/gtn/"
      }
    },
    {
      "@type": "Course",
      "url": "https://training.galaxyproject.org//training-material/topics/admin/tutorials/gxadmin/tutorial.html",
      "name": "Galaxy Monitoring with gxadmin",
      "description": "Hands-on for 'Galaxy Monitoring with gxadmin' tutorial",
      "learningResourceType": "hands-on tutorial",
      "interactivityType": "expositive",
      "provider": {
        "@type": "Organization",
        "email": "galaxytrainingnetwork@gmail.com",
        "name": "Galaxy Training Network",
        "url": "https://galaxyproject.org/teach/gtn/"
      }
    }
  ],
  "hasPart": [

  ],
  "author": [
    {
      "@type": "Person",
      "name": "Helena Rasche"
    }
  ],
  "contributor": [
    {
      "@type": "Person",
      "name": "Helena Rasche"
    }
  ],
  "about": [
    {
      "@type": "CreativeWork",
      "name": "Galaxy Server administration",
      "description": "Resources related to configuration and maintenance of Galaxy servers",
      "url": "https://training.galaxyproject.org//training-material/topics/admin/"
    }
  ]
}
    </script>

    <section class="tutorial">
        <h1 data-toc-skip>Galaxy Monitoring with Telegraf and Grafana</h1>
        

        <div class="contributors-line">By: 

<a href="/training-material/hall-of-fame/hexylena/" class="contributor-badge"><img src="https://avatars.githubusercontent.com/hexylena" alt="Helena Rasche">Helena Rasche</a>

</div>

        <blockquote class="overview">
            <h3>Overview</h3>
            <strong><i class="far fa-question-circle" aria-hidden="true"></i><span class="visually-hidden">question</span> Questions</strong>
            <ul>
            
            <li><p>How to monitor Galaxy with Telegraf</p>
</li>
            
            <li><p>How do I set up InfluxDB</p>
</li>
            
            <li><p>How can I make graphs in Grafana?</p>
</li>
            
            <li><p>How can I best alert on important metrics?</p>
</li>
            
            </ul>

            <strong><i class="fas fa-bullseye" aria-hidden="true"></i><span class="visually-hidden">objectives</span> Objectives</strong>
            <ul>
            
            <li><p>Setup InfluxDB</p>
</li>
            
            <li><p>Setup Telegraf</p>
</li>
            
            <li><p>Setup Grafana</p>
</li>
            
            <li><p>Create several charts</p>
</li>
            
            </ul>

            
            <strong><i class="fas fa-check-circle" aria-hidden="true"></i><span class="visually-hidden">requirements</span> Requirements</strong>
            <ul>
            
            
    <li>
    
        
        
        <a href="/training-material/topics/admin">Galaxy Server administration</a>
        
            <ul>
                
                    
                        
                    
                        
                    
                        
                            
                            <li> Ansible:
                            
                                <a href="/training-material/topics/admin/tutorials/ansible/slides.html"><i class="fab fa-slideshare" aria-hidden="true"></i><span class="visually-hidden">slides</span> slides</a>
                                
                            
                            
                                
                                    - <a href="/training-material/topics/admin/tutorials/ansible/tutorial.html"><i class="fas fa-laptop" aria-hidden="true"></i><span class="visually-hidden">tutorial</span> hands-on</a>
                                
                            
                            </li>
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                            
                            <li> Galaxy Installation with Ansible:
                            
                                <a href="/training-material/topics/admin/tutorials/ansible-galaxy/slides.html"><i class="fab fa-slideshare" aria-hidden="true"></i><span class="visually-hidden">slides</span> slides</a>
                                
                            
                            
                                
                                    - <a href="/training-material/topics/admin/tutorials/ansible-galaxy/tutorial.html"><i class="fas fa-laptop" aria-hidden="true"></i><span class="visually-hidden">tutorial</span> hands-on</a>
                                
                            
                            </li>
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                            
                            <li> Galaxy Monitoring with gxadmin:
                            
                                <a href="/training-material/topics/admin/tutorials/gxadmin/slides.html"><i class="fab fa-slideshare" aria-hidden="true"></i><span class="visually-hidden">slides</span> slides</a>
                                
                            
                            
                                
                                    - <a href="/training-material/topics/admin/tutorials/gxadmin/tutorial.html"><i class="fas fa-laptop" aria-hidden="true"></i><span class="visually-hidden">tutorial</span> hands-on</a>
                                
                            
                            </li>
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                
            </ul>
        
    
    </li>

            </ul>
            

            
            <p><strong><i class="fas fa-hourglass-half" aria-hidden="true"></i><span class="visually-hidden">time</span> Time estimation:</strong> 2 hours</p>
            

            

            
            

            
            <p id="supporting-materials"><strong><i class="fa fa-external-link" aria-hidden="true"></i> Supporting Materials</strong></p>
            <ul>
                <div class="supporting_material">
                
                    <li class="btn btn-default"><a href="/training-material/topics/admin/tutorials/monitoring/slides.html" title="Slides for this tutorial">
                        <i class="fab fa-slideshare" aria-hidden="true"></i><span class="visually-hidden">slides</span> Slides
                    </a></li>
                

                

                

                

                
                </div>
            </ul>
            

            <p><strong> <i class="far fa-calendar" aria-hidden="true"></i><span class="visually-hidden">last_modification</span> Last modification:</strong> Jan 6, 2021 </p>
        </blockquote>

        <div class="container">
            <div class="row">
                <!-- sidebar, which will move to the top on a small screen -->
                <div class="col-sm-2">
                    <nav id="toc" data-toggle="toc" class="sticky-top"></nav>
                </div>
                <div class="col-sm-10">
                    <h1 class="no_toc" id="overview">Overview</h1>

<p>Monitoring is an incredibly important part of server monitoring and maintenance. Being able to observe trends and identify hot spots by collecting metrics gives you a significant ability to respond to any issues that arise in production. Monitoring is quite easy to get started with, it can be as simple as writing a quick shell script in order to start collecting metrics.</p>

<blockquote class="agenda">
  <h3 id="agenda">Agenda</h3>

<ol id="markdown-toc">
  <li><a href="#data-flow" id="markdown-toc-data-flow">Data Flow</a></li>
  <li><a href="#infrastructure" id="markdown-toc-infrastructure">Infrastructure</a>    <ol>
      <li><a href="#influxdb" id="markdown-toc-influxdb">InfluxDB</a></li>
      <li><a href="#grafana" id="markdown-toc-grafana">Grafana</a></li>
      <li><a href="#telegraf" id="markdown-toc-telegraf">Telegraf</a></li>
    </ol>
  </li>
  <li><a href="#monitoring-with-grafana" id="markdown-toc-monitoring-with-grafana">Monitoring with Grafana</a>    <ol>
      <li><a href="#importing-a-dashboard" id="markdown-toc-importing-a-dashboard">Importing a dashboard</a></li>
      <li><a href="#setting-up-a-galaxy-dashboard" id="markdown-toc-setting-up-a-galaxy-dashboard">Setting up a <span class="notranslate">Galaxy</span> dashboard</a></li>
      <li><a href="#styling" id="markdown-toc-styling">Styling</a></li>
      <li><a href="#monitoring" id="markdown-toc-monitoring">Monitoring</a></li>
    </ol>
  </li>
  <li><a href="#telegraf--gxadmin" id="markdown-toc-telegraf--gxadmin">Telegraf &amp; <code class="language-plaintext highlighter-rouge">gxadmin</code></a>    <ol>
      <li><a href="#installing-gxadmin" id="markdown-toc-installing-gxadmin">Installing gxadmin</a></li>
      <li><a href="#configuring-telegraf-for-gxadmin" id="markdown-toc-configuring-telegraf-for-gxadmin">Configuring Telegraf for gxadmin</a></li>
    </ol>
  </li>
  <li><a href="#conclusion" id="markdown-toc-conclusion">Conclusion</a></li>
</ol>

</blockquote>

<p>This tutorial explicitly assumes you are starting with a setup like that created in the <em><span class="notranslate">Galaxy</span> installation with Ansible</em> tutorial</p>

<h1 id="data-flow">Data Flow</h1>

<p>The monitoring setup we (Use<span class="notranslate">Galaxy</span>.*) use involves compute nodes collecting metrics and forwarding the data to a central collector. On each node we have a data collector running (Telegraf) which collects data from numerous sources before aggregating it and forwarding it onwards. On another, sometimes public, node we accept and collect all of these metrics (InfluxDB) and provide an interface to visualise and query that data (Grafana).</p>

<p>For Use<span class="notranslate">Galaxy</span>.eu, we pre-install Telegraf on our compute node images. Whenever we launch new compute nodes, they automatically start sending data to our central collection point. Telegraf additionally provides a nice feature of aggregating metrics it collects, batching them up before sending them off to InfluxDB. Telegraf has built in data collectors, or can run command line scripts and tools which output specifically formatted data.</p>

<p>Telegraf communicates with InfluxDB using a JSON based HTTP API, making it easy to write custom tooling to send data there, if need be. Grafana provides the visualisation component, the most interesting component for most consumers of the metrics and monitoring.</p>

<h1 id="infrastructure">Infrastructure</h1>

<p>Setting up the infrastructure is quite simple thanks to the automation provided by Ansible. We will first setup a playbook for a ‚Äúmonitoring‚Äù machine, which will collect and visualize our data using InfluxDB and Grafana. We will then expand the <span class="notranslate">Galaxy</span> playbook to include Telegraf on the machine to monitor both it and <span class="notranslate">Galaxy</span> itself. In this tutorial we will do everything on the same machine. In practice you can separate these services to different machines, if you wish. The only requirement is that Telegraf run on the machine from which you wish to collect data.</p>

<h2 id="influxdb">InfluxDB</h2>

<p><a href="https://www.influxdata.com/">InfluxDB</a> provides the data storage for monitoring. It is a <abbr title="Time Series Database">TSDB</abbr>, so it has been designed specifically for storing time-series data like monitoring and metrics. There are other TSBD options for storing data but we have had good experiences with this one. TSBDs commonly feature some form of automatic data expiration after a set period of time. In InfluxDB these are known as ‚Äúretention policies‚Äù. Outside of this feature, it is a <a href="https://docs.influxdata.com/influxdb/v1.7/concepts/crosswalk/">relatively normal database</a>.</p>

<p>The available Ansible roles for InfluxDB unfortunately do not support configuring databases or users or retention policies. Ansible itself contains <a href="https://docs.ansible.com/ansible/2.9/modules/list_of_database_modules.html#influxdb">several modules</a> you can use to write your own roles, but nothing generic. Use<span class="notranslate">Galaxy</span>.eu wrote <a href="https://github.com/usegalaxy-eu/infrastructure-playbook/blob/master/roles/hxr.influxdb/tasks/main.yml">their own role</a> for setting up their InfluxDB database, but it is not reusable enough for it to be used here yet. If you plan to automate your entire setup, this tutorial can perhaps provide inspiration for writing your own Ansible role. However, in this case it is sufficient to manually create your users and retention policies as a one-off task.</p>

<blockquote class="notranslate hands_on">
  <h3 id="hands_on-hands-on-setting-up-influxdb"><i class="fas fa-pencil-alt" aria-hidden="true"></i><span class="visually-hidden">hands_on</span> Hands-on: Setting up InfluxDB</h3>

  <ol>
    <li>
      <p>Edit your <code class="language-plaintext highlighter-rouge">requirements.yml</code> and add the following:</p>

      <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="pi">-</span> <span class="na">src</span><span class="pi">:</span> <span class="s">use<span class="notranslate">galaxy</span>_eu.influxdb</span>
  <span class="na">version</span><span class="pi">:</span> <span class="s">v6.0.3</span>
</code></pre></div>      </div>
    </li>
    <li>
      <p><code class="language-plaintext highlighter-rouge">ansible-<span class="notranslate">galaxy</span> install -p roles -r requirements.yml</code></p>
    </li>
    <li>
      <p>Create a new playbook, <code class="language-plaintext highlighter-rouge">monitoring.yml</code> with the following:</p>

      <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">---</span>
<span class="pi">-</span> <span class="na">hosts</span><span class="pi">:</span> <span class="s">monitoring</span>
  <span class="na">become</span><span class="pi">:</span> <span class="no">true</span>
  <span class="na">roles</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">use<span class="notranslate">galaxy</span>_eu.influxdb</span>
</code></pre></div>      </div>

      <p>During this tutorial we will install everything on the same host, but often one keeps the monitoring infrastructure (Grafana, InfluxDB) on a separate host.</p>
    </li>
    <li>
      <p>Edit the inventory file (<code class="language-plaintext highlighter-rouge">hosts</code>) an add a group for monitoring like:</p>

      <div class="language-ini highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">[monitoring]</span>
<span class="err">training-0.example.org</span> <span class="py">ansible_connection</span><span class="p">=</span><span class="s">local</span>
</code></pre></div>      </div>

      <p><strong>Ensure that the hostname is the full hostname of your machine.</strong></p>
    </li>
    <li>
      <p>Run the playbook:</p>

      <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ansible-playbook monitoring.yml
</code></pre></div>      </div>
    </li>
  </ol>

</blockquote>

<p>This will setup an InfluxDB server listening on port <code class="language-plaintext highlighter-rouge">:8086</code>. The service is currently unauthenticated but it is only listening on <code class="language-plaintext highlighter-rouge">localhost</code> so it is less of a concern. The service can be authenticated and SSL configured quite easily but that is outside the scope of this tutorial.</p>

<p>You can access the InfluxDB service by running the command <code class="language-plaintext highlighter-rouge">influx</code>.</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">$</span> <span class="n">influx</span>
<span class="n">Connected</span> <span class="k">to</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">localhost</span><span class="p">:</span><span class="mi">8086</span> <span class="k">version</span> <span class="mi">1</span><span class="p">.</span><span class="mi">7</span><span class="p">.</span><span class="mi">7</span>
<span class="n">InfluxDB</span> <span class="n">shell</span> <span class="k">version</span><span class="p">:</span> <span class="mi">1</span><span class="p">.</span><span class="mi">7</span><span class="p">.</span><span class="mi">7</span>
<span class="o">&gt;</span> <span class="k">show</span> <span class="n">databases</span>
<span class="n">name</span><span class="p">:</span> <span class="n">databases</span>
<span class="n">name</span>
<span class="c1">----</span>
<span class="n">_inte<span class="notranslate">rna</span>l</span>
<span class="o">&gt;</span> <span class="n">use</span> <span class="n">_inte<span class="notranslate">rna</span>l</span>
<span class="k">Using</span> <span class="k">database</span> <span class="n">_inte<span class="notranslate">rna</span>l</span>
<span class="o">&gt;</span> <span class="k">show</span> <span class="n">measurements</span>
<span class="n">name</span><span class="p">:</span> <span class="n">measurements</span>
<span class="n">name</span>
<span class="c1">----</span>
<span class="n">cq</span>
<span class="k">database</span>
<span class="n">httpd</span>
<span class="n">queryExecutor</span>
<span class="n">runtime</span>
<span class="n">shard</span>
<span class="n">subscriber</span>
<span class="n">tsm1_cache</span>
<span class="n">tsm1_engine</span>
<span class="n">tsm1_filestore</span>
<span class="n">tsm1_wal</span>
<span class="k">write</span>
</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">influx</code> command provides command line access to InfluxDB in a similar fashion to <code class="language-plaintext highlighter-rouge">psql</code> for Postgresql. It provides commands like <code class="language-plaintext highlighter-rouge">show databases</code> and others, but we will not use this interface very often. Telegraf will automatically try to create any database needed, and no interaction is required to setup Grafana to talk to the database.</p>

<h2 id="grafana">Grafana</h2>

<p><a href="https://grafana.com/">Grafana</a> provides a visual interface to our metrics. It includes a nice query builder that provides a uniform experience across multiple backend databases, along with many attractive graphing and other visualization options. Each page in the Grafana webserver display is called a ‚Äúdashboard.‚Äù Dashboards can each have multiple visualizations and graphs, all responding to the data collected by InfluxDB. Another benefit of using Grafana is that many of the Use<span class="notranslate">Galaxy</span>.* servers share their dashboards publicly, and you can easily copy these and use them on your own server.</p>

<p>There are some nice examples of dashboards available from the public Galaxies, we recommend that you peruse them to get an idea of the possibilities:</p>

<ul>
  <li><a href="https://stats.galaxyproject.eu/">Use<span class="notranslate">Galaxy</span>.eu</a></li>
  <li><a href="https://stats.genome.edu.au/">Use<span class="notranslate">Galaxy</span>.org.au</a></li>
</ul>

<blockquote class="notranslate hands_on">
  <h3 id="hands_on-hands-on-setting-up-grafana"><i class="fas fa-pencil-alt" aria-hidden="true"></i><span class="visually-hidden">hands_on</span> Hands-on: Setting up Grafana</h3>

  <ol>
    <li>
      <p>Edit your <code class="language-plaintext highlighter-rouge">requirements.yml</code> and add the following:</p>

      <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="pi">-</span> <span class="na">src</span><span class="pi">:</span> <span class="s">cloudalchemy.grafana</span>
  <span class="na">version</span><span class="pi">:</span> <span class="s">0.14.2</span>
</code></pre></div>      </div>
    </li>
    <li>
      <p><code class="language-plaintext highlighter-rouge">ansible-<span class="notranslate">galaxy</span> install -p roles -r requirements.yml</code></p>
    </li>
    <li>
      <p>Add <code class="language-plaintext highlighter-rouge">cloudalchemy.grafana</code> to your <code class="language-plaintext highlighter-rouge">monitoring.yml</code> playbook</p>
    </li>
    <li>
      <p>Edit the file <code class="language-plaintext highlighter-rouge">group_vars/monitoring.yml</code> and set the following variables:</p>

      <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">grafana_url</span><span class="pi">:</span> <span class="s2">"</span><span class="s">https://{{</span><span class="nv"> </span><span class="s">inventory_hostname</span><span class="nv"> </span><span class="s">}}/grafana/"</span>

<span class="na">grafana_security</span><span class="pi">:</span>
    <span class="c1"># Please change at least the password to something more suitable</span>
    <span class="na">admin_user</span><span class="pi">:</span> <span class="s">admin</span>
    <span class="na">admin_password</span><span class="pi">:</span> <span class="s">password</span>

<span class="c1"># These datasources will be automatically included into Grafana</span>
<span class="na">grafana_datasources</span><span class="pi">:</span>
 <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s"><span class="notranslate">Galaxy</span></span>
   <span class="na">type</span><span class="pi">:</span> <span class="s">influxdb</span>
   <span class="na">access</span><span class="pi">:</span> <span class="s">proxy</span>
   <span class="na">url</span><span class="pi">:</span> <span class="s">http://127.0.0.1:8086</span>
   <span class="na">isDefault</span><span class="pi">:</span> <span class="no">true</span>
   <span class="na">version</span><span class="pi">:</span> <span class="m">1</span>
   <span class="na">editable</span><span class="pi">:</span> <span class="no">false</span>
   <span class="na">database</span><span class="pi">:</span> <span class="s">telegraf</span>
</code></pre></div>      </div>
    </li>
    <li>
      <p>Run the playbook:</p>

      <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ansible-playbook monitoring.yml
</code></pre></div>      </div>
    </li>
    <li>
      <p>Update the nginx configuration in <code class="language-plaintext highlighter-rouge">templates/nginx/<span class="notranslate">galaxy</span>.j2</code> to include the following at the end, before the last curly brace</p>

      <div class="language-nginx highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">...</span>
    <span class="s">location</span> <span class="n">/grafana/</span> <span class="p">{</span>
        <span class="kn">proxy_pass</span> <span class="s">http://127.0.0.1:3000/</span><span class="p">;</span>
    <span class="p">}</span>
</code></pre></div>      </div>

      <p>Since we will setup everything on the same host, we will re-use the Nginx server we setup for <span class="notranslate">Galaxy</span>. If you had planned to run the Grafana and InfluxDB servers on a separate host, you would need to setup Nginx for this host separately.</p>
    </li>
    <li>
      <p>Run the <span class="notranslate">Galaxy</span> playbook which includes Nginx:</p>

      <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ansible-playbook <span class="notranslate">galaxy</span>.yml
</code></pre></div>      </div>
    </li>
  </ol>

</blockquote>

<p>This has now deployed Grafana on your domain under <code class="language-plaintext highlighter-rouge">/grafana/</code>, with the use<span class="notranslate">rna</span>me and password you set. The datasource, from which Grafana obtains data, is preconfigured. The Grafana web application will now be available, but currently there is no data available to it. We will return to Grafana shortly in the tutorial to configure dashboards once data is present.</p>

<h2 id="telegraf">Telegraf</h2>

<p>We use <a href="https://github.com/influxdata/telegraf">Telegraf</a> for monitoring as it is incredibly easy to get started with, and it natively integrates with InfluxDB.</p>

<h3 id="data-input">Data Input</h3>

<p>Telegraf has extensive documentation on how to configure different types of monitoring, and it supports <a href="https://github.com/influxdata/telegraf#input-plugins">a huge array of inputs</a>. If Telegraf doesn‚Äôt support a specific data source you wish to query, you can write a bash script to query this data, and have Telegraf <a href="https://github.com/influxdata/telegraf/tree/master/plugins/inputs/exec">execute it regularly</a>. Telegraf supports several text formats here but the easiest to manage is the InfluxDB line protocol format. The InfluxDB format looks like:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>weather,country=germany,city=freiburg temperature=25,wind=0 1453832006274169688
weather,country=usa,city=state-college temperature=33,wind=10 1453832006274169688
</code></pre></div></div>

<p>The first portion is the metric name, in both of these cases <code class="language-plaintext highlighter-rouge">weather</code>. This is just a unique key for a metric which describes the data being collected. Telegraf commonly collects metrics like <code class="language-plaintext highlighter-rouge">cpu</code>, or <code class="language-plaintext highlighter-rouge">disk</code>, or <code class="language-plaintext highlighter-rouge">mem</code>. After the metric name, up to the first space are tags. Tags are used to store categorical data usually, something that is <a href="https://en.wikipedia.org/wiki/Continuous_or_discrete_variable">discrete</a> and <a href="https://en.wikipedia.org/wiki/Enumeration">enumerable</a>. If you‚Äôre interested in the weather you would collect some information from a particular city, and then <em>tag</em> these values with information about where they‚Äôre collected. After the space, are the various values or data points that are of interest. For weather this would be information like temperature, wind speed or direction, percentage cloud coverage, etc. After the final space is a timestamp, formatted as <a href="https://en.wikipedia.org/wiki/Unix_time">Unix epoch</a> with nanosecond precision.</p>

<p>To apply this example to real world data, we‚Äôll look at the some example output of the <a href="https://github.com/influxdata/telegraf/tree/master/plugins/inputs/disk"><code class="language-plaintext highlighter-rouge">disk</code> plugin</a>, which measures information about disks mounted to a server:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>disk,device=devtmpfs,fstype=devtmpfs,host=stats.<span class="notranslate">galaxy</span>project.eu,mode=rw,path=/dev free=952795136i,inodes_free=232283i,inodes_total=232616i,inodes_used=333i,total=952795136i,used=0i,used_percent=0 1564485157000000000
disk,device=tmpfs,fstype=tmpfs,host=stats.<span class="notranslate">galaxy</span>project.eu,mode=rw,path=/dev/shm free=963690496i,inodes_free=235275i,inodes_total=235276i,inodes_used=1i,total=963690496i,used=0i,used_percent=0 1564485157000000000
disk,device=tmpfs,fstype=tmpfs,host=stats.<span class="notranslate">galaxy</span>project.eu,mode=rw,path=/run free=862007296i,inodes_free=234817i,inodes_total=235276i,inodes_used=459i,total=963690496i,used=101683200i,used_percent=10.551437460684472 1564485157000000000
disk,device=tmpfs,fstype=tmpfs,host=stats.<span class="notranslate">galaxy</span>project.eu,mode=ro,path=/sys/fs/cgroup free=963690496i,inodes_free=235260i,inodes_total=235276i,inodes_used=16i,total=963690496i,used=0i,used_percent=0 1564485157000000000
disk,device=vda2,fstype=xfs,host=stats.<span class="notranslate">galaxy</span>project.eu,mode=rw,path=/ free=6652604416i,inodes_free=6134444i,inodes_total=6290368i,inodes_used=155924i,total=12872298496i,used=6219694080i,used_percent=48.31844197780791 1564485157000000000
disk,device=vdb,fstype=xfs,host=stats.<span class="notranslate">galaxy</span>project.eu,mode=rw,path=/vdb free=2013384704i,inodes_free=1044728i,inodes_total=1048576i,inodes_used=3848i,total=2136997888i,used=123613184i,used_percent=5.78443173454367 1564485157000000000
disk,device=tmpfs,fstype=tmpfs,host=stats.<span class="notranslate">galaxy</span>project.eu,mode=rw,path=/run/user/0 free=192741376i,inodes_free=235275i,inodes_total=235276i,inodes_used=1i,total=192741376i,used=0i,used_percent=0 1564485157000000000
disk,device=tmpfs,fstype=tmpfs,host=stats.<span class="notranslate">galaxy</span>project.eu,mode=rw,path=/run/user/1000 free=192741376i,inodes_free=235275i,inodes_total=235276i,inodes_used=1i,total=192741376i,used=0i,used_percent=0 1564485157000000000

</code></pre></div></div>

<p>Reformatting one of the lines to be a bit easier to read:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>disk,
	device=vdb,
	fstype=xfs,
	host=stats.<span class="notranslate">galaxy</span>project.eu,
	mode=rw,
	path=/vdb

	free=2013384704i,
	inodes_free=1044728i,
	inodes_total=1048576i,
	inodes_used=3848i,
	total=2136997888i,
	used=123613184i,
	used_percent=5.78443173454367

	1564485157000000000
</code></pre></div></div>

<p>The plugin generates a line of output per disk. It is tagged with the <code class="language-plaintext highlighter-rouge">fstype</code>, the type of the filesystem (e.g. <code class="language-plaintext highlighter-rouge">ext3</code>/<code class="language-plaintext highlighter-rouge">ext4</code>/<code class="language-plaintext highlighter-rouge">xfs</code>/<code class="language-plaintext highlighter-rouge">autofs</code>/etc.), the mode by which the filesystem was mounted (<code class="language-plaintext highlighter-rouge">rw</code> or <code class="language-plaintext highlighter-rouge">ro</code>), and the path to which the filesystem was mounted. Then various numbers are collected, the <code class="language-plaintext highlighter-rouge">i</code> suffix meaning an <a href="https://en.wikipedia.org/wiki/Integer">integer</a>. Those without a suffix are <a href="https://en.wikipedia.org/wiki/Floating-point_arithmetic">floats</a>. In this example, you can see that it is an <code class="language-plaintext highlighter-rouge">xfs</code> formatted device, available as vdb, mounted read-write on the path /vdb. Telegraf automatically tags values with the name of the host from which the data was collected.</p>

<p>The values collected usually have quite self-explanatory names. Here there are <code class="language-plaintext highlighter-rouge">2013384704</code> bytes free on the disk, 1044728 <a href="https://en.wikipedia.org/wiki/Inode">inodes</a>, so many bytes total and used, and finally 5.784% disk usage.</p>

<h3 id="gxadmin"><code class="language-plaintext highlighter-rouge">gxadmin</code></h3>

<p>In the <span class="notranslate">Galaxy</span> world, the InfluxDB line protocol format and <a href="https://github.com/influxdata/telegraf/tree/master/plugins/inputs/exec">exec</a> plugin are commonly seen together in conjunction with <a href="https://github.com/usegalaxy-eu/gxadmin">gxadmin</a> to run various database queries, and store the results into InfluxDB.</p>

<p><code class="language-plaintext highlighter-rouge">gxadmin</code> provides various commands to inspect the database like <code class="language-plaintext highlighter-rouge">gxadmin query queue-detail</code>. It was written such that many of the queries can be automatically formatted for consumption by InfluxDB:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ gxadmin iquery queue-overview --short-tool-id
queue-overview,tool_id=__SET_METADATA__,tool_version=1.0.1,state=new,handler=handler_main_9,destination_id=unknown,job_runner_name=unknown count=3
queue-overview,tool_id=iuc/mothur_pre_cluster/mothur_pre_cluster,tool_version=1.39.5.0,state=new,handler=handler_main_2,destination_id=unknown,job_runner_name=unknown count=1
</code></pre></div></div>

<p>If Telegraf runs this command in an exec block, the data will then be available for graphing. Here the only numeric value we‚Äôre collecting is the <em>count</em> of how many jobs of that type are currently running.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>queue-overview,
	tool_id=__SET_METADATA__,
	tool_version=1.0.1,
	state=new,
	handler=handler_main_9,
	destination_id=unknown,
	job_runner_name=unknown

	count=3
</code></pre></div></div>

<p>We capture information about what tool is running, the job state, and where it is running. This will allow us to produce nice graphs of the current queue status, how many jobs are new or queued or running.</p>

<h3 id="configuring-telegraf">Configuring Telegraf</h3>

<p>Setting up Telegraf is again very simple. We just add a single role to our playbook and set some variables.</p>

<blockquote class="notranslate hands_on">
  <h3 id="hands_on-hands-on-dependencies"><i class="fas fa-pencil-alt" aria-hidden="true"></i><span class="visually-hidden">hands_on</span> Hands-on: Dependencies</h3>

  <ol>
    <li>
      <p>Edit your <code class="language-plaintext highlighter-rouge">requirements.yml</code> and add the following:</p>

      <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="pi">-</span> <span class="na">src</span><span class="pi">:</span> <span class="s">dj-wasabi.telegraf</span>
  <span class="na">version</span><span class="pi">:</span> <span class="s">0.12.0</span>
</code></pre></div>      </div>
    </li>
    <li>
      <p>Install the requirements</p>

      <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ansible-<span class="notranslate">galaxy</span> install -p roles -r requirements.yml
</code></pre></div>      </div>
    </li>
    <li>
      <p>Add an entry to the <em>end</em> of your <code class="language-plaintext highlighter-rouge"><span class="notranslate">galaxy</span>.yml</code> playbook under <code class="language-plaintext highlighter-rouge">roles:</code></p>

      <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="pi">-</span> <span class="s">dj-wasabi.telegraf</span>
</code></pre></div>      </div>
    </li>
    <li>
      <p>Create and edit <code class="language-plaintext highlighter-rouge">group_vars/all.yml</code> and add the following variables:</p>

      <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Install the latest version</span>
<span class="na">telegraf_agent_package_state</span><span class="pi">:</span> <span class="s">latest</span>

<span class="c1"># Configure the output to point to an InfluxDB</span>
<span class="c1"># running on localhost, and # place data in the</span>
<span class="c1"># database "telegraf" which will be created if need be.</span>
<span class="na">telegraf_agent_output</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">type</span><span class="pi">:</span> <span class="s">influxdb</span>
    <span class="na">config</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">urls = ["http://127.0.0.1:8086"]</span>
    <span class="pi">-</span> <span class="s">database = "telegraf"</span>

<span class="c1"># The default plugins, applied to any telegraf-configured host</span>
<span class="na">telegraf_plugins_default</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">plugin</span><span class="pi">:</span> <span class="s">cpu</span>
  <span class="pi">-</span> <span class="na">plugin</span><span class="pi">:</span> <span class="s">disk</span>
  <span class="pi">-</span> <span class="na">plugin</span><span class="pi">:</span> <span class="s">kernel</span>
  <span class="pi">-</span> <span class="na">plugin</span><span class="pi">:</span> <span class="s">processes</span>
  <span class="pi">-</span> <span class="na">plugin</span><span class="pi">:</span> <span class="s">io</span>
  <span class="pi">-</span> <span class="na">plugin</span><span class="pi">:</span> <span class="s">mem</span>
  <span class="pi">-</span> <span class="na">plugin</span><span class="pi">:</span> <span class="s">system</span>
  <span class="pi">-</span> <span class="na">plugin</span><span class="pi">:</span> <span class="s">swap</span>
  <span class="pi">-</span> <span class="na">plugin</span><span class="pi">:</span> <span class="s">net</span>
  <span class="pi">-</span> <span class="na">plugin</span><span class="pi">:</span> <span class="s">netstat</span>
</code></pre></div>      </div>

      <p>We have not previously used the <code class="language-plaintext highlighter-rouge">all</code> variables file. Any variables placed here apply to <em>all</em> groups known to Ansible, whenever you run a playbook, the variables from this file will be added to those of any more specific group. Variables specified in a named group (e.g. <code class="language-plaintext highlighter-rouge">group_vars/<span class="notranslate">galaxy</span>servers.yml</code>) will take precedence over those in the <code class="language-plaintext highlighter-rouge">group_vars/all.yml</code> file.</p>

      <p>This configures telegraf to output to the configured influxdb server in the <code class="language-plaintext highlighter-rouge">telegraf</code> database. A number of plugins are enabled as <code class="language-plaintext highlighter-rouge">defaults</code> like cpu or disk or memory, all of which is generically interesting to observe, across every host.</p>

      <p>Any host that we setup Telegraf on, will have this base configuration. If you are setting up multiple hosts to be monitored, you will need to put the full hostname (or IP address) where InfluxDB will be available in the <code class="language-plaintext highlighter-rouge">telegraf_agent_output</code>, rather than <code class="language-plaintext highlighter-rouge">127.0.0.1</code>. That way every host with Telegraf will send data to the correct location.</p>
    </li>
    <li>
      <p>Now with the generic configuration applied to all of our hosts, we will apply some specific configuration to the <span class="notranslate">Galaxy</span> server.</p>

      <p>Open your <code class="language-plaintext highlighter-rouge">group_vars/<span class="notranslate">galaxy</span>servers.yml</code> file, and add the following variables:</p>

      <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">telegraf_plugins_extra</span><span class="pi">:</span>
  <span class="na">listen_<span class="notranslate">galaxy</span>_routes</span><span class="pi">:</span>
    <span class="na">plugin</span><span class="pi">:</span> <span class="s2">"</span><span class="s">statsd"</span>
    <span class="na">config</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">service_address = ":8125"</span>
      <span class="pi">-</span> <span class="s">metric_separator = "."</span>
      <span class="pi">-</span> <span class="s">allowed_pending_messages = </span><span class="m">10000</span>
</code></pre></div>      </div>

      <p>We have configured the <code class="language-plaintext highlighter-rouge">statsd</code> plugin for telegraf, as we will use it to receive <span class="notranslate">Galaxy</span> timing data. <a href="https://github.com/statsd/statsd">StatsD</a> was an earlier time series database and had an associated line protocol with a different format. Telegraf supports data sent in this format, allowing us to reuse the long-present <span class="notranslate">Galaxy</span> support for this with our newer Telegraf/InfluxDB setup. Telegraf parses the data and converts it into a format that InfluxDB can understand.</p>
    </li>
    <li>
      <p>Lastly, we need to enable <span class="notranslate">Galaxy</span> to send data to Telegraf:</p>

      <p>In <code class="language-plaintext highlighter-rouge">group_vars/<span class="notranslate">galaxy</span>servers.yml</code>, edit the <code class="language-plaintext highlighter-rouge"><span class="notranslate">galaxy</span>_config</code> block, and add <code class="language-plaintext highlighter-rouge">statsd_host: localhost</code> and <code class="language-plaintext highlighter-rouge">statsd_influxdb: true</code> under the <code class="language-plaintext highlighter-rouge"><span class="notranslate">galaxy</span></code> subsection. It should look like:</p>

      <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na"><span class="notranslate">galaxy</span>_config</span><span class="pi">:</span>
  <span class="na"><span class="notranslate">galaxy</span></span><span class="pi">:</span>
    <span class="s">...</span>
    <span class="s">statsd_host</span><span class="pi">:</span> <span class="s">localhost</span>
    <span class="na">statsd_influxdb</span><span class="pi">:</span> <span class="no">true</span>
    <span class="s">...</span>
</code></pre></div>      </div>
    </li>
    <li>
      <p>Run the <code class="language-plaintext highlighter-rouge"><span class="notranslate">galaxy</span>.yml</code> playbook</p>
    </li>
  </ol>

</blockquote>

<h1 id="monitoring-with-grafana">Monitoring with Grafana</h1>

<p>The stats have been collecting in InfluxDB for a few minutes, so now we will now configure Grafana with dashboards and alerting rules.</p>

<h2 id="importing-a-dashboard">Importing a dashboard</h2>

<p>For any public Grafana dashboard, you can copy the dashboard for your own use. This is a nice feature of Grafana that has really helped it spread in the <span class="notranslate">Galaxy</span> community, any cool thing one of us builds, everyone else can copy and build upon.</p>

<blockquote class="notranslate hands_on">
  <h3 id="hands_on-hands-on-import-a-dashboard"><i class="fas fa-pencil-alt" aria-hidden="true"></i><span class="visually-hidden">hands_on</span> Hands-on: Import a dashboard</h3>

  <ol>
    <li>
      <p><a href="https://stats.galaxyproject.eu/d/000000023/node-detail-infrastructure?orgId=1">Visit Use<span class="notranslate">Galaxy</span>.eu‚Äôs Node Detail dashboard</a></p>
    </li>
    <li>
      <p>Look for the sharing icon at the top and click it</p>
    </li>
    <li>
      <p>Under the ‚ÄúExport‚Äù tab, click ‚ÄúSave to file‚Äù</p>
    </li>
    <li>
      <p>On your own Grafana server, on the home page, hover over the <code class="language-plaintext highlighter-rouge">+</code> icon and use ‚ÄúImport‚Äù from the menu.</p>
    </li>
    <li>
      <p>Click ‚ÄúUpload .json file‚Äù and select the json dashboard you downloaded</p>
    </li>
    <li>
      <p>Click ‚ÄúImport‚Äù.</p>
    </li>
  </ol>

</blockquote>

<p>With this, your first dashboard should be live! You should see some data from your <span class="notranslate">Galaxy</span> instance, like CPU/load/memory/etc. This can give you a nice <code class="language-plaintext highlighter-rouge">htop</code> like view into your systems, all collected in one easy dashboard. At the top you will see a box labelled ‚ÄúHost‚Äù with a dropdown. If you have more systems, you can click here to select between different machines.</p>

<h2 id="setting-up-a-galaxy-dashboard">Setting up a <span class="notranslate">Galaxy</span> dashboard</h2>

<p>Importing dashboards is a good start, but it‚Äôs more interesting to create our own that‚Äôs personalised to our needs.</p>

<blockquote class="notranslate hands_on">
  <h3 id="hands_on-hands-on-create-a-dashboard"><i class="fas fa-pencil-alt" aria-hidden="true"></i><span class="visually-hidden">hands_on</span> Hands-on: Create a dashboard</h3>

  <ol>
    <li>
      <p>Again find the <code class="language-plaintext highlighter-rouge">+</code> icon in Grafana and create a dashboard. This will bring you to a new screen</p>
    </li>
    <li>
      <p>Click <em>Add Query</em>, and you will be dropped into the Grafana query builder</p>

      <p><img src="../../images/grafana-query-builder.png" alt="Grafana query builder interface" /></p>

      <p>This is the query builder interface. The interface somewhat resembles a SQL query, selecting data <em>from</em> a database, <em>where</em> it meets some condition, <em>select</em>ing some specific data, and <em>grouping by</em> time period. If this isn‚Äôt immediately clear how it behaves, hopefully it will become more clear once you have built some queries.</p>
    </li>
    <li>Let‚Äôs build a query:
      <ul>
        <li>From:
          <ul>
            <li><em>‚Äúselect measurement‚Äù</em>: <code class="language-plaintext highlighter-rouge"><span class="notranslate">galaxy</span>.</code></li>
          </ul>
        </li>
        <li>Select:
          <ul>
            <li><em>‚Äúfield(value)‚Äù</em>: <code class="language-plaintext highlighter-rouge">field(mean)</code></li>
          </ul>
        </li>
        <li>Group by:
          <ul>
            <li><em>‚Äúfill(null)‚Äù</em>: <code class="language-plaintext highlighter-rouge">fill(none)</code></li>
            <li>add new (+): <code class="language-plaintext highlighter-rouge">tag(path)</code></li>
          </ul>
        </li>
        <li>Alias by: <code class="language-plaintext highlighter-rouge">[[tag_path]]</code></li>
      </ul>
    </li>
    <li>
      <p>At the top of the page it probably says ‚ÄúLast 6 hours‚Äù, click this to change to ‚ÄúLast 30 minutes‚Äù</p>
    </li>
    <li>
      <p>Remember to save the dashboard (using the <i class="far fa-save" aria-hidden="true"></i><span class="visually-hidden"><span class="notranslate">galaxy</span>-save</span> at the top), and give it a name like ‚Äú<span class="notranslate">Galaxy</span>‚Äù</p>
    </li>
    <li>You can hit <kbd>Escape</kbd> to exit out of the graph editor, if need be.</li>
  </ol>

</blockquote>

<p>This will track how long it takes the interface to respond on various web routes and API routes. The collection of individual points is a bit hard to interpret the ‚Äúfeeling‚Äù of, so it‚Äôs common to add a query like the <a href="https://en.wikipedia.org/wiki/Percentile">95th percentile</a> of requests. This is a value that is calculated from all of the data points collected. The 95th percentile means that 95% of requests are responded to more quickly than this value.</p>

<blockquote class="notranslate hands_on">
  <h3 id="hands_on-hands-on-add-a-second-query-to-an-existing-graph"><i class="fas fa-pencil-alt" aria-hidden="true"></i><span class="visually-hidden">hands_on</span> Hands-on: Add a second query to an existing graph</h3>

  <ol>
    <li>
      <p>The top of the graph is probably labelled ‚ÄúPanel Title‚Äù, unless you changed it. Click this to access a dropdown and click ‚ÄúEdit‚Äù</p>
    </li>
    <li>
      <p>On the right side you will find a button <strong>Add Query</strong>, click it.</p>
    </li>
    <li>Let‚Äôs build a query:
      <ul>
        <li>From:
          <ul>
            <li><em>‚Äúselect measurement‚Äù</em>: <code class="language-plaintext highlighter-rouge"><span class="notranslate">galaxy</span>.</code></li>
          </ul>
        </li>
        <li>Select:
          <ul>
            <li><em>‚Äúfield(value)‚Äù</em>: <code class="language-plaintext highlighter-rouge">field(mean)</code></li>
            <li>add new (+): Selectors ‚Üí percentile</li>
          </ul>
        </li>
        <li>Group by:
          <ul>
            <li><em>‚Äúfill(null)‚Äù</em>: <code class="language-plaintext highlighter-rouge">fill(none)</code></li>
          </ul>
        </li>
        <li>Alias by: <code class="language-plaintext highlighter-rouge">percentile</code></li>
      </ul>
    </li>
    <li>
      <p>Remember to save the dashboard</p>
    </li>
    <li>
      <p>You can hit <kbd>Escape</kbd> to exit out of the graph editor</p>
    </li>
    <li>At any time you can drag the bottom right corner of the graph to resize it as needed.</li>
  </ol>

</blockquote>

<p>We should now have a graph that gives us not only individual data points, but also a more easily consumable overall representation. For many metrics there are so many data points individually collected that it can be overwhelming and so it is often useful to come up with an aggregate representation that summarises the points into a more easily consumed value. We will touch upon this again under the monitoring section.</p>

<h2 id="styling">Styling</h2>

<p>There is a significant amount of visual styling that one can do to the graphs to make data more or less prominent as you need.</p>

<figure id="figure-1"><img src="../../images/grafana-graph-sections.png" alt="Grafana graph configuration sections" /><figcaption><span class="figcaption-prefix">Figure 1:</span> Graph configuration sections, from top to bottom: data, visualisation, configuration, and alerting</figcaption></figure>

<p>We will update the panel we‚Äôve added to highlight the important information and downplay less important facets, as well as configuring it to have a nicer title than ‚ÄúPanel Title‚Äù</p>

<blockquote class="notranslate hands_on">
  <h3 id="hands_on-hands-on-styling-the-graph"><i class="fas fa-pencil-alt" aria-hidden="true"></i><span class="visually-hidden">hands_on</span> Hands-on: Styling the graph</h3>

  <ol>
    <li>
      <p>Again edit the one graph we‚Äôve added in our dashboard</p>
    </li>
    <li>
      <p>On the left side, select the second icon, Visualisation</p>
    </li>
    <li>
      <p>In the first section, we can edit some display attributes.</p>

      <p>We are primarily interested in the 95th percentile line. Here we can change the display from points to lines or bars, change the tooltip that displays when we hover over the graph, among other facets.</p>

      <ul>
        <li>Click <strong>Add series override</strong>, click in the box that appears and type ‚Äúpercentile‚Äù, to find the series we created early. Select it when it appears. We can now apply custom styling to this series.</li>
        <li>Click the ‚Äú+‚Äù after the series override, and find <strong>‚ÄúColor ‚Üí change‚Äù</strong>, and choose a colour that you like.</li>
        <li>Click the ‚Äú+‚Äù again, and find <strong>‚ÄúLine width ‚Üí 5‚Äù</strong> to make the line more visible. This is the most important facet of the graph for us, so we can emphasise it through colour and size.</li>
      </ul>
    </li>
    <li>
      <p>In the second section, we can edit information about the Axes:</p>

      <ul>
        <li>Left Y
          <ul>
            <li><em>‚ÄúUnit‚Äù</em>: Time ‚Üí millisecond (ms)</li>
          </ul>
        </li>
      </ul>

      <p>This will cause the axis to display nicely at any scale. Before Grafana only knew it was a number, now it knows the type of number. If you have a request that takes 30 seconds, it will display as ‚Äú30s‚Äù in Grafana, rather than ‚Äú30000 ms‚Äù.</p>

      <p>This section is also useful for setting the scale if your data is better viewed with a logarithmic scale, or forcing specific axis bounds. Commonly on graphs that show things like ‚Äúdisk usage percentage‚Äù, it can be useful to set the axis bounds to 0 and 100 to ensure that full context is available.</p>
    </li>
    <li>
      <p>In the next section, ‚ÄúLegend‚Äù allows us to format the legend in more interesting ways.</p>

      <ul>
        <li>Options
          <ul>
            <li><em>‚ÄúShow‚Äù</em>: yes</li>
            <li><em>‚ÄúAs table‚Äù</em>: yes</li>
            <li><em>‚ÄúTo right‚Äù</em>: yes</li>
          </ul>
        </li>
        <li>Values
          <ul>
            <li><em>‚ÄúMin‚Äù</em>: yes</li>
            <li><em>‚ÄúMax‚Äù</em>: yes</li>
            <li><em>‚ÄúAvg‚Äù</em>: yes</li>
          </ul>
        </li>
      </ul>

      <p>Clicking on the headers of the table that has appeared, you can force it to be sorted by one column or another.</p>
    </li>
    <li>
      <p>On the left side, select the third icon, ‚ÄúGeneral‚Äù</p>

      <ul>
        <li><em>‚ÄúTitle‚Äù</em>: <code class="language-plaintext highlighter-rouge"><span class="notranslate">Galaxy</span> Request Times</code></li>
      </ul>
    </li>
    <li>
      <p>Save the dashboard</p>
    </li>
  </ol>

</blockquote>

<p>Your graph should look something like the following:</p>

<figure id="figure-2"><img src="../../images/grafana-graph-final.png" alt="Final graph" /><figcaption><span class="figcaption-prefix">Figure 2:</span> The final graph should look something like this, but probably different based on the requests to your server. For this image the author made repeated, automated requests to <span class="notranslate">Galaxy</span> to produce more data points than might normally be present.</figcaption></figure>

<h2 id="monitoring">Monitoring</h2>

<p>Collecting all of this data is interesting to visualise but as an administrator you surely have more interesting things to do than to watch graphs all day. Many organisations like to display these dashboards on large monitors, but again this assumes someone is watching it. Everyone has better things to do with their time! So we will setup monitoring on the most important aspects of our system.</p>

<p>Doing monitoring effectively, without causing undue burden to the administrators (extraneous alerts that are not actionable), or the users (unexpected/unnoticed downtime), is a very complex topic. Recommended reading here includes the <a href="https://landing.google.com/sre/sre-book/chapters/monitoring-distributed-systems/">monitoring chapter</a> of the Google SRE book <a class="citation" href="#Beyer:2016:SRE:3006357">Beyer <i>et al.</i> 2016</a> which can provide some general guidance on the topic and what metrics may be interesting or annoying to alert upon.</p>

<blockquote class="comment">
  <h3 id="comment-no-generic-advice"><i class="far fa-comment-dots" aria-hidden="true"></i><span class="visually-hidden">comment</span> No generic advice</h3>
  <p>We cannot easily provide generic and applicable recommendations, that work across every system and every scale. Some of these performance bounds or features you will need to discover yourself, either adding new metrics in support of this, or changing monitoring thresholds to match the values you need.</p>
</blockquote>

<p>We will add an example alert, to make you familiar with the process. This is not an alert that will probably be useful in production.</p>

<blockquote class="notranslate hands_on">
  <h3 id="hands_on-hands-on-add-an-alert-to-your-graph"><i class="fas fa-pencil-alt" aria-hidden="true"></i><span class="visually-hidden">hands_on</span> Hands-on: Add an alert to your graph</h3>

  <ol>
    <li>
      <p>Again edit the <code class="language-plaintext highlighter-rouge"><span class="notranslate">Galaxy</span> Request Times</code> graph</p>
    </li>
    <li>
      <p>On the left side, select the last icon, Alerting</p>
    </li>
    <li>
      <p>Click <strong>Create Alert</strong></p>

      <p>Alerts consist of a <em>Rule</em>, with some name, evaluated every N seconds, for a period of time. The <em>for</em> can be an important parameter, which you can read more about <a href="https://grafana.com/docs/alerting/rules/">in the Grafana documentation</a>.</p>

      <p>Under some <em>conditions</em>, this alert will activate. We will change the conditions of the alert here:</p>

      <ul>
        <li><em>‚ÄúWhen‚Äù</em>: <code class="language-plaintext highlighter-rouge">avg()</code></li>
        <li><em>‚ÄúOF‚Äù</em>: <code class="language-plaintext highlighter-rouge">query(B, 1m, now)</code>, here we select query B, the 95th percentile track, and the average over 1 minute</li>
        <li><em>‚ÄúIS ABOVE‚Äù</em>: <code class="language-plaintext highlighter-rouge">50</code></li>
      </ul>

      <p>We will not configure a notification channel in this tutorial. In practice, it is useful to do to ensure that the relevant people are notified automatically. If you and your team use <a href="https://grafana.com/docs/alerting/notifications/">one of the many services</a>, then you can configure this following their documentation.</p>
    </li>
    <li>
      <p>Save the dashboard</p>
    </li>
  </ol>

</blockquote>

<h1 id="telegraf--gxadmin">Telegraf &amp; <code class="language-plaintext highlighter-rouge">gxadmin</code></h1>

<p>Via this setup using <code class="language-plaintext highlighter-rouge">systemd</code> we collect metrics about <span class="notranslate">Galaxy</span> request times. To get statistics about other <span class="notranslate">Galaxy</span>-specific metrics such as the job queue status, we need to use <code class="language-plaintext highlighter-rouge">gxadmin</code> to query the <span class="notranslate">Galaxy</span> database and configure Telegraf to consume this data. In this section we will setup gxadmin, and to configure Telegraf to have permissions to run it.</p>

<h2 id="installing-gxadmin">Installing gxadmin</h2>

<p>It‚Äôs simple to install gxadmin. Here‚Äôs how you do it, if you haven‚Äôt done it already:</p>

<blockquote class="notranslate hands_on">
  <h3 id="hands_on-hands-on-installing-gxadmin-and-configuring-telegraf"><i class="fas fa-pencil-alt" aria-hidden="true"></i><span class="visually-hidden">hands_on</span> Hands-on: Installing gxadmin and configuring Telegraf</h3>

  <ol>
    <li>
      <p>Edit your <code class="language-plaintext highlighter-rouge">requirements.yml</code> and add the following:</p>

      <div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="pi">-</span> <span class="na">src</span><span class="pi">:</span> <span class="s">use<span class="notranslate">galaxy</span>_eu.gxadmin</span>
  <span class="na">version</span><span class="pi">:</span> <span class="s">0.0.3</span>
</code></pre></div>      </div>
    </li>
    <li>
      <p>Install the role with <code class="language-plaintext highlighter-rouge">ansible-<span class="notranslate">galaxy</span> install -p roles -r requirements.yml</code></p>
    </li>
    <li>
      <p>Add the role to your <code class="language-plaintext highlighter-rouge"><span class="notranslate">galaxy</span>.yml</code> playbook, it should come before the Telegraf role.</p>
    </li>
  </ol>

</blockquote>

<p>You can run the playbook now, or wait until you have configured Telegraf below:</p>

<h2 id="configuring-telegraf-for-gxadmin">Configuring Telegraf for gxadmin</h2>

<blockquote class="notranslate hands_on">
  <h3 id="hands_on-hands-on-configuring-telegraf"><i class="fas fa-pencil-alt" aria-hidden="true"></i><span class="visually-hidden">hands_on</span> Hands-on: Configuring Telegraf</h3>

  <ol>
    <li>
      <p>Edit the <code class="language-plaintext highlighter-rouge">group_vars/<span class="notranslate">galaxy</span>servers.yml</code>, we need to add some additional permissions to permit Telegraf to run <code class="language-plaintext highlighter-rouge">gxadmin</code>:</p>

      <div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># This should already exist!</span>
<span class="na">postgresql_objects_users</span><span class="pi">:</span>
  <span class="s">...</span>
  <span class="s"># Add this to create a telegraf user</span>
  <span class="s">- name</span><span class="pi">:</span> <span class="s">telegraf</span>
    <span class="s">password</span><span class="pi">:</span> <span class="no">null</span>

<span class="c1"># And this to grant telegraf privileges to</span>
<span class="c1"># SELECT values from the <span class="notranslate">Galaxy</span> database</span>
<span class="na">postgresql_objects_privileges</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">database</span><span class="pi">:</span> <span class="s"><span class="notranslate">galaxy</span></span>
    <span class="na">roles</span><span class="pi">:</span> <span class="s">telegraf</span>
    <span class="na">privs</span><span class="pi">:</span> <span class="s">SELECT</span>
    <span class="na">objs</span><span class="pi">:</span> <span class="s">ALL_IN_SCHEMA</span>
</code></pre></div>      </div>
    </li>
    <li>
      <p>Again edit the <code class="language-plaintext highlighter-rouge">group_vars/<span class="notranslate">galaxy</span>servers.yml</code>, we need to configure Telegraf to run <code class="language-plaintext highlighter-rouge">gxadmin</code></p>

      <p>Under <code class="language-plaintext highlighter-rouge">telegraf_plugins_extra</code>, where we already have set a <span class="notranslate">Galaxy</span> StatsD listener, add a stanza to monitor the <span class="notranslate">Galaxy</span> queue</p>

      <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">telegraf_plugins_extra</span><span class="pi">:</span>
  <span class="s">...</span>
  <span class="s">monitor_<span class="notranslate">galaxy</span>_queue</span><span class="pi">:</span>
    <span class="na">plugin</span><span class="pi">:</span> <span class="s2">"</span><span class="s">exec"</span>
    <span class="na">config</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">commands = ["/usr/bin/env PGDATABASE=<span class="notranslate">galaxy</span> /usr/bin/gxadmin iquery queue-overview --short-tool-id"]</span>
      <span class="pi">-</span> <span class="s">timeout = "10s"</span>
      <span class="pi">-</span> <span class="s">data_format = "influx"</span>
      <span class="pi">-</span> <span class="s">interval = "15s"</span>
</code></pre></div>      </div>

      <p>This one is slightly more complex in the configuration. The command block does several things:</p>

      <ul>
        <li>it wraps the command with <code class="language-plaintext highlighter-rouge">env</code> which allows setting environment variables for a single command</li>
        <li>It sets the <code class="language-plaintext highlighter-rouge">PGDATABASE</code> to the <span class="notranslate">Galaxy</span> database, by default the <code class="language-plaintext highlighter-rouge">psql</code> will try and connect to a database with the same name of the user. So the <code class="language-plaintext highlighter-rouge">telegraf</code> user will attempt to connect to a (non-existent) <code class="language-plaintext highlighter-rouge">telegraf</code> database.</li>
        <li>Then it calls the gxadmin command <code class="language-plaintext highlighter-rouge">queue-overview</code>. By using <code class="language-plaintext highlighter-rouge">iquery</code> instead of <code class="language-plaintext highlighter-rouge">query</code>, the output is automatically converted to InfluxDB line protocol.</li>
        <li>The command is run every 15 seconds, and has a timeout of 10 seconds. If the command fails to finish in 10 seconds, it will be killed.</li>
      </ul>
    </li>
    <li>
      <p>Run the <span class="notranslate">Galaxy</span> playbook</p>
    </li>
  </ol>

</blockquote>

<p>With this, Telegraf will start monitoring the <span class="notranslate">Galaxy</span> queue by calling the query every few seconds to check the status every 15 seconds. This monitoring <em>will</em> miss jobs that complete within the 15 second interval, but for most servers this is not an issue. Most jobs are running for more than 15 seconds, and if not, it still gives an accurate point-in-time view.</p>

<p>We‚Äôll now create a graph for this, just like the one on <a href="https://stats.galaxyproject.eu">stats.<span class="notranslate">galaxy</span>project.eu</a></p>

<blockquote class="notranslate hands_on">
  <h3 id="hands_on-hands-on-building-the-queue-graph"><i class="fas fa-pencil-alt" aria-hidden="true"></i><span class="visually-hidden">hands_on</span> Hands-on: Building the queue graph</h3>

  <ol>
    <li>
      <p>Click the <strong>new graph</strong> button at the top of Grafana‚Äôs interface, and <em>Add a Query</em></p>
    </li>
    <li>Let‚Äôs build a query:
      <ul>
        <li>From:
          <ul>
            <li><em>‚Äúselect measurement‚Äù</em>: <code class="language-plaintext highlighter-rouge">queue-overview</code></li>
          </ul>
        </li>
        <li>Select:
          <ul>
            <li><em>‚Äúfield(value)‚Äù</em>: <code class="language-plaintext highlighter-rouge">field(count)</code></li>
            <li>add new (+): Aggregations ‚Üí sum</li>
          </ul>
        </li>
        <li>Group by:
          <ul>
            <li><em>‚Äútime(__interval)‚Äù</em>: <code class="language-plaintext highlighter-rouge">time(15s)</code>, because we set the interval to 15s</li>
            <li>add new (+): <code class="language-plaintext highlighter-rouge">tag(tool_id)</code></li>
            <li>add new (+): <code class="language-plaintext highlighter-rouge">tag(tool_version)</code></li>
          </ul>
        </li>
        <li>Alias by: <code class="language-plaintext highlighter-rouge">[[tag_tool_id]]/[[tag_tool_version]]</code></li>
      </ul>
    </li>
    <li>
      <p>In the second tab on the left, Visualisation:</p>

      <p>Under the first section:</p>

      <ul>
        <li>Draw Modes:
          <ul>
            <li><em>‚ÄúBars‚Äù</em>: <code class="language-plaintext highlighter-rouge">no</code></li>
            <li><em>‚ÄúLines‚Äù</em>: <code class="language-plaintext highlighter-rouge">yes</code></li>
            <li><em>‚ÄúPoints‚Äù</em>: <code class="language-plaintext highlighter-rouge">no</code></li>
          </ul>
        </li>
        <li>Mode Options:
          <ul>
            <li><em>‚ÄúStaircase‚Äù</em>: <code class="language-plaintext highlighter-rouge">yes</code></li>
          </ul>
        </li>
        <li>Stacking &amp; Null Value
          <ul>
            <li><em>‚ÄúStack‚Äù</em>: <code class="language-plaintext highlighter-rouge">yes</code></li>
            <li><em>‚ÄúNull Value‚Äù</em>: <code class="language-plaintext highlighter-rouge">null as zero</code></li>
          </ul>
        </li>
      </ul>

      <p>Below, under the <em>Legend</em> section,</p>

      <ul>
        <li>Options:
          <ul>
            <li><em>‚ÄúShow‚Äù</em>: <code class="language-plaintext highlighter-rouge">yes</code></li>
            <li><em>‚ÄúAs table‚Äù</em>: <code class="language-plaintext highlighter-rouge">yes</code></li>
            <li><em>‚ÄúTo Right‚Äù</em>: <code class="language-plaintext highlighter-rouge">yes</code></li>
          </ul>
        </li>
        <li>Values:
          <ul>
            <li><em>‚ÄúMax‚Äù</em>: <code class="language-plaintext highlighter-rouge">yes</code></li>
            <li><em>‚ÄúAvg‚Äù</em>: <code class="language-plaintext highlighter-rouge">yes</code></li>
            <li><em>‚ÄúCurrent‚Äù</em>: <code class="language-plaintext highlighter-rouge">yes</code></li>
          </ul>
        </li>
        <li>Hide Series:
          <ul>
            <li><em>‚ÄúWith only nulls‚Äù</em>: <code class="language-plaintext highlighter-rouge">yes</code></li>
            <li><em>‚ÄúWith only zeros‚Äù</em>: <code class="language-plaintext highlighter-rouge">yes</code></li>
          </ul>
        </li>
      </ul>
    </li>
    <li>
      <p>In the third tab, General settings:</p>

      <ul>
        <li><em>‚ÄúTitle‚Äù</em>: <code class="language-plaintext highlighter-rouge"><span class="notranslate">Galaxy</span> Queue Overview</code></li>
      </ul>
    </li>
    <li>You can hit <kbd>Escape</kbd> to exit out of the graph editor, and remember to save your dashboard.</li>
  </ol>

</blockquote>

<p>Run some tools in <span class="notranslate">Galaxy</span>, try to generate a large number of jobs. It is relatively easy to upload a dataset, and then run the ‚ÄúSecure Hash / Message Digest‚Äù or another tool repeatedly, running it over every dataset in your history, repeating until you‚Äôve generated a few dozen datasets. If you have a slower tool like <code class="language-plaintext highlighter-rouge">bwa</code> installed, this can be an option too.</p>

<figure id="figure-3"><img src="../../images/grafana-final-graph.png" alt="Final Graph" /><figcaption><span class="figcaption-prefix">Figure 3:</span> Final graphs generated from this tutorial.</figcaption></figure>

<p>You can also import a <a href="/training-material/topics/admin/tutorials/monitoring/dashboard.json">copy of the dashboard</a>.</p>

<h1 id="conclusion">Conclusion</h1>

<p>Monitoring with Telegraf, InfluxDB, and Grafana can provide an easy solution to monitor your infrastructure. The Use<span class="notranslate">Galaxy</span>.* servers use this stack and it has proven to be effective in production situations, with large <span class="notranslate">Galaxy</span> servers. The base monitoring done with Telegraf is easy to setup and extend on a per-site basis simply by adding scripts or commands to your servers which generate InfluxDB line protocol formatted output. Grafana provides an ideal visualisation solution as it encourages sharing, and allows you to import whatever dashboards have been developed by Use<span class="notranslate">Galaxy</span>.*, and then to extend them to your own needs.</p>


                    
                    <blockquote class="key_points">
                        <h3><i class="fas fa-key" aria-hidden="true"></i><span class="visually-hidden">keypoints</span> Key points</h3>
                        <ul>
                            
                            <li><p>Telegraf provides an easy solution to monitor servers</p>
</li>
                            
                            <li><p>Galaxy can send metrics to Telegraf</p>
</li>
                            
                            <li><p>Telegraf can run arbitrary commands like <code class="language-plaintext highlighter-rouge">gxadmin</code>, which provides influx formatted output</p>
</li>
                            
                            <li><p>InfluxDB can collect metrics from Telegraf</p>
</li>
                            
                            <li><p>Use Grafana to visualise these metrics, and monitor their values</p>
</li>
                            
                        </ul>
                    </blockquote>
                    

                    

                    
                    <h1 id="bibliography">References</h1>
                    <ol class="bibliography"><li><span id="Beyer:2016:SRE:3006357">Beyer, B., C. Jones, J. Petoff, and N. R. Murphy, 2016 <b>Site Reliability Engineering: How Google Runs Production Systems</b>. <i>O‚ÄôReilly Media, Inc.</i></span>
    
    
    
      <!-- prevent duplicate doi links -->
      
      <a href="https://landing.google.com/sre/sre-book/toc/index.html">https://landing.google.com/sre/sre-book/toc/index.html</a>
      
    

</li></ol>
                    

                    <h1>Feedback</h1>
                    <p class="text-muted">Did you use this material as an instructor? Feel free to give us feedback on <a href="https://github.com/galaxyproject/training-material/issues/1452" target="_blank">how it went</a>.</p>

                    <div id="feedback-button">
                        <img src="/training-material/shared/images/feedback.png" title="Click to activate" alt="Click here to load Google feedback frame" />
                    </div>
                    <div id="feedback-form">
                    </div>
                    <script type="text/javascript">
                        (function (window, document) {
                            function onDocumentReady(fn) {
                                if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
                                    fn();
                                } else {
                                    document.addEventListener('DOMContentLoaded', fn);
                                }
                            }

                            onDocumentReady(function () {
                                $("#feedback-button").click(function(evt){
                                    var e = $(evt.target)
                                    e.hide();

                                    $("#feedback-form").html(`
                                        <iframe id="feedback-google" class="google-form" src="https://docs.google.com/forms/d/e/1FAIpQLSd4VZptFTQ03kHkMz0JyW9b6_S8geU5KjNE_tLM0dixT3ZQmA/viewform?embedded=true&entry.1235803833=Galaxy Monitoring with Telegraf and Grafana (Galaxy Server administration)">Loading...</iframe>
                                    `)
                                })
                            });
                        })(window, document);
                    </script>



                    <h1>Citing this Tutorial</h1>
                    <p>
                        <ol>
                            <li id="citation-text">Helena Rasche, 2021 <b>Galaxy Monitoring with Telegraf and Grafana (Galaxy Training Materials)</b>. <a href="/training-material/topics/admin/tutorials/monitoring/tutorial.html">/training-material/topics/admin/tutorials/monitoring/tutorial.html</a> Online; accessed TODAY
                            </li>
                            <li>
                            Batut et al., 2018 <b>Community-Driven Data Analysis Training for Biology</b> Cell Systems <a href="https://doi.org/10.1016%2Fj.cels.2018.05.012">10.1016/j.cels.2018.05.012</a>
                            </li>
                        </ol>
                    </p>


                    <blockquote class="details">
                      <h3><i class="fa fa-info-circle" aria-hidden="true"></i><span class="visually-hidden">details</span> BibTeX</h3>
                      <p style="display: none;">

                    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight">
<code id="citation-code">@misc{admin-monitoring,
    author = "Helena Rasche",
    title = "Galaxy Monitoring with Telegraf and Grafana (Galaxy Training Materials)",
    year = "2021",
    month = "01",
    day = "06"
    url = "\url{/training-material/topics/admin/tutorials/monitoring/tutorial.html}",
    note = "[Online; accessed TODAY]"
}
@article{Batut_2018,
        doi = {10.1016/j.cels.2018.05.012},
        url = {https://doi.org/10.1016%2Fj.cels.2018.05.012},
        year = 2018,
        month = {jun},
        publisher = {Elsevier {BV}},
        volume = {6},
        number = {6},
        pages = {752--758.e1},
        author = {B{\'{e}}r{\'{e}}nice Batut and Saskia Hiltemann and Andrea Bagnacani and Dannon Baker and Vivek Bhardwaj and Clemens Blank and Anthony Bretaudeau and Loraine Brillet-Gu{\'{e}}guen and Martin {\v{C}}ech and John Chilton and Dave Clements and Olivia Doppelt-Azeroual and Anika Erxleben and Mallory Ann Freeberg and Simon Gladman and Youri Hoogstrate and Hans-Rudolf Hotz and Torsten Houwaart and Pratik Jagtap and Delphine Larivi{\`{e}}re and Gildas Le Corguill{\'{e}} and Thomas Manke and Fabien Mareuil and Fidel Ram{\'{\i}}rez and Devon Ryan and Florian Christoph Sigloch and Nicola Soranzo and Joachim Wolff and Pavankumar Videm and Markus Wolfien and Aisanjiang Wubuli and Dilmurat Yusuf and James Taylor and Rolf Backofen and Anton Nekrutenko and Bj√∂rn Gr√ºning},
        title = {Community-Driven Data Analysis Training for Biology},
        journal = {Cell Systems}
}</code>
                    </pre></div></div>
                    </p>
                    </blockquote>


<script type="text/javascript">
// update the date on load, or leave fallback of 'today'
d = new Date();
document.getElementById("citation-code").innerHTML = document.getElementById("citation-code").innerHTML.replace("TODAY", d.toDateString());
document.getElementById("citation-text").innerHTML = document.getElementById("citation-text").innerHTML.replace("TODAY", d.toDateString());
</script>

                </div>
            </div>
        </div>

        <h3><i class="far fa-thumbs-up" aria-hidden="true"></i><span class="visually-hidden">congratulations</span> Congratulations on successfully completing this tutorial!</h3>

        

        
    </section>
</div>


<footer>
    <div class="container">
        <p>
            This material is the result of a collaborative work. Thanks to the
            <a href="https://wiki.galaxyproject.org/Teach/GTN">Galaxy Training Network</a>
            and all the <a href="/training-material/hall-of-fame">contributors</a> (Helena Rasche)!
        </p>
        <p>
            Found a typo? Something is wrong in this tutorial? Edit it on
            <a href="https://github.com/galaxyproject/training-material/tree/master/topics/admin/tutorials/monitoring/tutorial.md">GitHub</a>.
        </p>
        <p>
    The content of the tutorials and website is licensed under the <a rel="license" href="https://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 International License</a>.
</p>
    </div>
</footer>

    </body>
    <script type="text/javascript" src="/training-material/assets/js/jquery.slim.min.js"></script>
    <script type="text/javascript" src="/training-material/assets/js/popper.min.js"></script>
    <script type="text/javascript" src="/training-material/assets/js/bootstrap.min.js?v=3"></script>
    <script type="text/javascript" src="/training-material/assets/js/details-element-polyfill.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="/training-material/assets/js/bootstrap-toc.min.js"></script>
    <script type="text/javascript" src="/training-material/assets/js/main.js"></script>
    <script type="text/javascript" src="/training-material/assets/js/theme.js"></script>

    <script type="text/javascript" src="/training-material/assets/js/clipboard.min.js"></script>
    <script type="text/javascript">
    var snippets=document.querySelectorAll('div.highlight');
    [].forEach.call(snippets,function(snippet){
        snippet.firstChild.insertAdjacentHTML('beforebegin','<button class="btn btn-light" data-clipboard-snippet><i class="fa fa-copy"></i>&nbsp;Copy</button>');
    });

    var clipboardSnippets=new ClipboardJS('[data-clipboard-snippet]',{
        target:function(trigger){return trigger.nextElementSibling;
    }});
    </script>
    

    <script type="text/javascript">
        if(window.location.hostname === "galaxyproject.github.io") {
            // Redirect
            var redirect = "https://training.galaxyproject.org" + window.location.pathname + window.location.search;
            $('div.container.main-content').prepend("<div class='alert alert-warning'><strong>Note: </strong>This content has a new home at <a href=\"" + redirect + "\">" + redirect + "</a>, which you will be redirected to in 5 seconds.</div>");

            window.setTimeout(function(){
                window.location.href = redirect;
            }, 5000)

        }
    </script>
</html>
