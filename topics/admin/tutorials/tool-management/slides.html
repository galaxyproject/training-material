<!DOCTYPE html>
<html>









  <head>
    <meta charset="utf-8">
    <title>Galaxy Tool Management with Ephemeris</title>
    
        <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
    ga('create', '' , 'auto');
    ga('send', 'pageview');
</script>
    
    <link rel="stylesheet" href="/training-material/assets/css/slides.css">
    <script src="https://kit.fontawesome.com/67b3f98409.js" crossorigin="anonymous"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="shortcut icon" href="/training-material/favicon.ico" type="image/x-icon" />

    
    
    
    
    <meta name="description" content="Resources related to configuration and maintenance of Gal..." />
    <meta property="og:title" content="Galaxy Training: Galaxy Tool Management with Ephemeris" />
    <meta property="og:description" content="Resources related to configuration and maintenance of Gal..." />
    <meta property="og:image" content="/training-material/assets/images/GTNLogo1000.png" />
    <script type="application/ld+json">
      


{
  "@context": "http://schema.org",
  "@type": "Course",
  "accessMode": [
    "textual",
    "visual"
  ],
  "accessModeSufficient": [
    "textual",
    "visual"
  ],
  "accessibilityControl": [
    "fullKeyboardControl",
    "fullMouseControl"
  ],
  "accessibilityFeature": [
    "alternativeText",
    "tableOfContents"
  ],
  "accessibilitySummary": "Short descriptions are present but long descriptions will be needed for non-visual users",
  "audience": {
    "@type": "EducationalAudience",
    "educationalRole": "students"
  },
  "citation": {
    "@type": "CreativeWork",
    "name": "Community-Driven Data Analysis Training for Biology",
    "url": "https://doi.org/10.1016/j.cels.2018.05.012"
  },
  "copyrightHolder": {
    "@type": "Organization",
    "email": "galaxytrainingnetwork@gmail.com",
    "name": "Galaxy Training Network",
    "url": "https://galaxyproject.org/teach/gtn/"
  },
  "discussionUrl": "https://gitter.im/Galaxy-Training-Network/Lobby",
  "headline": "Galaxy Tool Management with Ephemeris",
  "inLanguage": {
    "@type": "Language",
    "name": "English",
    "alternateName": "en"
  },
  "interactivityType": "mixed",
  "isAccessibleForFree": true,
  "license": "https://github.com/galaxyproject/training-material/blob/master/LICENSE.md",
  "producer": {
    "@type": "Organization",
    "email": "galaxytrainingnetwork@gmail.com",
    "name": "Galaxy Training Network",
    "url": "https://galaxyproject.org/teach/gtn/"
  },
  "provider": {
    "@type": "Organization",
    "email": "galaxytrainingnetwork@gmail.com",
    "name": "Galaxy Training Network",
    "url": "https://galaxyproject.org/teach/gtn/"
  },
  "sourceOrganization": {
    "@type": "Organization",
    "email": "galaxytrainingnetwork@gmail.com",
    "name": "Galaxy Training Network",
    "url": "https://galaxyproject.org/teach/gtn/"
  },
  "isPartOf": {
    "@type": "CreativeWork",
    "name": "Galaxy Server administration",
    "description": "Resources related to configuration and maintenance of Galaxy servers",
    "url": "https://training.galaxyproject.org//training-material/topics/admin/"
  },
  "courseCode": "admin / tool-management / slides",
  "learningResourceType": "slides",
  "name": "Slides for 'Galaxy Tool Management with Ephemeris' tutorial",
  "url": "https://training.galaxyproject.org//training-material/topics/admin/tutorials/tool-management/slides.html",
  "description": "The questions this  addresses are:\n - How to install, update, and maintain Galaxy tools?\n - How to extract a list of tools from a workflow or Galaxy instance?\n - How are tool dependencies resolved by Galaxy?\n\n\\nThe objectives are:\n - Extract a list of tools from a workflow\n - Install these tools into a given Galaxy\n - Understand the tool dependency resolution process\n\n",
  "hasPart": [

  ],
  "author": [
    {
      "@type": "Person",
      "name": "Marius van den Beek"
    },
    {
      "@type": "Person",
      "name": "Martin Čech"
    },
    {
      "@type": "Person",
      "name": "Simon Gladman"
    },
    {
      "@type": "Person",
      "name": "Helena Rasche"
    },
    {
      "@type": "Person",
      "name": "Nicola Soranzo"
    }
  ],
  "contributor": [
    {
      "@type": "Person",
      "name": "Marius van den Beek"
    },
    {
      "@type": "Person",
      "name": "Martin Čech"
    },
    {
      "@type": "Person",
      "name": "Simon Gladman"
    },
    {
      "@type": "Person",
      "name": "Helena Rasche"
    },
    {
      "@type": "Person",
      "name": "Nicola Soranzo"
    }
  ],
  "about": [
    {
      "@type": "CreativeWork",
      "name": "Galaxy Server administration",
      "description": "Resources related to configuration and maintenance of Galaxy servers",
      "url": "https://training.galaxyproject.org//training-material/topics/admin/"
    }
  ]
}
    </script>
    <script type="text/javascript" src="/training-material/assets/js/jquery.slim.min.js"></script>
  </head>
  <body>
    <textarea id="source">
name: inverse
layout: true
class: center, middle, inverse

<div class="my-header"><span>
<a href="/training-material/topics/admin" title="Return to topic page" ><i class="fa fa-level-up" aria-hidden="true"></i></a>

<a class="nav-link" href="https://github.com/galaxyproject/training-material/edit/master/topics/admin/tutorials/tool-management/slides.html"><i class="fa fa-pencil" aria-hidden="true"></i></a>

</span></div>

<div class="my-footer"><span>

<img src="/training-material/assets/images/GTN-60px.png" alt="Galaxy Training Network" style="height: 40px;"/>

</span></div>

---

# Galaxy Tool Management with Ephemeris



.footnote[Tip: press `P` to view the presenter notes]

???
Presenter notes contain extra information which might be useful if you
intend to use these slides for teaching.

Press `P` again to switch presenter notes off

Press `C` to create a new window where the same presentation will be displayed.
This window is linked to the main window. Changing slides on one will cause the
slide to change on the other. Useful when presenting.

---

## Galaxy Vocabulary

* `tool` or `tool wrapper` - XML file that describes to Galaxy how the underlying software works.
* `repository` - Versioned code archive in Tool Shed containing Galaxy tool(s).
* `requirement` or `dependency` - the underlying software needed to execute the tool command

---
class: left

# Ways to add tools

You can add tools to Galaxy either

* Manually - useful for tool development.
* From the Tool Shed
  * Through the admin UI in Galaxy
  * Using **ephemeris** (recommended)

---

## How to add tools manually

- By default Galaxy loads all tools in `tool_conf.xml.sample` into tool panel.
- To add a local tool by hand:
  - Make a copy `$ cp tool_conf.xml.sample tool_conf.xml`.
  - Add your tool entry to the `tool_conf.xml`.
- To add local tools with the [galaxyproject.galaxy Ansible role][galaxy-role]:
  - Set `galaxy_local_tools` to the local tool paths
  - Run the playbook
- Tool dependencies need to be installed separately, unless
  `conda_auto_install: true` is set in `galaxy.yml` (not recommended for
  production)


[galaxy-role]: https://galaxy.ansible.com/galaxyproject/galaxy

---

## How to install tools from the Tool Shed

- From the Galaxy admin UI, select &quot;Tool Management &gt; Install and Uninstall&quot;
- Find the repository with the tool(s) you want to install
- Install the tool repository into Galaxy

---

## How to install with Ephemeris

* Find the repository you want to install.
* Run `shed-tools install` with the repository name

---

# What is ephemeris and what does it do?

Small Python library for Galaxy Management

* Can install:
	- Tools
	- Reference data
	- Workflows
	- Data libraries
* `$ pip install ephemeris`
* https://github.com/galaxyproject/ephemeris
* https://ephemeris.readthedocs.io

---

## Install workflows

```console
workflow-install [-h] [-v] [-g GALAXY] [-u USER] [-p PASSWORD] [-a API_KEY]
	-w WORKFLOW_PATH
	[--publish_workflows]
```

(use `workflow-to-tools` to extract the list of tools used in a workflow)

---
## Get installed tool list for a Galaxy instance

```console
get-tool-list [-h] [-v] [-g GALAXY] [-u USER] [-p PASSWORD] [-a API_KEY]
	-o OUTPUT
	[--include_tool_panel_id]
	[--skip_tool_panel_name]
	[--skip_changeset_revision]
	[--get_data_managers]
	[--get_all_tools]
```

---

```yaml
tools:
- name: 'column_maker'
  owner: 'devteam'
  tool_panel_section_label: 'Columnmaker section'
- name: 'bwa'
  owner: 'devteam'
  tool_panel_section_label: 'NGS mapping'
  revisions:
  - '051eba708f43'  # 0.7.15.2
  - '4d82cf59895e'  # 0.7.16.2
  install_resolver_dependencies: False
- name: 'tabular_to_fasta'
  owner: 'devteam'
  tool_panel_section_label: 'New Converters'
  revisions:
  - '0b4e36026794'  # v1.1.0
```

---
## Install/Update/Test tools

```console
shed-tools install [-h] [-v] [-g GALAXY] [-u USER] [-p PASSWORD] [-a API_KEY]
	[--log_file LOG_FILE]
	[-t TOOL_LIST_FILE]
	[-y TOOL_YAML]
	[--name NAME]
	[--owner OWNER]
	[--revisions [REVISIONS [REVISIONS ...]]]
	[--toolshed TOOL_SHED_URL]
	[--install_tool_dependencies]
	[--skip_install_resolver_dependencies]
	[--skip_install_repository_dependencies]
	[--test]
	[--test_existing]
	[--test_json TEST_JSON]
	[--test_user_api_key TEST_USER]
	[--test_user TEST_USER]
	[--section TOOL_PANEL_SECTION_ID]
	[--section_label TOOL_PANEL_SECTION_LABEL]
	[--latest]
```

* Ansible role: https://github.com/galaxyproject/ansible-galaxy-tools
* Sample playbook: https://github.com/afgane/galaxy-tools-playbook

---

## Run data managers

```console
run-data-managers [-h] [-v] [-g GALAXY] [-u USER] [-p PASSWORD] [-a API_KEY]
	[--log_file LOG_FILE]
	--config CONFIG
	[--overwrite]
	[--ignore_errors]
```

---

## Setup data libraries

```console
setup-data-libraries [-h] [-v] [-g GALAXY] [-u USER] [-p PASSWORD] [-a API_KEY]
	-i INFILE
	[--training]
	[--legacy]
```

---
```yaml
destination:
  type: library
  name: &quot;Cool Training Library&quot;
  description: &quot;A longer description.&quot;
  synopsis: &quot;Optional - does anyone ever set this?&quot;
items:
  - name: &quot;Test Folder 1&quot;
    description: &quot;Description of what is in Test Folder 1&quot;  # Only populated with new API.
    items:
      - url: https://example.org/cliques-high-representatives.fa
        src: url
        ext: fasta
        info: &quot;A cool longer description.&quot;  # Only populated with new API.
        dbkey: &quot;hg19&quot;  # Only populated with new API.
  - name: &quot;Test data segmentation-fold&quot;
    items:
      - url: https://example.org/tests/test-data/workflow-test_cd-box_kturns.xml
        name: workflow-test_cd-box_kturns.xml  # Only populated with new API.
        info: Downloaded from https://example.org/
        src: url
        ext: xml
```

---
## Wait for Galaxy

```console
$ galaxy-wait -g http://localhost:8080 -v
[00] Galaxy not up yet... HTTPConnectionPool(host='localhost', port=8080):
	 Max retries exceeded with url: /api/version (Caused
[01] Galaxy not up yet... HTTPConnectionPool(host='localhost', port=8080):
	 Max retries exceeded with url: /api/version (Caused
[02] Galaxy not up yet... HTTPConnectionPool(host='localhost', port=8080):
	 Max retries exceeded with url: /api/version (Caused
[03] Galaxy not up yet... HTTPConnectionPool(host='localhost', port=8080):
	 Max retries exceeded with url: /api/version (Caused
[04] Galaxy not up yet... HTTPConnectionPool(host='localhost', port=8080):
	 Max retries exceeded with url: /api/version (Caused
[05] Galaxy not up yet... HTTPConnectionPool(host='localhost', port=8080):
	 Max retries exceeded with url: /api/version (Caused

Galaxy Version: 17.05
```

---

# More on Tool Management:

- Tool installation
- Configuration
- Dependencies

---

## What happens when installing a tool from TS

* Repository is downloaded.
* If needed, Galaxy installs the tool's dependencies typically using [conda][conda].
* Galaxy creates an entry for the tool in its database.
* Galaxy adds the tool to `shed_tool_conf.xml` .

[conda]: https://conda.io/

---
class: left

## Example `shed_tool_conf.xml` entry

```xml
&lt;section id=&quot;filter&quot; name=&quot;Filter and Sort&quot; version=&quot;&quot;&gt;
  &lt;tool file=&quot;testtoolshed.g2.bx.psu.edu/repos/devteam/bamtools_filter/23a1c1f66b47/bamtools_filter/bamtools-filter.xml&quot; guid=&quot;testtoolshed.g2.bx.psu.edu/repos/devteam/bamtools_filter/bamFilter/0.0.1&quot;&gt;
      &lt;tool_shed&gt;testtoolshed.g2.bx.psu.edu&lt;/tool_shed&gt;
        &lt;repository_name&gt;bamtools_filter&lt;/repository_name&gt;
        &lt;repository_owner&gt;devteam&lt;/repository_owner&gt;
        &lt;installed_changeset_revision&gt;23a1c1f66b47&lt;/installed_changeset_revision&gt;
        &lt;id&gt;testtoolshed.g2.bx.psu.edu/repos/devteam/bamtools_filter/bamFilter/0.0.1&lt;/id&gt;
        &lt;version&gt;0.0.1&lt;/version&gt;
    &lt;/tool&gt;
&lt;/section&gt;
```

---

## Tool panel management

* How the tool panel looks like is decided in a file called `integrated_tool_panel.xml`.
* By default it resides in Galaxy's `config/` folder.
* If missing it is generated from all other tool config files during startup.
* Modify it if you want to reorder tools or move section.

```xml
&lt;section id=&quot;filter&quot; name=&quot;Filter and Sort&quot; version=&quot;&quot;&gt;
    &lt;tool id=&quot;testtoolshed.g2.bx.psu.edu/repos/devteam/bamtools_filter/bamFilter/0.0.1&quot; /&gt;
&lt;/section&gt;
```

---

## Tool dependency resolution

* We aim to make Galaxy resolver-independent but Conda-oriented.
* What resolver is going to be used for the tool dependencies is determined at runtime
according to the order specified in `dependency_resolvers_conf.xml`.

```xml
&lt;dependency_resolvers&gt;
  &lt;tool_shed_packages /&gt;
  &lt;galaxy_packages /&gt;
  &lt;conda /&gt;
  &lt;galaxy_packages versionless=&quot;true&quot; /&gt;
  &lt;conda versionless=&quot;true&quot; /&gt;
&lt;!-- other resolvers
  &lt;lmod /&gt;
  &lt;lmod versionless=&quot;true&quot; /&gt;
  &lt;modules modulecmd=&quot;/opt/Modules/3.2.9/bin/modulecmd&quot; /&gt;
  &lt;modules modulecmd=&quot;/opt/Modules/3.2.9/bin/modulecmd&quot; versionless=&quot;true&quot; default_indicator=&quot;default&quot; /&gt;
  &lt;tool_shed_tap /&gt;
  &lt;homebrew /&gt;
--&gt;
&lt;/dependency_resolvers&gt;
```

[Full documentation](https://docs.galaxyproject.org/en/master/admin/dependency_resolvers.html)

---
class: left

## Dependency resolution example

Tool XML contains:

```xml
&lt;tool id=&quot;foo&quot;&gt;
    &lt;requirements&gt;
        &lt;requirement type=&quot;package&quot; version=&quot;4.2&quot;&gt;bar&lt;/requirement&gt;
    &lt;/requirements&gt;
&lt;/tool&gt;
```

---
class: left

## `&lt;tool_shed_packages /&gt;`

Did tool `foo` depend on a Tool Shed package providing `bar` 4.2 when installed?
- Yes: Query install DB for `repo_owner`, `repo_name`, `changeset_id`, then source:
  - `&lt;tool_dependencies_dir&gt;/bar/4.2/&lt;repo_owner&gt;/&lt;repo_name&gt;/&lt;changeset_id&gt;/env.sh`
- No: continue

---
class: left

## `&lt;galaxy_packages /&gt;`

Does `&lt;tool_dependency_dir&gt;/bar/4.2/env.sh` exist?:
- Yes: source it
- No: Does `&lt;tool_dependency_dir&gt;/bar/4.2/bin/` exist?:
  - Yes: prepend it to `$PATH`
  - No: continue

Good for dependencies manually installed by an administrator

---
class: left

## `&lt;conda /&gt;`

Does `bar==4.2` exist in Conda?:
- Yes: use `conda create` to create a Conda env in `&lt;conda_prefix&gt;/envs/` (if it doesn't exist already), then activate it
- No: continue

[Conda for tool dependencies FAQ](https://docs.galaxyproject.org/en/master/admin/conda_faq.html)

---
class: left

## `&lt;galaxy_packages versionless=&quot;true&quot; /&gt;`

Does `&lt;tool_dependency_dir&gt;/bar/default/` exist and is it a symlink?:

- Yes: Does `&lt;tool_dependency_dir&gt;/bar/default/env.sh` exist?:
  - Yes: source it
  - No: Does `&lt;tool_dependency_dir&gt;/bar/default/bin/` exist?:
      - Yes: prepend it to `$PATH`
      - No: continue
- No: continue

---
class: left

## `&lt;conda versionless=&quot;true&quot; /&gt;`

Does `bar` (any version) exist in Conda?:
- Yes: use `conda create` to create env in job working directory
- No: continue

---
class: left

## `&lt;modules modulecmd=&quot;...&quot; /&gt;`

Is `bar/4.2` a registered module?:
- Yes: Load module `bar/4.2`
- No: continue

See: [Environment Modules](http://modules.sourceforge.net/)

---
class: left

## `&lt;modules modulecmd=&quot;...&quot; versionless=&quot;true&quot; /&gt;`

Is `bar/default` a registered module?:
- Yes: Load module `bar/default`
- No: continue

---

## If dependency is not resolved

Submit the job anyway, maybe it's available on `$PATH`

---

## Using containers for Tool Dependencies

- Galaxy can also use **Docker** or **Singularity** containers to resolve dependencies
- You can read more about this in the [Tool Dependencies and Containers slides](../../../dev/tutorials/containers/slides.html)


---

## Thank you!

This material is the result of a collaborative work. Thanks to the [Galaxy Training Network](https://wiki.galaxyproject.org/Teach/GTN) and all the contributors!


<div class="contributors-line">


<a href="/training-material/hall-of-fame/mvdbeek/" class="contributor-badge"><img src="https://avatars.githubusercontent.com/mvdbeek" alt="Marius van den Beek">Marius van den Beek</a>, <a href="/training-material/hall-of-fame/martenson/" class="contributor-badge"><img src="https://avatars.githubusercontent.com/martenson" alt="Martin Čech">Martin Čech</a>, <a href="/training-material/hall-of-fame/slugger70/" class="contributor-badge"><img src="https://avatars.githubusercontent.com/slugger70" alt="Simon Gladman">Simon Gladman</a>, <a href="/training-material/hall-of-fame/hexylena/" class="contributor-badge"><img src="https://avatars.githubusercontent.com/hexylena" alt="Helena Rasche">Helena Rasche</a>, <a href="/training-material/hall-of-fame/nsoranzo/" class="contributor-badge"><img src="https://avatars.githubusercontent.com/nsoranzo" alt="Nicola Soranzo">Nicola Soranzo</a>


</div>



<img src="/training-material/assets/images/GTN.png" alt="Galaxy Training Network" style="height: 100px;"/>


This material is licensed under the <a rel="license" href="https://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 International License</a>.


.footnote[Found a typo? Something is wrong in this tutorial? <br/>Edit it on [GitHub](https://github.com/galaxyproject/training-material/tree/master/topics/admin/tutorials/tool-management/slides.html)]

    </textarea>
	<script src="/training-material/assets/js/remark-latest.min.js" type="text/javascript"></script>
    <script type="text/javascript" src="/training-material/assets/js/theme.js"></script>
    <script type="text/javascript" src="/training-material/assets/js/clipboard.min.js"></script>
    <script type="text/javascript">
      var slideshow = remark.create({navigation: {scroll: false,}});
      var hljs = remark.highlighter.engine;
      var snippets = document.querySelectorAll('code.remark-code');
        [].forEach.call(snippets,function(snippet){
          snippet.firstChild.insertAdjacentHTML('beforebegin','<button class="btn btn-light" data-clipboard-snippet><i class="fa fa-copy"></i>&nbsp;Copy</button>');
        });
      var clipboardSnippets=new ClipboardJS('[data-clipboard-snippet]',{
        target:function(trigger){return trigger.parentElement;
      }});
    </script>

    <script type="text/javascript">
        if(window.location.hostname === "galaxyproject.github.io") {
            // Redirect
            var redirect = "https://training.galaxyproject.org" + window.location.pathname + window.location.search;
            $('body').prepend("<div style='text-align: center'><strong>Note: </strong>This content has a new home at <a href=\"" + redirect + "\">" + redirect + "</a>, which you will be redirected to in 5 seconds.</div>");

            window.setTimeout(function(){
                window.location.href = redirect;
            }, 5000)

        }
    </script>

  </body>
</html>
