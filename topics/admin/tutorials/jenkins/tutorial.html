<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
        <title>Automation with Jenkins</title>
        <link rel="stylesheet" href="/training-material/assets/css/bootstrap.min.css?v=3">
        <link rel="stylesheet" href="/training-material/assets/css/bootstrap-toc.min.css">
        <link rel="stylesheet" href="/training-material/assets/css/main.css?v=2">
        <script src="https://kit.fontawesome.com/67b3f98409.js" crossorigin="anonymous"></script>
        <link rel="stylesheet" href="/training-material/assets/css/academicons.css">
        <link rel="stylesheet" href="/training-material/assets/css/syntax_highlighting.css">
        <link rel="shortcut icon" href="/training-material/favicon.ico" type="image/x-icon" />

        
        
        
        
        
        <meta name="description" content="Resources related to configuration and maintenance of Gal..." />
        <meta property="og:title" content="Galaxy Training: Automation with Jenkins" />
        <meta property="og:description" content="Resources related to configuration and maintenance of Gal..." />
        <meta property="og:image" content="/training-material/assets/images/GTNLogo1000.png" />
    </head>
    <body data-spy="scroll" data-target="#toc">
        











<!-- Gitter -->


<script>
  ((window.gitter = {}).chat = {}).options = {
  room: 'galaxyproject/admins'
  };
</script>
<script src="https://sidecar.gitter.im/dist/sidecar.v1.js" async defer></script>

<header>
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand" href="/training-material/">
                <img src="/training-material/assets/images/GTN-60px.png" height="30" alt="Galaxy Training Network logo">
                Galaxy Training!
            </a>

            <button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse" data-target="#top-navbar" aria-controls="top-navbar" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="top-navbar">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="/training-material/topics/admin" title="Go back to list of tutorials">
                            <i class="far fa-folder" aria-hidden="true"></i><span class="visually-hidden">topic</span> Galaxy Server administration
                        </a>
                    </li>

                    <li class="nav-item dropdown">
                        <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown" aria-expanded="false" title="Language Selector">
                            <i class="fas fa-language" aria-hidden="true"></i><span class="visually-hidden">language</span> Language
                        </a>
                        <div class="dropdown-menu">
                            
                            <a class="dropdown-item" href="https://translate.google.com/translate?hl=jp&sl=en&tl=fr&u=https%3A%2F%2Ftraining.galaxyproject.org%2Ftopics%2Fadmin%2Ftutorials%2Fjenkins%2Ftutorial.html&edit-text=&act=url" title="">
                                Fran√ßais
                            </a>
                            
                            <a class="dropdown-item" href="https://translate.google.com/translate?hl=jp&sl=en&tl=ja&u=https%3A%2F%2Ftraining.galaxyproject.org%2Ftopics%2Fadmin%2Ftutorials%2Fjenkins%2Ftutorial.html&edit-text=&act=url" title="">
                                Êó•Êú¨Ë™û
                            </a>
                            
                            <a class="dropdown-item" href="https://translate.google.com/translate?hl=jp&sl=en&tl=es&u=https%3A%2F%2Ftraining.galaxyproject.org%2Ftopics%2Fadmin%2Ftutorials%2Fjenkins%2Ftutorial.html&edit-text=&act=url" title="">
                                Espa√±ol
                            </a>
                            
                            <a class="dropdown-item" href="https://translate.google.com/translate?hl=jp&sl=en&tl=pt&u=https%3A%2F%2Ftraining.galaxyproject.org%2Ftopics%2Fadmin%2Ftutorials%2Fjenkins%2Ftutorial.html&edit-text=&act=url" title="">
                                Portugu√™s
                            </a>
                            
                            <a class="dropdown-item" href="https://translate.google.com/translate?hl=jp&sl=en&tl=ar&u=https%3A%2F%2Ftraining.galaxyproject.org%2Ftopics%2Fadmin%2Ftutorials%2Fjenkins%2Ftutorial.html&edit-text=&act=url" title="">
                                ÿßŸÑÿπÿ±ÿ®Ÿäÿ©
                            </a>
                            
                            <a class="dropdown-item" href="https://translate.google.com/translate?hl=jp&sl=en&tl=&u=https%3A%2F%2Ftraining.galaxyproject.org%2Ftopics%2Fadmin%2Ftutorials%2Fjenkins%2Ftutorial.html&edit-text=&act=url" title="">
                                And more!
                            </a>
                        </div>
                    </li>

                    <li class="nav-item dropdown">
    <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown" aria-expanded="false" title="Help">
        <i class="far fa-question-circle" aria-hidden="true"></i><span class="visually-hidden">help</span> Help
    </a>
    <div class="dropdown-menu dropdown-menu-right">
        <form method="get" action="https://tess.elixir-europe.org/materials">
            <input type="text" id="search" name="q" value="" style="margin-left: 0.5em;/*! border-radius: 0px; */">
            <input type="hidden" value="Galaxy Training" name="content_provider">
            <input type="submit" value="Search on TeSS" style="width: 92%;border-radius: 0px;margin: 0.5em;background: #f47d20;border: 0px;padding: 0.25em;" class="">
        </form>

        <div class="dropdown-divider"></div>
        <a class="dropdown-item" href="/training-material/faq" title="Check our FAQ">
            FAQ
        </a>
        <a class="dropdown-item" href="https://help.galaxyproject.org/" title="Discuss on Galaxy Help">
            Discuss on Galaxy Help
        </a>

        <div class="dropdown-item">
            <div>
                Theme
            </div>

            <div id="theme-selector" data-toggle="buttons">
                <label data-value="default" class="btn btn-secondary">
                    <input type="radio" name="options" id="default" autocomplete="off"> Default
                </label>
                <label data-value="night" class="btn btn-secondary">
                    <input type="radio" name="options" id="night" autocomplete="off"> Night
                </label>
                <label data-value="midnight" class="btn btn-secondary">
                    <input type="radio" name="options" id="midnight" autocomplete="off"> Midnight
                </label>
                <label data-value="rainbow" class="btn btn-secondary">
                    <input type="radio" name="options" id="rainbow" autocomplete="off"> Rainbow
                </label>
                <label data-value="halloween" class="btn btn-secondary">
                    <input type="radio" name="options" id="halloween" autocomplete="off"> üéÉ
                </label>
            </div>

        </div>
    </div>
</li>


                    <li class="nav-item">
                        <a class="nav-link" href="https://github.com/galaxyproject/training-material/edit/master/topics/admin/tutorials/jenkins/tutorial.md">
                            <i class="fab fa-github" aria-hidden="true"></i><span class="visually-hidden">github</span> Edit
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>
</header>

<div class="container main-content">
    <script type="application/ld+json">
        


{
  "@context": "http://schema.org",
  "@type": "Course",
  "accessMode": [
    "textual",
    "visual"
  ],
  "accessModeSufficient": [
    "textual",
    "visual"
  ],
  "accessibilityControl": [
    "fullKeyboardControl",
    "fullMouseControl"
  ],
  "accessibilityFeature": [
    "alternativeText",
    "tableOfContents"
  ],
  "accessibilitySummary": "Short descriptions are present but long descriptions will be needed for non-visual users",
  "audience": {
    "@type": "EducationalAudience",
    "educationalRole": "students"
  },
  "citation": {
    "@type": "CreativeWork",
    "name": "Community-Driven Data Analysis Training for Biology",
    "url": "https://doi.org/10.1016/j.cels.2018.05.012"
  },
  "copyrightHolder": {
    "@type": "Organization",
    "email": "galaxytrainingnetwork@gmail.com",
    "name": "Galaxy Training Network",
    "url": "https://galaxyproject.org/teach/gtn/"
  },
  "discussionUrl": "https://gitter.im/Galaxy-Training-Network/Lobby",
  "headline": "Automation with Jenkins",
  "inLanguage": {
    "@type": "Language",
    "name": "English",
    "alternateName": "en"
  },
  "interactivityType": "mixed",
  "isAccessibleForFree": true,
  "license": "https://github.com/galaxyproject/training-material/blob/master/LICENSE.md",
  "producer": {
    "@type": "Organization",
    "email": "galaxytrainingnetwork@gmail.com",
    "name": "Galaxy Training Network",
    "url": "https://galaxyproject.org/teach/gtn/"
  },
  "provider": {
    "@type": "Organization",
    "email": "galaxytrainingnetwork@gmail.com",
    "name": "Galaxy Training Network",
    "url": "https://galaxyproject.org/teach/gtn/"
  },
  "sourceOrganization": {
    "@type": "Organization",
    "email": "galaxytrainingnetwork@gmail.com",
    "name": "Galaxy Training Network",
    "url": "https://galaxyproject.org/teach/gtn/"
  },
  "isPartOf": {
    "@type": "CreativeWork",
    "name": "Galaxy Server administration",
    "description": "Resources related to configuration and maintenance of Galaxy servers",
    "url": "https://training.galaxyproject.org//training-material/topics/admin/"
  },
  "courseCode": "admin / jenkins / hands-on",
  "learningResourceType": "hands-on tutorial",
  "name": "Hands-on for 'Automation with Jenkins' tutorial",
  "url": "https://training.galaxyproject.org//training-material/topics/admin/tutorials/jenkins/tutorial.html",
  "timeRequired": "PT1H",
  "keywords": "automation",
  "description": "The questions this  addresses are:\n - What sort of tasks should be automated?\n - What are my options for automation?\n - How can I automate repetitive tasks?\n\n\\nThe objectives are:\n - Setup Jenkins\n - Setup a simple job\n - Automate running of the Galaxy playbook\n - Secure Jenkins\n\n",
  "coursePrerequisites": [
    {
      "@type": "Course",
      "url": "https://training.galaxyproject.org//training-material/topics/admin/tutorials/ansible/slides.html",
      "name": "Ansible",
      "description": "Slides for 'Ansible' tutorial",
      "learningResourceType": "slides",
      "interactivityType": "expositive",
      "provider": {
        "@type": "Organization",
        "email": "galaxytrainingnetwork@gmail.com",
        "name": "Galaxy Training Network",
        "url": "https://galaxyproject.org/teach/gtn/"
      }
    },
    {
      "@type": "Course",
      "url": "https://training.galaxyproject.org//training-material/topics/admin/tutorials/ansible/tutorial.html",
      "name": "Ansible",
      "description": "Hands-on for 'Ansible' tutorial",
      "learningResourceType": "hands-on tutorial",
      "interactivityType": "expositive",
      "provider": {
        "@type": "Organization",
        "email": "galaxytrainingnetwork@gmail.com",
        "name": "Galaxy Training Network",
        "url": "https://galaxyproject.org/teach/gtn/"
      }
    },
    {
      "@type": "Course",
      "url": "https://training.galaxyproject.org//training-material/topics/admin/tutorials/ansible-galaxy/slides.html",
      "name": "Galaxy Installation with Ansible",
      "description": "Slides for 'Galaxy Installation with Ansible' tutorial",
      "learningResourceType": "slides",
      "interactivityType": "expositive",
      "provider": {
        "@type": "Organization",
        "email": "galaxytrainingnetwork@gmail.com",
        "name": "Galaxy Training Network",
        "url": "https://galaxyproject.org/teach/gtn/"
      }
    },
    {
      "@type": "Course",
      "url": "https://training.galaxyproject.org//training-material/topics/admin/tutorials/ansible-galaxy/tutorial.html",
      "name": "Galaxy Installation with Ansible",
      "description": "Hands-on for 'Galaxy Installation with Ansible' tutorial",
      "learningResourceType": "hands-on tutorial",
      "interactivityType": "expositive",
      "provider": {
        "@type": "Organization",
        "email": "galaxytrainingnetwork@gmail.com",
        "name": "Galaxy Training Network",
        "url": "https://galaxyproject.org/teach/gtn/"
      }
    }
  ],
  "hasPart": [

  ],
  "author": [
    {
      "@type": "Person",
      "name": "Helena Rasche"
    }
  ],
  "contributor": [
    {
      "@type": "Person",
      "name": "Helena Rasche"
    }
  ],
  "about": [
    {
      "@type": "CreativeWork",
      "name": "Galaxy Server administration",
      "description": "Resources related to configuration and maintenance of Galaxy servers",
      "url": "https://training.galaxyproject.org//training-material/topics/admin/"
    }
  ]
}
    </script>

    <section class="tutorial">
        <h1 data-toc-skip>Automation with Jenkins</h1>
        

        <div class="contributors-line">By: 

<a href="/training-material/hall-of-fame/hexylena/" class="contributor-badge"><img src="https://avatars.githubusercontent.com/hexylena" alt="Helena Rasche">Helena Rasche</a>

</div>

        <blockquote class="overview">
            <h3>Overview</h3>
            <strong><i class="far fa-question-circle" aria-hidden="true"></i><span class="visually-hidden">question</span> Questions</strong>
            <ul>
            
            <li><p>What sort of tasks should be automated?</p>
</li>
            
            <li><p>What are my options for automation?</p>
</li>
            
            <li><p>How can I automate repetitive tasks?</p>
</li>
            
            </ul>

            <strong><i class="fas fa-bullseye" aria-hidden="true"></i><span class="visually-hidden">objectives</span> Objectives</strong>
            <ul>
            
            <li><p>Setup Jenkins</p>
</li>
            
            <li><p>Setup a simple job</p>
</li>
            
            <li><p>Automate running of the Galaxy playbook</p>
</li>
            
            <li><p>Secure Jenkins</p>
</li>
            
            </ul>

            
            <strong><i class="fas fa-check-circle" aria-hidden="true"></i><span class="visually-hidden">requirements</span> Requirements</strong>
            <ul>
            
            
    <li>
    
        
        
        <a href="/training-material/topics/admin">Galaxy Server administration</a>
        
            <ul>
                
                    
                        
                    
                        
                    
                        
                            
                            <li> Ansible:
                            
                                <a href="/training-material/topics/admin/tutorials/ansible/slides.html"><i class="fab fa-slideshare" aria-hidden="true"></i><span class="visually-hidden">slides</span> slides</a>
                                
                            
                            
                                
                                    - <a href="/training-material/topics/admin/tutorials/ansible/tutorial.html"><i class="fas fa-laptop" aria-hidden="true"></i><span class="visually-hidden">tutorial</span> hands-on</a>
                                
                            
                            </li>
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                            
                            <li> Galaxy Installation with Ansible:
                            
                                <a href="/training-material/topics/admin/tutorials/ansible-galaxy/slides.html"><i class="fab fa-slideshare" aria-hidden="true"></i><span class="visually-hidden">slides</span> slides</a>
                                
                            
                            
                                
                                    - <a href="/training-material/topics/admin/tutorials/ansible-galaxy/tutorial.html"><i class="fas fa-laptop" aria-hidden="true"></i><span class="visually-hidden">tutorial</span> hands-on</a>
                                
                            
                            </li>
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                
            </ul>
        
    
    </li>

            </ul>
            

            
            <p><strong><i class="fas fa-hourglass-half" aria-hidden="true"></i><span class="visually-hidden">time</span> Time estimation:</strong> 1 hour</p>
            

            

            
            

            
            <p id="supporting-materials"><strong><i class="fa fa-external-link" aria-hidden="true"></i> Supporting Materials</strong></p>
            <ul>
                <div class="supporting_material">
                
                    <li class="btn btn-default supporting_material"><a href="/training-material/topics/admin/slides/introduction.html" title="Topic Overview slides">
                        <i class="fab fa-slideshare" aria-hidden="true"></i><span class="visually-hidden">slides</span> Topic Overview slides
                    </a></li>
                

                

                

                

                
                </div>
            </ul>
            

            <p><strong> <i class="far fa-calendar" aria-hidden="true"></i><span class="visually-hidden">last_modification</span> Last modification:</strong> Jan 6, 2021 </p>
        </blockquote>

        <div class="container">
            <div class="row">
                <!-- sidebar, which will move to the top on a small screen -->
                <div class="col-sm-2">
                    <nav id="toc" data-toggle="toc" class="sticky-top"></nav>
                </div>
                <div class="col-sm-10">
                    <h1 class="no_toc" id="overview">Overview</h1>

<p>Automation is a key component for making your life easier. There are dozens of regular, boring tasks involved in server administration, and many of these can be automated in order to make your life easier.
<abbr title="Continuous Integration">CI</abbr> systems provide one way to accomplish this.
Many of these systems focus on testing and deploying code, and provide some built-in shortcuts to accomplish this.
Testing and deploying code boils down to ‚Äúplease run this command, when X happens‚Äù, and they tend to function as ‚Äúcommands as a service‚Äù.
You can often configure them to ‚Äútest code when it is pushed to a branch on GitHub‚Äù, or ‚Äútest this code daily‚Äù or ‚Äúdeploy this code daily‚Äù.
If you need to automatically run a command whenever some event happens, and then to report this back in some standardised way (GitHub PR statuses, automatically deploying, notifications in chat), then a CI system can do this for you.</p>

<p>There are many options for, some of these have different features which may be desirable in one or another scenario.
This tutorial will specifically cover automation with Jenkins as that is one of the tools <code class="language-plaintext highlighter-rouge">use<span class="notranslate">galaxy</span>.*</code> use for a subset of their automation.</p>

<blockquote class="agenda">
  <h3 id="agenda">Agenda</h3>

<ol id="markdown-toc">
  <li><a href="#comparison-of-ci-systems" id="markdown-toc-comparison-of-ci-systems">Comparison of CI Systems</a></li>
  <li><a href="#infrastructure" id="markdown-toc-infrastructure">Infrastructure</a>    <ol>
      <li><a href="#jenkins" id="markdown-toc-jenkins">Jenkins</a></li>
    </ol>
  </li>
  <li><a href="#building-things-with-jenkins" id="markdown-toc-building-things-with-jenkins">Building things with Jenkins</a>    <ol>
      <li><a href="#a-simple-job" id="markdown-toc-a-simple-job">A simple job</a></li>
      <li><a href="#ansible-in-jenkins" id="markdown-toc-ansible-in-jenkins">Ansible in Jenkins</a></li>
    </ol>
  </li>
  <li><a href="#securing-jenkins" id="markdown-toc-securing-jenkins">Securing Jenkins</a></li>
  <li><a href="#advanced-topics" id="markdown-toc-advanced-topics">Advanced Topics</a>    <ol>
      <li><a href="#updating-jenkins" id="markdown-toc-updating-jenkins">Updating Jenkins</a></li>
      <li><a href="#updating-plugins" id="markdown-toc-updating-plugins">Updating Plugins</a></li>
      <li><a href="#plugins" id="markdown-toc-plugins">Plugins</a></li>
      <li><a href="#real-life-examples" id="markdown-toc-real-life-examples">Real Life Examples</a></li>
    </ol>
  </li>
</ol>

</blockquote>

<h1 id="comparison-of-ci-systems">Comparison of CI Systems</h1>

<p>There are dozens of CI systems available meeting different needs, which CI system you want to use depends largely on the task you are trying to automate. A couple of key factors you may wish to consider are:</p>

<ul>
  <li>How long will jobs run for? Free services often have time and log-output limits.</li>
  <li>Are you concerned about secret storage? Self-hosted can be a better option here, but it depends on your security posture and threat matrix.</li>
  <li>Do you have infrastructure available? Self-hosted could be worth it for the extra freedoms.</li>
</ul>

<p>In general, self-hosted options have the overhead of managing and securing and updating the service, but offer significantly more freedom if you need it. They generally provide poor per-job isolation and assume you trust all of the jobs and people with access to build scripts used in the build pipeline. The free services (Travis, Circle CI) often have much better user-experiences and are easier to get started with and provide better out-of-the-box isolation.</p>

<p>We will look at setting up and managing a Jenkins server today, how to setup tasks, and some of the things that <code class="language-plaintext highlighter-rouge">use<span class="notranslate">galaxy</span>.*</code> automate with their Jenkins servers.</p>

<h1 id="infrastructure">Infrastructure</h1>

<p>As per many of the tutorials, we will use Ansible to setup and manage our Jenkins server so we can easily leverage the work of a large community. Jenkins is one choice, there are other self-hosted systems you could use, but it is the one with which many of us are familiar.</p>

<h2 id="jenkins">Jenkins</h2>

<blockquote class="notranslate hands_on">
  <h3 id="hands_on-hands-on-setting-up-jenkins"><i class="fas fa-pencil-alt" aria-hidden="true"></i><span class="visually-hidden">hands_on</span> Hands-on: Setting up Jenkins</h3>

  <ol>
    <li>
      <p>Edit your <code class="language-plaintext highlighter-rouge">requirements.yml</code> and add the following:</p>

      <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="pi">-</span> <span class="na">src</span><span class="pi">:</span> <span class="s">geerlingguy.java</span>
  <span class="na">version</span><span class="pi">:</span> <span class="s">1.9.5</span>
<span class="pi">-</span> <span class="na">src</span><span class="pi">:</span> <span class="s">geerlingguy.jenkins</span>
  <span class="na">version</span><span class="pi">:</span> <span class="s">3.7.0</span>
</code></pre></div>      </div>
    </li>
    <li>
      <p>Install the requirements</p>

      <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ansible-<span class="notranslate">galaxy</span> install -p roles -r requirements.yml
</code></pre></div>      </div>
    </li>
    <li>
      <p>Create a new playbook, <code class="language-plaintext highlighter-rouge">build.yml</code> with the following:</p>

      <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">---</span>
<span class="pi">-</span> <span class="na">hosts</span><span class="pi">:</span> <span class="s">build</span>
  <span class="na">become</span><span class="pi">:</span> <span class="no">true</span>
  <span class="na">pre_tasks</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Allow jenkins user to execute things as root</span>
      <span class="na">copy</span><span class="pi">:</span>
        <span class="na">content</span><span class="pi">:</span> <span class="pi">|</span>
          <span class="s">jenkins ALL=(ALL:ALL) NOPASSWD:ALL</span>
        <span class="na">dest</span><span class="pi">:</span> <span class="s">/etc/sudoers.d/jenkins</span>
        <span class="na">validate</span><span class="pi">:</span> <span class="s1">'</span><span class="s">visudo</span><span class="nv"> </span><span class="s">-cf</span><span class="nv"> </span><span class="s">%s'</span>
        <span class="na">mode</span><span class="pi">:</span> <span class="m">0440</span>
  <span class="na">roles</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">geerlingguy.java</span>
    <span class="pi">-</span> <span class="s">geerlingguy.jenkins</span>
</code></pre></div>      </div>

      <p>During this tutorial we will install everything on the same host, but often one keeps the build infrastructure on a separate host. We permit the Jenkins user to run everything as root, because later we will run Ansible with Jenkins, and we have <code class="language-plaintext highlighter-rouge">become: true</code> in our <code class="language-plaintext highlighter-rouge"><span class="notranslate">galaxy</span>.yml</code> playbook, so the <code class="language-plaintext highlighter-rouge">jenkins</code> user will need to be able to become root.</p>
    </li>
    <li>
      <p>Edit the inventory file (<code class="language-plaintext highlighter-rouge">hosts</code>) an add a group for monitoring like:</p>

      <div class="language-ini highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">[build]</span>
<span class="err">localhost</span> <span class="py">ansible_connection</span><span class="p">=</span><span class="s">local</span>
</code></pre></div>      </div>
    </li>
    <li>
      <p>Create and edit the group variables for the <code class="language-plaintext highlighter-rouge">build</code> group, <code class="language-plaintext highlighter-rouge">group_vars/build.yml</code>, and include the following:</p>

      <div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">jenkins_http_port</span><span class="pi">:</span> <span class="m">4000</span>
<span class="na">jenkins_admin_use<span class="notranslate">rna</span>me</span><span class="pi">:</span> <span class="s">admin</span>
<span class="c1"># Please change at least the password to something more suitable</span>
<span class="na">jenkins_admin_password</span><span class="pi">:</span> <span class="s">admin</span>
<span class="na">jenkins_url_prefix</span><span class="pi">:</span> <span class="s">/jenkins</span>
<span class="na">jenkins_plugins</span><span class="pi">:</span>
<span class="pi">-</span> <span class="s">matrix-auth</span>
</code></pre></div>      </div>

      <p>We need to set the port because it defaults to <code class="language-plaintext highlighter-rouge">8080</code> and <span class="notranslate">Galaxy</span> currently listens on port 8080.</p>
    </li>
    <li>
      <p>Run the build server playbook:</p>

      <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ansible-playbook -i hosts build.yml
</code></pre></div>      </div>
    </li>
    <li>
      <p>Update the nginx configuration in <code class="language-plaintext highlighter-rouge">templates/nginx/<span class="notranslate">galaxy</span>.j2</code> to proxy jenkins with the following. Add it <em>before the last curly brace</em> at the end of the file.</p>

      <div class="language-nginx highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">location</span> <span class="n">/jenkins</span> <span class="p">{</span>
        <span class="kn">proxy_set_header</span>        <span class="s">Host</span> <span class="nv">$host</span><span class="p">:</span><span class="nv">$server_port</span><span class="p">;</span>
        <span class="kn">proxy_set_header</span>        <span class="s">X-Real-IP</span> <span class="nv">$remote_addr</span><span class="p">;</span>
        <span class="kn">proxy_set_header</span>        <span class="s">X-Forwarded-For</span> <span class="nv">$proxy_add_x_forwarded_for</span><span class="p">;</span>
        <span class="kn">proxy_set_header</span>        <span class="s">X-Forwarded-Proto</span> <span class="nv">$scheme</span><span class="p">;</span>

        <span class="c1"># Fix the "It appears that your reverse proxy set up is broken" error.</span>
        <span class="kn">proxy_pass</span>          <span class="s">http://127.0.0.1:4000</span><span class="p">;</span>
        <span class="kn">proxy_read_timeout</span>  <span class="mi">90</span><span class="p">;</span>
    <span class="p">}</span>
</code></pre></div>      </div>
    </li>
    <li>
      <p>Run the <span class="notranslate">galaxy</span> playbook which contains Nginx:</p>

      <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ansible-playbook -i hosts <span class="notranslate">galaxy</span>.yml
</code></pre></div>      </div>
    </li>
  </ol>

</blockquote>

<p>With this, we‚Äôre done, Jenkins is set up and ready to use!</p>

<h1 id="building-things-with-jenkins">Building things with Jenkins</h1>

<p>We will look at a couple basic cases of how to build things with Jenkins, and wrap up with some advanced usage documentation that is not so practical for a tutorial environment.</p>

<p>Start by <strong>visiting your Jenkins instance</strong>, at <code class="language-plaintext highlighter-rouge">https://your-domain/jenkins</code></p>

<figure id="figure-1"><img src="../../images/jenkins-01-welcome.png" alt="Welcome to Jenkins" /><figcaption><span class="figcaption-prefix">Figure 1:</span> Welcome to Jenkins! This is how it looks once you've run the playbook and logged in. The menu on the left gives you some ability to configure Jenkins, below it is the job queue where running and queued jobs will appear. When you have configured some jobs, they will be visible in the central panel.</figcaption></figure>

<h2 id="a-simple-job">A simple job</h2>

<blockquote class="notranslate hands_on">
  <h3 id="hands_on-hands-on-create-a-simple-job"><i class="fas fa-pencil-alt" aria-hidden="true"></i><span class="visually-hidden">hands_on</span> Hands-on: Create a simple job</h3>

  <ol>
    <li>
      <p>Visit your Jenkins and login with the credentials you set up in the group variables file</p>
    </li>
    <li>
      <p>Click <strong>New Item</strong> in the left hand menu</p>
    </li>
    <li>
      <p>Give your job a name like <code class="language-plaintext highlighter-rouge">my-project</code>, and select that it is a <code class="language-plaintext highlighter-rouge">freestyle project</code>, and click ‚ÄúOK‚Äù</p>

      <figure id="figure-2"><img src="../../images/jenkins-02-create-job.png" alt="Create a job" /><figcaption><span class="figcaption-prefix">Figure 2:</span> There are other types of jobs if you install plugins, but we will mostly use freestyle jobs as they are the most appropriate for our case.</figcaption></figure>
    </li>
    <li>
      <p>The job configuration interface is split into a few sections, visible in the tabs at the top of the page:</p>

      <figure id="figure-3"><img src="../../images/jenkins-03-job-config.png" alt="Job configuration interface" /><figcaption><span class="figcaption-prefix">Figure 3:</span> The job configuration interface, split into 'General', 'Source Code Management', 'Build Triggers', 'Build', and 'Post-build Actions'</figcaption></figure>
    </li>
    <li>
      <p>In the <strong>Build Triggers</strong> section:</p>

      <ul>
        <li>Build Periodically
          <ul>
            <li><em>‚ÄúSchedule‚Äù</em>: <code class="language-plaintext highlighter-rouge">H * * * * </code></li>
          </ul>
        </li>
      </ul>

      <blockquote class="details">
        <h3 id="details-cron-syntax"><i class="fas fa-info-circle" aria-hidden="true"></i><span class="visually-hidden">details</span> Cron syntax</h3>
        <p>Jenkins uses the <a href="https://en.wikipedia.org/wiki/Cron#Overview">cron syntax</a>, with the addition that <code class="language-plaintext highlighter-rouge">H</code> can be used to randomly choose a value for that place, rather than running at precisely that minute or hour. This allows you to spread the load of multiple jobs over a period of time, rather than having maybe 10 jobs all attempting to run simultaneously if they do not need to.
For the above example it will choose one value for the <code class="language-plaintext highlighter-rouge">H</code>, a random minute in the hour, and then run every hour, every day, at that minute.
You can enter different <span class="notranslate">expression</span>s to see when Jenkins would run it next.</p>
      </blockquote>
    </li>
    <li>
      <p>Add a build step:</p>

      <ul>
        <li>Add build step
          <ul>
            <li><strong>Click</strong> ‚ÄúExecute shell‚Äù</li>
          </ul>
        </li>
        <li>In the new step
          <ul>
            <li><em>‚ÄúCommand‚Äù</em>:
              <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>echo Hello world!
date
env | sort
</code></pre></div>              </div>
            </li>
          </ul>

          <p><img src="../../images/jenkins-05-job1.png" alt="Executing a shell" /></p>
        </li>
      </ul>

      <blockquote class="warning">
        <h3 id="warning-danger"><i class="fas fa-exclamation-triangle" aria-hidden="true"></i><span class="visually-hidden">warning</span> Danger!</h3>
        <p>This field allows you to execute arbitrary bash scripts. This is a reason Jenkins <strong>must</strong> be secured with HTTPS and a good use<span class="notranslate">rna</span>me/password.</p>
      </blockquote>
    </li>
    <li>
      <p>Click <strong>Save</strong> at the bottom</p>
    </li>
    <li>
      <p>You will be brought back to the job information page. Click <strong>Build Now</strong></p>
    </li>
    <li>
      <p>Your job will appear in the <em>Build History</em> box at the left. <strong>Click</strong> the ball associated with your job, to see the console.</p>

      <figure id="figure-4"><img src="../../images/jenkins-06-job1-run.png" alt="Seeing a Jenkins job's console" /><figcaption><span class="figcaption-prefix">Figure 4:</span> The build history box lets you see the status of previous, running, and queued builds. The 'sun' icon indicates that all builds have been successful, it will become more cloudy/overcast if you experience failures. The 'trend' button allows you to visualise how quickly builds have run historically.</figcaption></figure>

      <p>Clicking the number will bring you to a job information page, where you can click ‚ÄúConsole Output‚Äù to see the jobs output</p>

      <figure id="figure-5"><img src="../../images/jenkins-07-job1-out.png" alt="Jenkins job output" /><figcaption><span class="figcaption-prefix">Figure 5:</span> The output of your first Jenkins job. All jenkins jobs log both the commands that were run, and their outputs. Use this to see which step potentially failed.</figcaption></figure>
    </li>
  </ol>
</blockquote>

<p>Setting up Jenkins jobs is as simple as setting up a cron job, but the results are stored in a nice visual interface that may provide better visibility than a <code class="language-plaintext highlighter-rouge">cron</code> job.</p>

<blockquote class="comment">
  <h3 id="comment-authors-commentary"><i class="far fa-comment-dots" aria-hidden="true"></i><span class="visually-hidden">comment</span> Author‚Äôs commentary</h3>
  <p>Cron jobs are great and often useful, but most people ignore the emails that cron sends them. I know I have mailboxes across N servers with dozens and dozens of unread emails from cron jobs. Jenkins is an improvement here because it shows ‚Äúsuccess‚Äù and ‚Äúfailure‚Äù messages that are clear, while storing the output in case you later decide that you want to look at it. For the most part, cron jobs write output that is never read, and we really only want to see the output if something has failed, but writing a cron job that behaves like this is unnecessarily complex.</p>
</blockquote>

<h2 id="ansible-in-jenkins">Ansible in Jenkins</h2>

<p>We will now setup Jenkins to run Ansible on cron. In the <a href="/training-material/topics/admin/tutorials/ansible-galaxy/tutorial.html"><span class="notranslate">Galaxy</span> Installation with Ansible</a> tutorial we emphasised that it is useful to often run the entire playbook to ensure that all changes are applied. Use<span class="notranslate">Galaxy</span>.eu likes to accomplish this by having Jenkins run the playbooks every day. We know that even if our coworkers made some changes to the servers, that by tomorrow it will be reverted to a known-good configuration.</p>

<blockquote class="notranslate hands_on">
  <h3 id="hands_on-hands-on-jenkins-running-ansible"><i class="fas fa-pencil-alt" aria-hidden="true"></i><span class="visually-hidden">hands_on</span> Hands-on: Jenkins running Ansible</h3>

  <ol>
    <li>
      <p>Go back to the Jenkins homepage (click the logo in the top left)</p>
    </li>
    <li>
      <p>Click <strong>New Item</strong> in the left hand menu.</p>
    </li>
    <li>
      <p>Give your job a name like ‚Äúansible-<span class="notranslate">galaxy</span>‚Äù, and select that it is a ‚Äúfreestyle project‚Äù, and click ‚ÄúOK‚Äù</p>
    </li>
    <li>
      <p>Configure your job</p>

      <ul>
        <li>Build Triggers
          <ul>
            <li>Build Periodically
              <ul>
                <li><em>‚ÄúSchedule‚Äù</em>: <code class="language-plaintext highlighter-rouge">H * * * * </code></li>
              </ul>
            </li>
          </ul>
        </li>
        <li>Build
          <ul>
            <li>Add build step
              <ul>
                <li><strong>Click</strong> ‚ÄúExecute shell‚Äù</li>
              </ul>
            </li>
            <li>In the new step
              <ul>
                <li><em>‚ÄúCommand‚Äù</em>:
                  <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cd /home/ubuntu/<span class="notranslate">galaxy</span>/ # Change this to wherever your <span class="notranslate">galaxy</span>.yml is, you can check with the command pwd
ansible-playbook -i hosts <span class="notranslate">galaxy</span>.yml --diff
</code></pre></div>                  </div>
                </li>
              </ul>
            </li>
          </ul>
        </li>
        <li>Save</li>
      </ul>
    </li>
    <li>
      <p>Click <strong>Build Now</strong> and check the console output of the job</p>

      <p>What do you see? It should look like Jenkins is running the playbook:</p>

      <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Started by user admin
Running as SYSTEM
Building in workspace /var/lib/jenkins/workspace/ansible-<span class="notranslate">galaxy</span>
[ansible-<span class="notranslate">galaxy</span>] $ /bin/sh -xe /tmp/jenkins6010384499214486550.sh
+ cd /home/ubuntu/<span class="notranslate">galaxy</span>/
+ ansible-playbook -i hosts <span class="notranslate">galaxy</span>.yml --diff

PLAY [<span class="notranslate">galaxy</span>servers] ***********************************************************

TASK [Gathering Facts] *********************************************************
ok: [gcc-3.training.<span class="notranslate">galaxy</span>project.eu]

TASK [Install Dependencies] ****************************************************
 [WARNING]: Could not find aptitude. Using apt-get instead
ok: [gcc-3.training.<span class="notranslate">galaxy</span>project.eu]
</code></pre></div>      </div>
    </li>
  </ol>

</blockquote>

<p>With this we have Jenkins running our playbook for us! You can imaging several steps you could take to follow up from this:</p>

<ol>
  <li>Storing your playbooks in <code class="language-plaintext highlighter-rouge">git</code> like Use<span class="notranslate">Galaxy</span>.*
    <ul>
      <li><a href="https://github.com/usegalaxy-eu/infrastructure-playbook">Use<span class="notranslate">Galaxy</span>.eu‚Äôs playbooks</a> are public, anyone can contribute and if the PR is merged, it is automatically applied to our infrastructure within the next day. We store our job configuration in here as well which specifies how much memory and how many CPUs tools receive. Our teammates often can contribute fixes themselves when they notice a tool needs more memory.</li>
      <li><a href="https://github.com/galaxyproject/infrastructure-playbook">Use<span class="notranslate">Galaxy</span>.org‚Äôs playbooks</a> are also public, but run manually.</li>
    </ul>
  </li>
  <li>Running this job regularly
    <ul>
      <li>This can prevent mistakes, if a coworker edits some configuration on the server and forgets to commit it, this ensures everything is reverted back to the expected state.</li>
      <li>The amount of time the <span class="notranslate">Galaxy</span> playbook takes can be quite annoying when done manually but no one is upset if it takes 30 minutes when it is run on cron.</li>
    </ul>
  </li>
  <li>Alerting you if something went wrong
    <ul>
      <li>There are numerous plugins that can send notifications of build success/failure to various places like Slack, etc.</li>
    </ul>
  </li>
</ol>

<p>These are all next steps that are great to look into, and will make your systems more reliable and trustworthy as you will know when things change, and you can be certain that the code is configured how you specified.</p>

<h1 id="securing-jenkins">Securing Jenkins</h1>

<p>You have already secured Jenkins in that it is protected with a good password and HTTPS. This is one important thing. The other portion is the visibility of jobs and their outputs. In the above Ansible <span class="notranslate">Galaxy</span> deployment job we set the parameter <code class="language-plaintext highlighter-rouge">--diff</code>, so we could see what changed. This is an extremely helpful thing to do to be able to audit changes from a particular run. But! If you change the <code class="language-plaintext highlighter-rouge">id_secret</code> or other secret variables, then this diff will be visible in the job‚Äôs console logs. This is useful to see for admins but needs to be restricted so that the whole world cannot see this.</p>

<blockquote class="notranslate hands_on">
  <h3 id="hands_on-hands-on-securing-jenkins"><i class="fas fa-pencil-alt" aria-hidden="true"></i><span class="visually-hidden">hands_on</span> Hands-on: Securing Jenkins</h3>

  <ol>
    <li>
      <p>Return to the Jenkins home page</p>
    </li>
    <li>
      <p>Click on <strong>Manage Jenkins</strong></p>
    </li>
    <li>
      <p>Click on <strong>Configure Global Security</strong></p>

      <ol>
        <li>
          <p>In the first block <em>Access Control</em> Change the <em>Authorization</em> strategy from ‚ÄúLogged-in users can do anything‚Äù to ‚ÄúMatrix-based security‚Äù</p>
        </li>
        <li>
          <p>Click ‚ÄúAdd user or group‚Äù and add the <code class="language-plaintext highlighter-rouge">admin</code> user</p>
        </li>
        <li>
          <p>Configure the permissions like below. Clicking on the checked checkbox icon at the right will allow you to enable/disable all of the checkboxes for that row.</p>

          <p><img src="../../images/jenkins-09-permissions.png" alt="Configuring matrix based permissions" /></p>

          <p>The matrix based security plugin is provided by a plugin, we installed this by setting the variable <code class="language-plaintext highlighter-rouge">jenkins_plugins: [matrix-auth]</code> in our group variables earlier.
The checkboxes give you the ability to grant or deny permissions to certain classes of users. Each column is an individual permission, and you can hover over each column to get more information about what that permission allows.</p>

          <p>In the above example we have configured that:</p>
          <ul>
            <li><em>Anonymous users</em> (not logged in) may <code class="language-plaintext highlighter-rouge">Read</code>, so they can access the Jenkins page, but by default will not see any jobs. The <code class="language-plaintext highlighter-rouge">Discover</code> permission is also granted so that if a user has bookmarked the ansible-<span class="notranslate">galaxy</span> job page, they will automatically be redirected through the login page, if they are not already logged in.</li>
            <li>Once they login and are <em>Authenticated Users</em>, they can see that <code class="language-plaintext highlighter-rouge">Manage</code> and <code class="language-plaintext highlighter-rouge">Run</code> Jobs and Views</li>
            <li>Only the <em>admin</em> user, however, can configure <code class="language-plaintext highlighter-rouge">Agents</code> to run those jobs.</li>
          </ul>
        </li>
        <li>
          <p>Under <strong>CSRF Protection</strong>, check the box to prevent CSRF, and select the default crumb issuer, and then enable proxy compatibility.</p>
        </li>
      </ol>
    </li>
    <li>
      <p>Save</p>

      <blockquote class="question">
        <h3 id="question-question"><i class="far fa-question-circle" aria-hidden="true"></i><span class="visually-hidden">question</span> Question</h3>

        <p>Try accessing your Jenkins from a private browsing session. How does it look?</p>

        <blockquote class="solution">
          <h3 id="solution-solution"><i class="far fa-eye" aria-hidden="true"></i><span class="visually-hidden">solution</span> Solution</h3>
          <p>It should appear as if there are no jobs, until you log in.</p>
        </blockquote>
      </blockquote>
    </li>
  </ol>

</blockquote>

<h1 id="advanced-topics">Advanced Topics</h1>

<p>These topics are outside the scope of a training or do not lend themselves well to interesting exercises, but some discussion and configuration information will be provided below documenting common issues and questions that can be useful if you start using Jenkins ‚Äúin anger‚Äù.</p>

<h2 id="updating-jenkins">Updating Jenkins</h2>

<p>Jenkins updates regularly due to security issues. We recommend that you either:</p>

<ol>
  <li>Regularly check the <a href="https://jenkins.io/changelog/">Jenkins Changelog</a>, and update the server whenever there are important security fixes</li>
  <li>OR include some sort of yum or apt auto-updater on whichever system that Jenkins is running on</li>
</ol>

<p>The downside of automatic updating is that Jenkins will restart and kill any jobs that had been running. Choose which works best for your environment. Use<span class="notranslate">Galaxy</span>.eu chose a completely automated setup because their jobs can be killed and few things are affected. Use<span class="notranslate">Galaxy</span>.org chose a more manual setup because their jobs are more critical, there if jobs fail, <span class="notranslate">Galaxy</span> pull request tests will fail unexpectedly and unhelpfully.</p>

<h2 id="updating-plugins">Updating Plugins</h2>

<p>Plugins also regularly receive updates due to security issues. You should either check in with your Jenkins server regularly and apply updates when they are available, or automate this as well. Use<span class="notranslate">Galaxy</span>.eu uses a script like:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>
<span class="nv">ARGS</span><span class="o">=</span><span class="s2">"-jar /opt/jenkins-cli.jar -s http://localhost:8080/ -auth user:password"</span>
<span class="nv">UPDATE_LIST</span><span class="o">=</span><span class="si">$(</span>java <span class="nv">$ARGS</span> list-plugins | <span class="nb">grep</span> <span class="s1">')$'</span> | <span class="nb">awk</span> <span class="s1">'{print $1}'</span><span class="si">)</span>

<span class="k">if</span> <span class="o">[</span> <span class="o">!</span> <span class="nt">-z</span> <span class="s2">"</span><span class="k">${</span><span class="nv">UPDATE_LIST</span><span class="k">}</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
    </span><span class="nb">echo </span>Updating Jenkins Plugins: <span class="k">${</span><span class="nv">UPDATE_LIST</span><span class="k">}</span><span class="p">;</span>
    java <span class="nv">$ARGS</span> install-plugin <span class="k">${</span><span class="nv">UPDATE_LIST</span><span class="k">}</span><span class="p">;</span>
    java <span class="nv">$ARGS</span> safe-restart<span class="p">;</span>
<span class="k">fi</span>
</code></pre></div></div>

<p>And we run this on cron hourly. The <code class="language-plaintext highlighter-rouge">safe-restart</code> at the end causes Jenkins to stop processing new jobs, and wait until all jobs are complete before restarting. Unfortunately this is not an option for Jenkins server updates.</p>

<h2 id="plugins">Plugins</h2>

<p>Jenkins provides an impressive number of plugins for a lot of different environments. Here are some of the ones we use and their purposes:</p>

<table>
  <thead>
    <tr>
      <th>Plugin</th>
      <th>Comments</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Git Plugin</td>
      <td>Allow cloning git repositories to build</td>
    </tr>
    <tr>
      <td>Build Timeout</td>
      <td>Allows us to automatically kill jobs which run longer than we expect. We can use this to set per-build timeouts</td>
    </tr>
    <tr>
      <td>Credentials Binding Plugin</td>
      <td>This can be used to inject secrets into builds, e.g. vault passwords. <!-- TODO: use this with vault in ansible-galaxy tuto --></td>
    </tr>
    <tr>
      <td>Embeddable Build Status Plugin</td>
      <td>Produces nice build statuses like Travis does, e.g. <a href="https://github.com/usegalaxy-eu/infrastructure-playbook#build-statuses">Use<span class="notranslate">Galaxy</span>.eu‚Äôs playbook statuses</a></td>
    </tr>
    <tr>
      <td>GitHub Authentication plugin</td>
      <td>The Use<span class="notranslate">Galaxy</span>.eu build server requires login with GitHub and ensures membership in the correct organisation to be able to access group secrets and build logs.</td>
    </tr>
    <tr>
      <td>Job Configuration History plugin</td>
      <td>This plugin tracks changes made in the configuration of jobs over time, so you can see what was changed in the Jenkins configuration which may have caused the job to start succeeding or failing.</td>
    </tr>
    <tr>
      <td>ShiningPanda Plugin</td>
      <td>Allows easily running jobs within a per-job python virtualenv.</td>
    </tr>
    <tr>
      <td>SSH Agent Plugin</td>
      <td>Allows providing specific SSH credentials to a build</td>
    </tr>
  </tbody>
</table>

<p>These plugins can be installed via the Ansible automation by expanding <code class="language-plaintext highlighter-rouge">jenkins_plugins</code> in your <code class="language-plaintext highlighter-rouge">group_vars/build.yml</code>, or installed with the web interface.</p>

<h3 id="source-code-management">Source Code Management</h3>

<p>Jenkins supports most VCSs that are in use today. For the Git plugin, it allows you to clone a git repository into the job‚Äôs directory, and then run scripts from there. It forms the foundation of most jobs.</p>

<p>You may need to specify credentials for cloning from private repositories, in this case you should beware that when you configure the SSH credentials you should specify the <code class="language-plaintext highlighter-rouge">user</code> as <code class="language-plaintext highlighter-rouge">git</code>. You will also need to ensure that the server‚Äôs SSH public key is known to your Jenkins system which generally requires <code class="language-plaintext highlighter-rouge">su</code>ing as the Jenkins user and running <code class="language-plaintext highlighter-rouge">ssh git@...</code> once, and accepting the ‚ÄúUnknown host‚Äù key prompt. We recommend that you use repository URLs of the format <code class="language-plaintext highlighter-rouge">git@github.com:org/repo.git</code>, if you are using one of the GitHub PR builder plugins, then this URL has to match a value in the incoming webhook and it is not always obvious that this needs to be set like this.</p>

<p>The ‚ÄúBranches to build‚Äù section allows you to specify which branches. Whenever you click ‚ÄúBuild now‚Äù, Jenkins usually just picks the master branch to build, and doesn‚Äôt run a build job per-branch. If you are automatically triggering Jenkins builds based on GitHub (or other) webhooks, then you can ensure that branches that should not be built are filtered out here. Real life example: Use<span class="notranslate">Galaxy</span>.eu has one Jenkins job which should only build the master branch of a repository, and another job that only builds the PRs for that repository. We know the first job will only ever build the master branch so we can hardcode that there. With the Git plugin, many ‚ÄúAdditional Behaviours‚Äù are available. If you have submodules in your repository, you will need to enable one of these to ensure that the repository is cloned recursively. If you want to ensure a fresh start each time because you write out temporary files to the current working directory, then there is a behaviour to wipe out the repository before each build.</p>

<h3 id="build-triggers">Build Triggers</h3>

<p>The GitHub Pull Request Builder plugin is not always easy to configure, here systems like Travis are generally significantly easier. Consider if that is an option. It is not a bad thing to use multiple CI systems, it provides some degree of redundancy where if one system is experiencing an outage it may not affect all CI jobs.</p>

<h3 id="credential-binding">Credential Binding</h3>

<p>If you provide credentials to Jenkins builds, they will automatically be stripped from log outputs. So if your job will not ‚Äúleak‚Äù any private information (e.g. in <code class="language-plaintext highlighter-rouge">--diff</code>) and you want to share the build logs with your users to prove that actions were taken or that things are working and automated, then the credential binding plugin ensures that any secrets will be stripped from output and replaced with <code class="language-plaintext highlighter-rouge">******</code>. They can be made available as environment variables, or in files that can be accessed.</p>

<p>We often upload a configuration file with secrets (e.g. <code class="language-plaintext highlighter-rouge">.parsec.yml</code> ), and then can just call our software <code class="language-plaintext highlighter-rouge">parsec -c $PARSEC_CONFIG_FILE_LOCATION ...</code> passing in that file, wherever Jenkins has stored it securely.</p>

<h3 id="ssh-agent">SSH Agent</h3>

<p>This allows you to automatically inject credentials into your build‚Äôs SSH agent. If you want to <code class="language-plaintext highlighter-rouge">rsync</code> some build outputs to another server, or <code class="language-plaintext highlighter-rouge">ssh</code> to a server to run some one-off command, or to run <code class="language-plaintext highlighter-rouge">ansible</code>, then this is the feature you want. Beware that if you are pulling from and pushing to git repositories on GitHub with separate SSH credentials you may need to use a combination of the SSH Agent plugin, and injecting an SSH key through credential binding.</p>

<h2 id="real-life-examples">Real Life Examples</h2>

<p>Here are some examples of how Jenkins is used in the wild, maybe it can provide some reference for potential uses within your organisation or solutions to various problems. The examples are mostly pulled from Use<span class="notranslate">Galaxy</span>.eu‚Äôs experiences, as the author is most familiar with those.</p>

<h3 id="compute-nodes">Compute Nodes</h3>

<p>We attach VMs as compute nodes for Jenkins to use as executors. We have an OpenStack cloud available so that is an easy option for us. We setup the VMs such that Jenkins just logs in as the default <code class="language-plaintext highlighter-rouge">centos</code> user and uses the home directory for building jobs. There is a Jenkins plugin to manage the VMs in the cloud automatically (scaling up/down as necessary, removing VMs with full disk) but our cloud was upgraded and we could not get this working. It is worth trying if that is an option! There are other cloud provider plugins available with similar features.</p>

<p>We also use a custom image that includes a lot of our requirements pre-installed. We include e.g. LaTeX, Ruby/RVM, Java, Node, anything we think we might need for our jobs. This also lets us reduce the privileges of the jobs, nothing <em>needs</em> <code class="language-plaintext highlighter-rouge">root</code> access to install packages globally. Python, Ruby, and Node all have something similar to virtualenvs.</p>

<h3 id="job-apollo-builder">Job: Apollo Builder</h3>

<p>This is a relatively straightforward job to build a WAR file and upload it to our depot server.</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">#</span><span class="w"> </span>some <span class="nb">env </span>vars that are needed, it<span class="s1">'s kind of gross but it works :(
</span><span class="go">export JAVA_HOME=/usr/lib/jvm/java-1.8.0-openjdk-1.8.0.212.b04-0.el7_6.x86_64/
</span><span class="gp">export PERL5LIB=/home/centos/workspace/use<span class="notranslate">galaxy</span>-eu/apollo-builder/extlib/lib/perl5:$</span>PERL5LIB
<span class="gp">#</span><span class="w"> </span>setting a variable from some build data
<span class="gp">APOLLO_VERSION=$</span><span class="o">(</span><span class="nb">cat </span>application.properties | <span class="nb">grep </span>app.version | <span class="nb">sed</span> <span class="s1">'s/.*=//g'</span><span class="o">)</span>
<span class="go">
</span><span class="gp">#</span><span class="w"> </span>Check <span class="k">if </span>this version needs to be built
<span class="gp">curl --silent https://use<span class="notranslate">galaxy</span>.eu/static/vgcn/ | \
	grep -F "apollo-$</span><span class="o">{</span>APOLLO_VERSION<span class="o">}</span><span class="s2">" &amp;&amp; echo "</span>Already built!<span class="s2">" &amp;&amp; exit 0;
</span><span class="go">
</span><span class="gp">#</span><span class="w"> </span>Build the thing
<span class="go">./apollo deploy

</span><span class="gp">#</span><span class="w"> </span>Deploy it to our server
<span class="gp">scp -i $</span>PRIV_KEY <span class="se">\</span>
	target/<span class="k">*</span>.war <span class="se">\</span>
    user@server:/static/apollo-<span class="k">${</span><span class="nv">APOLLO_VERSION</span><span class="k">}</span>.war
</code></pre></div></div>

<ul>
  <li>We use the ‚ÄúSecret file‚Äù binding to inject a specific private key (available in the build as <code class="language-plaintext highlighter-rouge">$PRIV_KEY</code>) but the SSH agent plugin would work equally well.</li>
  <li>We could also use the ‚ÄúArchive Artifacts‚Äù plugin to have Jenkins retain all of the artefacts (build outputs that you care about) but we wanted to have an Ansible role pull those files and it was simpler to have them accessible at predictable URLs.</li>
</ul>

<h3 id="job-chado-schema-builder">Job: Chado Schema Builder</h3>

<p>Similar to the Apollo builder but it uploads outputs as GitHub releases which is useful for public projects with complex build pipelines. The CSB takes on average 5-6 hours to run so we cannot easily run this on free infrastructure.</p>

<p>Here we store both the <a href="https://github.com/hexylena/chado-schema-builder/blob/master/.ci/run.sh">build</a> and <a href="https://github.com/hexylena/chado-schema-builder/blob/master/.ci/upload.sh">deploy</a> scripts in the GitHub repository. If you do this, you have to be careful about building PRs, as anyone can edit the build scripts and access your inte<span class="notranslate">rna</span>l infrastructure!</p>

<h3 id="job-website">Job: Website</h3>

<p>We build our own Jekyll website because we have some plugins GitHub will not compile for us. The configuration here is more complex:</p>

<ul>
  <li>Throttle builds, since GitHub will only accept so many deploy requests in a time period</li>
  <li>One SSH key used to clone the repository using the Git SCM, with ‚ÄúWipe out repository &amp; force clone‚Äù set.</li>
  <li>Triggers on both:
    <ul>
      <li>Cron, daily</li>
      <li>GitHub webhooks notifying us of pushes to master</li>
    </ul>
  </li>
  <li>SSH Agent is configured with a deploy SSH key (because git really prefers you provide keys in the SSH agent, I don‚Äôt know if it is possible to pass a keyfile on the CLI)</li>
  <li>The <a href="https://github.com/usegalaxy-eu/website/blob/master/.build.sh">.build.sh</a> is run which activates the RVM pre-installed on the VMs</li>
  <li>If the master branch is checked out, <a href="https://github.com/usegalaxy-eu/website/blob/master/.publish.sh"><code class="language-plaintext highlighter-rouge">.publish.sh</code></a> is run</li>
  <li>Empty <a href="https://github.com/usegalaxy-eu/website/blob/master/.nojekyll"><code class="language-plaintext highlighter-rouge">.nojekyll</code></a> file to prevent GitHub from trying to build this.</li>
</ul>

<h3 id="job-install-tools">Job: Install Tools</h3>

<p>For this job we use Jenkin‚Äôs ‚ÄúTrigger other builds‚Äù feature:</p>
<ul>
  <li>We have one job that fetches all of the latest updates for IUC tools and writes those into yaml files. This job runs on cron every week.</li>
  <li>This triggers a separate job to actually apply the changes to our server.</li>
</ul>

<p>By splitting these up, we can run the ‚Äúactually apply‚Äù portion without having to fetch updates to the tools first. Additionally we can have the second portion run only if the first portion succeeds, so we have some check that everything looks OK before trying to apply it.</p>

<p>We include a <span class="notranslate">Galaxy</span> API key as a credential and then use a <code class="language-plaintext highlighter-rouge">Makefile</code> contained in the project to do the steps. We don‚Äôt automatically test PRs so we don‚Äôt care if people change the Makefile because we visually validate it before merging their PR.</p>

<h3 id="configuration-themes">Configuration: Themes</h3>

<p>Many people find the ‚Äúblue/red ball‚Äù icons a bit hard to understand. Using the ‚ÄúSimple Theme Plugin‚Äù you can easily add custom CSS files or directly enter custom CSS. Use<span class="notranslate">Galaxy</span>.* use the <a href="http://afonsof.com/jenkins-material-theme/">jenkins-material-theme</a> as it provides a slightly cleaner view of Jenkins with better iconography.</p>

<h3 id="configuration-folder-permissions">Configuration: Folder Permissions</h3>

<p>We have the aforementioned problem that our playbooks run with <code class="language-plaintext highlighter-rouge">--diff</code> and while we want to capture this output and be able to review it, it is not necessary that the public can see it. So permissions are configured not only on the global Jenkins level, but also within a single folder of jobs. The folder permissions involve setting:</p>

<ul>
  <li>Properties
    <ul>
      <li><em>‚ÄúInheritance Strategy‚Äù</em>: <code class="language-plaintext highlighter-rouge">Do not inherit permission grants from other ACLs</code></li>
      <li>Allowing <code class="language-plaintext highlighter-rouge">Discover</code> and nothing else for Anonymous + Authenticated</li>
      <li>Explicitly granting all permissions for the admins</li>
    </ul>
  </li>
</ul>


                    
                    <blockquote class="key_points">
                        <h3><i class="fas fa-key" aria-hidden="true"></i><span class="visually-hidden">keypoints</span> Key points</h3>
                        <ul>
                            
                            <li><p>Automate all the things!</p>
</li>
                            
                            <li><p>Especially regular tasks you might forget to do</p>
</li>
                            
                            <li><p>Automatically run Ansible to ensure machines are in compliance</p>
</li>
                            
                        </ul>
                    </blockquote>
                    

                    

                    

                    <h1>Feedback</h1>
                    <p class="text-muted">Did you use this material as an instructor? Feel free to give us feedback on <a href="https://github.com/galaxyproject/training-material/issues/1452" target="_blank">how it went</a>.</p>

                    <div id="feedback-button">
                        <img src="/training-material/shared/images/feedback.png" title="Click to activate" alt="Click here to load Google feedback frame" />
                    </div>
                    <div id="feedback-form">
                    </div>
                    <script type="text/javascript">
                        (function (window, document) {
                            function onDocumentReady(fn) {
                                if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
                                    fn();
                                } else {
                                    document.addEventListener('DOMContentLoaded', fn);
                                }
                            }

                            onDocumentReady(function () {
                                $("#feedback-button").click(function(evt){
                                    var e = $(evt.target)
                                    e.hide();

                                    $("#feedback-form").html(`
                                        <iframe id="feedback-google" class="google-form" src="https://docs.google.com/forms/d/e/1FAIpQLSd4VZptFTQ03kHkMz0JyW9b6_S8geU5KjNE_tLM0dixT3ZQmA/viewform?embedded=true&entry.1235803833=Automation with Jenkins (Galaxy Server administration)">Loading...</iframe>
                                    `)
                                })
                            });
                        })(window, document);
                    </script>



                    <h1>Citing this Tutorial</h1>
                    <p>
                        <ol>
                            <li id="citation-text">Helena Rasche, 2021 <b>Automation with Jenkins (Galaxy Training Materials)</b>. <a href="/training-material/topics/admin/tutorials/jenkins/tutorial.html">/training-material/topics/admin/tutorials/jenkins/tutorial.html</a> Online; accessed TODAY
                            </li>
                            <li>
                            Batut et al., 2018 <b>Community-Driven Data Analysis Training for Biology</b> Cell Systems <a href="https://doi.org/10.1016%2Fj.cels.2018.05.012">10.1016/j.cels.2018.05.012</a>
                            </li>
                        </ol>
                    </p>


                    <blockquote class="details">
                      <h3><i class="fa fa-info-circle" aria-hidden="true"></i><span class="visually-hidden">details</span> BibTeX</h3>
                      <p style="display: none;">

                    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight">
<code id="citation-code">@misc{admin-jenkins,
    author = "Helena Rasche",
    title = "Automation with Jenkins (Galaxy Training Materials)",
    year = "2021",
    month = "01",
    day = "06"
    url = "\url{/training-material/topics/admin/tutorials/jenkins/tutorial.html}",
    note = "[Online; accessed TODAY]"
}
@article{Batut_2018,
        doi = {10.1016/j.cels.2018.05.012},
        url = {https://doi.org/10.1016%2Fj.cels.2018.05.012},
        year = 2018,
        month = {jun},
        publisher = {Elsevier {BV}},
        volume = {6},
        number = {6},
        pages = {752--758.e1},
        author = {B{\'{e}}r{\'{e}}nice Batut and Saskia Hiltemann and Andrea Bagnacani and Dannon Baker and Vivek Bhardwaj and Clemens Blank and Anthony Bretaudeau and Loraine Brillet-Gu{\'{e}}guen and Martin {\v{C}}ech and John Chilton and Dave Clements and Olivia Doppelt-Azeroual and Anika Erxleben and Mallory Ann Freeberg and Simon Gladman and Youri Hoogstrate and Hans-Rudolf Hotz and Torsten Houwaart and Pratik Jagtap and Delphine Larivi{\`{e}}re and Gildas Le Corguill{\'{e}} and Thomas Manke and Fabien Mareuil and Fidel Ram{\'{\i}}rez and Devon Ryan and Florian Christoph Sigloch and Nicola Soranzo and Joachim Wolff and Pavankumar Videm and Markus Wolfien and Aisanjiang Wubuli and Dilmurat Yusuf and James Taylor and Rolf Backofen and Anton Nekrutenko and Bj√∂rn Gr√ºning},
        title = {Community-Driven Data Analysis Training for Biology},
        journal = {Cell Systems}
}</code>
                    </pre></div></div>
                    </p>
                    </blockquote>


<script type="text/javascript">
// update the date on load, or leave fallback of 'today'
d = new Date();
document.getElementById("citation-code").innerHTML = document.getElementById("citation-code").innerHTML.replace("TODAY", d.toDateString());
document.getElementById("citation-text").innerHTML = document.getElementById("citation-text").innerHTML.replace("TODAY", d.toDateString());
</script>

                </div>
            </div>
        </div>

        <h3><i class="far fa-thumbs-up" aria-hidden="true"></i><span class="visually-hidden">congratulations</span> Congratulations on successfully completing this tutorial!</h3>

        

        
    </section>
</div>


<footer>
    <div class="container">
        <p>
            This material is the result of a collaborative work. Thanks to the
            <a href="https://wiki.galaxyproject.org/Teach/GTN">Galaxy Training Network</a>
            and all the <a href="/training-material/hall-of-fame">contributors</a> (Helena Rasche)!
        </p>
        <p>
            Found a typo? Something is wrong in this tutorial? Edit it on
            <a href="https://github.com/galaxyproject/training-material/tree/master/topics/admin/tutorials/jenkins/tutorial.md">GitHub</a>.
        </p>
        <p>
    The content of the tutorials and website is licensed under the <a rel="license" href="https://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 International License</a>.
</p>
    </div>
</footer>

    </body>
    <script type="text/javascript" src="/training-material/assets/js/jquery.slim.min.js"></script>
    <script type="text/javascript" src="/training-material/assets/js/popper.min.js"></script>
    <script type="text/javascript" src="/training-material/assets/js/bootstrap.min.js?v=3"></script>
    <script type="text/javascript" src="/training-material/assets/js/details-element-polyfill.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="/training-material/assets/js/bootstrap-toc.min.js"></script>
    <script type="text/javascript" src="/training-material/assets/js/main.js"></script>
    <script type="text/javascript" src="/training-material/assets/js/theme.js"></script>

    <script type="text/javascript" src="/training-material/assets/js/clipboard.min.js"></script>
    <script type="text/javascript">
    var snippets=document.querySelectorAll('div.highlight');
    [].forEach.call(snippets,function(snippet){
        snippet.firstChild.insertAdjacentHTML('beforebegin','<button class="btn btn-light" data-clipboard-snippet><i class="fa fa-copy"></i>&nbsp;Copy</button>');
    });

    var clipboardSnippets=new ClipboardJS('[data-clipboard-snippet]',{
        target:function(trigger){return trigger.nextElementSibling;
    }});
    </script>
    

    <script type="text/javascript">
        if(window.location.hostname === "galaxyproject.github.io") {
            // Redirect
            var redirect = "https://training.galaxyproject.org" + window.location.pathname + window.location.search;
            $('div.container.main-content').prepend("<div class='alert alert-warning'><strong>Note: </strong>This content has a new home at <a href=\"" + redirect + "\">" + redirect + "</a>, which you will be redirected to in 5 seconds.</div>");

            window.setTimeout(function(){
                window.location.href = redirect;
            }, 5000)

        }
    </script>
</html>
