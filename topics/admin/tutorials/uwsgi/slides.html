<!DOCTYPE html>
<html>









  <head>
    <meta charset="utf-8">
    <title>uWSGI</title>
    
        <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
    ga('create', '' , 'auto');
    ga('send', 'pageview');
</script>
    
    <link rel="stylesheet" href="/training-material/assets/css/slides.css">
    <script src="https://kit.fontawesome.com/67b3f98409.js" crossorigin="anonymous"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="shortcut icon" href="/training-material/favicon.ico" type="image/x-icon" />

    
    
    
    
    <meta name="description" content="Resources related to configuration and maintenance of Gal..." />
    <meta property="og:title" content="Galaxy Training: uWSGI" />
    <meta property="og:description" content="Resources related to configuration and maintenance of Gal..." />
    <meta property="og:image" content="/training-material/assets/images/GTNLogo1000.png" />
    <script type="application/ld+json">
      


{
  "@context": "http://schema.org",
  "@type": "Course",
  "accessMode": [
    "textual",
    "visual"
  ],
  "accessModeSufficient": [
    "textual",
    "visual"
  ],
  "accessibilityControl": [
    "fullKeyboardControl",
    "fullMouseControl"
  ],
  "accessibilityFeature": [
    "alternativeText",
    "tableOfContents"
  ],
  "accessibilitySummary": "Short descriptions are present but long descriptions will be needed for non-visual users",
  "audience": {
    "@type": "EducationalAudience",
    "educationalRole": "students"
  },
  "citation": {
    "@type": "CreativeWork",
    "name": "Community-Driven Data Analysis Training for Biology",
    "url": "https://doi.org/10.1016/j.cels.2018.05.012"
  },
  "copyrightHolder": {
    "@type": "Organization",
    "email": "galaxytrainingnetwork@gmail.com",
    "name": "Galaxy Training Network",
    "url": "https://galaxyproject.org/teach/gtn/"
  },
  "discussionUrl": "https://gitter.im/Galaxy-Training-Network/Lobby",
  "headline": "uWSGI",
  "inLanguage": {
    "@type": "Language",
    "name": "English",
    "alternateName": "en"
  },
  "interactivityType": "mixed",
  "isAccessibleForFree": true,
  "license": "https://github.com/galaxyproject/training-material/blob/master/LICENSE.md",
  "producer": {
    "@type": "Organization",
    "email": "galaxytrainingnetwork@gmail.com",
    "name": "Galaxy Training Network",
    "url": "https://galaxyproject.org/teach/gtn/"
  },
  "provider": {
    "@type": "Organization",
    "email": "galaxytrainingnetwork@gmail.com",
    "name": "Galaxy Training Network",
    "url": "https://galaxyproject.org/teach/gtn/"
  },
  "sourceOrganization": {
    "@type": "Organization",
    "email": "galaxytrainingnetwork@gmail.com",
    "name": "Galaxy Training Network",
    "url": "https://galaxyproject.org/teach/gtn/"
  },
  "isPartOf": {
    "@type": "CreativeWork",
    "name": "Galaxy Server administration",
    "description": "Resources related to configuration and maintenance of Galaxy servers",
    "url": "https://training.galaxyproject.org//training-material/topics/admin/"
  },
  "courseCode": "admin / uwsgi / slides",
  "learningResourceType": "slides",
  "name": "Slides for 'uWSGI' tutorial",
  "url": "https://training.galaxyproject.org//training-material/topics/admin/tutorials/uwsgi/slides.html",
  "description": "",
  "hasPart": [

  ],
  "author": [
    {
      "@type": "Person",
      "name": "Nate Coraor"
    },
    {
      "@type": "Person",
      "name": "Simon Gladman"
    }
  ],
  "contributor": [
    {
      "@type": "Person",
      "name": "Nate Coraor"
    },
    {
      "@type": "Person",
      "name": "Simon Gladman"
    }
  ],
  "about": [
    {
      "@type": "CreativeWork",
      "name": "Galaxy Server administration",
      "description": "Resources related to configuration and maintenance of Galaxy servers",
      "url": "https://training.galaxyproject.org//training-material/topics/admin/"
    }
  ]
}
    </script>
    <script type="text/javascript" src="/training-material/assets/js/jquery.slim.min.js"></script>
  </head>
  <body>
    <textarea id="source">
name: inverse
layout: true
class: center, middle, inverse

<div class="my-header"><span>
<a href="/training-material/topics/admin" title="Return to topic page" ><i class="fa fa-level-up" aria-hidden="true"></i></a>

<a class="nav-link" href="https://github.com/galaxyproject/training-material/edit/master/topics/admin/tutorials/uwsgi/slides.html"><i class="fa fa-pencil" aria-hidden="true"></i></a>

</span></div>

<div class="my-footer"><span>

<img src="/training-material/assets/images/GTN-60px.png" alt="Galaxy Training Network" style="height: 40px;"/>

</span></div>

---

# uWSGI



.footnote[Tip: press `P` to view the presenter notes]

???
Presenter notes contain extra information which might be useful if you
intend to use these slides for teaching.

Press `P` again to switch presenter notes off

Press `C` to create a new window where the same presentation will be displayed.
This window is linked to the main window. Changing slides on one will cause the
slide to change on the other. Useful when presenting.

---

# What is uWSGI?

- Python WSGI (Web Server Gateway Interface) application framework
- Written in C
- Forking application server
- Optional HTTP server
- Process manager

...and the rest of the kitchen sink

---

# Why do we need uWSGI?

- Galaxy is a Python web application without a web server
- Implements standard Python WSGI
- Some other application does the web serving
- Technically we could use any HTTP/WSGI interface
  - Traditionally [Python Paste](https://github.com/cdent/paste/)

---

# What is uWSGI used for?

.left[In a production Galaxy server:]
- To start, manage, and scale web workers
- Optionally, to start, manage, and scale job handlers

---

# Why uWSGI?

Because Python can't multithread.

![Python GIL](../../images/gil.png)

.footnote[Image credit: [Dariusz Fryta](http://www.tivix.com/blog/lets-go-python/)]

???
Python can't multithread, but it can *multiprocess*.

---

# Why uWSGI?

- Fork many Galaxy server processes
- Isolate job functions from web functions
- Built in load balancing
- Speak native high performance uWSGI protocol to nginx
- Uninterrupted restarting
- Can do anything you can imagine: [uWSGI configuration options](http://uwsgi-docs.readthedocs.io/en/latest/Options.html)

---

## uWSGI

- **Configuration**
- uWSGI wheel
- Job handler mules

---

## uWSGI Configuration File

uWSGI configuration is performed in the `uwsgi` key of `galaxy.yml`.

`galaxy.yml.sample` is never consulted.

.left[If using `run.sh`:]
- If no config exists, all necessary defaults are generated as command line arguments to uWSGI
- If a config exists, it is parsed, and any missing required options are passed as command line arguments to uWSGI

**Galaxy servers deployed with Ansible do not use `run.sh` and should fully specify their uWSGI configuration.**

---

## uWSGI default command line

Without a config file, the uWSGI command line is:

```sh-session
$ /home/nate/galaxy/.venv/bin/python3 .venv/bin/uwsgi \
    --module 'galaxy.webapps.galaxy.buildapp:uwsgi_app()' \
    --virtualenv /home/nate/galaxy/.venv --pythonpath lib \
    --threads 4 --http localhost:8080 \
    --static-map /static=/home/nate/galaxy/static --die-on-term \
    --hook-master-start 'unix_signal:2 gracefully_kill_them_all' \
    --hook-master-start 'unix_signal:15 gracefully_kill_them_all' \
    --enable-threads --py-call-osafterfork
```

---

## uWSGI command line

.left[Behind the scenes, `run.sh` calls `scripts/get_uwsgi_args.py`, which:]
- locates your config file (if any),
- parses it to determine whether you have set any of the default (or conflicting) options,
- determines the flags needed to run Galaxy.

You can take &quot;full control&quot; over this process by skipping `run.sh` and simply calling `uwsgi` directly, e.g. `uwsgi --yaml config/galaxy.yml`.

---

# uWSGI communication

- uWSGI can serve HTTP directly using the `--http` option
- uWSGI speaks a native protocol (which nginx also speaks) using `--socket`

A proxy server is not *required,* but its use is strongly encouraged for performance reasons.

---

## YAML config

uWSGI natively supports YAML configs (and INI, and PasteDeploy INI, and XML, and JSON, and ...)

**WARNING:** &quot;uWSGI YAML&quot; is not real YAML!

--

.pull-left[
Real YAML
```yaml
uwsgi:
    # quoting forces string
    socket: '127.0.0.1:8001'
    # proper YAML list
    mule:
      - lib/galaxy/main.py
      - lib/galaxy/main.py
```
]

.pull-right[
uWSGI &quot;YAML&quot;
```yaml
uwsgi:
    # quote chars read literally
    socket: '127.0.0.1:8001'
    # a uWSGI YAML &quot;list&quot;:
    #  repeat keys
    mule: lib/galaxy/main.py
    mule: lib/galaxy/main.py
```
]

---

## YAML config

- &quot;uWSGI YAML&quot; only applies to the `uwsgi` section of `galaxy.yml`
  - The `galaxy` section must use real YAML
- uWSGI can be compiled against libyaml for real YAML support
- Galaxy Ansible role can write *both* uWSGI (default), real YAML
- `galaxy.ini` is still usable but deprecated

---

## Configuration Schema

.center[`[config_schema.yml][config-schema]` contains possible options **and their types**.]

.left[config_schema.yml is the canonical source for config option documentation, from which:]
- .left[`[galaxy.yml.sample][config-sample]` is generated]
- [Galaxy configuration options documentation][config-docs] is generated

[config-schema]: https://github.com/galaxyproject/galaxy/blob/release_20.01/lib/galaxy/webapps/galaxy/config_schema.yml
[config-sample]: https://github.com/galaxyproject/galaxy/blob/release_20.01/lib/galaxy/config/sample/galaxy.yml.sample
[config-docs]: https://docs.galaxyproject.org/en/master/admin/config.html

---

## uWSGI

- Configuration
- **uWSGI wheel**
- Job handler mules

---

## uWSGI Wheel

Galaxy's uWSGI is not built like standard `pip install uwsgi`

A bit of technical minutiae that might help debugging

---

## uWSGI Wheel

- The challenge:
  - Unlike Galaxy's other framework dependencies, uWSGI is not a Python library
  - uWSGI embeds the CPython interpreter
  - Essentially uWSGI *is* Galaxy's CPython

--

- The goal: Provide a no-compilation-required, no-dependencies installation method for Galaxy that includes uWSGI that:
  - Doesn't embed statically linked CPython
  - Doesn't require system `libpythonX.Y.so`
  - Uses system CPython

---

## uWSGI Wheel

The uWSGI wheel is built differently than when built from source with

`pip install uwsgi`

- From source by pip:
  - Built as a single `uwsgi` ELF binary embedding the CPython interpreter
- As the pyuwsgi wheel:
  - Built as a Python C extension into an ELF shared library `pyuwsgi.so`
  - Loaded by a stub `uwsgi` Python script by the CPython interpreter

pyuwsgi wheel: the only way to precompile uWSGI in a way that does not require `libpythonX.Y.so` or ship CPython

---

## uWSGI

- Configuration
- uWSGI wheel
- **Job handler mules**

---
class: top

## Processes and Job Handling

uWSGI starts up in a single &quot;master&quot; process and then `fork()`s a configured number of anonymous *web worker* processes to **serve web requests**.

By default, web workers also handle Galaxy job (tool execution) preparation and completion.

--

Processing Galaxy job (tool execution) preparation and finishing is somewhat resource intensive and affects web responsiveness.

Production Galaxy servers traditionally start additional dedicated Galaxy &quot;webless&quot; (do not serve web requests) *job handler* processes.

--

uWSGI provides a useful feature for running Galaxy job handlers: [uWSGI Mules](https://uwsgi-docs.readthedocs.io/en/latest/Mules.html).

---

## uWSGI Mules

**Mules** are processes `fork()`ed from the uWSGI master after the application has been loaded and web workers have `fork()`ed.

Mules can continue to run the same code or can load and run arbitrary code.

Mules can receive messages from the web proceses.

Mules can be pooled in to *Farms*, and messages can be sent to the farm to be handled by any mule in that farm.

---

## Mule Advantages

.pull-left.reduce90[
Webless handlers
- Config is complex
- Must manage handler processes externally (e.g. w/ systemd)
- Handler assignment:
  - At random from configured handlers
  - No regard as to handler health
  - Notification via database
- Can be spread across multiple hosts
]

.pull-right.reduce90[
uWSGI Mule handlers
- Config is trivial
- Handler processes managed automatically by uWSGI master
- Handler assignment:
  - &quot;Grabbed&quot; by healthy mule
  - IPC (messaging) from web worker
- Mules run on same host as web workers
]

---

## Job Handler Mule Configuration

Adding job handler mules is performed by simply instructing uWSGI to start them in `galaxy.yml`:

```yaml
uwsgi:
    mule: lib/galaxy/main.py
    mule: lib/galaxy/main.py
    farm: job-handlers:1,2
```

That's it! This Galaxy instance will now start and use two job handler mules.

---
class: top

## uWSGI Start/Run and Job Handling Lifecycle

1. Master process loads Galaxy application.
--

2. Master `fork()`s web worker processes and begins serving web requests.
--

3. Master `fork()`s job handler mules.
--

4. Mules reload Galaxy application as job handlers.
--

5. The first mule to fully initialize grabs a lock on the farm message queue.
--

6. All additional mules wait on the lock.
--

7. A web worker receives a request for a new job.
--

8. The web worker creates a `job` record in the database but leaves the `handler` field `null`.
--

9. The web worker uses uWSGI's `farm_msg()` function to notify the `job-handlers` farm that a new job is ready to run.
--

10. The mule with the lock receives the message, assigns itself, and gives up the lock.
--

11. Another mule acquires the lock and waits for the next message.
--

12. Job handling continues as normal.

---

## Advanced: Job Handler Assignment Methods

**Mules can only be used if web workers and job handlers run on the same host.**

The database can be used like a message queue to get the benefits of mules using webless job handlers.

See [Job Handler Assignment Methods](https://docs.galaxyproject.org/en/master/admin/scaling.html#job-handler-assignment-methods) for details.

Mules are preferred in scenarios where webless handlers are not needed.

---

## Advanced: Transparent Restart

Provides uninterrupted restart capability (clients do not notice restarts).

See [Transparent Restart](https://docs.galaxyproject.org/en/master/admin/scaling.html#transparent-restart-zerg-mode) and [uWSGI Zerg Mode documentation](https://uwsgi-docs.readthedocs.io/en/latest/Zerg.html) for details.

---

## Advanced: Zerg Mode + Job Handler Mules

Combining both advanced modes was long thought to be impossible.

However, a proof of concept has emerged!

[Watch this space](https://gist.github.com/natefoo/6e45ae363ef434f38a935ff1b05b4b6e).


---

## Thank you!

This material is the result of a collaborative work. Thanks to the [Galaxy Training Network](https://wiki.galaxyproject.org/Teach/GTN) and all the contributors!


<div class="contributors-line">


<a href="/training-material/hall-of-fame/natefoo/" class="contributor-badge"><img src="https://avatars.githubusercontent.com/natefoo" alt="Nate Coraor">Nate Coraor</a>, <a href="/training-material/hall-of-fame/slugger70/" class="contributor-badge"><img src="https://avatars.githubusercontent.com/slugger70" alt="Simon Gladman">Simon Gladman</a>


</div>



<img src="/training-material/assets/images/GTN.png" alt="Galaxy Training Network" style="height: 100px;"/>


This material is licensed under the <a rel="license" href="https://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 International License</a>.


.footnote[Found a typo? Something is wrong in this tutorial? <br/>Edit it on [GitHub](https://github.com/galaxyproject/training-material/tree/master/topics/admin/tutorials/uwsgi/slides.html)]

    </textarea>
	<script src="/training-material/assets/js/remark-latest.min.js" type="text/javascript"></script>
    <script type="text/javascript" src="/training-material/assets/js/theme.js"></script>
    <script type="text/javascript" src="/training-material/assets/js/clipboard.min.js"></script>
    <script type="text/javascript">
      var slideshow = remark.create({navigation: {scroll: false,}});
      var hljs = remark.highlighter.engine;
      var snippets = document.querySelectorAll('code.remark-code');
        [].forEach.call(snippets,function(snippet){
          snippet.firstChild.insertAdjacentHTML('beforebegin','<button class="btn btn-light" data-clipboard-snippet><i class="fa fa-copy"></i>&nbsp;Copy</button>');
        });
      var clipboardSnippets=new ClipboardJS('[data-clipboard-snippet]',{
        target:function(trigger){return trigger.parentElement;
      }});
    </script>

    <script type="text/javascript">
        if(window.location.hostname === "galaxyproject.github.io") {
            // Redirect
            var redirect = "https://training.galaxyproject.org" + window.location.pathname + window.location.search;
            $('body').prepend("<div style='text-align: center'><strong>Note: </strong>This content has a new home at <a href=\"" + redirect + "\">" + redirect + "</a>, which you will be redirected to in 5 seconds.</div>");

            window.setTimeout(function(){
                window.location.href = redirect;
            }, 5000)

        }
    </script>

  </body>
</html>
