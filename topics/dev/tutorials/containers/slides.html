---
layout: tutorial_slides
topic_name: "Dev-Corner"
tutorial_name: containers
logo: "GTN"
---

## Planemo

These slides mirror the section on "Dependencies and Docker" in the [Planemo Documentation](http://planemo.readthedocs.io/en/latest/writing_advanced.html#dependencies-and-docker).

---

## Generic Containers are Good Slide

.image-75[![](../../images/containers.png)]

* Isolation and Security\*
* Reproducibility
* Flexibility\*

.footnote[\* the industry is getting there]

???

---

## Galaxy in Containers?

.image-75[![](../../images/docker-galaxy-stable-github.png)]

???

When people think Galaxy and containers I think this project comes to mind.
Three years ago Bj√∂rn created this docker-galaxy-stable project and it has
been wildly successful. It has proven to be a useful toolkit for advanced
deployment options, an extremely portable way to bring Galaxy to new domains,
and a brilliant tool for training users.

https://github.com/bgruening/docker-galaxy-stable/commit/27ef7966508958dfec9ce35ff1c5f076ffccf80f

Also mention Galaxy KickStart as a way to run Galaxy itself in a container.

---

## Containerizing Galaxy vs Tools

We are going to discuss containerizing tool execution instead - executing just jobs in containers.

Containers for the particular job's tool.

However you deploy Galaxy, including in a container, you can still containerize tools.

???

---

class: left

### Containerizing Tools is Still Important

* Isolated tool execution.
* Isolate file system access.
* Added layer of security.
* Increased re-computability.
* New deployment options - Kubernetes, Mesos Chronos, AWS Batch, etc.

---

class: left

### Containerizing Tool Execution

Decomposes to basic problems:

* <i class="fa fa-square-o" aria-hidden="true"></i> Instruct Galaxy where to find a container for the tool.
* <i class="fa fa-square-o" aria-hidden="true"></i> Instruct Galaxy to run the tool in a container.

---

class: left

### Configuring Galaxy to Use Containers

Just configure the destination. For instance, transform the cluster destination:

```
<destination id="short_fast" runner="slurm">
    <param id="nativeSpecification">--time=00:05:00 --nodes=1</param>
</destination>
```

as follows:


```
<destination id="short_fast" runner="slurm">
    <param id="nativeSpecification">--time=00:05:00 --nodes=1</param>
    <param id="docker_enabled">true</parma>
    <param id="docker_sudo">false</param>
</destination>
```

That is it!

For development, the Planemo flag `--docker` does this for `test`, `serve`, and related commands.

---

class: left

### Containerizing Tool Execution

#### Decomposes to basic problems

* <i class="fa fa-square-o" aria-hidden="true"></i> Instruct Galaxy where to find a container for the tool.
* <i class="fa fa-check-square-o" aria-hidden="true"></i> Instruct Galaxy to run the tool in a container.

---

class: left

## Explicit Container Dependencies

Returning to the seqtk example, lets change the `requirements` from:

```
<requirements>
    <requirement type="package" version="1.2">seqtk</requirement>
</requirements>
```

into

```
<requirements>
    <container type="docker">dukegcb/seqtk</container>
    <requirement type="package" version="1.2">seqtk</requirement>
</requirements>
```

Now run Planemo `test` and `serve` with the `--docker` flag and as a tool developer you are done!

---

### Containerizing Tool Execution

#### Decomposes to basic problems

* <i class="fa fa-check-square-o" aria-hidden="true"></i> Instruct Galaxy where to find a container for the tool.
* <i class="fa fa-check-square-o" aria-hidden="true"></i> Instruct Galaxy to run the tool in a container.

We're done... right?

???

---

class: left

## The Problems with Making Docker Explicit

* Setting up a `Dockerfile` and publishing a Docker image more process for the tool even though the dependencies have already been completely defined.
* An arbitrary Docker image is a blackbox that we can't be sure will execute the same binaries as the Conda requirements.

In other words, this:

```
<requirements>
    <requirement type="package" version="1.2">seqtk</requirement>
</requirements>
```

should have been sufficient! And the good news is that now it is (mostly).

---

class: left

## BioContainers

Galaxy can now automatically find containers for best practice tools.

Planemo can tell you if your tool is ready by linting with the `--biocontainers` flag.

```
$ planemo lint --biocontainers seqtk_seq.xml
...
Applying linter biocontainer_registered... CHECK
.. INFO: BioContainer best-practice container found [quay.io/biocontainers/seqtk:1.2--0].
```

???

But we didn't do anything - where did this magic seqtk container come from.

---

## The Mystery quay.io/biocontainers/seqtk Container

![](../../images/quayioseqtk.png)

???

I swear Planemo did not just create that with `tool_init` or `lint`, maybe we should try using it...

---

class: left

## Using the BioContainer

Run Planemo `test` or `serve` with `--biocontainers` to try mystery container.

.reduce70[```
$ planemo test --mulled_containers seqtk_seq.xml
...
[galaxy.tools.actions] Setup for job Job[unflushed,tool_id=seqtk_seq] complete, ready to flush (20.380 ms)
[galaxy.tools.actions] Flushed transaction for job Job[id=2,tool_id=seqtk_seq] (15.191 ms)
...
[galaxy.tools.deps.containers] Checking with container resolver [ExplicitContainerResolver[]] found description [None]
[galaxy.tools.deps.containers] Checking with container resolver [CachedMulledContainerResolver[namespace=None]] found description [None]
[galaxy.tools.deps.containers] Checking with container resolver [MulledContainerResolver[namespace=biocontainers]] found description [ContainerDescription[identifier=quay.io/biocontainers/seqtk:1.2--0,type=docker]]
[galaxy.jobs.command_factory] Built script [/tmp/tmpw8_UQm/job_working_directory/000/2/tool_script.sh] for tool command [seqtk seq -a '/tmp/tmpw8_UQm/files/000/dataset_1.dat' > '/tmp/tmpw8_UQm/files/000/dataset_2.dat']
...
ok

----------------------------------------------------------------------
XML: /private/tmp/tmpw8_UQm/xunit.xml
----------------------------------------------------------------------
Ran 1 test in 11.926s
OK
```]

The important line here is - `Checking with container resolver [MulledContainerResolver[namespace=biocontainers]] found description [ContainerDescription[identifier=quay.io/biocontainers/seqtk:1.2--0,type=docker]]`.

---

### BioContainers

![](../../images/biocontainers_org.png)

---

## Build on Demand

Galaxy can be configured to attempt to build containers on demand for containers that haven't
been published to the BioContainers namespace on quay.io.

These containers will have same names as would be published to quay.io (e.g. `quay.io/biocontainers/seqtk:1.2--0`).

---

### Containerizing Tool Execution

#### Decomposes to basic problems

* <i class="fa fa-check-square-o" aria-hidden="true"></i><i class="fa fa-check-square-o" aria-hidden="true"></i> Instruct Galaxy where to find a container for the tool.
* <i class="fa fa-check-square-o" aria-hidden="true"></i> Instruct Galaxy to run the tool in a container.

We're done this time now right?

???

---

## Revisiting Galaxy Requirements

![](../../images/galaxy_instance.png)

Many tools have multiple requirements, these need containers also!

???

---

class: left

## An Example

The BWA tool is an example of one such tool that has multiple requirements - because samtools is used to sort BAMs after mapping. The Planemo `conda_testing` project is distributed with a simple tool to simulate this containing both `bwa` and `samtools` requirements.

.reduce90[```
$ planemo project_init --project_template=conda_testing conda_testing
$ cd conda_testing/
$ grep -r require bwa_and_samtools.xml
bwa_and_samtools.xml:    <requirements>
bwa_and_samtools.xml:        <requirement type="package" version="0.7.15">bwa</requirement>
bwa_and_samtools.xml:        <requirement type="package" version="1.3.1">samtools</requirement>
bwa_and_samtools.xml:    </requirements>
```]

---

class: left

## Container Hashing

Galaxy finds containers based on the names and versions of requirements, so far we have seen
the hash for single requirements is just the name and the version.

If multiple requirements are present, the hash looks more like a hash. For bwa @ 0.7.15 and samtools @ 1.3.1,
Galaxy will look for a container called: `quay.io/biocontainers/mulled-v1-01afc412d1f216348d85970ce5f88c984aa443f3`.

???

TODO: mulled-v2...

---

## The Planemo `mull` command (1 / 2)

While Galaxy can be configured to auto-build BioContainers as they are needed, the `mull` command
can be used to manually build them for your local Docker host.

???

TODO: mulled-v2...

---

class: reduce70

## The `mull` command (2 / 2)

```
$ planemo mull bwa_and_samtools.xml
/home/planemo/.planemo/involucro -v=3 -f /home/planemo/workspace/planemo/.venv/lib/python2.7/site-packages/galaxy_lib-17.5.6.dev0-py2.7.egg/galaxy/tools/deps/mulled/invfile.lua -set CHANNELS='iuc,bioconda,r,defaults,conda-forge' -set TEST='true' -set TARGETS='samtools=1.3.1,bwa=0.7.15' -set REPO='quay.io/biocontainers/mulled-v1-01afc412d1f216348d85970ce5f88c984aa443f3' -set BINDS='build/dist:/usr/local/' -set PREINSTALL='conda install --quiet --yes conda=4.3' build
/home/planemo/.planemo/involucro -v=3 -f /home/planemo/workspace/planemo/.venv/lib/python2.7/site-packages/galaxy_lib-17.5.6.dev0-py2.7.egg/galaxy/tools/deps/mulled/invfile.lua -set CHANNELS='iuc,bioconda,r,defaults,conda-forge' -set TEST='true' -set TARGETS='samtools=1.3.1,bwa=0.7.15' -set REPO='quay.io/biocontainers/mulled-v1-01afc412d1f216348d85970ce5f88c984aa443f3' -set BINDS='build/dist:/usr/local/' -set PREINSTALL='conda install --quiet --yes conda=4.3' build
[Mar  1 10:35:52] DEBU Run file [/home/planemo/workspace/planemo/.venv/lib/python2.7/site-packages/galaxy_lib-17.5.6.dev0-py2.7.egg/galaxy/tools/deps/mulled/invfile.lua]
[Mar  1 10:35:52] STEP Run image [continuumio/miniconda:latest] with command [[rm -rf /data/dist]]
[Mar  1 10:35:52] DEBU Creating container [step-dc0ca6a011]
[Mar  1 10:35:52] DEBU Created container [fc1f03ba6d5c step-dc0ca6a011], starting it
[Mar  1 10:35:52] DEBU Container [fc1f03ba6d5c step-dc0ca6a011] started, waiting for completion
[Mar  1 10:35:55] DEBU Container [fc1f03ba6d5c step-dc0ca6a011] completed with exit code [0] as expected
[Mar  1 10:35:55] DEBU Container [fc1f03ba6d5c step-dc0ca6a011] removed
[Mar  1 10:35:55] STEP Run image [continuumio/miniconda:latest] with command [[/bin/sh -c conda install --quiet --yes conda=4.3 && conda install  -c iuc -c bioconda -c r -c defaults -c conda-forge  samtools=1.3.1 bwa=0.7.15 -p /usr/local --copy --yes --quiet]]
[Mar  1 10:35:55] DEBU Creating container [step-15585c5e5f]
[Mar  1 10:35:55] DEBU Created container [fd60643cbd2e step-15585c5e5f], starting it
[Mar  1 10:35:57] DEBU Container [fd60643cbd2e step-15585c5e5f] started, waiting for completion
[Mar  1 10:35:58] SOUT Fetching package metadata .......
[Mar  1 10:35:59] SOUT Solving package specifications: ..........
...
[Mar  1 10:36:56] SOUT
[Mar  1 10:36:57] DEBU Container [fd60643cbd2e step-15585c5e5f] completed with exit code [0] as expected
[Mar  1 10:36:58] DEBU Container [fd60643cbd2e step-15585c5e5f] removed
[Mar  1 10:36:58] STEP Wrap [build/dist] as [quay.io/biocontainers/mulled-v1-01afc412d1f216348d85970ce5f88c984aa443f3]
[Mar  1 10:36:58] DEBU Creating container [step-dfbadd3a91]
[Mar  1 10:36:59] DEBU Packing succeeded
```

This built `quay.io/biocontainers/mulled-v1-01afc412d1f216348d85970ce5f88c984aa443f3`!

???

TODO: mulled-v2...


---

class: reduce70

## Testing locally `mull`ed containers

```
$ planemo test --biocontainers bwa_and_samtools.xml
...
[galaxy.tools.actions] Handled output named output_2 for tool bwa_and_samtools (17.443 ms)
[galaxy.tools.actions] Added output datasets to history (12.935 ms)
[galaxy.tools.actions] Verified access to datasets for Job[unflushed,tool_id=bwa_and_samtools] (0.021 ms)
[galaxy.tools.actions] Setup for job Job[unflushed,tool_id=bwa_and_samtools] complete, ready to flush (5.755 ms)
[galaxy.tools.actions] Flushed transaction for job Job[id=1,tool_id=bwa_and_samtools] (19.582 ms)
[galaxy.jobs.handler] (1) Job dispatched
[galaxy.tools.deps] Using dependency bwa version 0.7.15 of type conda
[galaxy.tools.deps] Using dependency samtools version 1.3.1 of type conda
[galaxy.tools.deps] Using dependency bwa version 0.7.15 of type conda
[galaxy.tools.deps] Using dependency samtools version 1.3.1 of type conda
[galaxy.tools.deps.containers] Checking with container resolver [ExplicitContainerResolver[]] found description [None]
[galaxy.tools.deps.containers] Checking with container resolver [CachedMulledContainerResolver[namespace=None]] found description [ContainerDescription[identifier=quay.io/biocontainers/mulled-v1-01afc412d1f216348d85970ce5f88c984aa443f3:latest,type=docker]]
[galaxy.jobs.command_factory] Built script [/tmp/tmpQs0gyp/job_working_directory/000/1/tool_script.sh] for tool command [bwa > /tmp/tmpQs0gyp/files/000/dataset_1.dat 2>&1 ; samtools > /tmp/tmpQs0gyp/files/000/dataset_2.dat 2>&1]
[galaxy.tools.deps] Using dependency samtools version None of type conda
[galaxy.tools.deps] Using dependency samtools version None of type conda
ok

----------------------------------------------------------------------
XML: /private/tmp/tmpQs0gyp/xunit.xml
----------------------------------------------------------------------
Ran 1 test in 7.553s

OK
[test_driver] Shutting down
[test_driver] Shutting down embedded galaxy web server
[test_driver] Embedded web server galaxy stopped
[test_driver] Stopping application galaxy
...
[galaxy.jobs.handler] job handler stop queue stopped
Testing complete. HTML report is in "/home/planemo/workspace/planemo/tool_test_output.html".
All 1 test(s) executed passed.
bwa_and_samtools[0]: passed
```

---

### <i class="fa fa-pencil" aria-hidden="true"></i> Hands-on

![](../../images/exercise.png)

---

### <i class="fa fa-pencil" aria-hidden="true"></i> Hands-on

#### The Goal

- Use `--biocontainers` to build a container on-demand for a test tool.

---

class: left

### <i class="fa fa-pencil" aria-hidden="true"></i> Hands-on

#### Steps

- Run through the bwa_and_samtools.xml test tool and verify container creation.

```
$ planemo project_init --project_template=conda_testing conda_testing
$ cd conda_testing/
$ planemo test --biocontainers bwa_and_samtools.xml
```
