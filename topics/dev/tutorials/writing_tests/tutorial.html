<!DOCTYPE html>
<html lang="en" dir="auto">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Hands-on: Writing Automated Tests for Galaxy / Writing Automated Tests for Galaxy / Development in Galaxy</title>
        
            <meta name="google-site-verification" content="9mOXn2JL833-i7-aioCCEuIdG4_tb6qjwUozB5GJnPQ" />

<!-- JavaScript Error Monitoring, and performance tracking. -->
<script
  src="https://browser.sentry-cdn.com/7.52.1/bundle.tracing.min.js"
  integrity="sha384-muuFXKS3752PNA4rPm9Uq6BLvOfV4CXyr9MHDBPvozOJJUWLKkogEFWOIRoVps43"
  crossorigin="anonymous"
></script>
<script type="text/javascript">
if(localStorage.getItem('sentry-opt-out') !== 'opt-out' && navigator.doNotTrack !== "1") {
	console.log("Sentry: opt-in");
	Sentry.init({
		dsn: "https://45e0ec6e4373462b92969505df37cf40@sentry.galaxyproject.org/10",
		release: "galaxy-training-network@07d82075d85f1904fe5da1a3b0d187a1192494eb",
		integrations: [new Sentry.BrowserTracing(), new Sentry.Replay()],
		sampleRate: 0.1,
		tracesSampleRate: 0.1,
		// Capture Replay for no sessions by default
		replaysSessionSampleRate: 0.01,
		// plus for 1% of sessions with an error
		replaysOnErrorSampleRate: 0.01,
		// PII OFF
		sendDefaultPii: false, // Off by default but just in case.
		environment: "production",
	});
}
</script>

<!-- Page view tracking -->
<script defer data-domain="training.galaxyproject.org" src="https://plausible.galaxyproject.eu/js/plausible.js"></script>
<script>
if(localStorage.getItem('plausible-opt-out') !== 'opt-out' && navigator.doNotTrack !== "1") {
	localStorage.removeItem("plausible_ignore")
	console.log("Plausible: opt-in");
	window.plausible = window.plausible || function() { (window.plausible.q = window.plausible.q || []).push(arguments) }
} else {
	// if they're opting-out, or DNT
	// we might get one page by accident but we won't get future ones.
	localStorage.setItem("plausible_ignore", "true")
}
</script>

        
        <link rel="shortcut icon" href="/training-material/favicon.ico" type="image/x-icon">
        <link rel="alternate" type="application/atom+xml" href="/training-material/feed.xml">
        <link rel="canonical" href="https://training.galaxyproject.org/training-material/topics/dev/tutorials/writing_tests/tutorial.html">
        <link rel="license" href="https://spdx.org/licenses/CC-BY-4.0">
        <link rel="preload" href="/training-material/assets/fonts/AtkinsonHyperlegible/Atkinson-Hyperlegible-Regular-102a.woff2" as="font" type="font/woff2" crossorigin>
        <link rel="preload" href="/training-material/assets/fonts/AtkinsonHyperlegible/Atkinson-Hyperlegible-Bold-102a.woff2" as="font" type="font/woff2" crossorigin>
        <link rel="preload" href="/training-material/assets/fonts/AtkinsonHyperlegible/Atkinson-Hyperlegible-Italic-102a.woff2" as="font" type="font/woff2" crossorigin>
        
        <link rel="preload" href="/training-material/assets/css/main.css?v=3" as="style">
        <link rel='preload' href='/training-material/assets/js/bundle.theme.f1f2de89.js' as='script'>
<link rel='preload' href='/training-material/assets/js/bundle.main.40d4e218.js' as='script'>
        <link rel="stylesheet" href="/training-material/assets/css/main.css?v=3">
        <link rel="manifest" href="/training-material/manifest.json">
        <meta name="theme-color" content="#2c3143"/>
	

        <meta name="DC.identifier" content="https://github.com/galaxyproject/training-material">
<meta name="DC.type" content="text">
<meta name="DC.title" content="Writing Automated Tests for Galaxy">
<meta name="DC.publisher" content="Galaxy Training Network">
<meta name="DC.date" content="2024-06-25 09:18:34 +0000">
<meta name="DC.creator" content="John Davis">
<meta name="DC.creator" content="John Chilton"><meta name="description" content="Galaxy is an open-source project. Everyone can contribute to its development with core Galaxy development, integration of softwares in Galaxy environment, ...">
        <meta property="og:site_name" content="Galaxy Training Network">
	<meta property="og:title" content="Development in Galaxy / Writing Automated Tests for Galaxy / Hands-on: Writing Automated Tests for Galaxy">
        <meta property="og:description" content="Galaxy is an open-source project. Everyone can contribute to its development with core Galaxy development, integration of softwares in Galaxy environment, ...">
        <meta property="og:image" content="https://galaxy-training.s3.amazonaws.com/social/topics/dev/tutorials/writing_tests/tutorial.png">
	<script type="application/ld+json">


{
  "@context": "http://schema.org",
  "@type": "LearningResource",
  "http://purl.org/dc/terms/conformsTo": {
    "@id": "https://bioschemas.org/profiles/TrainingMaterial/1.0-RELEASE",
    "@type": "CreativeWork"
  },
  "audience": {
    "@type": "EducationalAudience",
    "educationalRole": "Galaxy Administrators"
  },
  "citation": [
    {
      "@type": "CreativeWork",
      "name": "Galaxy Training: A Powerful Framework for Teaching!",
      "url": "https://doi.org/10.1371/journal.pcbi.1010752"
    },
    {
      "@type": "CreativeWork",
      "name": "Community-Driven Data Analysis Training for Biology",
      "url": "https://doi.org/10.1016/j.cels.2018.05.012"
    }
  ],
  "discussionUrl": "https://gitter.im/Galaxy-Training-Network/Lobby",
  "headline": "Writing Automated Tests for Galaxy",
  "interactivityType": "mixed",
  "isAccessibleForFree": true,
  "isFamilyFriendly": true,
  "license": "https://spdx.org/licenses/CC-BY-4.0.html",
  "producer": {
    "@type": "Organization",
    "http://purl.org/dc/terms/conformsTo": {
      "@id": "https://bioschemas.org/profiles/Organization/0.2-DRAFT-2019_07_19",
      "@type": "Organization"
    },
    "id": "https://training.galaxyproject.org",
    "email": "galaxytrainingnetwork@gmail.com",
    "name": "Galaxy Training Network",
    "legalName": "Galaxy Training Network",
    "alternateName": "GTN",
    "url": "https://training.galaxyproject.org",
    "logo": "https://training.galaxyproject.org/training-material/assets/images/GTNLogo1000.png",
    "fundingModel": "The GTN's infrastructure relies on GitHub and the Galaxy Project for hosting costs. There are no full time paid staff members of the GTN. Individuals are occasionally funded on GTN-adjacent projects.",
    "keywords": [
      "galaxy",
      "bioinformatics",
      "training",
      "fair",
      "accessible"
    ],
    "status": "active",
    "foundingDate": "2015-06-29",
    "socialMedia": "https://mstdn.science/@gtn",
    "type": "project"
  },
  "provider": {
    "@type": "Organization",
    "http://purl.org/dc/terms/conformsTo": {
      "@id": "https://bioschemas.org/profiles/Organization/0.2-DRAFT-2019_07_19",
      "@type": "Organization"
    },
    "id": "https://training.galaxyproject.org",
    "email": "galaxytrainingnetwork@gmail.com",
    "name": "Galaxy Training Network",
    "legalName": "Galaxy Training Network",
    "alternateName": "GTN",
    "url": "https://training.galaxyproject.org",
    "logo": "https://training.galaxyproject.org/training-material/assets/images/GTNLogo1000.png",
    "fundingModel": "The GTN's infrastructure relies on GitHub and the Galaxy Project for hosting costs. There are no full time paid staff members of the GTN. Individuals are occasionally funded on GTN-adjacent projects.",
    "keywords": [
      "galaxy",
      "bioinformatics",
      "training",
      "fair",
      "accessible"
    ],
    "status": "active",
    "foundingDate": "2015-06-29",
    "socialMedia": "https://mstdn.science/@gtn",
    "type": "project"
  },
  "sourceOrganization": {
    "@type": "Organization",
    "http://purl.org/dc/terms/conformsTo": {
      "@id": "https://bioschemas.org/profiles/Organization/0.2-DRAFT-2019_07_19",
      "@type": "Organization"
    },
    "id": "https://training.galaxyproject.org",
    "email": "galaxytrainingnetwork@gmail.com",
    "name": "Galaxy Training Network",
    "legalName": "Galaxy Training Network",
    "alternateName": "GTN",
    "url": "https://training.galaxyproject.org",
    "logo": "https://training.galaxyproject.org/training-material/assets/images/GTNLogo1000.png",
    "fundingModel": "The GTN's infrastructure relies on GitHub and the Galaxy Project for hosting costs. There are no full time paid staff members of the GTN. Individuals are occasionally funded on GTN-adjacent projects.",
    "keywords": [
      "galaxy",
      "bioinformatics",
      "training",
      "fair",
      "accessible"
    ],
    "status": "active",
    "foundingDate": "2015-06-29",
    "socialMedia": "https://mstdn.science/@gtn",
    "type": "project"
  },
  "workTranslation": [

  ],
  "creativeWorkStatus": "Active",
  "dateModified": "2024-06-25 09:18:34 +0000",
  "datePublished": "2022-07-15 10:22:17 +0000",
  "copyrightHolder": {
    "@type": "Organization",
    "http://purl.org/dc/terms/conformsTo": {
      "@id": "https://bioschemas.org/profiles/Organization/0.2-DRAFT-2019_07_19",
      "@type": "Organization"
    },
    "id": "https://training.galaxyproject.org",
    "email": "galaxytrainingnetwork@gmail.com",
    "name": "Galaxy Training Network",
    "legalName": "Galaxy Training Network",
    "alternateName": "GTN",
    "url": "https://training.galaxyproject.org",
    "logo": "https://training.galaxyproject.org/training-material/assets/images/GTNLogo1000.png",
    "fundingModel": "The GTN's infrastructure relies on GitHub and the Galaxy Project for hosting costs. There are no full time paid staff members of the GTN. Individuals are occasionally funded on GTN-adjacent projects.",
    "keywords": [
      "galaxy",
      "bioinformatics",
      "training",
      "fair",
      "accessible"
    ],
    "status": "active",
    "foundingDate": "2015-06-29",
    "socialMedia": "https://mstdn.science/@gtn",
    "type": "project"
  },
  "funder": [

  ],
  "funding": [

  ],
  "identifier": "https://gxy.io/GTN:T00123",
  "accessMode": [
    "textual",
    "visual"
  ],
  "accessModeSufficient": [
    "textual",
    "visual"
  ],
  "accessibilityControl": [
    "fullKeyboardControl",
    "fullMouseControl"
  ],
  "accessibilityFeature": [
    "alternativeText",
    "tableOfContents"
  ],
  "accessibilitySummary": "The text aims to be as accessible as possible. Image descriptions will vary per tutorial, from images being completely inaccessible, to images with good descriptions for non-visual users.",
  "isPartOf": {
    "@type": "CreativeWork",
    "name": "Development in Galaxy",
    "description": "Galaxy is an open-source project. Everyone can contribute to its development with core Galaxy development, integration of softwares in Galaxy environment, ...",
    "url": "https://training.galaxyproject.org/training-material/topics/dev/"
  },
  "abstract": "The Galaxy code base contains thousands of tests that include tests of different types (unit vs. functional vs. end-to-end; client vs. backend, etc.) that are supported by a variety of testing frameworks and libraries. In this tutorial, we will offer a small, yet representative sample of the types of tests you might write, as well as the concepts and issues you may need to be familiar with when writing tests for Galaxy code, whether as part of a new feature you are implementing, or as a standalone contribution to Galaxy's testing code.",
  "learningResourceType": "e-learning",
  "name": "Writing Automated Tests for Galaxy",
  "url": "https://training.galaxyproject.org/training-material/topics/dev/tutorials/writing_tests/tutorial.html",
  "version": 5,
  "timeRequired": "PT3H",
  "teaches": "- Learn about the different types of automated tests in Galaxy\n- Learn to write API tests\n- Learn to write unit tests",
  "keywords": [
    "Development in Galaxy"
  ],
  "description": "## Abstract\n\nThe Galaxy code base contains thousands of tests that include tests of different types (unit vs. functional vs. end-to-end; client vs. backend, etc.) that are supported by a variety of testing frameworks and libraries. In this tutorial, we will offer a small, yet representative sample of the types of tests you might write, as well as the concepts and issues you may need to be familiar with when writing tests for Galaxy code, whether as part of a new feature you are implementing, or as a standalone contribution to Galaxy's testing code.\n\n\n## About This Material\n\nThis is a Hands-on Tutorial from the GTN which is usable either for individual self-study, or as a teaching material in a classroom.\n\n\n## Learning Objectives\n\n- Learn about the different types of automated tests in Galaxy\n- Learn to write API tests\n- Learn to write unit tests\n\n",
  "inLanguage": {
    "@type": "Language",
    "name": "English",
    "alternateName": "en"
  },
  "competencyRequired": [
    "Familiarity with basic Git commands",
    "Basic knowledge of Python and JavaScript",
    "Mac OS or Linux that can run Galaxy & your favorite IDE or editor",
    {
      "@context": "http://schema.org",
      "@type": "LearningResource",
      "url": "https://training.galaxyproject.org/training-material/topics/dev/tutorials/architecture/slides.html",
      "name": "Galaxy Code Architecture",
      "description": "Slides for 'Galaxy Code Architecture' tutorial",
      "learningResourceType": "slides",
      "interactivityType": "expositive",
      "provider": {
        "@type": "Organization",
        "http://purl.org/dc/terms/conformsTo": {
          "@id": "https://bioschemas.org/profiles/Organization/0.2-DRAFT-2019_07_19",
          "@type": "Organization"
        },
        "id": "https://training.galaxyproject.org",
        "email": "galaxytrainingnetwork@gmail.com",
        "name": "Galaxy Training Network",
        "legalName": "Galaxy Training Network",
        "alternateName": "GTN",
        "url": "https://training.galaxyproject.org",
        "logo": "https://training.galaxyproject.org/training-material/assets/images/GTNLogo1000.png",
        "fundingModel": "The GTN's infrastructure relies on GitHub and the Galaxy Project for hosting costs. There are no full time paid staff members of the GTN. Individuals are occasionally funded on GTN-adjacent projects.",
        "keywords": [
          "galaxy",
          "bioinformatics",
          "training",
          "fair",
          "accessible"
        ],
        "status": "active",
        "foundingDate": "2015-06-29",
        "socialMedia": "https://mstdn.science/@gtn",
        "type": "project"
      }
    }
  ],
  "author": [
    {
      "@context": "https://schema.org",
      "@type": "Person",
      "http://purl.org/dc/terms/conformsTo": {
        "@id": "https://bioschemas.org/profiles/Person/0.3-DRAFT",
        "@type": "CreativeWork"
      },
      "url": "https://training.galaxyproject.org/training-material/hall-of-fame/jdavcs/",
      "mainEntityOfPage": "https://training.galaxyproject.org/training-material/hall-of-fame/jdavcs/",
      "name": "John Davis",
      "image": "https://avatars.githubusercontent.com/jdavcs",
      "description": "A contributor to the GTN project.",
      "memberOf": [
        {
          "@type": "Organization",
          "http://purl.org/dc/terms/conformsTo": {
            "@id": "https://bioschemas.org/profiles/Organization/0.2-DRAFT-2019_07_19",
            "@type": "Organization"
          },
          "id": "https://training.galaxyproject.org",
          "email": "galaxytrainingnetwork@gmail.com",
          "name": "Galaxy Training Network",
          "legalName": "Galaxy Training Network",
          "alternateName": "GTN",
          "url": "https://training.galaxyproject.org",
          "logo": "https://training.galaxyproject.org/training-material/assets/images/GTNLogo1000.png",
          "fundingModel": "The GTN's infrastructure relies on GitHub and the Galaxy Project for hosting costs. There are no full time paid staff members of the GTN. Individuals are occasionally funded on GTN-adjacent projects.",
          "keywords": [
            "galaxy",
            "bioinformatics",
            "training",
            "fair",
            "accessible"
          ],
          "status": "active",
          "foundingDate": "2015-06-29",
          "socialMedia": "https://mstdn.science/@gtn",
          "type": "project"
        }
      ],
      "identifier": "https://orcid.org/0000-0002-1363-1245",
      "orcid": "https://orcid.org/0000-0002-1363-1245"
    },
    {
      "@context": "https://schema.org",
      "@type": "Person",
      "http://purl.org/dc/terms/conformsTo": {
        "@id": "https://bioschemas.org/profiles/Person/0.3-DRAFT",
        "@type": "CreativeWork"
      },
      "url": "https://training.galaxyproject.org/training-material/hall-of-fame/jmchilton/",
      "mainEntityOfPage": "https://training.galaxyproject.org/training-material/hall-of-fame/jmchilton/",
      "name": "John Chilton",
      "image": "https://avatars.githubusercontent.com/jmchilton",
      "description": "A contributor to the GTN project.",
      "memberOf": [
        {
          "@type": "Organization",
          "http://purl.org/dc/terms/conformsTo": {
            "@id": "https://bioschemas.org/profiles/Organization/0.2-DRAFT-2019_07_19",
            "@type": "Organization"
          },
          "id": "https://training.galaxyproject.org",
          "email": "galaxytrainingnetwork@gmail.com",
          "name": "Galaxy Training Network",
          "legalName": "Galaxy Training Network",
          "alternateName": "GTN",
          "url": "https://training.galaxyproject.org",
          "logo": "https://training.galaxyproject.org/training-material/assets/images/GTNLogo1000.png",
          "fundingModel": "The GTN's infrastructure relies on GitHub and the Galaxy Project for hosting costs. There are no full time paid staff members of the GTN. Individuals are occasionally funded on GTN-adjacent projects.",
          "keywords": [
            "galaxy",
            "bioinformatics",
            "training",
            "fair",
            "accessible"
          ],
          "status": "active",
          "foundingDate": "2015-06-29",
          "socialMedia": "https://mstdn.science/@gtn",
          "type": "project"
        }
      ],
      "identifier": "https://orcid.org/0000-0002-6794-0756",
      "orcid": "https://orcid.org/0000-0002-6794-0756"
    }
  ],
  "about": [
    {
      "@type": "CreativeWork",
      "name": "Development in Galaxy",
      "description": "Galaxy is an open-source project. Everyone can contribute to its development with core Galaxy development, integration of softwares in Galaxy environment, ...",
      "url": "https://training.galaxyproject.org/training-material/topics/dev/"
    },
    {
      "@type": "DefinedTerm",
      "@id": "http://edamontology.org/topic_3372",
      "inDefinedTermSet": "http://edamontology.org",
      "termCode": "topic_3372",
      "url": "https://bioportal.bioontology.org/ontologies/EDAM/?p=classes&conceptid=http%3A%2F%2Fedamontology.org%2Ftopic_3372"
    }
  ],
  "educationalLevel": "Beginner",
  "mentions": [

  ]
}</script></head>
    <body data-spy="scroll" data-target="#toc" data-brightness="auto" data-contrast="auto">
        <script  src='/training-material/assets/js/bundle.theme.f1f2de89.js'></script>
        <header>
    <nav class="navbar navbar-expand-md navbar-dark" aria-label="Site Navigation">
        <div class="container">
            <a class="navbar-brand" href="/training-material/">
                <img src="/training-material/assets/images/GTN-60px.png" height="30" alt="Galaxy Training Network logo">
                
                    Galaxy Training!
                
            </a>

            <button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse" data-target="#top-navbar" aria-controls="top-navbar" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="top-navbar">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        
                        <a class="nav-link" href="/training-material/topics/dev" title="Go back to list of tutorials">
                            <i class="far fa-folder" aria-hidden="true"></i> Development in Galaxy
                        </a>
                        
                    </li>

                    <li class="nav-item">
                        
                        <a class="nav-link" href="/training-material/learning-pathways" title="Learning Pathways">
                           <i class="fas fa-graduation-cap" aria-hidden="true"></i><span class="visually-hidden">curriculum</span> Learning Pathways
                        </a>
                        
                    </li>

                    <li class="nav-item dropdown">
    <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown" aria-expanded="false" title="Help">
        <i class="far fa-question-circle" aria-hidden="true"></i><span class="visually-hidden">help</span> Help
    </a>
    <div class="dropdown-menu dropdown-menu-right">
	<a class="dropdown-item" href="/training-material/faqs/index.html" title="Check our FAQs">
           <i class="far fa-question-circle" aria-hidden="true"></i><span class="visually-hidden">question</span> FAQs
        </a>
        
        
        
        <a class="dropdown-item" href="/training-material/topics/dev/faqs/" title="Check our FAQs for the Development in Galaxy topic">
           <i class="far fa-question-circle" aria-hidden="true"></i><span class="visually-hidden">question</span> Topic FAQs
        </a>
        
        
        
        <a class="dropdown-item" href="https://help.galaxyproject.org/" title="Discuss on Galaxy Help">
            <i class="far fa-comments" aria-hidden="true"></i><span class="visually-hidden">feedback</span> Galaxy Help Forum
        </a>
        <a class="dropdown-item" href="https://gitter.im/Galaxy-Training-Network/Lobby" title="Discuss on gitter">
           <i class="fab fa-gitter" aria-hidden="true"></i><span class="visually-hidden">gitter</span> Discuss on Matrix
        </a>
    </div>
</li>


                    <li class="nav-item dropdown">
    <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown" aria-expanded="false" title="Settings">
	<i class="fas fa-cog" aria-hidden="true"></i><span class="visually-hidden">galaxy-gear</span> Settings
    </a>
    <div class="dropdown-menu dropdown-menu-right">

	<h6 class="dropdown-header">Preferences</h6>

	<a href="/training-material/user/theme.html" class="dropdown-item">
		<i class="fas fa-palette" aria-hidden="true"></i><span class="visually-hidden">gtn-theme</span> Theme
	</a>

	<a href="/training-material/user/privacy.html" class="dropdown-item">
		<i class="fas fa-lock" aria-hidden="true"></i><span class="visually-hidden">pref-dataprivate</span> Data Privacy
	</a>

	<div class="dropdown-divider"></div>

	<h6 class="dropdown-header">For Everyone</h6>

        <a class="dropdown-item" href="https://github.com/galaxyproject/training-material/edit/main/topics/dev/tutorials/writing_tests/tutorial.md">
          <i class="fab fa-github" aria-hidden="true"></i><span class="visually-hidden">github</span> Propose a change or correction
        </a>

	<h6 class="dropdown-header">Instructor Utilities</h6>

        <a class="dropdown-item" href="/training-material/stats.html">
            <i class="fas fa-chart-column" aria-hidden="true"></i><span class="visually-hidden">galaxy-barchart</span> GTN statistics
        </a>

        <a class="dropdown-item" href="https://plausible.galaxyproject.eu/training.galaxyproject.org?period=12mo&page=/training-material/topics/dev/tutorials/writing_tests/tutorial.html">
            <i class="fas fa-chart-column" aria-hidden="true"></i><span class="visually-hidden">galaxy-barchart</span> Page View Metrics
        </a>

        <!-- link to feedback -->
        
            
            
                <a class="dropdown-item" href="/training-material/feedback.html">
                    <i class="fas fa-chart-column" aria-hidden="true"></i><span class="visually-hidden">galaxy-barchart</span> GTN feedback
                </a>
            
        

        <div class="dropdown-item">
            <div>
                <i class="fas fa-history" aria-hidden="true"></i><span class="visually-hidden">galaxy-rulebuilder-history</span> Previous Versions
            </div>

            <div id="archive-selector">
            
                <a class="btn btn-warning" href="https://training.galaxyproject.org/archive/">Older Versions</a>
            </div>

        </div>

    </div>
</li>


                    <!-- Search bar-->
                    <li class="nav-item">
                      <div id="navbarSupportedContent" role="search">
                        <!-- Search form -->
                        <form class="form-inline mr-auto" method="GET" action="/training-material/search2">
                          <i class="fas fa-search nav-link" aria-hidden="true"></i>
                          <div class="md-form mb-2">
                            <input name="query" class="form-control nicer" type="text" placeholder="Search Tutorials" aria-label="Search">
                          </div>
                        </form>
                      </div>
                    </li>
                </ul>
            </div>
        </div>
    </nav>
</header>

        
        <div class="container main-content" role="main">
        














<!-- Gitter -->






<article class="tutorial topic-dev">
    <h1 data-toc-skip>Writing Automated Tests for Galaxy</h1>
    

    <section aria-labelledby="overview-box" id="tutorial-metadata">
    <div markdown="0">

	<div class="contributors-line">
		Authors: <a href="/training-material/hall-of-fame/jdavcs/" class="contributor-badge contributor-jdavcs"><img src="/training-material/assets/images/orcid.png" alt="orcid logo" width="36" height="36"/><img src="https://avatars.githubusercontent.com/jdavcs?s=36" alt="John Davis avatar" width="36" class="avatar" />
    John Davis</a><a href="/training-material/hall-of-fame/jmchilton/" class="contributor-badge contributor-jmchilton"><img src="/training-material/assets/images/orcid.png" alt="orcid logo" width="36" height="36"/><img src="https://avatars.githubusercontent.com/jmchilton?s=36" alt="John Chilton avatar" width="36" class="avatar" />
    John Chilton</a>
	</div>

</div>


    <blockquote class="overview">
        <div id="overview-box" class="box-title">Overview</div>
        
        <img alt="Creative Commons License: CC-BY" class="float-right" style="border-width:0; display: inline-block; margin:0" src="/training-material/assets/images/cc-by.png" width="88" height="31"/>
        
        <strong><i class="far fa-question-circle" aria-hidden="true"></i> Questions:</strong>
        <ul>
        
        </ul>

        <strong><i class="fas fa-bullseye" aria-hidden="true"></i> Objectives: </strong>
        <ul>
        
        <li><p>Learn about the different types of automated tests in Galaxy</p>
</li>
        
        <li><p>Learn to write API tests</p>
</li>
        
        <li><p>Learn to write unit tests</p>
</li>
        
        </ul>

        
        <strong><i class="fas fa-check-circle" aria-hidden="true"></i> Requirements:</strong>
        <ul>
        

        
    
      <li>
        Familiarity with basic Git commands
      </li>
    

    
      <li>
        Basic knowledge of Python and JavaScript
      </li>
    

    
      <li>
        Mac OS or Linux that can run Galaxy & your favorite IDE or editor
      </li>
    

    
        
        
        
            
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                        
                            <li>
                              <a href="/training-material/topics/dev/tutorials/architecture/slides.html"><i class="fab fa-slideshare" aria-hidden="true"></i><span class="visually-hidden">slides</span> Slides: Galaxy Code Architecture</a>
                            </li>
                        
                        
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
            
        
    


        </ul>
        

        
        <div><strong><i class="fas fa-hourglass-half" aria-hidden="true"></i> Time estimation:</strong> 3 hours</div>
        

        

        

        

        <div id="supporting-materials"><strong><i class="fa fa-external-link" aria-hidden="true"></i> Supporting Materials:</strong></div>
        <ul class="supporting_material">
            

            

            

            

            

            

            

            
            
            

            <!-- Check the GTN Video Library for recordings of this tutorial or associated slides -->
            












            
                
            
        </ul>

        <div><strong><i class="far fa-calendar" aria-hidden="true"></i> Published:</strong> Jul 15, 2022 </div>
        <div><strong><i class="far fa-calendar" aria-hidden="true"></i> Last modification:</strong> Jun 25, 2024 </div>
        <div><strong><i class="fas fa-balance-scale" aria-hidden="true"></i> License:</strong>
		
            Tutorial Content is licensed under
            
              <a rel="license" href="http://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 International License</a>.
            
            The GTN Framework is licensed under <a rel="license" href="https://github.com/galaxyproject/training-material/blob/main/LICENSE.md">MIT</a>
        </div>
        
        <div><strong><i class="fas fa-fingerprint" aria-hidden="true"></i><span class="visually-hidden">purl</span> <abbr title="Persistent URL">PURL</abbr>:</strong> <a href="https://gxy.io/GTN:T00123">https://gxy.io/GTN:T00123</a> </div>
        

	
	

	
	
	<div><strong><i class="fas fa-code-commit" aria-hidden="true"></i><span class="visually-hidden">version</span> Revision:</strong> 5 </div>

    </blockquote>
    </section>

    <div class="container">
        <div class="row">
            <!-- sidebar, which will move to the top on a small screen -->
            <div class="col-sm-2 hide-when-printing">
                <nav id="toc" data-toggle="toc" class="sticky-top" aria-label="Table of Contents"></nav>
            </div>
            <div class="col-sm-10">
                 

                <section aria-label="Tutorial Content" id="tutorial-content">
                <p>The Galaxy code base contains thousands of tests that include tests of different types (unit vs. functional vs. end-to-end; client vs. backend, etc.) that are supported by a variety of testing frameworks and libraries. In this tutorial, we will offer a small, yet representative sample of the types of tests you might write, as well as the concepts and issues you may need to be familiar with when writing tests for Galaxy code, whether as part of a new feature you are implementing, or as a standalone contribution to Galaxy’s testing code.</p>

<p>A good way to start learning about Galaxy’s testing infrastructure and how to use it is to read the documentation article on the different types of tests that are present in the code base as well as how to determine which type is most appropriate for a given scenario (see <a href="https://docs.galaxyproject.org/en/master/dev/writing_tests.html">Writing Tests for Galaxy</a>).</p>

<p>In addition to reading the documentation, it is essential to have a reasonable understanding of Galaxy’s code organization. The best documentation resource for that is the <a href="/training-material/topics/dev/tutorials/architecture/slides.html">Galaxy Code Architecture slides</a>. In addition, we recommend the <a href="/training-material/topics/dev/tutorials/core-contributing/tutorial.html">Contributing a New Feature to Galaxy Core</a> tutorial, which, among other things, combines some of the concepts from the architecture slides with the material covered in this tutorial.</p>

<p>The most detailed and up-to-date documentation on running Galaxy tests is located at the top of the <code class="language-plaintext highlighter-rouge">run_tests.sh</code> script in Galaxy’s root directory.</p>

<p>To run Galaxy tests, you may also use the <code class="language-plaintext highlighter-rouge">pytest</code> command directly (except for client tests, which provide their own infrastructure and scripts described in <code class="language-plaintext highlighter-rouge">client/README.md</code>. Using pytest directly is most convenient for running individual tests (although you might have to manually set the required environment variables for all but unit tests, as per documentation in <code class="language-plaintext highlighter-rouge">run_tests.sh</code>). However, keep in mind that the <code class="language-plaintext highlighter-rouge">run_scripts.sh</code> script optimizes the tests by reusing the same Galaxy instance and database for API tests, so running API tests in batch with pytest would be very inefficient.</p>

<p>Another useful resource is the <a href="/training-material/topics/dev/tutorials/debugging/tutorial.html">Debugging Galaxy</a> tutorial which contains a lot of useful information on how to debug test failures that occur both locally and remotely.</p>

<p>Finally, nothing can substitute studying Galaxy’s test code - we encourage you to always look for examples of similar tests and testing scenarios before you write your own.</p>

<blockquote class="agenda">
  <div class="box-title agenda-title" id="agenda">Agenda</div>

<ol id="markdown-toc">
  <li><a href="#local-development-environment-setup" id="markdown-toc-local-development-environment-setup">Local development environment setup</a></li>
  <li><a href="#api-tests" id="markdown-toc-api-tests">API tests</a>    <ol>
      <li><a href="#basic-api-test" id="markdown-toc-basic-api-test">Basic API test</a></li>
      <li><a href="#test-creating-a-simple-object" id="markdown-toc-test-creating-a-simple-object">Test creating a simple object</a></li>
      <li><a href="#a-better-test-for-creating-a-simple-object" id="markdown-toc-a-better-test-for-creating-a-simple-object">A better test for creating a simple object</a></li>
      <li><a href="#use-galaxys-populators-for-setting-up-database-state" id="markdown-toc-use-galaxys-populators-for-setting-up-database-state">Use Galaxy’s populators for setting up database state</a></li>
    </ol>
  </li>
  <li><a href="#unit-tests" id="markdown-toc-unit-tests">Unit tests</a>    <ol>
      <li><a href="#testing-simple-functions" id="markdown-toc-testing-simple-functions">Testing simple functions</a></li>
      <li><a href="#verifying-that-an-error-is-raised" id="markdown-toc-verifying-that-an-error-is-raised">Verifying that an error is raised</a></li>
      <li><a href="#using-fixtures-to-reduce-code-duplication" id="markdown-toc-using-fixtures-to-reduce-code-duplication">Using fixtures to reduce code duplication</a></li>
      <li><a href="#parametrization-of-test-functions" id="markdown-toc-parametrization-of-test-functions">Parametrization of test functions</a></li>
      <li><a href="#dealing-with-less-trivial-code" id="markdown-toc-dealing-with-less-trivial-code">Dealing with less trivial code</a></li>
      <li><a href="#mocking-a-dependency" id="markdown-toc-mocking-a-dependency">Mocking a dependency</a></li>
      <li><a href="#refactoring-for-testability" id="markdown-toc-refactoring-for-testability">Refactoring for testability</a></li>
      <li><a href="#monkeypatching-the-module-under-test" id="markdown-toc-monkeypatching-the-module-under-test">“Monkeypatching” the module under test</a></li>
      <li><a href="#more-refactoring" id="markdown-toc-more-refactoring">More refactoring</a></li>
      <li><a href="#more-monkeypatching" id="markdown-toc-more-monkeypatching">More “monkeypatching”</a></li>
      <li><a href="#utilizing-the-mocks-to-test-the-logic" id="markdown-toc-utilizing-the-mocks-to-test-the-logic">Utilizing the mocks to test the logic</a></li>
      <li><a href="#reformatting-for-improved-readability" id="markdown-toc-reformatting-for-improved-readability">Reformatting for improved readability</a></li>
      <li><a href="#adding-the-remaining-tests" id="markdown-toc-adding-the-remaining-tests">Adding the remaining tests</a></li>
    </ol>
  </li>
</ol>

</blockquote>

<h1 id="local-development-environment-setup">Local development environment setup</h1>

<!--SNIPPET-->
<blockquote class="tip">   <div class="box-title tip-title" id="tip-how-to-contribute-to-galaxy"><button class="gtn-boxify-button tip" type="button" aria-controls="tip-how-to-contribute-to-galaxy" aria-expanded="true"><i class="far fa-lightbulb" aria-hidden="true"></i> <span>Tip: How to Contribute to Galaxy</span><span class="fold-unfold fa fa-minus-square"></span></button></div>   <p>To contribute to galaxy, a GitHub account is required. Changes are proposed via a <a href="https://docs.github.com/en/github/collaborating-with-pull-requests">pull request</a>. This allows the project maintainers to review the changes and suggest improvements.</p>   <p>The general steps are as follows:</p>   <ol>   <li>Fork the Galaxy repository</li>   <li>Clone your fork</li>   <li>Make changes in a new branch</li>   <li>Commit your changes, push branch to your fork</li>   <li>Open a pull request for this branch in the upstream Galaxy repository</li> </ol>   <blockquote class="details">   <div class="box-title details-title" id="details-git-github-and-galaxy-core"><button class="gtn-boxify-button details" type="button" aria-controls="details-git-github-and-galaxy-core" aria-expanded="true"><i class="fas fa-info-circle" aria-hidden="true" ></i> <span>Details: Git, Github, and Galaxy Core</span><span class="fold-unfold fa fa-minus-square"></span></button></div>   <p>For a lot more information about Git branching and managing a repository on Github,  see the <a href="/training-material/topics/contributing/tutorials/github-command-line-contribution/tutorial.html">Contributing with GitHub via command-line</a> tutorial.</p>   <p>The <a href="/training-material/topics/dev/tutorials/architecture/slides.html">Galaxy Core Architecture slides</a> have a lot of important Galaxy core-related information related to branches,  project management, and contributing to Galaxy - under the Project Management section of the slides.</p> </blockquote> </blockquote>
<p><!--END_SNIPPET--></p>

<blockquote class="notranslate hands_on">
  <div class="box-title hands-on-title" id="hands-on-setup-your-local-galaxy-instance"><i class="fas fa-pencil-alt" aria-hidden="true" ></i> Hands-on: Setup your local Galaxy instance</div>

  <ol>
    <li>Use GitHub UI to fork Galaxy’s repository at <code class="language-plaintext highlighter-rouge">galaxyproject/galaxy</code>.</li>
    <li>
      <p>Clone your forked repository to a local path, further referred to as <code class="language-plaintext highlighter-rouge">GALAXY_ROOT</code> and <code class="language-plaintext highlighter-rouge">cd</code> into <code class="language-plaintext highlighter-rouge">GALAXY_ROOT</code>. Note that we specify the tutorial branch with the <code class="language-plaintext highlighter-rouge">-b</code> option:</p>

      <blockquote class="code-in">
        <div class="box-title code-in-title" id="code-in-bash"><i class="far fa-keyboard" aria-hidden="true" ></i> Input: Bash</div>
        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git clone https://github.com/&lt;your-username&gt;/galaxy GALAXY_ROOT
<span class="nb">cd </span>GALAXY_ROOT
</code></pre></div>        </div>
      </blockquote>
    </li>
    <li>
      <p>Before we can use Galaxy, we need to create a virtual environment and install the required dependencies. This is generally done with the <code class="language-plaintext highlighter-rouge">common_startup.sh</code> script:</p>

      <blockquote class="code-in">
        <div class="box-title code-in-title" id="code-in-bash-1"><i class="far fa-keyboard" aria-hidden="true" ></i> Input: Bash</div>
        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bash scripts/common_startup.sh <span class="nt">--dev-wheels</span>
</code></pre></div>        </div>
      </blockquote>

      <p>Make sure your Python version is at least 3.7 (you can check your Python version with <code class="language-plaintext highlighter-rouge">python --version</code>). If your system uses an older version, you may specify an alternative Python interpreter using the <code class="language-plaintext highlighter-rouge">GALAXY_PYTHON</code> environment variable (<code class="language-plaintext highlighter-rouge">GALAXY_PYTHON=/path/to/alt/python bash scripts/common_startup.sh --dev-wheels</code>).</p>
    </li>
    <li>
      <p>Activate your new virtual environment:</p>

      <blockquote class="code-in">
        <div class="box-title code-in-title" id="code-in-bash-2"><i class="far fa-keyboard" aria-hidden="true" ></i> Input: Bash</div>
        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">.</span> .venv/bin/activate
</code></pre></div>        </div>
      </blockquote>

      <p>Once activated, you’ll see the name of the virtual environment prepended to your shell prompt: <code class="language-plaintext highlighter-rouge">(.venv)$</code>.</p>
    </li>
    <li>
      <p>Finally, let’s create a new branch for your edits:</p>

      <blockquote class="code-in">
        <div class="box-title code-in-title" id="code-in-bash-3"><i class="far fa-keyboard" aria-hidden="true" ></i> Input: Bash</div>
        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git checkout <span class="nt">-b</span> my-training
</code></pre></div>        </div>
      </blockquote>

      <p>Now when you run <code class="language-plaintext highlighter-rouge">git branch</code> you’ll see that your new branch is activated:</p>

      <blockquote class="code-2col">
        <blockquote class="code-in">
          <div class="box-title code-in-title" id="code-in-bash-4"><i class="far fa-keyboard" aria-hidden="true" ></i> Input: Bash</div>
          <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git branch
</code></pre></div>          </div>
        </blockquote>

        <blockquote class="code-out">
          <div class="box-title code-out-title" id="code-out"><i class="fas fa-laptop-code" aria-hidden="true" ></i> Output</div>
          <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  training
<span class="k">*</span> my-training
</code></pre></div>          </div>
        </blockquote>
      </blockquote>

      <p>Note: <code class="language-plaintext highlighter-rouge">my-training</code> is just an example; you can call your new branch anything you like.</p>
    </li>
  </ol>
</blockquote>

<h1 id="api-tests">API tests</h1>

<p>We turn to API tests when we need to test some feature that requires a running Galaxy instance and, in many cases, the Galaxy database. These tests use the Galaxy API to drive the test.</p>

<p>In a way, these tests may be the simplest to write. While the required setup of an API test is, certainly, more involved than that of a basic unit test, Galaxy’s testing infrastructure takes care of all the heavy lifting, such as creating a test database, configuring and starting up a Galaxy instance, and tearing down the setup upon test completion. The testing infrastructure also provides a wealth of convenient abstractions that simplify pre-populating the database with the necessary state for each test, interacting with the API, as well as expressing expectations about the outcomes of a test. Thus, writing an API test boils down to calling the appropriate API endpoint and verifying the result.</p>

<p>We are not developing any new features in this tutorial (check out the <a href="/training-material/topics/dev/tutorials/core-contributing/tutorial.html">Contributing a New Feature to Galaxy Core</a> tutorial). However, we need to exercise the API, so we will be using existing Galaxy functionality as our testing context. Much of that functionality is already covered by tests. Existing tests may include advanced concepts or details on Galaxy’s internals that are beyond the scope of a tutorial on testing, so they are not optimal as examples for training. Therefore, the approach we will use is as follows:</p>

<ol>
  <li>Pick a controller <code class="language-plaintext highlighter-rouge">foo</code> in the <code class="language-plaintext highlighter-rouge">lib/galaxy/webapps/galaxy/api</code> directory.</li>
  <li>Pick one of the existing endpoints from the selected controller. If the endpoint represents a <code class="language-plaintext highlighter-rouge">GET</code> request (e.g. <code class="language-plaintext highlighter-rouge">@router.get("/api/foos</code>), you may be able to view the results on a running instance at <code class="language-plaintext highlighter-rouge">[host]/api/foos</code></li>
  <li>Write a new test to verify the specified functionality.</li>
</ol>

<p>Ideally, we’d like to follow the process of test-driven development: write a test, run it and watch it fail, implement the functionality under test, rerun the test to verify it passes. Although we are not developing any new functionality here, we still would like to verify that the test we have written is a legitimate test of the correctness of the underlying code. In other words, we want it to be deterministic, and fail if the input is invalid. For this, you may want to intentionally break the test on its first run to verify it doesn’t pass under any condition. Then fix the test and rerun. Although this doesn’t guarantee correctness, it helps prevent obvious errors in the testing code (such as forgetting to edit the endpoint after cutting and pasting code from a similar test function.</p>

<h2 id="basic-api-test">Basic API test</h2>

<p>Let’s start by writing a basic test for a very simple API endpoint: <code class="language-plaintext highlighter-rouge">api/version</code>. The controller for this endpoint is located at <code class="language-plaintext highlighter-rouge">lib/galaxy/webapps/galaxy/api/configuration.py</code>. You can check the format of the data at <code class="language-plaintext highlighter-rouge">https://usegalaxy.org/api/version</code>.</p>

<p>First, you need to create a new file at <code class="language-plaintext highlighter-rouge">lib/galaxy_test/api/test_mytutorial.py</code>. For simplicity, we’ll place all new tests in this module. Next, add a class definition for <code class="language-plaintext highlighter-rouge">TestMyTutorialApiTestCase</code> that should be a subclass of <code class="language-plaintext highlighter-rouge">ApiTestCase</code>. Then add a test method, <code class="language-plaintext highlighter-rouge">test_version_is_current</code>, where you will (1) call the API via the <code class="language-plaintext highlighter-rouge">_get</code> method that returns a response object; and (2) verify that the response contains the “24.1” version number (assuming you have cloned the “dev” branch; otherwise your version may be different).</p>

<p>If your test fails, one way to debug it is to insert a <code class="language-plaintext highlighter-rouge">breakpoint()</code> statement into the body of the test (right after the call to <code class="language-plaintext highlighter-rouge">_get</code> would be a logical spot), and then use <a href="https://docs.python.org/3/library/pdb.html">pdb</a>, Python’s interactive debugger, to explore the response at runtime with the test paused (see <a href="/training-material/topics/dev/tutorials/debugging/tutorial.html">Debugging Galaxy</a> for more details on using pdb to debug Galaxy).</p>

<blockquote class="solution">
  <div class="box-title solution-title" id="solution"><button class="gtn-boxify-button solution" type="button" aria-controls="solution" aria-expanded="true"><i class="far fa-eye" aria-hidden="true" ></i> <span>Solution</span><span class="fold-unfold fa fa-minus-square"></span></button></div>

  <p>Example of a basic API test.</p>

  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">._framework</span> <span class="kn">import</span> <span class="n">ApiTestCase</span>


<span class="k">class</span> <span class="nc">TestMyTutorialApiTestCase</span><span class="p">(</span><span class="n">ApiTestCase</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">test_version_is_current</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_get</span><span class="p">(</span><span class="sh">"</span><span class="s">version</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">response</span><span class="p">.</span><span class="nf">raise_for_status</span><span class="p">()</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">response</span><span class="p">.</span><span class="nf">json</span><span class="p">()</span>
        <span class="k">assert</span> <span class="n">data</span><span class="p">[</span><span class="sh">"</span><span class="s">version_major</span><span class="sh">"</span><span class="p">]</span> <span class="o">==</span> <span class="sh">"</span><span class="s">24.1</span><span class="sh">"</span>  <span class="c1"># Assuming you are on the "dev" branch
</span></code></pre></div>  </div>
</blockquote>

<p>You may notice that in the provided solution we also call <code class="language-plaintext highlighter-rouge">response.raise_for_status()</code>: this is a requests library function that verifies that the request was successful (of course, we can also explicitly check the status code). It is helpful to include this check, because otherwise, if an error is raised, the error message in the error log will be not as helpful. Try using a nonextistant endpoint and running the test with and without the <code class="language-plaintext highlighter-rouge">raise_for_status</code> call. Compare these error messages:</p>

<p>With the status check:</p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">requests.exceptions.HTTPError: 404 Client Error: Not Found for url: http://127.0.0.1:9584/api/versionx</code></li>
</ul>

<p>Without the status check:</p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">requests.exceptions.JSONDecodeError: Expecting value: line 1 column 1 (char 0)</code></li>
</ul>

<h2 id="test-creating-a-simple-object">Test creating a simple object</h2>

<p>Now let’s write an API test for adding a simple object. By “simple”, we mean that this object does not depend on any other objects, so, for example, we don’t need to provide a reference to a History or User object to create it. We will be creating a role, using the <code class="language-plaintext highlighter-rouge">api/roles</code> <code class="language-plaintext highlighter-rouge">POST</code> endpoint located at <code class="language-plaintext highlighter-rouge">lib/galaxy/webapps/galaxy/api/roles.py</code>.</p>

<p>To create a role, we need to call the <code class="language-plaintext highlighter-rouge">_post</code> method, passing it 4 arguments:</p>
<ul>
  <li>the string value of the endpoint</li>
  <li>the payload containing the data for the new Role object</li>
  <li>a boolean argument setting the format of the payload data: <code class="language-plaintext highlighter-rouge">json=True</code></li>
  <li>a boolean argument setting the test user’s admin status: <code class="language-plaintext highlighter-rouge">admin=True</code></li>
</ul>

<p>How do we know what data to include in the payload? Look at the method signature in the API:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>self, trans: ProvidesUserContext = DependsOnTrans, role_definition_model: RoleDefinitionModel = Body(...)
</code></pre></div></div>
<p><code class="language-plaintext highlighter-rouge">RoleDefinitionModel</code> is the Pydantic model that describes the structure of the data passed with this argument. Looking at its definition (check the import statement at the top of the file to find its location), we see the following:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">RoleDefinitionModel</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">RoleNameField</span>
    <span class="n">description</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">RoleDescriptionField</span>
    <span class="n">user_ids</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">EncodedDatabaseIdField</span><span class="p">]]</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="sh">"</span><span class="s">User IDs</span><span class="sh">"</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="p">[])</span>
    <span class="n">group_ids</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">EncodedDatabaseIdField</span><span class="p">]]</span> <span class="o">=</span> <span class="nc">Field</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="sh">"</span><span class="s">Group IDs</span><span class="sh">"</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="p">[])</span>
</code></pre></div></div>

<p>Thus, we need to provide a name and a description, both of which are string values (the other members are optional), formatted as JSON. (For more details on how the API works, see <a href="https://fastapi.tiangolo.com/tutorial/">FastAPI’s excellent documentation</a>.)</p>

<p>The response will return the Role object, so testing it is straightforward.</p>

<blockquote class="solution">
  <div class="box-title solution-title" id="solution-1"><button class="gtn-boxify-button solution" type="button" aria-controls="solution-1" aria-expanded="true"><i class="far fa-eye" aria-hidden="true" ></i> <span>Solution</span><span class="fold-unfold fa fa-minus-square"></span></button></div>

  <p>API test for creating an object.</p>

  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">TestMyTutorialApiTestCase</span><span class="p">(</span><span class="n">ApiTestCase</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">test_create_role</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="c1"># prepare new role
</span>        <span class="n">name</span> <span class="o">=</span> <span class="sh">"</span><span class="s">cool role</span><span class="sh">"</span>
        <span class="n">description</span> <span class="o">=</span> <span class="sh">"</span><span class="s">description of this cool role</span><span class="sh">"</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="n">description</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="c1"># add new role and verify
</span>        <span class="n">response</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_post</span><span class="p">(</span><span class="sh">"</span><span class="s">roles</span><span class="sh">"</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="n">admin</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">response</span><span class="p">.</span><span class="nf">raise_for_status</span><span class="p">()</span>
        <span class="n">role</span> <span class="o">=</span> <span class="n">response</span><span class="p">.</span><span class="nf">json</span><span class="p">()</span>
        <span class="k">assert</span> <span class="n">role</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">]</span> <span class="o">==</span> <span class="n">name</span>
        <span class="k">assert</span> <span class="n">role</span><span class="p">[</span><span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">]</span> <span class="o">==</span> <span class="n">description</span>
</code></pre></div>  </div>
</blockquote>

<h2 id="a-better-test-for-creating-a-simple-object">A better test for creating a simple object</h2>

<p>Can we do better? We can verify that the new object has been added by using another endpoint to retrieve that object from the database. Here’s a first take:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">test_create_role_WRONG</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
    <span class="n">ROLE_COUNT</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="c1"># verify no roles except one built-in role for test user
</span>    <span class="n">response</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_get</span><span class="p">(</span><span class="sh">"</span><span class="s">roles</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">response</span><span class="p">.</span><span class="nf">raise_for_status</span><span class="p">()</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">response</span><span class="p">.</span><span class="nf">json</span><span class="p">()</span>
    <span class="k">assert</span> <span class="nf">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">==</span> <span class="n">ROLE_COUNT</span>

    <span class="c1"># create role
</span>    <span class="n">name</span> <span class="o">=</span> <span class="sh">'</span><span class="s">my cool name</span><span class="sh">'</span>
    <span class="n">description</span> <span class="o">=</span> <span class="sh">'</span><span class="s">description of this cool role</span><span class="sh">'</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="n">description</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_post</span><span class="p">(</span><span class="sh">"</span><span class="s">roles</span><span class="sh">"</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="n">admin</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">response</span><span class="p">.</span><span class="nf">raise_for_status</span><span class="p">()</span>
    <span class="n">role</span> <span class="o">=</span> <span class="n">response</span><span class="p">.</span><span class="nf">json</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">role</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">]</span> <span class="o">==</span> <span class="n">name</span>
    <span class="k">assert</span> <span class="n">role</span><span class="p">[</span><span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">]</span> <span class="o">==</span> <span class="n">description</span>

    <span class="c1"># verify role has been added
</span>    <span class="n">response</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_get</span><span class="p">(</span><span class="sh">"</span><span class="s">roles</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">response</span><span class="p">.</span><span class="nf">raise_for_status</span><span class="p">()</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">response</span><span class="p">.</span><span class="nf">json</span><span class="p">()</span>
    <span class="k">assert</span> <span class="nf">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">==</span> <span class="n">ROLE_COUNT</span> <span class="o">+</span> <span class="mi">1</span>
</code></pre></div></div>

<p>Everything is straightforward: we verify that there is only n=1 role currently present (a built-in for the test user), we add the role, then retrieve all roles and verify that the new total is n + 1. Unfortunately, <strong><em>this is the wrong approach</em></strong>. Try running this together with the previous version of the test - you’ll get an assertion error: there’s an extra role in the database!</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>FAILED lib/galaxy_test/api/test_mytutorial.py::TestMyTutorialApiTestCase::test_create_role_WRONG - AssertionError: assert 2 == 1
</code></pre></div></div>

<p>The reason for that is that we are using the same database for both tests, so whatever artifacts are created in one test will affect the following test if we make any kind of assumptions about the state of the database.</p>

<p>How do we rewrite this test without making assumptions about database state? We can’t retrieve the roles and use their initial quantity as our baseline: that’s a perfect recipe for a race condition (if some other test creates a role after we have counted the existing roles but before we have created our new role, our test will fail). Instead, we can use the role’s name (which is unique across all roles) to verify that our object has been added.</p>

<p>We could generate our own unique name, but we can also simply use an existing method used across Galaxy’s tests: <code class="language-plaintext highlighter-rouge">get_random_name()</code> (we need to add an import and override the <code class="language-plaintext highlighter-rouge">setUp</code> method for that: see the solution code). Now we have a test we can safely run together with our old test (or with any number of other tests that create role objects).</p>

<blockquote class="solution">
  <div class="box-title solution-title" id="solution-2"><button class="gtn-boxify-button solution" type="button" aria-controls="solution-2" aria-expanded="true"><i class="far fa-eye" aria-hidden="true" ></i> <span>Solution</span><span class="fold-unfold fa fa-minus-square"></span></button></div>

  <p>Alternative test for creating an object. Note the <code class="language-plaintext highlighter-rouge">setUp</code> method and the new import.</p>

  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">galaxy_test.base.populators</span> <span class="kn">import</span> <span class="n">DatasetPopulator</span>
<span class="kn">from</span> <span class="n">._framework</span> <span class="kn">import</span> <span class="n">ApiTestCase</span>


<span class="k">class</span> <span class="nc">TestMyTutorialApiTestCase</span><span class="p">(</span><span class="n">ApiTestCase</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="nf">super</span><span class="p">().</span><span class="nf">setUp</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">dataset_populator</span> <span class="o">=</span> <span class="nc">DatasetPopulator</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">galaxy_interactor</span><span class="p">)</span>

<span class="c1"># [code omitted]
</span>
    <span class="k">def</span> <span class="nf">test_create_role2</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="c1"># prepare new role
</span>        <span class="n">name</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">dataset_populator</span><span class="p">.</span><span class="nf">get_random_name</span><span class="p">()</span>
        <span class="n">description</span> <span class="o">=</span> <span class="sh">'</span><span class="s">description of this cool role</span><span class="sh">'</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="n">description</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="c1"># verify new role does not exist
</span>        <span class="n">response</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_get</span><span class="p">(</span><span class="sh">"</span><span class="s">roles</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">response</span><span class="p">.</span><span class="nf">raise_for_status</span><span class="p">()</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">response</span><span class="p">.</span><span class="nf">json</span><span class="p">()</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="nf">any</span><span class="p">(</span><span class="n">role</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">]</span> <span class="o">==</span> <span class="n">name</span> <span class="k">for</span> <span class="n">role</span> <span class="ow">in</span> <span class="n">data</span><span class="p">)</span>

        <span class="c1"># add new role
</span>        <span class="n">response</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_post</span><span class="p">(</span><span class="sh">"</span><span class="s">roles</span><span class="sh">"</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="n">admin</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">response</span><span class="p">.</span><span class="nf">raise_for_status</span><span class="p">()</span>
        <span class="n">role</span> <span class="o">=</span> <span class="n">response</span><span class="p">.</span><span class="nf">json</span><span class="p">()</span>
        <span class="k">assert</span> <span class="n">role</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">]</span> <span class="o">==</span> <span class="n">name</span>
        <span class="k">assert</span> <span class="n">role</span><span class="p">[</span><span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">]</span> <span class="o">==</span> <span class="n">description</span>

        <span class="c1"># verify role has been added
</span>        <span class="n">response</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_get</span><span class="p">(</span><span class="sh">"</span><span class="s">roles</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">response</span><span class="p">.</span><span class="nf">raise_for_status</span><span class="p">()</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">response</span><span class="p">.</span><span class="nf">json</span><span class="p">()</span>
        <span class="k">assert</span> <span class="nf">any</span><span class="p">(</span><span class="n">role</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">]</span> <span class="o">==</span> <span class="n">name</span> <span class="k">for</span> <span class="n">role</span> <span class="ow">in</span> <span class="n">data</span><span class="p">)</span>
</code></pre></div>  </div>
</blockquote>

<p>Can’t we destroy and create or re-populate the database for each test? We can, and there is infrastructure for that in <code class="language-plaintext highlighter-rouge">test/unit/data/model/db</code>. However, setting up and initializing the database is an expensive operation, which will be noticeable for a single test; Galaxy has hundreds of tests that rely on the database, so providing a fresh copy of the database for each test function is infeasible.</p>

<h2 id="use-galaxys-populators-for-setting-up-database-state">Use Galaxy’s populators for setting up database state</h2>

<p>As our last example, we’ll look at how to take advantage of some of the many abstractions provided by Galaxy’s testing infrastructure. Supposing you’d like to test the “datasets-filter-by-history” functionality exposed via the <code class="language-plaintext highlighter-rouge">api/datasets</code> endpoint (see <code class="language-plaintext highlighter-rouge">lib/galaxy/webapps/galaxy/api/datasets.py</code>). The test design is straightforward:</p>
<ul>
  <li>Create 2 history objects h1 and h2.</li>
  <li>Create n and m datasets associated with h1 and h2 respectively.</li>
  <li>Retrieve datasets filtering by h1. Verify there are n results.</li>
  <li>Retrieve datasets filtering by h2. Verify there are m results.</li>
</ul>

<p>The question is, how do we create the datasets and the histories (and all their respective dependencies?). One way would be to use the API for each such object. However, that would result in a barely readable test function which would mostly consist of setup code. Instead, we want our tests to be simple and understandable at a glance, and contain as little infrastructure code as possible. Enter dataset populators! This is one of many abstractions available to you that make it much easier to write tests that otherwise would have required nontrivial setup.</p>

<blockquote class="solution">
  <div class="box-title solution-title" id="solution-3"><button class="gtn-boxify-button solution" type="button" aria-controls="solution-3" aria-expanded="true"><i class="far fa-eye" aria-hidden="true" ></i> <span>Solution</span><span class="fold-unfold fa fa-minus-square"></span></button></div>

  <p>Using populators.</p>

  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">def</span> <span class="nf">test_search_dataset_by_history</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">history1_id</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">dataset_populator</span><span class="p">.</span><span class="nf">new_history</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">history2_id</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">dataset_populator</span><span class="p">.</span><span class="nf">new_history</span><span class="p">()</span>

        <span class="n">history1_datasets</span><span class="p">,</span> <span class="n">history2_datasets</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">history1_datasets</span><span class="p">):</span>
            <span class="n">self</span><span class="p">.</span><span class="n">dataset_populator</span><span class="p">.</span><span class="nf">new_dataset</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">history1_id</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">history2_datasets</span><span class="p">):</span>
            <span class="n">self</span><span class="p">.</span><span class="n">dataset_populator</span><span class="p">.</span><span class="nf">new_dataset</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">history2_id</span><span class="p">)</span>

        <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span> <span class="sh">"</span><span class="s">history_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">history1_id</span><span class="p">,</span> <span class="p">}</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_get</span><span class="p">(</span><span class="sh">"</span><span class="s">datasets</span><span class="sh">"</span><span class="p">,</span> <span class="n">payload</span><span class="p">).</span><span class="nf">json</span><span class="p">()</span>
        <span class="k">assert</span> <span class="nf">len</span><span class="p">(</span><span class="n">response</span><span class="p">)</span> <span class="o">==</span> <span class="n">history1_datasets</span>

        <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span> <span class="sh">"</span><span class="s">history_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">history2_id</span><span class="p">,</span> <span class="p">}</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_get</span><span class="p">(</span><span class="sh">"</span><span class="s">datasets</span><span class="sh">"</span><span class="p">,</span> <span class="n">payload</span><span class="p">).</span><span class="nf">json</span><span class="p">()</span>
        <span class="k">assert</span> <span class="nf">len</span><span class="p">(</span><span class="n">response</span><span class="p">)</span> <span class="o">==</span> <span class="n">history2_datasets</span>
</code></pre></div>  </div>
</blockquote>

<p>Populators are used extensively throughout API tests as well as integration and Selenium tests to both setup database state, as well as access information from the Galaxy server. For more details, see the populators module at <code class="language-plaintext highlighter-rouge">lib/galaxy_test/base/populators.py</code>.</p>

<p>And we are done! Here’s the final version of the code we added to this testing module.</p>

<blockquote class="solution">
  <div class="box-title solution-title" id="solution-4"><button class="gtn-boxify-button solution" type="button" aria-controls="solution-4" aria-expanded="true"><i class="far fa-eye" aria-hidden="true" ></i> <span>Solution</span><span class="fold-unfold fa fa-minus-square"></span></button></div>

  <p>Final code.</p>

  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">galaxy_test.base.populators</span> <span class="kn">import</span> <span class="n">DatasetPopulator</span>
<span class="kn">from</span> <span class="n">._framework</span> <span class="kn">import</span> <span class="n">ApiTestCase</span>


<span class="k">class</span> <span class="nc">TestMyTutorialApiTestCase</span><span class="p">(</span><span class="n">ApiTestCase</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="nf">super</span><span class="p">().</span><span class="nf">setUp</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">dataset_populator</span> <span class="o">=</span> <span class="nc">DatasetPopulator</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">galaxy_interactor</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_version_is_current</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_get</span><span class="p">(</span><span class="sh">"</span><span class="s">version</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">response</span><span class="p">.</span><span class="nf">raise_for_status</span><span class="p">()</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">response</span><span class="p">.</span><span class="nf">json</span><span class="p">()</span>
        <span class="k">assert</span> <span class="n">data</span><span class="p">[</span><span class="sh">"</span><span class="s">version_major</span><span class="sh">"</span><span class="p">]</span> <span class="o">==</span> <span class="sh">"</span><span class="s">24.1</span><span class="sh">"</span>

    <span class="k">def</span> <span class="nf">test_create_role</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="c1"># prepare new role
</span>        <span class="n">name</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">dataset_populator</span><span class="p">.</span><span class="nf">get_random_name</span><span class="p">()</span>
        <span class="n">description</span> <span class="o">=</span> <span class="sh">'</span><span class="s">description of this cool role</span><span class="sh">'</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="n">description</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="c1"># add new role and verify
</span>        <span class="n">response</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_post</span><span class="p">(</span><span class="sh">"</span><span class="s">roles</span><span class="sh">"</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="n">admin</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">response</span><span class="p">.</span><span class="nf">raise_for_status</span><span class="p">()</span>
        <span class="n">role</span> <span class="o">=</span> <span class="n">response</span><span class="p">.</span><span class="nf">json</span><span class="p">()</span>
        <span class="k">assert</span> <span class="n">role</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">]</span> <span class="o">==</span> <span class="n">name</span>
        <span class="k">assert</span> <span class="n">role</span><span class="p">[</span><span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">]</span> <span class="o">==</span> <span class="n">description</span>

    <span class="k">def</span> <span class="nf">test_create_role2</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="c1"># prepare new role
</span>        <span class="n">name</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">dataset_populator</span><span class="p">.</span><span class="nf">get_random_name</span><span class="p">()</span>
        <span class="n">description</span> <span class="o">=</span> <span class="sh">'</span><span class="s">description of this cool role</span><span class="sh">'</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">:</span> <span class="n">description</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="c1"># verify new role does not exist
</span>        <span class="n">response</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_get</span><span class="p">(</span><span class="sh">"</span><span class="s">roles</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">response</span><span class="p">.</span><span class="nf">raise_for_status</span><span class="p">()</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">response</span><span class="p">.</span><span class="nf">json</span><span class="p">()</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="nf">any</span><span class="p">(</span><span class="n">role</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">]</span> <span class="o">==</span> <span class="n">name</span> <span class="k">for</span> <span class="n">role</span> <span class="ow">in</span> <span class="n">data</span><span class="p">)</span>

        <span class="c1"># add new role
</span>        <span class="n">response</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_post</span><span class="p">(</span><span class="sh">"</span><span class="s">roles</span><span class="sh">"</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="n">admin</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">response</span><span class="p">.</span><span class="nf">raise_for_status</span><span class="p">()</span>
        <span class="n">role</span> <span class="o">=</span> <span class="n">response</span><span class="p">.</span><span class="nf">json</span><span class="p">()</span>
        <span class="k">assert</span> <span class="n">role</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">]</span> <span class="o">==</span> <span class="n">name</span>
        <span class="k">assert</span> <span class="n">role</span><span class="p">[</span><span class="sh">"</span><span class="s">description</span><span class="sh">"</span><span class="p">]</span> <span class="o">==</span> <span class="n">description</span>

        <span class="c1"># verify role has been added
</span>        <span class="n">response</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_get</span><span class="p">(</span><span class="sh">"</span><span class="s">roles</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">response</span><span class="p">.</span><span class="nf">raise_for_status</span><span class="p">()</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">response</span><span class="p">.</span><span class="nf">json</span><span class="p">()</span>
        <span class="k">assert</span> <span class="nf">any</span><span class="p">(</span><span class="n">role</span><span class="p">[</span><span class="sh">"</span><span class="s">name</span><span class="sh">"</span><span class="p">]</span> <span class="o">==</span> <span class="n">name</span> <span class="k">for</span> <span class="n">role</span> <span class="ow">in</span> <span class="n">data</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_search_dataset_by_history</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">history1_id</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">dataset_populator</span><span class="p">.</span><span class="nf">new_history</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">history2_id</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">dataset_populator</span><span class="p">.</span><span class="nf">new_history</span><span class="p">()</span>

        <span class="n">history1_datasets</span><span class="p">,</span> <span class="n">history2_datasets</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">history1_datasets</span><span class="p">):</span>
            <span class="n">self</span><span class="p">.</span><span class="n">dataset_populator</span><span class="p">.</span><span class="nf">new_dataset</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">history1_id</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">history2_datasets</span><span class="p">):</span>
            <span class="n">self</span><span class="p">.</span><span class="n">dataset_populator</span><span class="p">.</span><span class="nf">new_dataset</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">history2_id</span><span class="p">)</span>

        <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span> <span class="sh">"</span><span class="s">history_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">history1_id</span><span class="p">,</span> <span class="p">}</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_get</span><span class="p">(</span><span class="sh">"</span><span class="s">datasets</span><span class="sh">"</span><span class="p">,</span> <span class="n">payload</span><span class="p">).</span><span class="nf">json</span><span class="p">()</span>
        <span class="k">assert</span> <span class="nf">len</span><span class="p">(</span><span class="n">response</span><span class="p">)</span> <span class="o">==</span> <span class="n">history1_datasets</span>

        <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span> <span class="sh">"</span><span class="s">history_id</span><span class="sh">"</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">history2_id</span><span class="p">,</span> <span class="p">}</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_get</span><span class="p">(</span><span class="sh">"</span><span class="s">datasets</span><span class="sh">"</span><span class="p">,</span> <span class="n">payload</span><span class="p">).</span><span class="nf">json</span><span class="p">()</span>
        <span class="k">assert</span> <span class="nf">len</span><span class="p">(</span><span class="n">response</span><span class="p">)</span> <span class="o">==</span> <span class="n">history2_datasets</span>
</code></pre></div>  </div>
</blockquote>

<h1 id="unit-tests">Unit tests</h1>

<p>Unit tests are best suited for testing well-defined, isolated functionality and, with rare exceptions, should not require a running Galaxy instance, a database, or any other external infrastructure. Unit tests are located in the <code class="language-plaintext highlighter-rouge">test/unit</code> directory.</p>

<p>There are numerous unit tests in the Galaxy code base. However, existing unit tests do not cover the entire code base and do not verify all the relevant logic (so there is plenty of space for improvement, and new contributions are always welcome!) In this tutorial, we will be writing unit tests for such code.</p>

<h2 id="testing-simple-functions">Testing simple functions</h2>

<p>We’ll start by looking at the module <code class="language-plaintext highlighter-rouge">lib/galaxy/util/bytesize.py</code>. This module is not covered by unit tests. There are 2 obvious targets for unit tests: the <code class="language-plaintext highlighter-rouge">parse bytesize</code> function and the <code class="language-plaintext highlighter-rouge">to_unit</code> method of the <code class="language-plaintext highlighter-rouge">ByteSize</code> class. Our goal is to come up with a reasonable selection of unit tests that verify essential aspects of this functionality.</p>

<p>We’ll start with the <code class="language-plaintext highlighter-rouge">parse_bytesize</code> function. Look at the code of the function and identify the logic that, you think, needs testing. Essentially, you want to ensure that any combination of valid input produces the expected output. Next, add a few tests. (see <a href="https://docs.pytest.org/en/8.2.x/how-to/assert.html">https://docs.pytest.org/en/8.2.x/how-to/assert.html</a> for examples)</p>

<blockquote class="solution">
  <div class="box-title solution-title" id="solution-5"><button class="gtn-boxify-button solution" type="button" aria-controls="solution-5" aria-expanded="true"><i class="far fa-eye" aria-hidden="true" ></i> <span>Solution</span><span class="fold-unfold fa fa-minus-square"></span></button></div>

  <p>Example of tests for the <code class="language-plaintext highlighter-rouge">parse_bytesize</code> function:</p>

  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">galaxy.util.bytesize</span> <span class="kn">import</span> <span class="n">ByteSize</span><span class="p">,</span> <span class="n">parse_bytesize</span>


<span class="k">def</span> <span class="nf">test_parse_bytesize_int_or_float</span><span class="p">():</span>
    <span class="k">assert</span> <span class="nf">parse_bytesize</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span> <span class="o">==</span> <span class="mi">42</span>
    <span class="k">assert</span> <span class="nf">parse_bytesize</span><span class="p">(</span><span class="mf">42.5</span><span class="p">)</span> <span class="o">==</span> <span class="mf">42.5</span>


<span class="k">def</span> <span class="nf">test_parse_bytesize_str_no_suffix</span><span class="p">():</span>
    <span class="k">assert</span> <span class="nf">parse_bytesize</span><span class="p">(</span><span class="sh">'</span><span class="s">42</span><span class="sh">'</span><span class="p">)</span> <span class="o">==</span> <span class="mi">42</span>
    <span class="k">assert</span> <span class="nf">parse_bytesize</span><span class="p">(</span><span class="sh">'</span><span class="s">42.5</span><span class="sh">'</span><span class="p">)</span> <span class="o">==</span> <span class="mf">42.5</span>


<span class="k">def</span> <span class="nf">test_parse_bytesize_str_suffix</span><span class="p">():</span>
    <span class="k">assert</span> <span class="nf">parse_bytesize</span><span class="p">(</span><span class="sh">'</span><span class="s">10K</span><span class="sh">'</span><span class="p">)</span> <span class="o">==</span> <span class="mi">10000</span>
    <span class="k">assert</span> <span class="nf">parse_bytesize</span><span class="p">(</span><span class="sh">'</span><span class="s">10 KI</span><span class="sh">'</span><span class="p">)</span> <span class="o">==</span> <span class="mi">10240</span>
</code></pre></div>  </div>
</blockquote>

<p>Run the tests to verify they pass. You can use the <code class="language-plaintext highlighter-rouge">pytest</code> command:</p>

<blockquote class="code-in">
  <div class="box-title code-in-title" id="code-in-bash-5"><i class="far fa-keyboard" aria-hidden="true" ></i> Input: Bash</div>
  <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pytest <span class="nb">test</span>/unit/util/test_bytesize.py
</code></pre></div>  </div>
</blockquote>

<h2 id="verifying-that-an-error-is-raised">Verifying that an error is raised</h2>

<p>Now let’s add a test that verifies that invalid input raises an error, as expected.</p>

<blockquote class="solution">
  <div class="box-title solution-title" id="solution-6"><button class="gtn-boxify-button solution" type="button" aria-controls="solution-6" aria-expanded="true"><i class="far fa-eye" aria-hidden="true" ></i> <span>Solution</span><span class="fold-unfold fa fa-minus-square"></span></button></div>

  <p>Example of a test verifying a raised exception. Make sure you add the <code class="language-plaintext highlighter-rouge">pytest</code> import.</p>

  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">pytest</span>

<span class="c1"># [code omitted]
</span>
<span class="k">def</span> <span class="nf">test_parse_bytesize_str_invalid</span><span class="p">():</span>
    <span class="k">with</span> <span class="n">pytest</span><span class="p">.</span><span class="nf">raises</span><span class="p">(</span><span class="nb">ValueError</span><span class="p">):</span>
        <span class="nf">parse_bytesize</span><span class="p">(</span><span class="sh">'</span><span class="s">10 invalid-suffix</span><span class="sh">'</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">pytest</span><span class="p">.</span><span class="nf">raises</span><span class="p">(</span><span class="nb">ValueError</span><span class="p">):</span>
        <span class="nf">parse_bytesize</span><span class="p">(</span><span class="sh">'</span><span class="s">invalid-value</span><span class="sh">'</span><span class="p">)</span>
</code></pre></div>  </div>
</blockquote>

<p>Run the tests to verify they pass.</p>

<h2 id="using-fixtures-to-reduce-code-duplication">Using fixtures to reduce code duplication</h2>

<p>Let’s move on to the <code class="language-plaintext highlighter-rouge">to_unit</code> method of the <code class="language-plaintext highlighter-rouge">ByteSize</code>class. Just like you did for the previous function, add a few tests that verify that valid input produces expected output, and invalid input raises an error.</p>

<blockquote class="solution">
  <div class="box-title solution-title" id="solution-7"><button class="gtn-boxify-button solution" type="button" aria-controls="solution-7" aria-expanded="true"><i class="far fa-eye" aria-hidden="true" ></i> <span>Solution</span><span class="fold-unfold fa fa-minus-square"></span></button></div>

  <p>Example of tests for the <code class="language-plaintext highlighter-rouge">ByteSize.to_unit</code> method:</p>

  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">test_bytesize_to_unit</span><span class="p">():</span>
    <span class="n">bytesize</span> <span class="o">=</span> <span class="nc">ByteSize</span><span class="p">(</span><span class="mi">1_000_000_000_000_000</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">bytesize</span><span class="p">.</span><span class="nf">to_unit</span><span class="p">(</span><span class="sh">'</span><span class="s">k</span><span class="sh">'</span><span class="p">)</span> <span class="o">==</span> <span class="sh">'</span><span class="s">1000000000000K</span><span class="sh">'</span>
    <span class="k">assert</span> <span class="n">bytesize</span><span class="p">.</span><span class="nf">to_unit</span><span class="p">(</span><span class="sh">'</span><span class="s">m</span><span class="sh">'</span><span class="p">)</span> <span class="o">==</span> <span class="sh">'</span><span class="s">1000000000M</span><span class="sh">'</span>
    <span class="k">assert</span> <span class="n">bytesize</span><span class="p">.</span><span class="nf">to_unit</span><span class="p">(</span><span class="sh">'</span><span class="s">g</span><span class="sh">'</span><span class="p">)</span> <span class="o">==</span> <span class="sh">'</span><span class="s">1000000G</span><span class="sh">'</span>
    <span class="k">assert</span> <span class="n">bytesize</span><span class="p">.</span><span class="nf">to_unit</span><span class="p">(</span><span class="sh">'</span><span class="s">t</span><span class="sh">'</span><span class="p">)</span> <span class="o">==</span> <span class="sh">'</span><span class="s">1000T</span><span class="sh">'</span>
    <span class="k">assert</span> <span class="n">bytesize</span><span class="p">.</span><span class="nf">to_unit</span><span class="p">(</span><span class="sh">'</span><span class="s">p</span><span class="sh">'</span><span class="p">)</span> <span class="o">==</span> <span class="sh">'</span><span class="s">1P</span><span class="sh">'</span>
    <span class="k">assert</span> <span class="n">bytesize</span><span class="p">.</span><span class="nf">to_unit</span><span class="p">(</span><span class="sh">'</span><span class="s">e</span><span class="sh">'</span><span class="p">)</span> <span class="o">==</span> <span class="sh">'</span><span class="s">0E</span><span class="sh">'</span>

    <span class="k">assert</span> <span class="n">bytesize</span><span class="p">.</span><span class="nf">to_unit</span><span class="p">(</span><span class="sh">'</span><span class="s">ki</span><span class="sh">'</span><span class="p">)</span> <span class="o">==</span> <span class="sh">'</span><span class="s">976562500000KI</span><span class="sh">'</span>
    <span class="k">assert</span> <span class="n">bytesize</span><span class="p">.</span><span class="nf">to_unit</span><span class="p">(</span><span class="sh">'</span><span class="s">mi</span><span class="sh">'</span><span class="p">)</span> <span class="o">==</span> <span class="sh">'</span><span class="s">953674316MI</span><span class="sh">'</span>
    <span class="k">assert</span> <span class="n">bytesize</span><span class="p">.</span><span class="nf">to_unit</span><span class="p">(</span><span class="sh">'</span><span class="s">gi</span><span class="sh">'</span><span class="p">)</span> <span class="o">==</span> <span class="sh">'</span><span class="s">931322GI</span><span class="sh">'</span>
    <span class="k">assert</span> <span class="n">bytesize</span><span class="p">.</span><span class="nf">to_unit</span><span class="p">(</span><span class="sh">'</span><span class="s">ti</span><span class="sh">'</span><span class="p">)</span> <span class="o">==</span> <span class="sh">'</span><span class="s">909TI</span><span class="sh">'</span>
    <span class="k">assert</span> <span class="n">bytesize</span><span class="p">.</span><span class="nf">to_unit</span><span class="p">(</span><span class="sh">'</span><span class="s">pi</span><span class="sh">'</span><span class="p">)</span> <span class="o">==</span> <span class="sh">'</span><span class="s">0PI</span><span class="sh">'</span>
    <span class="k">assert</span> <span class="n">bytesize</span><span class="p">.</span><span class="nf">to_unit</span><span class="p">(</span><span class="sh">'</span><span class="s">ei</span><span class="sh">'</span><span class="p">)</span> <span class="o">==</span> <span class="sh">'</span><span class="s">0EI</span><span class="sh">'</span>

    <span class="k">assert</span> <span class="n">bytesize</span><span class="p">.</span><span class="nf">to_unit</span><span class="p">()</span> <span class="o">==</span> <span class="sh">'</span><span class="s">1000000000000000</span><span class="sh">'</span>  <span class="c1"># no unit
</span>    <span class="k">assert</span> <span class="n">bytesize</span><span class="p">.</span><span class="nf">to_unit</span><span class="p">(</span><span class="sh">'</span><span class="s">K</span><span class="sh">'</span><span class="p">)</span> <span class="o">==</span> <span class="sh">'</span><span class="s">1000000000000K</span><span class="sh">'</span>  <span class="c1"># uppercase unit
</span>

<span class="k">def</span> <span class="nf">test_bytesize_to_unit_as_str</span><span class="p">():</span>
    <span class="n">bytesize</span> <span class="o">=</span> <span class="nc">ByteSize</span><span class="p">(</span><span class="mi">1_000_000_000_000_000</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">bytesize</span><span class="p">.</span><span class="nf">to_unit</span><span class="p">(</span><span class="sh">'</span><span class="s">k</span><span class="sh">'</span><span class="p">,</span> <span class="n">as_string</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1000000000000</span>  <span class="c1"># not to_string
</span>

<span class="k">def</span> <span class="nf">test_bytesize_to_unit_invalid</span><span class="p">():</span>
    <span class="n">bytesize</span> <span class="o">=</span> <span class="nc">ByteSize</span><span class="p">(</span><span class="mi">1_000_000_000_000_000</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">pytest</span><span class="p">.</span><span class="nf">raises</span><span class="p">(</span><span class="nb">KeyError</span><span class="p">):</span>
        <span class="n">bytesize</span><span class="p">.</span><span class="nf">to_unit</span><span class="p">(</span><span class="sh">'</span><span class="s">invalid</span><span class="sh">'</span><span class="p">)</span>
</code></pre></div>  </div>
</blockquote>

<p>Run the tests to verify they pass.</p>

<p>Our tests are looking good for the most part, although code duplication is starting to creep in. It’s time to refactor!</p>

<p>Let’s start by factoring out the ByteSize object creation into a fixture (see <a href="https://docs.pytest.org/en/8.2.x/how-to/fixtures.html">https://docs.pytest.org/en/8.2.x/how-to/fixtures.html</a>). In this particular case moving this code into a fixture might be unnecessary, however, it provides an example of an approach that is very useful in more complex scenarios and is heavily used in Galaxy’s testing code.</p>

<blockquote class="solution">
  <div class="box-title solution-title" id="solution-8"><button class="gtn-boxify-button solution" type="button" aria-controls="solution-8" aria-expanded="true"><i class="far fa-eye" aria-hidden="true" ></i> <span>Solution</span><span class="fold-unfold fa fa-minus-square"></span></button></div>

  <p>Factoring out code into a fixture: we declare a fixture using pytest’s built-in <code class="language-plaintext highlighter-rouge">fixture</code> decorator,
and then simply pass it as an argument to our tests.</p>

  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@pytest.fixture</span>
<span class="k">def</span> <span class="nf">bytesize</span><span class="p">():</span>
    <span class="k">return</span> <span class="nc">ByteSize</span><span class="p">(</span><span class="mi">1_000_000_000_000_000</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">test_bytesize_to_unit</span><span class="p">(</span><span class="n">bytesize</span><span class="p">):</span>
    <span class="k">assert</span> <span class="n">bytesize</span><span class="p">.</span><span class="nf">to_unit</span><span class="p">(</span><span class="sh">'</span><span class="s">k</span><span class="sh">'</span><span class="p">)</span> <span class="o">==</span> <span class="sh">'</span><span class="s">1000000000000K</span><span class="sh">'</span>
    <span class="k">assert</span> <span class="n">bytesize</span><span class="p">.</span><span class="nf">to_unit</span><span class="p">(</span><span class="sh">'</span><span class="s">m</span><span class="sh">'</span><span class="p">)</span> <span class="o">==</span> <span class="sh">'</span><span class="s">1000000000M</span><span class="sh">'</span>
    <span class="k">assert</span> <span class="n">bytesize</span><span class="p">.</span><span class="nf">to_unit</span><span class="p">(</span><span class="sh">'</span><span class="s">g</span><span class="sh">'</span><span class="p">)</span> <span class="o">==</span> <span class="sh">'</span><span class="s">1000000G</span><span class="sh">'</span>
    <span class="k">assert</span> <span class="n">bytesize</span><span class="p">.</span><span class="nf">to_unit</span><span class="p">(</span><span class="sh">'</span><span class="s">t</span><span class="sh">'</span><span class="p">)</span> <span class="o">==</span> <span class="sh">'</span><span class="s">1000T</span><span class="sh">'</span>
    <span class="k">assert</span> <span class="n">bytesize</span><span class="p">.</span><span class="nf">to_unit</span><span class="p">(</span><span class="sh">'</span><span class="s">p</span><span class="sh">'</span><span class="p">)</span> <span class="o">==</span> <span class="sh">'</span><span class="s">1P</span><span class="sh">'</span>
    <span class="k">assert</span> <span class="n">bytesize</span><span class="p">.</span><span class="nf">to_unit</span><span class="p">(</span><span class="sh">'</span><span class="s">e</span><span class="sh">'</span><span class="p">)</span> <span class="o">==</span> <span class="sh">'</span><span class="s">0E</span><span class="sh">'</span>

    <span class="k">assert</span> <span class="n">bytesize</span><span class="p">.</span><span class="nf">to_unit</span><span class="p">(</span><span class="sh">'</span><span class="s">ki</span><span class="sh">'</span><span class="p">)</span> <span class="o">==</span> <span class="sh">'</span><span class="s">976562500000KI</span><span class="sh">'</span>
    <span class="k">assert</span> <span class="n">bytesize</span><span class="p">.</span><span class="nf">to_unit</span><span class="p">(</span><span class="sh">'</span><span class="s">mi</span><span class="sh">'</span><span class="p">)</span> <span class="o">==</span> <span class="sh">'</span><span class="s">953674316MI</span><span class="sh">'</span>
    <span class="k">assert</span> <span class="n">bytesize</span><span class="p">.</span><span class="nf">to_unit</span><span class="p">(</span><span class="sh">'</span><span class="s">gi</span><span class="sh">'</span><span class="p">)</span> <span class="o">==</span> <span class="sh">'</span><span class="s">931322GI</span><span class="sh">'</span>
    <span class="k">assert</span> <span class="n">bytesize</span><span class="p">.</span><span class="nf">to_unit</span><span class="p">(</span><span class="sh">'</span><span class="s">ti</span><span class="sh">'</span><span class="p">)</span> <span class="o">==</span> <span class="sh">'</span><span class="s">909TI</span><span class="sh">'</span>
    <span class="k">assert</span> <span class="n">bytesize</span><span class="p">.</span><span class="nf">to_unit</span><span class="p">(</span><span class="sh">'</span><span class="s">pi</span><span class="sh">'</span><span class="p">)</span> <span class="o">==</span> <span class="sh">'</span><span class="s">0PI</span><span class="sh">'</span>
    <span class="k">assert</span> <span class="n">bytesize</span><span class="p">.</span><span class="nf">to_unit</span><span class="p">(</span><span class="sh">'</span><span class="s">ei</span><span class="sh">'</span><span class="p">)</span> <span class="o">==</span> <span class="sh">'</span><span class="s">0EI</span><span class="sh">'</span>

    <span class="k">assert</span> <span class="n">bytesize</span><span class="p">.</span><span class="nf">to_unit</span><span class="p">()</span> <span class="o">==</span> <span class="sh">'</span><span class="s">1000000000000000</span><span class="sh">'</span>  <span class="c1"># no unit
</span>    <span class="k">assert</span> <span class="n">bytesize</span><span class="p">.</span><span class="nf">to_unit</span><span class="p">(</span><span class="sh">'</span><span class="s">K</span><span class="sh">'</span><span class="p">)</span> <span class="o">==</span> <span class="sh">'</span><span class="s">1000000000000K</span><span class="sh">'</span>  <span class="c1"># uppercase unit
</span>

<span class="k">def</span> <span class="nf">test_bytesize_to_unit_as_str</span><span class="p">(</span><span class="n">bytesize</span><span class="p">):</span>
    <span class="k">assert</span> <span class="n">bytesize</span><span class="p">.</span><span class="nf">to_unit</span><span class="p">(</span><span class="sh">'</span><span class="s">k</span><span class="sh">'</span><span class="p">,</span> <span class="n">as_string</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1000000000000</span>  <span class="c1"># not to_string
</span>

<span class="k">def</span> <span class="nf">test_bytesize_to_unit_invalid</span><span class="p">(</span><span class="n">bytesize</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">pytest</span><span class="p">.</span><span class="nf">raises</span><span class="p">(</span><span class="nb">KeyError</span><span class="p">):</span>
        <span class="n">bytesize</span><span class="p">.</span><span class="nf">to_unit</span><span class="p">(</span><span class="sh">'</span><span class="s">invalid</span><span class="sh">'</span><span class="p">)</span>
</code></pre></div>  </div>
</blockquote>

<p>Run the tests to verify they pass.</p>

<h2 id="parametrization-of-test-functions">Parametrization of test functions</h2>

<p>Finally, our <code class="language-plaintext highlighter-rouge">test_bytesize_to_unit</code> test has a lot of assert statements of the same form. We can do better! Let’s use pytest’s test parametrization feature (see <a href="https://docs.pytest.org/en/8.2.x/how-to/parametrize.html">https://docs.pytest.org/en/8.2.x/how-to/parametrize.html</a>) to eliminate this redundancy. Again, as with the fixture example, this particular case would be fine without this feature. However, sometime you want to run the same test function on hundreds of different input combinations, in which case this feature is invaluable (e.g. Galaxy’s tool tests, or integration tests for configuration settings).</p>

<blockquote class="solution">
  <div class="box-title solution-title" id="solution-9"><button class="gtn-boxify-button solution" type="button" aria-controls="solution-9" aria-expanded="true"><i class="far fa-eye" aria-hidden="true" ></i> <span>Solution</span><span class="fold-unfold fa fa-minus-square"></span></button></div>

  <p>Example of parametrizing a test. Replace the previous version of <code class="language-plaintext highlighter-rouge">test_bytesize_to_unit</code> with the
following. Note that the test function takes 2 additional arguments.</p>

  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@pytest.mark.parametrize</span><span class="p">(</span>
    <span class="sh">"</span><span class="s">unit, expected_value</span><span class="sh">"</span><span class="p">,</span>
    <span class="p">[</span>
        <span class="p">(</span><span class="sh">'</span><span class="s">k</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">1000000000000K</span><span class="sh">'</span><span class="p">),</span>
        <span class="p">(</span><span class="sh">'</span><span class="s">m</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">1000000000M</span><span class="sh">'</span><span class="p">),</span>
        <span class="p">(</span><span class="sh">'</span><span class="s">g</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">1000000G</span><span class="sh">'</span><span class="p">),</span>
        <span class="p">(</span><span class="sh">'</span><span class="s">t</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">1000T</span><span class="sh">'</span><span class="p">),</span>
        <span class="p">(</span><span class="sh">'</span><span class="s">p</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">1P</span><span class="sh">'</span><span class="p">),</span>
        <span class="p">(</span><span class="sh">'</span><span class="s">e</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">0E</span><span class="sh">'</span><span class="p">),</span>
        <span class="p">(</span><span class="sh">'</span><span class="s">ki</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">976562500000KI</span><span class="sh">'</span><span class="p">),</span>
        <span class="p">(</span><span class="sh">'</span><span class="s">mi</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">953674316MI</span><span class="sh">'</span><span class="p">),</span>
        <span class="p">(</span><span class="sh">'</span><span class="s">gi</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">931322GI</span><span class="sh">'</span><span class="p">),</span>
        <span class="p">(</span><span class="sh">'</span><span class="s">ti</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">909TI</span><span class="sh">'</span><span class="p">),</span>
        <span class="p">(</span><span class="sh">'</span><span class="s">pi</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">0PI</span><span class="sh">'</span><span class="p">),</span>
        <span class="p">(</span><span class="sh">'</span><span class="s">ei</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">0EI</span><span class="sh">'</span><span class="p">),</span>
        <span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="sh">'</span><span class="s">1000000000000000</span><span class="sh">'</span><span class="p">),</span>
        <span class="p">(</span><span class="sh">'</span><span class="s">K</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">1000000000000K</span><span class="sh">'</span><span class="p">),</span>
    <span class="p">]</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_bytesize_to_unit</span><span class="p">(</span><span class="n">unit</span><span class="p">,</span> <span class="n">expected_value</span><span class="p">,</span> <span class="n">bytesize</span><span class="p">):</span>
    <span class="k">assert</span> <span class="n">bytesize</span><span class="p">.</span><span class="nf">to_unit</span><span class="p">(</span><span class="n">unit</span><span class="p">)</span> <span class="o">==</span> <span class="n">expected_value</span>
</code></pre></div>  </div>
</blockquote>

<p>Run the tests to verify they pass.</p>

<h2 id="dealing-with-less-trivial-code">Dealing with less trivial code</h2>

<p>So far we’ve been dealing with simple clean functions that had no external dependencies. However, quite often you will encounter lengthy blocks of code implementing nontrivial logic, that depend on objects that would be hard to instantiate in the context of a test. There are many excellent resources on this topic (the book <a href="https://www.oreilly.com/library/view/working-effectively-with/0131177052/">Working Effectively with Legacy Code</a> by Michael Feathers is but one example). In this tutorial, we’ll demonstrate a few basic approaches to handling such cases.</p>

<p>Your target module for the following exercises is <code class="language-plaintext highlighter-rouge">lib/galaxy/security/validate_user_input.py</code>. The unit tests for this module are located at <code class="language-plaintext highlighter-rouge">test/unit/data/security/test_validate_user_input.py</code>. You will be adding your code to this testing module.</p>

<p>If you look at the tests for this module, you’ll note that most of its functionality is directly or indirectly covered by tests. However, the <code class="language-plaintext highlighter-rouge">validate_email</code> function does not have tests - and that’s a shame for, despite being relatively small, it contains logic that is not immediately obvious (consider how the function behaves under different combinations of the allowlist and blocklist). That’s the function we’ll be testing.</p>

<p>The <code class="language-plaintext highlighter-rouge">validate_email</code> function is not fun to test. It depends on a Transaction and User objects - one does not simply <del>walk into Mordor</del> instantiate those in the context of a unit test. It has multiple paths of execution, to determine which it accesses the GalaxyApplication object (which is a reference to a running instance of Galaxy) to access configuration values, the User object to check the value of its email attribute, and in addition to all that, of course, it calls the database. None of these dependencies require testing, at least not in the context of a unit test. However, we do want to verify the function’s core logic: the cases when no validation is required, when the provided email already exists, and the different combinations of the allowlist and blocklist.</p>

<h2 id="mocking-a-dependency">Mocking a dependency</h2>

<p>First, let’s test the case when the function returns early - when the email argument is the empty string or when its value is the same as the value of the <code class="language-plaintext highlighter-rouge">email</code> attribute of the provided User object. The first case is trivial, but the next one requires a User object. However, if we think about it, we only care about that user having a given string as its <code class="language-plaintext highlighter-rouge">email</code> attribute. So let’s use a “test double” - a stand-in empty object, and give it an <code class="language-plaintext highlighter-rouge">email</code> attribute. We’ll call it <code class="language-plaintext highlighter-rouge">MockUser</code> (strictly speaking, it’s a stub, and <a href="https://martinfowler.com/articles/mocksArentStubs.html">“mocks aren’t stubs”</a>, but we’ll follow the naming convention often used in Galaxy). We can pass <code class="language-plaintext highlighter-rouge">None</code> as the transaction object in both cases.</p>

<blockquote class="solution">
  <div class="box-title solution-title" id="solution-10"><button class="gtn-boxify-button solution" type="button" aria-controls="solution-10" aria-expanded="true"><i class="far fa-eye" aria-hidden="true" ></i> <span>Solution</span><span class="fold-unfold fa fa-minus-square"></span></button></div>

  <p>Example of replacing an object with a test double:</p>

  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">galaxy.security.validate_user_input</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">extract_domain</span><span class="p">,</span>
    <span class="n">validate_email</span><span class="p">,</span>  <span class="c1"># we've added this import
</span>    <span class="n">validate_email_str</span><span class="p">,</span>
    <span class="n">validate_publicname_str</span><span class="p">,</span>
<span class="p">)</span>


<span class="k">class</span> <span class="nc">MockUser</span><span class="p">:</span>
    <span class="k">pass</span>


<span class="k">def</span> <span class="nf">test_email_is_empty</span><span class="p">():</span>
    <span class="k">assert</span> <span class="nf">validate_email</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="sh">""</span><span class="p">,</span> <span class="n">allow_empty</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span> <span class="o">==</span> <span class="sh">""</span>

<span class="k">def</span> <span class="nf">test_email_is_user_email</span><span class="p">():</span>
    <span class="n">my_email</span> <span class="o">=</span> <span class="sh">"</span><span class="s">foo</span><span class="sh">"</span>
    <span class="n">my_user</span> <span class="o">=</span> <span class="nc">MockUser</span><span class="p">()</span>
    <span class="n">my_user</span><span class="p">.</span><span class="n">email</span> <span class="o">=</span> <span class="n">my_email</span>
    <span class="k">assert</span> <span class="nf">validate_email</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="n">my_email</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="n">my_user</span><span class="p">)</span> <span class="o">==</span> <span class="sh">""</span>
</code></pre></div>  </div>
</blockquote>

<p>Now run the tests for this module:</p>

<blockquote class="code-in">
  <div class="box-title code-in-title" id="code-in-bash-6"><i class="far fa-keyboard" aria-hidden="true" ></i> Input: Bash</div>
  <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pytest <span class="nb">test</span>/unit/data/security/test_validate_user_input.py
</code></pre></div>  </div>
</blockquote>

<blockquote class="warning">
  <div class="box-title warning-title" id="warning"><i class="fas fa-exclamation-triangle" aria-hidden="true" ></i> Warning</div>
  <p>As a word of caution, mocking (or any kind of patching to accommodate testing) may lead to brittle tests: by relying too much on <em>how</em> the logic is implemented, we’ll be forced to adjust the test each time that implementation changes. It’s a tradeoff between having narrowly-scoped tests that will point to the exact location of the problem but may lock the code under test into a given state, and higher-level integration-type tests that test the end result without “looking under the hood”, but may be less helpful when pinpointing the exact cause of a failed test. So, use sparingly and keep it simple.</p>
</blockquote>

<h2 id="refactoring-for-testability">Refactoring for testability</h2>

<p>Next, we’d like to test the case when the provided email already exists, or doesn’t exist. To determine the existence of an email the function calls the database - we don’t want to do that. Instead, we can simulate both conditions, like we simulated the user email in the previous exercise.</p>

<p>For this, we need to factor out the code that calls the database into its own function - then we can override that function for our test. So let’s modify <code class="language-plaintext highlighter-rouge">lib/galaxy/security/validate_user_input.py</code>.</p>

<blockquote class="solution">
  <div class="box-title solution-title" id="solution-11"><button class="gtn-boxify-button solution" type="button" aria-controls="solution-11" aria-expanded="true"><i class="far fa-eye" aria-hidden="true" ></i> <span>Solution</span><span class="fold-unfold fa fa-minus-square"></span></button></div>

  <p>Factoring out the database call.</p>

  <p>Old version:</p>

  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">validate_email</span><span class="p">(</span><span class="n">trans</span><span class="p">,</span> <span class="n">email</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">check_dup</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">allow_empty</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">validate_domain</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">
    Validates the email format, also checks whether the domain is blocklisted in the disposable domains configuration.
    </span><span class="sh">"""</span>
    <span class="nf">if </span><span class="p">(</span><span class="n">user</span> <span class="ow">and</span> <span class="n">user</span><span class="p">.</span><span class="n">email</span> <span class="o">==</span> <span class="n">email</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">email</span> <span class="o">==</span> <span class="sh">""</span> <span class="ow">and</span> <span class="n">allow_empty</span><span class="p">):</span>
        <span class="k">return</span> <span class="sh">""</span>
    <span class="n">message</span> <span class="o">=</span> <span class="nf">validate_email_str</span><span class="p">(</span><span class="n">email</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">message</span> <span class="ow">and</span> <span class="n">validate_domain</span><span class="p">:</span>
        <span class="n">domain</span> <span class="o">=</span> <span class="nf">extract_domain</span><span class="p">(</span><span class="n">email</span><span class="p">)</span>
        <span class="n">message</span> <span class="o">=</span> <span class="nf">validate_domain_resolves</span><span class="p">(</span><span class="n">domain</span><span class="p">)</span>

    <span class="c1"># Code to be refactored
</span>    <span class="n">stmt</span> <span class="o">=</span> <span class="nf">select</span><span class="p">(</span><span class="n">trans</span><span class="p">.</span><span class="n">app</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="n">User</span><span class="p">).</span><span class="nf">filter</span><span class="p">(</span><span class="n">func</span><span class="p">.</span><span class="nf">lower</span><span class="p">(</span><span class="n">trans</span><span class="p">.</span><span class="n">app</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="n">User</span><span class="p">.</span><span class="n">email</span><span class="p">)</span> <span class="o">==</span> <span class="n">email</span><span class="p">.</span><span class="nf">lower</span><span class="p">()).</span><span class="nf">limit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">message</span> <span class="ow">and</span> <span class="n">check_dup</span> <span class="ow">and</span> <span class="n">trans</span><span class="p">.</span><span class="n">sa_session</span><span class="p">.</span><span class="nf">scalars</span><span class="p">(</span><span class="n">stmt</span><span class="p">).</span><span class="nf">first</span><span class="p">():</span>
        <span class="n">message</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">User with email </span><span class="sh">'</span><span class="si">{</span><span class="n">email</span><span class="si">}</span><span class="sh">'</span><span class="s"> already exists.</span><span class="sh">"</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">message</span><span class="p">:</span>
        <span class="c1"># If the allowlist is not empty filter out any domain not in the list and ignore blocklist.
</span>        <span class="k">if</span> <span class="n">trans</span><span class="p">.</span><span class="n">app</span><span class="p">.</span><span class="n">config</span><span class="p">.</span><span class="n">email_domain_allowlist_content</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">domain</span> <span class="o">=</span> <span class="nf">extract_domain</span><span class="p">(</span><span class="n">email</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">domain</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">trans</span><span class="p">.</span><span class="n">app</span><span class="p">.</span><span class="n">config</span><span class="p">.</span><span class="n">email_domain_allowlist_content</span><span class="p">:</span>
                <span class="n">message</span> <span class="o">=</span> <span class="sh">"</span><span class="s">Please enter an allowed domain email address for this server.</span><span class="sh">"</span>
        <span class="c1"># If the blocklist is not empty filter out the disposable domains.
</span>        <span class="k">elif</span> <span class="n">trans</span><span class="p">.</span><span class="n">app</span><span class="p">.</span><span class="n">config</span><span class="p">.</span><span class="n">email_domain_blocklist_content</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">domain</span> <span class="o">=</span> <span class="nf">extract_domain</span><span class="p">(</span><span class="n">email</span><span class="p">,</span> <span class="n">base_only</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">domain</span> <span class="ow">in</span> <span class="n">trans</span><span class="p">.</span><span class="n">app</span><span class="p">.</span><span class="n">config</span><span class="p">.</span><span class="n">email_domain_blocklist_content</span><span class="p">:</span>
                <span class="n">message</span> <span class="o">=</span> <span class="sh">"</span><span class="s">Please enter your permanent email address.</span><span class="sh">"</span>

    <span class="k">return</span> <span class="n">message</span>
</code></pre></div>  </div>

  <p>Refactored version:</p>

  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">check_for_existing_email</span><span class="p">(</span><span class="n">trans</span><span class="p">,</span> <span class="n">email</span><span class="p">):</span>
    <span class="n">stmt</span> <span class="o">=</span> <span class="nf">select</span><span class="p">(</span><span class="n">trans</span><span class="p">.</span><span class="n">app</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="n">User</span><span class="p">).</span><span class="nf">filter</span><span class="p">(</span><span class="n">func</span><span class="p">.</span><span class="nf">lower</span><span class="p">(</span><span class="n">trans</span><span class="p">.</span><span class="n">app</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="n">User</span><span class="p">.</span><span class="n">email</span><span class="p">)</span> <span class="o">==</span> <span class="n">email</span><span class="p">.</span><span class="nf">lower</span><span class="p">()).</span><span class="nf">limit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">user_record</span> <span class="o">=</span> <span class="n">trans</span><span class="p">.</span><span class="n">sa_session</span><span class="p">.</span><span class="nf">scalars</span><span class="p">(</span><span class="n">stmt</span><span class="p">).</span><span class="nf">first</span><span class="p">()</span>
    <span class="k">return</span> <span class="nf">bool</span><span class="p">(</span><span class="n">user_record</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">validate_email</span><span class="p">(</span><span class="n">trans</span><span class="p">,</span> <span class="n">email</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">check_dup</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">allow_empty</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">validate_domain</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">
    Validates the email format, also checks whether the domain is blocklisted in the disposable domains configuration.
    </span><span class="sh">"""</span>
    <span class="nf">if </span><span class="p">(</span><span class="n">user</span> <span class="ow">and</span> <span class="n">user</span><span class="p">.</span><span class="n">email</span> <span class="o">==</span> <span class="n">email</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">email</span> <span class="o">==</span> <span class="sh">""</span> <span class="ow">and</span> <span class="n">allow_empty</span><span class="p">):</span>
        <span class="k">return</span> <span class="sh">""</span>
    <span class="n">message</span> <span class="o">=</span> <span class="nf">validate_email_str</span><span class="p">(</span><span class="n">email</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">message</span> <span class="ow">and</span> <span class="n">validate_domain</span><span class="p">:</span>
        <span class="n">domain</span> <span class="o">=</span> <span class="nf">extract_domain</span><span class="p">(</span><span class="n">email</span><span class="p">)</span>
        <span class="n">message</span> <span class="o">=</span> <span class="nf">validate_domain_resolves</span><span class="p">(</span><span class="n">domain</span><span class="p">)</span>

    <span class="c1"># Refactored code
</span>    <span class="k">if</span> <span class="ow">not</span> <span class="n">message</span> <span class="ow">and</span> <span class="n">check_dup</span> <span class="ow">and</span> <span class="nf">check_for_existing_email</span><span class="p">(</span><span class="n">trans</span><span class="p">,</span> <span class="n">email</span><span class="p">):</span>
        <span class="n">message</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">User with email </span><span class="sh">'</span><span class="si">{</span><span class="n">email</span><span class="si">}</span><span class="sh">'</span><span class="s"> already exists.</span><span class="sh">"</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">message</span><span class="p">:</span>
        <span class="c1"># If the allowlist is not empty filter out any domain not in the list and ignore blocklist.
</span>        <span class="k">if</span> <span class="n">trans</span><span class="p">.</span><span class="n">app</span><span class="p">.</span><span class="n">config</span><span class="p">.</span><span class="n">email_domain_allowlist_content</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">domain</span> <span class="o">=</span> <span class="nf">extract_domain</span><span class="p">(</span><span class="n">email</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">domain</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">trans</span><span class="p">.</span><span class="n">app</span><span class="p">.</span><span class="n">config</span><span class="p">.</span><span class="n">email_domain_allowlist_content</span><span class="p">:</span>
                <span class="n">message</span> <span class="o">=</span> <span class="sh">"</span><span class="s">Please enter an allowed domain email address for this server.</span><span class="sh">"</span>
        <span class="c1"># If the blocklist is not empty filter out the disposable domains.
</span>        <span class="k">elif</span> <span class="n">trans</span><span class="p">.</span><span class="n">app</span><span class="p">.</span><span class="n">config</span><span class="p">.</span><span class="n">email_domain_blocklist_content</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">domain</span> <span class="o">=</span> <span class="nf">extract_domain</span><span class="p">(</span><span class="n">email</span><span class="p">,</span> <span class="n">base_only</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">domain</span> <span class="ow">in</span> <span class="n">trans</span><span class="p">.</span><span class="n">app</span><span class="p">.</span><span class="n">config</span><span class="p">.</span><span class="n">email_domain_blocklist_content</span><span class="p">:</span>
                <span class="n">message</span> <span class="o">=</span> <span class="sh">"</span><span class="s">Please enter your permanent email address.</span><span class="sh">"</span>

    <span class="k">return</span> <span class="n">message</span>
</code></pre></div>  </div>
</blockquote>

<h2 id="monkeypatching-the-module-under-test">“Monkeypatching” the module under test</h2>

<p>Now we can use pytest’s “monkeypatch” built-in fixture to replace that function with a stub method and then use it to return <code class="language-plaintext highlighter-rouge">True</code> or <code class="language-plaintext highlighter-rouge">False</code> to test both cases. (see <a href="https://docs.pytest.org/en/8.2.x/how-to/monkeypatch.html?highlight=monkeypatch">https://docs.pytest.org/en/8.2.x/how-to/monkeypatch.html?highlight=monkeypatch</a> for more details).</p>

<blockquote class="solution">
  <div class="box-title solution-title" id="solution-12"><button class="gtn-boxify-button solution" type="button" aria-controls="solution-12" aria-expanded="true"><i class="far fa-eye" aria-hidden="true" ></i> <span>Solution</span><span class="fold-unfold fa fa-minus-square"></span></button></div>

  <p>Monkeypatching the factored out function. Note the added import.</p>

  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">galaxy.security</span> <span class="kn">import</span> <span class="n">validate_user_input</span>

<span class="c1"># [code omitted]
</span>
<span class="k">def</span> <span class="nf">test_check_for_existing_email</span><span class="p">(</span><span class="n">monkeypatch</span><span class="p">):</span>
    <span class="n">monkeypatch</span><span class="p">.</span><span class="nf">setattr</span><span class="p">(</span><span class="n">validate_user_input</span><span class="p">,</span> <span class="sh">"</span><span class="s">check_for_existing_email</span><span class="sh">"</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="bp">True</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="nf">validate_email</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="sh">"</span><span class="s">duplicate_email@example.com</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">assert</span> <span class="sh">"</span><span class="s">exists</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">result</span>

    <span class="n">monkeypatch</span><span class="p">.</span><span class="nf">setattr</span><span class="p">(</span><span class="n">validate_user_input</span><span class="p">,</span> <span class="sh">"</span><span class="s">check_for_existing_email</span><span class="sh">"</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="bp">False</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="nf">validate_email</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="sh">"</span><span class="s">unique_email@example.com</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">result</span> <span class="o">==</span> <span class="sh">""</span>
</code></pre></div>  </div>
</blockquote>

<h2 id="more-refactoring">More refactoring</h2>

<p>Run the tests to verify they pass after our latest modifications. But one test fails! The problem is that our validation function is not yet ready for testing: it still relies on the transaction object to access the running instance of Galaxy to retrieve 2 configuration settings: <code class="language-plaintext highlighter-rouge">email_domain_allowlist_content</code> and <code class="language-plaintext highlighter-rouge">email_domain_blocklist_content</code>.</p>

<p>How would you fix this problem?</p>

<blockquote class="solution">
  <div class="box-title solution-title" id="solution-13"><button class="gtn-boxify-button solution" type="button" aria-controls="solution-13" aria-expanded="true"><i class="far fa-eye" aria-hidden="true" ></i> <span>Solution</span><span class="fold-unfold fa fa-minus-square"></span></button></div>

  <p>Factor out the logic for obtaining both lists:</p>
  <ol>
    <li>Create 2 functions that take a transaction object as an argument and return the lists.</li>
    <li>Call the functions from the <code class="language-plaintext highlighter-rouge">validate_email</code> function’s body, assigning the results to
local variables.</li>
    <li>Replace all calls to <code class="language-plaintext highlighter-rouge">trans.app.config.[the list]</code> with the variables you’ve just assigned.</li>
  </ol>

  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">get_email_domain_allowlist_content</span><span class="p">(</span><span class="n">trans</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">trans</span><span class="p">.</span><span class="n">app</span><span class="p">.</span><span class="n">config</span><span class="p">.</span><span class="n">email_domain_allowlist_content</span>


<span class="k">def</span> <span class="nf">get_email_domain_blocklist_content</span><span class="p">(</span><span class="n">trans</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">trans</span><span class="p">.</span><span class="n">app</span><span class="p">.</span><span class="n">config</span><span class="p">.</span><span class="n">email_domain_blocklist_content</span>


<span class="k">def</span> <span class="nf">validate_email</span><span class="p">(</span><span class="n">trans</span><span class="p">,</span> <span class="n">email</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">check_dup</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">allow_empty</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">validate_domain</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">
    Validates the email format, also checks whether the domain is blocklisted in the disposable domains configuration.
    </span><span class="sh">"""</span>
    <span class="nf">if </span><span class="p">(</span><span class="n">user</span> <span class="ow">and</span> <span class="n">user</span><span class="p">.</span><span class="n">email</span> <span class="o">==</span> <span class="n">email</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">email</span> <span class="o">==</span> <span class="sh">""</span> <span class="ow">and</span> <span class="n">allow_empty</span><span class="p">):</span>
        <span class="k">return</span> <span class="sh">""</span>
    <span class="n">message</span> <span class="o">=</span> <span class="nf">validate_email_str</span><span class="p">(</span><span class="n">email</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">message</span> <span class="ow">and</span> <span class="n">validate_domain</span><span class="p">:</span>
        <span class="n">domain</span> <span class="o">=</span> <span class="nf">extract_domain</span><span class="p">(</span><span class="n">email</span><span class="p">)</span>
        <span class="n">message</span> <span class="o">=</span> <span class="nf">validate_domain_resolves</span><span class="p">(</span><span class="n">domain</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">message</span> <span class="ow">and</span> <span class="n">check_dup</span> <span class="ow">and</span> <span class="nf">check_for_existing_email</span><span class="p">(</span><span class="n">trans</span><span class="p">,</span> <span class="n">email</span><span class="p">):</span>
        <span class="n">message</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">User with email </span><span class="sh">'</span><span class="si">{</span><span class="n">email</span><span class="si">}</span><span class="sh">'</span><span class="s"> already exists.</span><span class="sh">"</span>

    <span class="n">email_domain_allowlist_content</span> <span class="o">=</span> <span class="nf">get_email_domain_allowlist_content</span><span class="p">(</span><span class="n">trans</span><span class="p">)</span>
    <span class="n">email_domain_blocklist_content</span> <span class="o">=</span> <span class="nf">get_email_domain_blocklist_content</span><span class="p">(</span><span class="n">trans</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">message</span><span class="p">:</span>
        <span class="c1"># If the allowlist is not empty filter out any domain not in the list and ignore blocklist.
</span>        <span class="k">if</span> <span class="n">email_domain_allowlist_content</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">domain</span> <span class="o">=</span> <span class="nf">extract_domain</span><span class="p">(</span><span class="n">email</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">domain</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">email_domain_allowlist_content</span><span class="p">:</span>
                <span class="n">message</span> <span class="o">=</span> <span class="sh">"</span><span class="s">Please enter an allowed domain email address for this server.</span><span class="sh">"</span>
        <span class="c1"># If the blocklist is not empty filter out the disposable domains.
</span>        <span class="k">elif</span> <span class="n">email_domain_blocklist_content</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">domain</span> <span class="o">=</span> <span class="nf">extract_domain</span><span class="p">(</span><span class="n">email</span><span class="p">,</span> <span class="n">base_only</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">domain</span> <span class="ow">in</span> <span class="n">email_domain_blocklist_content</span><span class="p">:</span>
                <span class="n">message</span> <span class="o">=</span> <span class="sh">"</span><span class="s">Please enter your permanent email address.</span><span class="sh">"</span>

    <span class="k">return</span> <span class="n">message</span>
</code></pre></div>  </div>
</blockquote>

<h2 id="more-monkeypatching">More “monkeypatching”</h2>

<p>Run the tests. They still fail. That’s because we haven’t replaced the new functions with a mock for our test. Try to do that - it’s the same approach as we used for monkeypatching the <code class="language-plaintext highlighter-rouge">check_for_existing_email</code> function. Note that both lists should be <code class="language-plaintext highlighter-rouge">None</code> to be ignored.</p>

<blockquote class="solution">
  <div class="box-title solution-title" id="solution-14"><button class="gtn-boxify-button solution" type="button" aria-controls="solution-14" aria-expanded="true"><i class="far fa-eye" aria-hidden="true" ></i> <span>Solution</span><span class="fold-unfold fa fa-minus-square"></span></button></div>

  <p>Monkeypatch the email lists: return <code class="language-plaintext highlighter-rouge">None</code> for both, then override as needed:</p>

  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">test_check_for_existing_email</span><span class="p">(</span><span class="n">monkeypatch</span><span class="p">):</span>
    <span class="n">monkeypatch</span><span class="p">.</span><span class="nf">setattr</span><span class="p">(</span><span class="n">validate_user_input</span><span class="p">,</span> <span class="sh">"</span><span class="s">get_email_domain_allowlist_content</span><span class="sh">"</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">a</span><span class="p">:</span> <span class="bp">None</span><span class="p">)</span>
    <span class="n">monkeypatch</span><span class="p">.</span><span class="nf">setattr</span><span class="p">(</span><span class="n">validate_user_input</span><span class="p">,</span> <span class="sh">"</span><span class="s">get_email_domain_blocklist_content</span><span class="sh">"</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">a</span><span class="p">:</span> <span class="bp">None</span><span class="p">)</span>

    <span class="n">monkeypatch</span><span class="p">.</span><span class="nf">setattr</span><span class="p">(</span><span class="n">validate_user_input</span><span class="p">,</span> <span class="sh">"</span><span class="s">check_for_existing_email</span><span class="sh">"</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="bp">True</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="nf">validate_email</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="sh">"</span><span class="s">duplicate_email@example.com</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">assert</span> <span class="sh">"</span><span class="s">exists</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">result</span>

    <span class="n">monkeypatch</span><span class="p">.</span><span class="nf">setattr</span><span class="p">(</span><span class="n">validate_user_input</span><span class="p">,</span> <span class="sh">"</span><span class="s">check_for_existing_email</span><span class="sh">"</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="bp">False</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="nf">validate_email</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="sh">"</span><span class="s">unique_email@example.com</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">result</span> <span class="o">==</span> <span class="sh">""</span>
</code></pre></div>  </div>
</blockquote>

<p>Run the tests - they should pass now.</p>

<h2 id="utilizing-the-mocks-to-test-the-logic">Utilizing the mocks to test the logic</h2>

<p>Now that our tests pass, it’s time to test the last bit of logic: the allowlist and the blocklist. Our first step is to add a simple test to verify that if the allow-list is not empty, only emails with allowed domain names will be validated.</p>

<blockquote class="solution">
  <div class="box-title solution-title" id="solution-15"><button class="gtn-boxify-button solution" type="button" aria-controls="solution-15" aria-expanded="true"><i class="far fa-eye" aria-hidden="true" ></i> <span>Solution</span><span class="fold-unfold fa fa-minus-square"></span></button></div>

  <p>First take on testing the allowlist.</p>

  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">test_validate_email_allowlist_not_empty</span><span class="p">(</span><span class="n">monkeypatch</span><span class="p">):</span>
    <span class="n">allowlist</span> <span class="o">=</span> <span class="p">[</span><span class="sh">'</span><span class="s">good_domain.com</span><span class="sh">'</span><span class="p">]</span>
    <span class="n">monkeypatch</span><span class="p">.</span><span class="nf">setattr</span><span class="p">(</span><span class="n">validate_user_input</span><span class="p">,</span> <span class="sh">"</span><span class="s">get_email_domain_allowlist_content</span><span class="sh">"</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">a</span><span class="p">:</span> <span class="n">allowlist</span><span class="p">)</span>
    <span class="n">monkeypatch</span><span class="p">.</span><span class="nf">setattr</span><span class="p">(</span><span class="n">validate_user_input</span><span class="p">,</span> <span class="sh">"</span><span class="s">get_email_domain_blocklist_content</span><span class="sh">"</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">a</span><span class="p">:</span> <span class="bp">None</span><span class="p">)</span>
    <span class="n">monkeypatch</span><span class="p">.</span><span class="nf">setattr</span><span class="p">(</span><span class="n">validate_user_input</span><span class="p">,</span> <span class="sh">"</span><span class="s">check_for_existing_email</span><span class="sh">"</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="bp">False</span><span class="p">)</span>

    <span class="k">assert</span> <span class="nf">validate_email</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="sh">"</span><span class="s">email@good_domain.com</span><span class="sh">"</span><span class="p">)</span> <span class="o">==</span> <span class="sh">""</span>
    <span class="k">assert</span> <span class="sh">"</span><span class="s">enter an allowed domain</span><span class="sh">"</span> <span class="ow">in</span> <span class="nf">validate_email</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="sh">"</span><span class="s">email@bad_domain.com</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div>  </div>
</blockquote>

<p>Run the tests to verify we haven’t broken anything.</p>

<p>However, again, we are getting a lot of duplication from our monkeypatching code, and there are more tests to come. Time to move some of it into fixtures; <strong>leave only the code that is specific to the test</strong>.</p>

<blockquote class="solution">
  <div class="box-title solution-title" id="solution-16"><button class="gtn-boxify-button solution" type="button" aria-controls="solution-16" aria-expanded="true"><i class="far fa-eye" aria-hidden="true" ></i> <span>Solution</span><span class="fold-unfold fa fa-minus-square"></span></button></div>

  <p>Factor out all common monkeypatching into fixtures. Note the <code class="language-plaintext highlighter-rouge">pytest</code> import.</p>

  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">pytest</span>

<span class="c1"># [code omitted]
</span>
<span class="nd">@pytest.fixture</span>
<span class="k">def</span> <span class="nf">patch_allowlist</span><span class="p">(</span><span class="n">monkeypatch</span><span class="p">):</span>
    <span class="n">monkeypatch</span><span class="p">.</span><span class="nf">setattr</span><span class="p">(</span><span class="n">validate_user_input</span><span class="p">,</span> <span class="sh">"</span><span class="s">get_email_domain_allowlist_content</span><span class="sh">"</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">a</span><span class="p">:</span> <span class="bp">None</span><span class="p">)</span>


<span class="nd">@pytest.fixture</span>
<span class="k">def</span> <span class="nf">patch_blocklist</span><span class="p">(</span><span class="n">monkeypatch</span><span class="p">):</span>
    <span class="n">monkeypatch</span><span class="p">.</span><span class="nf">setattr</span><span class="p">(</span><span class="n">validate_user_input</span><span class="p">,</span> <span class="sh">"</span><span class="s">get_email_domain_blocklist_content</span><span class="sh">"</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">a</span><span class="p">:</span> <span class="bp">None</span><span class="p">)</span>


<span class="nd">@pytest.fixture</span>
<span class="k">def</span> <span class="nf">patch_check_existing</span><span class="p">(</span><span class="n">monkeypatch</span><span class="p">):</span>
    <span class="n">monkeypatch</span><span class="p">.</span><span class="nf">setattr</span><span class="p">(</span><span class="n">validate_user_input</span><span class="p">,</span> <span class="sh">"</span><span class="s">check_for_existing_email</span><span class="sh">"</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="bp">False</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">test_email_is_empty</span><span class="p">():</span>
    <span class="k">assert</span> <span class="nf">validate_email</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="sh">""</span><span class="p">,</span> <span class="n">allow_empty</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span> <span class="o">==</span> <span class="sh">""</span>


<span class="k">def</span> <span class="nf">test_email_is_user_email</span><span class="p">():</span>
    <span class="n">my_email</span> <span class="o">=</span> <span class="sh">"</span><span class="s">foo</span><span class="sh">"</span>
    <span class="n">my_user</span> <span class="o">=</span> <span class="nc">MockUser</span><span class="p">()</span>
    <span class="n">my_user</span><span class="p">.</span><span class="n">email</span> <span class="o">=</span> <span class="n">my_email</span>
    <span class="k">assert</span> <span class="nf">validate_email</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="n">my_email</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="n">my_user</span><span class="p">)</span> <span class="o">==</span> <span class="sh">""</span>


<span class="k">def</span> <span class="nf">test_check_for_existing_email</span><span class="p">(</span><span class="n">patch_allowlist</span><span class="p">,</span> <span class="n">patch_blocklist</span><span class="p">,</span> <span class="n">monkeypatch</span><span class="p">):</span>
    <span class="n">monkeypatch</span><span class="p">.</span><span class="nf">setattr</span><span class="p">(</span><span class="n">validate_user_input</span><span class="p">,</span> <span class="sh">"</span><span class="s">check_for_existing_email</span><span class="sh">"</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="bp">True</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="nf">validate_email</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="sh">"</span><span class="s">duplicate_email@example.com</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">assert</span> <span class="sh">"</span><span class="s">exists</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">result</span>

    <span class="n">monkeypatch</span><span class="p">.</span><span class="nf">setattr</span><span class="p">(</span><span class="n">validate_user_input</span><span class="p">,</span> <span class="sh">"</span><span class="s">check_for_existing_email</span><span class="sh">"</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="bp">False</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="nf">validate_email</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="sh">"</span><span class="s">unique_email@example.com</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">result</span> <span class="o">==</span> <span class="sh">""</span>


<span class="k">def</span> <span class="nf">test_validate_email_allowlist_not_empty</span><span class="p">(</span><span class="n">monkeypatch</span><span class="p">,</span> <span class="n">patch_check_existing</span><span class="p">,</span> <span class="n">patch_blocklist</span><span class="p">):</span>
    <span class="n">allowlist</span> <span class="o">=</span> <span class="p">[</span><span class="sh">'</span><span class="s">good_domain.com</span><span class="sh">'</span><span class="p">]</span>
    <span class="n">monkeypatch</span><span class="p">.</span><span class="nf">setattr</span><span class="p">(</span><span class="n">validate_user_input</span><span class="p">,</span> <span class="sh">"</span><span class="s">get_email_domain_allowlist_content</span><span class="sh">"</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">a</span><span class="p">:</span> <span class="n">allowlist</span><span class="p">)</span>

    <span class="k">assert</span> <span class="nf">validate_email</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="sh">"</span><span class="s">email@good_domain.com</span><span class="sh">"</span><span class="p">)</span> <span class="o">==</span> <span class="sh">""</span>
    <span class="k">assert</span> <span class="sh">"</span><span class="s">enter an allowed domain</span><span class="sh">"</span> <span class="ow">in</span> <span class="nf">validate_email</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="sh">"</span><span class="s">email@bad_domain.com</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div>  </div>
</blockquote>

<p>Again, run the tests to verify we haven’t broken anything.</p>

<h2 id="reformatting-for-improved-readability">Reformatting for improved readability</h2>

<p>Before we add more tests, let’s reformat our code to group all the tests that target the <code class="language-plaintext highlighter-rouge">validate_email</code> function in one class. Keep in mind that each test gets its own instance of the class - so you cannot share instance state across tests. However, grouping related tests makes the testing module easier to navigate (there are more benefits; see <a href="https://docs.pytest.org/en/8.2.x/getting-started.html#group-multiple-tests-in-a-class">https://docs.pytest.org/en/8.2.x/getting-started.html#group-multiple-tests-in-a-class</a>).</p>

<blockquote class="solution">
  <div class="box-title solution-title" id="solution-17"><button class="gtn-boxify-button solution" type="button" aria-controls="solution-17" aria-expanded="true"><i class="far fa-eye" aria-hidden="true" ></i> <span>Solution</span><span class="fold-unfold fa fa-minus-square"></span></button></div>

  <p>Group related tests in one class. Note that you need to add <code class="language-plaintext highlighter-rouge">self</code> as the first
argument to each test function. You also need to add <code class="language-plaintext highlighter-rouge">self</code> to the call to <code class="language-plaintext highlighter-rouge">MockUser()</code>. Leave
the fixtures outside the class body, so that they can be reused by other test code.</p>

  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">TestValidateEmail</span><span class="p">:</span>

    <span class="k">class</span> <span class="nc">MockUser</span><span class="p">:</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">test_email_is_empty</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nf">validate_email</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="sh">""</span><span class="p">,</span> <span class="n">allow_empty</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span> <span class="o">==</span> <span class="sh">""</span>
    
    <span class="k">def</span> <span class="nf">test_email_is_user_email</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">my_email</span> <span class="o">=</span> <span class="sh">"</span><span class="s">foo</span><span class="sh">"</span>
        <span class="n">my_user</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nc">MockUser</span><span class="p">()</span>
        <span class="n">my_user</span><span class="p">.</span><span class="n">email</span> <span class="o">=</span> <span class="n">my_email</span>
        <span class="k">assert</span> <span class="nf">validate_email</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="n">my_email</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="n">my_user</span><span class="p">)</span> <span class="o">==</span> <span class="sh">""</span>
    
    <span class="k">def</span> <span class="nf">test_check_for_existing_email</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">patch_allowlist</span><span class="p">,</span> <span class="n">patch_blocklist</span><span class="p">,</span> <span class="n">monkeypatch</span><span class="p">):</span>
        <span class="n">monkeypatch</span><span class="p">.</span><span class="nf">setattr</span><span class="p">(</span><span class="n">validate_user_input</span><span class="p">,</span> <span class="sh">"</span><span class="s">check_for_existing_email</span><span class="sh">"</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="bp">True</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="nf">validate_email</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="sh">"</span><span class="s">duplicate_email@example.com</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">assert</span> <span class="sh">"</span><span class="s">exists</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">result</span>
    
        <span class="n">monkeypatch</span><span class="p">.</span><span class="nf">setattr</span><span class="p">(</span><span class="n">validate_user_input</span><span class="p">,</span> <span class="sh">"</span><span class="s">check_for_existing_email</span><span class="sh">"</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="bp">False</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="nf">validate_email</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="sh">"</span><span class="s">unique_email@example.com</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">result</span> <span class="o">==</span> <span class="sh">""</span>
    
    <span class="k">def</span> <span class="nf">test_validate_email_allowlist_not_empty</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">monkeypatch</span><span class="p">,</span> <span class="n">patch_check_existing</span><span class="p">,</span> <span class="n">patch_blocklist</span><span class="p">):</span>
        <span class="n">allowlist</span> <span class="o">=</span> <span class="p">[</span><span class="sh">'</span><span class="s">good_domain.com</span><span class="sh">'</span><span class="p">]</span>
        <span class="n">monkeypatch</span><span class="p">.</span><span class="nf">setattr</span><span class="p">(</span><span class="n">validate_user_input</span><span class="p">,</span> <span class="sh">"</span><span class="s">get_email_domain_allowlist_content</span><span class="sh">"</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">a</span><span class="p">:</span> <span class="n">allowlist</span><span class="p">)</span>
    
        <span class="k">assert</span> <span class="nf">validate_email</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="sh">"</span><span class="s">email@good_domain.com</span><span class="sh">"</span><span class="p">)</span> <span class="o">==</span> <span class="sh">""</span>
        <span class="k">assert</span> <span class="sh">"</span><span class="s">enter an allowed domain</span><span class="sh">"</span> <span class="ow">in</span> <span class="nf">validate_email</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="sh">"</span><span class="s">email@bad_domain.com</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div>  </div>
</blockquote>

<p>Again, run the tests to verify we haven’t broken anything.</p>

<h2 id="adding-the-remaining-tests">Adding the remaining tests</h2>

<p>Now we have all the infrastructure in place. We need to add 2 more tests. First, you may notice that if the allowlist is not empty, the blocklist is ignored. Let’s write a test to verify this.</p>

<blockquote class="solution">
  <div class="box-title solution-title" id="solution-18"><button class="gtn-boxify-button solution" type="button" aria-controls="solution-18" aria-expanded="true"><i class="far fa-eye" aria-hidden="true" ></i> <span>Solution</span><span class="fold-unfold fa fa-minus-square"></span></button></div>

  <p>Testing ignoring the blocklist.</p>

  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">test_ignore_blocklist_if_allowlist_not_empty</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">monkeypatch</span><span class="p">,</span> <span class="n">patch_check_existing</span><span class="p">):</span>
    <span class="n">allowlist</span> <span class="o">=</span> <span class="p">[</span><span class="sh">'</span><span class="s">my_domain.com</span><span class="sh">'</span><span class="p">]</span>
    <span class="n">monkeypatch</span><span class="p">.</span><span class="nf">setattr</span><span class="p">(</span><span class="n">validate_user_input</span><span class="p">,</span> <span class="sh">"</span><span class="s">get_email_domain_allowlist_content</span><span class="sh">"</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">a</span><span class="p">:</span> <span class="n">allowlist</span><span class="p">)</span>

    <span class="c1"># but add that domain to blocklist too!
</span>    <span class="n">blocklist</span> <span class="o">=</span> <span class="p">[</span><span class="sh">'</span><span class="s">my_domain.com</span><span class="sh">'</span><span class="p">]</span>
    <span class="n">monkeypatch</span><span class="p">.</span><span class="nf">setattr</span><span class="p">(</span><span class="n">validate_user_input</span><span class="p">,</span> <span class="sh">"</span><span class="s">get_email_domain_blocklist_content</span><span class="sh">"</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">a</span><span class="p">:</span> <span class="n">blocklist</span><span class="p">)</span>

    <span class="k">assert</span> <span class="nf">validate_email</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="sh">"</span><span class="s">email@my_domain.com</span><span class="sh">"</span><span class="p">)</span> <span class="o">==</span> <span class="sh">""</span>  <span class="c1"># we expect blocklist to be ignored
</span></code></pre></div>  </div>
</blockquote>

<p>Run the tests - they should pass.</p>

<p>Finally, let’s test the blocklist.</p>

<blockquote class="solution">
  <div class="box-title solution-title" id="solution-19"><button class="gtn-boxify-button solution" type="button" aria-controls="solution-19" aria-expanded="true"><i class="far fa-eye" aria-hidden="true" ></i> <span>Solution</span><span class="fold-unfold fa fa-minus-square"></span></button></div>

  <p>Testing the blocklist.</p>

  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">test_blocklist_when_allowlist_is_empty</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">monkeypatch</span><span class="p">,</span> <span class="n">patch_allowlist</span><span class="p">,</span> <span class="n">patch_check_existing</span><span class="p">):</span>
    <span class="n">blocklist</span> <span class="o">=</span> <span class="p">[</span><span class="sh">'</span><span class="s">bad_domain.com</span><span class="sh">'</span><span class="p">]</span>
    <span class="n">monkeypatch</span><span class="p">.</span><span class="nf">setattr</span><span class="p">(</span><span class="n">validate_user_input</span><span class="p">,</span> <span class="sh">"</span><span class="s">get_email_domain_blocklist_content</span><span class="sh">"</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">a</span><span class="p">:</span> <span class="n">blocklist</span><span class="p">)</span>
    <span class="k">assert</span> <span class="sh">"</span><span class="s">enter your permanent email</span><span class="sh">"</span> <span class="ow">in</span> <span class="nf">validate_email</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="sh">"</span><span class="s">email@bad_domain.com</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div>  </div>
</blockquote>

<p>Run the tests one last time - they should pass.</p>

<p>And we are done! Here’s the final version of the code we’ve added to this testing module.</p>

<blockquote class="solution">
  <div class="box-title solution-title" id="solution-20"><button class="gtn-boxify-button solution" type="button" aria-controls="solution-20" aria-expanded="true"><i class="far fa-eye" aria-hidden="true" ></i> <span>Solution</span><span class="fold-unfold fa fa-minus-square"></span></button></div>

  <p>Final code listing (excluding the 2 added imports).</p>

  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@pytest.fixture</span>
<span class="k">def</span> <span class="nf">patch_allowlist</span><span class="p">(</span><span class="n">monkeypatch</span><span class="p">):</span>
    <span class="n">monkeypatch</span><span class="p">.</span><span class="nf">setattr</span><span class="p">(</span><span class="n">validate_user_input</span><span class="p">,</span> <span class="sh">"</span><span class="s">get_email_domain_allowlist_content</span><span class="sh">"</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">a</span><span class="p">:</span> <span class="bp">None</span><span class="p">)</span>

<span class="nd">@pytest.fixture</span>
<span class="k">def</span> <span class="nf">patch_blocklist</span><span class="p">(</span><span class="n">monkeypatch</span><span class="p">):</span>
    <span class="n">monkeypatch</span><span class="p">.</span><span class="nf">setattr</span><span class="p">(</span><span class="n">validate_user_input</span><span class="p">,</span> <span class="sh">"</span><span class="s">get_email_domain_blocklist_content</span><span class="sh">"</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">a</span><span class="p">:</span> <span class="bp">None</span><span class="p">)</span>

<span class="nd">@pytest.fixture</span>
<span class="k">def</span> <span class="nf">patch_check_existing</span><span class="p">(</span><span class="n">monkeypatch</span><span class="p">):</span>
    <span class="n">monkeypatch</span><span class="p">.</span><span class="nf">setattr</span><span class="p">(</span><span class="n">validate_user_input</span><span class="p">,</span> <span class="sh">"</span><span class="s">check_for_existing_email</span><span class="sh">"</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="bp">False</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">TestValidateEmail</span><span class="p">:</span>

    <span class="k">class</span> <span class="nc">MockUser</span><span class="p">:</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">test_email_is_empty</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nf">validate_email</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="sh">""</span><span class="p">,</span> <span class="n">allow_empty</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span> <span class="o">==</span> <span class="sh">""</span>
    
    <span class="k">def</span> <span class="nf">test_email_is_user_email</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">my_email</span> <span class="o">=</span> <span class="sh">"</span><span class="s">foo</span><span class="sh">"</span>
        <span class="n">my_user</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nc">MockUser</span><span class="p">()</span>
        <span class="n">my_user</span><span class="p">.</span><span class="n">email</span> <span class="o">=</span> <span class="n">my_email</span>
        <span class="k">assert</span> <span class="nf">validate_email</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="n">my_email</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="n">my_user</span><span class="p">)</span> <span class="o">==</span> <span class="sh">""</span>
    
    <span class="k">def</span> <span class="nf">test_check_for_existing_email</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">patch_allowlist</span><span class="p">,</span> <span class="n">patch_blocklist</span><span class="p">,</span> <span class="n">monkeypatch</span><span class="p">):</span>
        <span class="n">monkeypatch</span><span class="p">.</span><span class="nf">setattr</span><span class="p">(</span><span class="n">validate_user_input</span><span class="p">,</span> <span class="sh">"</span><span class="s">check_for_existing_email</span><span class="sh">"</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="bp">True</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="nf">validate_email</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="sh">"</span><span class="s">duplicate_email@example.com</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">assert</span> <span class="sh">"</span><span class="s">exists</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">result</span>
    
        <span class="n">monkeypatch</span><span class="p">.</span><span class="nf">setattr</span><span class="p">(</span><span class="n">validate_user_input</span><span class="p">,</span> <span class="sh">"</span><span class="s">check_for_existing_email</span><span class="sh">"</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="bp">False</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="nf">validate_email</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="sh">"</span><span class="s">unique_email@example.com</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">result</span> <span class="o">==</span> <span class="sh">""</span>
    
    <span class="k">def</span> <span class="nf">test_validate_email_allowlist_not_empty</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">monkeypatch</span><span class="p">,</span> <span class="n">patch_check_existing</span><span class="p">,</span> <span class="n">patch_blocklist</span><span class="p">):</span>
        <span class="n">allowlist</span> <span class="o">=</span> <span class="p">[</span><span class="sh">'</span><span class="s">good_domain.com</span><span class="sh">'</span><span class="p">]</span>
        <span class="n">monkeypatch</span><span class="p">.</span><span class="nf">setattr</span><span class="p">(</span><span class="n">validate_user_input</span><span class="p">,</span> <span class="sh">"</span><span class="s">get_email_domain_allowlist_content</span><span class="sh">"</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">a</span><span class="p">:</span> <span class="n">allowlist</span><span class="p">)</span>
    
        <span class="k">assert</span> <span class="nf">validate_email</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="sh">"</span><span class="s">email@good_domain.com</span><span class="sh">"</span><span class="p">)</span> <span class="o">==</span> <span class="sh">""</span>
        <span class="k">assert</span> <span class="sh">"</span><span class="s">enter an allowed domain</span><span class="sh">"</span> <span class="ow">in</span> <span class="nf">validate_email</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="sh">"</span><span class="s">email@bad_domain.com</span><span class="sh">"</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_ignore_blocklist_if_allowlist_not_empty</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">monkeypatch</span><span class="p">,</span> <span class="n">patch_check_existing</span><span class="p">):</span>
        <span class="n">allowlist</span> <span class="o">=</span> <span class="p">[</span><span class="sh">'</span><span class="s">my_domain.com</span><span class="sh">'</span><span class="p">]</span>
        <span class="n">monkeypatch</span><span class="p">.</span><span class="nf">setattr</span><span class="p">(</span><span class="n">validate_user_input</span><span class="p">,</span> <span class="sh">"</span><span class="s">get_email_domain_allowlist_content</span><span class="sh">"</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">a</span><span class="p">:</span> <span class="n">allowlist</span><span class="p">)</span>

        <span class="c1"># but add that domain to blocklist too!
</span>        <span class="n">blocklist</span> <span class="o">=</span> <span class="p">[</span><span class="sh">'</span><span class="s">my_domain.com</span><span class="sh">'</span><span class="p">]</span>
        <span class="n">monkeypatch</span><span class="p">.</span><span class="nf">setattr</span><span class="p">(</span><span class="n">validate_user_input</span><span class="p">,</span> <span class="sh">"</span><span class="s">get_email_domain_blocklist_content</span><span class="sh">"</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">a</span><span class="p">:</span> <span class="n">blocklist</span><span class="p">)</span>

        <span class="k">assert</span> <span class="nf">validate_email</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="sh">"</span><span class="s">email@my_domain.com</span><span class="sh">"</span><span class="p">)</span> <span class="o">==</span> <span class="sh">""</span>  <span class="c1"># we expect blocklist to be ignored
</span>
    <span class="k">def</span> <span class="nf">test_blocklist_when_allowlist_is_empty</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">monkeypatch</span><span class="p">,</span> <span class="n">patch_allowlist</span><span class="p">,</span> <span class="n">patch_check_existing</span><span class="p">):</span>
        <span class="n">blocklist</span> <span class="o">=</span> <span class="p">[</span><span class="sh">'</span><span class="s">bad_domain.com</span><span class="sh">'</span><span class="p">]</span>
        <span class="n">monkeypatch</span><span class="p">.</span><span class="nf">setattr</span><span class="p">(</span><span class="n">validate_user_input</span><span class="p">,</span> <span class="sh">"</span><span class="s">get_email_domain_blocklist_content</span><span class="sh">"</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">a</span><span class="p">:</span> <span class="n">blocklist</span><span class="p">)</span>
        <span class="k">assert</span> <span class="sh">"</span><span class="s">enter your permanent email</span><span class="sh">"</span> <span class="ow">in</span> <span class="nf">validate_email</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="sh">"</span><span class="s">email@bad_domain.com</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div>  </div>
</blockquote>


                </section>

                <section aria-label="Tutorial Footer, Feedback, Citation" id="tutorial-footer">
                        <h3>You've Finished the Tutorial</h3>
                        <button id="tutorial-finish-button" class="btn btn-primary" onclick="tutorial_finish()">I finished this tutorial 👍</button>
                        <p style="display: none" id="tutorial-finish-text">Please also consider filling out the <a href="#gtn-feedback">Feedback Form</a> as well!</p>
                        <script>
                        function tutorial_finish() {
                          if(typeof plausible !== 'undefined'){
                            // Plausible may be undefined (script blocked)
                            // or it may be defined, but opted-out (select box/DNT),
                            // which means `plausible()` will work but not send data, *nor* execute the callback.
                            plausible('TutorialComplete', {props: {path: document.location.pathname}})
                          }
                          // since the callback is completely cosmetic, we'll just issue it optimistically.
                          tutorial_finish_finish();
                        }
                        function tutorial_finish_finish() {
                          document.getElementById("tutorial-finish-button").innerText = 'Congrats! Thanks for letting us know! 🎉'
                          document.getElementById("tutorial-finish-button").disabled = true
                          document.getElementById("tutorial-finish-button").disabled = true
                          document.getElementById("tutorial-finish-text").style.display = 'block'
                        }
                        </script>

                
                <blockquote class="key_points">
                    <div class="box-title"><i class="fas fa-key" aria-hidden="true"></i> Key points</div>
                    <ul>
                        
                        <li><p>Read the Writing Tests for Galaxy documentation article</p>
</li>
                        
                        <li><p>Check for existing examples of similar tests before implementing your own</p>
</li>
                        
                        <li><p>Prefer Galaxy’s abstractions to writing low level code whenever possible</p>
</li>
                        
                        <li><p>Write tests that do not depend on each other or the state of the database</p>
</li>
                        
                        <li><p>When testing the API, verify the return status code before checking the response data</p>
</li>
                        
                        <li><p>Refactor the code under test if that’s needed to make it testable</p>
</li>
                        
                        <li><p>Move redundant setup code into fixtures</p>
</li>
                        
                        <li><p>Use test doubles (mocks, stubs, etc.) sparingly</p>
</li>
                        
                    </ul>
                </blockquote>
                

                <h1>Frequently Asked Questions</h1>
                Have questions about this tutorial? Check out the  <a href="/training-material/topics/dev/faqs/">FAQ page for the Development in Galaxy topic</a> to see if your question is listed there.
                If not, please ask your question on the <a href="https://gitter.im/Galaxy-Training-Network/Lobby">GTN Gitter Channel</a> or the
                <a href="https://help.galaxyproject.org">Galaxy Help Forum</a>

                

                


                

                

                <h1 id="gtn-feedback">Feedback</h1>
                <p class="text-muted">Did you use this material as an instructor? Feel free to give us feedback on <a href="https://github.com/galaxyproject/training-material/issues/1452">how it went</a>.
                <br>Did you use this material as a learner or student? Click the form below to leave feedback.<i class="fas fa-hand-point-down"></i>
                </p>

                <iframe id="feedback-google" class="google-form" src="https://docs.google.com/forms/d/e/1FAIpQLSd4VZptFTQ03kHkMz0JyW9b6_S8geU5KjNE_tLM0dixT3ZQmA/viewform?embedded=true&entry.1235803833=dev/writing_tests"><a href="https://docs.google.com/forms/d/e/1FAIpQLSd4VZptFTQ03kHkMz0JyW9b6_S8geU5KjNE_tLM0dixT3ZQmA/viewform?embedded=true&entry.1235803833=dev/writing_tests">Feedback Form</a></iframe>

                <h1>Citing this Tutorial</h1>
                <p>
                    <ol>
                        <li id="citation-text">
                            John Davis, John Chilton,  <b>Writing Automated Tests for Galaxy (Galaxy Training Materials)</b>. <a href="https://training.galaxyproject.org/training-material/topics/dev/tutorials/writing_tests/tutorial.html">https://training.galaxyproject.org/training-material/topics/dev/tutorials/writing_tests/tutorial.html</a> Online; accessed TODAY
                        </li>
                        <li>
                        Hiltemann, Saskia, Rasche, Helena et al., 2023 <b>Galaxy Training: A Powerful Framework for Teaching!</b> PLOS Computational Biology <a href="https://journals.plos.org/ploscompbiol/article?id=10.1371/journal.pcbi.1010752">10.1371/journal.pcbi.1010752</a>
                        </li>
                        <li>
                        Batut et al., 2018 <b>Community-Driven Data Analysis Training for Biology</b> Cell Systems <a href="https://doi.org/10.1016%2Fj.cels.2018.05.012">10.1016/j.cels.2018.05.012</a>
                        </li>
                    </ol>
                </p>

                <!-- collapsible boxcontaining the BibTeX-formatted citation -->
                <blockquote class="details">

                  <div id="citation-bibtex" class="box-title">
                    <button type="button" aria-controls="citation-bibtex" aria-expanded="false">
                      <i class="fas fa-info-circle" aria-hidden="true"></i>
                      <span class="visually-hidden"></span> BibTeX<span role="button" class="fold-unfold fa fa-minus-square" aria-hidden="true"></span>
                    </button>
                   </div>
                   <p style="display: none;">

                   <div class="highlighter-rouge"><div class="highlight"><pre class="highlight">


<code id="citation-code">@misc{dev-writing_tests,
author = "John Davis and John Chilton",
	title = "Writing Automated Tests for Galaxy (Galaxy Training Materials)",
	year = "",
	month = "",
	day = ""
	url = "\url{https://training.galaxyproject.org/training-material/topics/dev/tutorials/writing_tests/tutorial.html}",
	note = "[Online; accessed TODAY]"
}
@article{Hiltemann_2023,
	doi = {10.1371/journal.pcbi.1010752},
	url = {https://doi.org/10.1371%2Fjournal.pcbi.1010752},
	year = 2023,
	month = {jan},
	publisher = {Public Library of Science ({PLoS})},
	volume = {19},
	number = {1},
	pages = {e1010752},
	author = {Saskia Hiltemann and Helena Rasche and Simon Gladman and Hans-Rudolf Hotz and Delphine Larivi{\`{e}}re and Daniel Blankenberg and Pratik D. Jagtap and Thomas Wollmann and Anthony Bretaudeau and Nadia Gou{\'{e}} and Timothy J. Griffin and Coline Royaux and Yvan Le Bras and Subina Mehta and Anna Syme and Frederik Coppens and Bert Droesbeke and Nicola Soranzo and Wendi Bacon and Fotis Psomopoulos and Crist{\'{o}}bal Gallardo-Alba and John Davis and Melanie Christine Föll and Matthias Fahrner and Maria A. Doyle and Beatriz Serrano-Solano and Anne Claire Fouilloux and Peter van Heusden and Wolfgang Maier and Dave Clements and Florian Heyl and Björn Grüning and B{\'{e}}r{\'{e}}nice Batut and},
	editor = {Francis Ouellette},
	title = {Galaxy Training: A powerful framework for teaching!},
	journal = {PLoS Comput Biol} Computational Biology}
}
</code>
                   </pre></div></div>
                   </p>
                </blockquote>

        


<script>
// update the date on load, or leave fallback of 'today'
const citationTodaysDate = new Date();
document.getElementById("citation-code").innerHTML = document.getElementById("citation-code").innerHTML.replace("TODAY", citationTodaysDate.toDateString());
document.getElementById("citation-text").innerHTML = document.getElementById("citation-text").innerHTML.replace("TODAY", citationTodaysDate.toDateString());
</script>

                <i class="far fa-thumbs-up" aria-hidden="true"></i> Congratulations on successfully completing this tutorial!

                

                

		
                <blockquote class="details follow-up" id="admins-install-missing-tools">
                  <div id="admin-missing-tools" class="box-title">
                    <button type="button" aria-controls="admin-missing-tools" aria-expanded="false">
                      <i class="fas fa-info-circle" aria-hidden="true"></i>
                      <span class="visually-hidden"></span> Galaxy Administrators: Install the missing tools<span role="button" class="fold-unfold fa fa-minus-square" aria-hidden="true"></span>
                    </button>
                   </div>


			<p>You can use Ephemeris's <code>shed-tools install</code> command to install the tools used in this tutorial.</p>
<div class="highlight"><pre class="highlight"><code>shed-tools install [-g GALAXY] [-a API_KEY] -t &lt;(curl https://training.galaxyproject.org/training-material/api/topics/dev/tutorials/writing_tests/tutorial.json | jq .admin_install_yaml -r)</code></pre></div>
<p>Alternatively you can copy and paste the following YAML</p>
<div class="highlight"><pre class="highlight"><code>---
install_tool_dependencies: true
install_repository_dependencies: true
install_resolver_dependencies: true
tools: []
</code></pre></div>
                </blockquote>
		

		<blockquote class="details hide-when-printing" id="feedback-responses">
                  <div id="feedback-response-c" class="box-title">
                    <button type="button" aria-controls="feedback-response-c" aria-expanded="false">
                      <i class="fas fa-info-circle" aria-hidden="true"></i>
                      <span class="visually-hidden"></span> Feedback<span role="button" class="fold-unfold fa fa-minus-square" aria-hidden="true"></span>
                    </button>
                   </div>

		   <p>
		   
		   <table class="charts-css bar show-labels" style="--labels-size: 8rem; overflow-y: hidden">
		   
		   </table>
		   </p>
		
        
        
            <p>No feedback has been recieved yet for this training. Be the first one by filling in the feedback form from <a href="#gtn-feedback">above</a>. </p>
        
		</blockquote>




		
		
		

                </section>

            </div>
        </div>
    </div>
</article>
<br/>
<br/>
<br/>

        </div>
        <footer>
	<hr />
	<div class="container">
		<div class="row">
			<div class="col-sm-3">
				<span style="font-size: 2em">GTN</span>
				<p>
					The GTN provides learners with a free, open repository of online training
					materials, with a focus on hands-on training that aims to be directly applicable for learners.
					We aim to connect researchers and learners with local trainers, and events worldwide.
				</p>
				<p>
					We promote FAIR and Open Science practices worldwide, are committed to the accessibility of this platform and training for everyone.
				</p>
			</div>
			<div class="col-sm-3">
				<span style="font-size: 1.3em">About Us</span>
				<ul class="no-bullets">
					<li><a href="/training-material/about.html">About</a></li>
					<li><a rel="code-of-conduct" href="https://galaxyproject.org/community/coc/">Code of Conduct</a></li>
					<li><a href="/training-material/accessibility.html">Accessibility</a></li>
					<li><a href="/training-material/faqs/gtn/fair_training.html">100% FAIR Training</a></li>
					<li><a href="/training-material/faqs/gtn/collaborative_development.html">Collaborative Development</a></li>
				</ul>
				<span style="font-size: 1.3em">Page</span>
				<ul class="no-bullets">
					
					<li><i class="fas fa-fingerprint" aria-hidden="true"></i><span class="visually-hidden">purl</span><abbr title="Persistent URL">PURL</abbr>: <a href="https://gxy.io/GTN:T00123">gxy.io/GTN:T00123</a></li>
					

					

					<li>
						<a rel="license" href="https://spdx.org/licenses/CC-BY-4.0">
							Content licensed under Creative Commons Attribution 4.0 International License
						</a>
					</li>
					<li>
						<a href="https://github.com/galaxyproject/training-material/edit/main/topics/dev/tutorials/writing_tests/tutorial.md">
						<i class="fab fa-github" aria-hidden="true"></i><span class="visually-hidden">github</span> Edit on GitHub
						</a>
					</li>
					<li>
						<a href="https://github.com/galaxyproject/training-material/commits/main/topics/dev/tutorials/writing_tests/tutorial.md">
						<i class="fab fa-github" aria-hidden="true"></i><span class="visually-hidden">github</span> View Changes on GitHub
						</a>
					</li>
				</ul>
			</div>
			<div class="col-sm-3">
				<span style="font-size: 1.3em">Support</span>
				<ul class="no-bullets">
					<li><a rel="me" href="/training-material/faqs/galaxy/">Galaxy FAQs</a></li>
					<li><a rel="me" href="https://help.galaxyproject.org">Galaxy Help Forum</a></li>
					<li><a rel="me" href="http://gxy.io/gtn-slack">GTN Slack Chat</a></li>
					<li><a rel="me" href="https://matrix.to/#/%23Galaxy-Training-Network_Lobby%3Agitter.im">GTN Matrix Chat</a></li>
					<li><a rel="me" href="https://matrix.to/#/#galaxyproject_Lobby:gitter.im">Galaxy Matrix Chat</a></li>
				</ul>
				<span style="font-size: 1.3em">Framework</span>
				<ul class="no-bullets">
					<li>Revision <a href="https://github.com/galaxyproject/training-material/commit/07d82075d85f1904fe5da1a3b0d187a1192494eb">07d8207</a></li>
					<li><a rel="license" href="https://github.com/galaxyproject/training-material/blob/main/LICENSE.md">MIT</a> Licensed</li>
					<li><a href="https://jekyllrb.com/">Jekyll(4.3.2 | production)</a></li>
				</ul>
			</div>
			<div class="col-sm-3">
				<span style="font-size: 1.3em">Follow Us!</span>
				<ul class="no-bullets">
					<li><span style="fill: var(--hyperlink);"><svg   width="1em"   height="1em"   viewBox="0 0 8.4937906 9.1084023"   version="1.1"   id="svg356"   xmlns="http://www.w3.org/2000/svg"   xmlns:svg="http://www.w3.org/2000/svg">  <g     id="layer1"     transform="translate(-70.566217,-144.26757)">    <path       style="fill-opacity:1;stroke:none;stroke-width:0.0179182"       d="m 76.39081,152.24155 c -0.737138,0.20763 -1.554999,0.29101 -2.311453,0.14333 -0.475335,-0.0928 -0.891898,-0.32923 -1.031589,-0.82423 -0.04356,-0.15434 -0.06132,-0.32388 -0.06142,-0.48378 0.353724,0.0457 0.702251,0.1304 1.057176,0.17407 0.701338,0.0864 1.394702,0.0784 2.096434,0.008 0.744056,-0.0745 1.433711,-0.21546 2.060598,-0.64854 0.243974,-0.16855 0.474672,-0.39133 0.603487,-0.66252 0.181421,-0.38195 0.175886,-0.89336 0.204447,-1.30803 0.0923,-1.34029 0.20588,-2.98599 -1.076708,-3.846 -0.499561,-0.33497 -1.208891,-0.39913 -1.791824,-0.45742 -0.987026,-0.0987 -1.971078,-0.0946 -2.956509,0.0338 -0.841146,0.10961 -1.595223,0.31468 -2.1065,1.0443 -0.493296,0.70396 -0.509564,1.52563 -0.509564,2.34729 0,1.37831 -0.05534,2.87744 0.595934,4.13911 0.504703,0.97774 1.498709,1.29589 2.52184,1.41832 0.473239,0.0566 0.96049,0.0849 1.434158,0.0172 0.328853,-0.0471 0.650325,-0.0999 0.966886,-0.20511 0.08957,-0.0298 0.266911,-0.0614 0.322027,-0.14486 0.04089,-0.0618 0.0099,-0.15812 0.0035,-0.22545 -0.01611,-0.16924 -0.02094,-0.34967 -0.02096,-0.51963 m -1.594723,-5.48298 c 0.214822,-0.25951 0.315898,-0.56088 0.60922,-0.75705 0.687899,-0.46006 1.692038,-0.11202 1.992096,0.63161 0.214571,0.5317 0.140174,1.15913 0.140174,1.72017 v 1.03925 c 0,0.0911 0.04009,0.30954 -0.01842,0.38339 -0.04193,0.053 -0.173018,0.0287 -0.232436,0.0287 h -0.698809 v -1.88142 c 0,-0.28413 0.04813,-0.63823 -0.09912,-0.89591 -0.234746,-0.4108 -0.875019,-0.36105 -1.092116,0.0358 -0.123368,0.22555 -0.116792,0.50369 -0.116792,0.75257 v 1.0751 h -0.931726 v -1.05718 c 0,-0.2555 0.0024,-0.53932 -0.121773,-0.77049 -0.21432,-0.39919 -0.857782,-0.44403 -1.090217,-0.0358 -0.147324,0.25871 -0.09604,0.61056 -0.09604,0.89591 v 1.88142 H 72.09042 v -1.98893 c 0,-0.4711 -0.01604,-0.95902 0.233201,-1.3797 0.585269,-0.98786 2.133584,-0.74836 2.472454,0.32253 z"       id="path2318" />  </g></svg></span> <a rel="me" href="https://mstdn.science/@gtn">Mastodon</a></li>
					<li><span style="fill: var(--hyperlink);"><svg  viewBox="0 0 64 57" width="1em" ><path style="fill-opacity:1;stroke:none;stroke-width:0.0179182" d="M13.873 3.805C21.21 9.332 29.103 20.537 32 26.55v15.882c0-.338-.13.044-.41.867-1.512 4.456-7.418 21.847-20.923 7.944-7.111-7.32-3.819-14.64 9.125-16.85-7.405 1.264-15.73-.825-18.014-9.015C1.12 23.022 0 8.51 0 6.55 0-3.268 8.579-.182 13.873 3.805ZM50.127 3.805C42.79 9.332 34.897 20.537 32 26.55v15.882c0-.338.13.044.41.867 1.512 4.456 7.418 21.847 20.923 7.944 7.111-7.32 3.819-14.64-9.125-16.85 7.405 1.264 15.73-.825 18.014-9.015C62.88 23.022 64 8.51 64 6.55c0-9.818-8.578-6.732-13.873-2.745Z"></path></svg></span><a rel="me" href="https://bsky.app/profile/galaxytraining.bsky.social"> Bluesky</a></li>
				</ul>

				<span style="font-size: 1.3em">Publications</span>
				<ul class="no-bullets">
					<li><a href="https://doi.org/10.1371/journal.pcbi.1010752">Hiltemann et al. 2023</a></li>
					<li><a href="https://doi.org/10.1016/j.cels.2018.05.012"> Batut et al. 2018</a></li>
					<li><a href="/training-material/faqs/gtn/gtn_citing.html">Citing Us</a></li>
				</ul>
			</div>
		</div>
	</div>
</footer>


        <script  async defer src='/training-material/assets/js/bundle.main.40d4e218.js'></script>

	
	

    </body>
</html>