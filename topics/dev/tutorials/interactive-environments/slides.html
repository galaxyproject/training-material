<!DOCTYPE html>
<html>









  <head>
    <meta charset="utf-8">
    <title>Galaxy Interactive Environments</title>
    
        <script async defer data-domain="training.galaxyproject.org" src="https://plausible.galaxyproject.eu/js/plausible.js"></script>

    
    <link rel="stylesheet" href="/training-material/assets/css/slides.css">
    <script src="https://kit.fontawesome.com/67b3f98409.js" crossorigin="anonymous"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="shortcut icon" href="/training-material/favicon.ico" type="image/x-icon" />

    
    
    
    
    <meta name="description" content="Galaxy is an open-source project. Everyone can contribute..." />
    <meta property="og:title" content="Galaxy Training: Galaxy Interactive Environments" />
    <meta property="og:description" content="Galaxy is an open-source project. Everyone can contribute..." />
    <meta property="og:image" content="/training-material/assets/images/GTNLogo1000.png" />
    <script type="application/ld+json">
      


{
  "@context": "http://schema.org",
  "@type": "Course",
  "accessMode": [
    "textual",
    "visual"
  ],
  "accessModeSufficient": [
    "textual",
    "visual"
  ],
  "accessibilityControl": [
    "fullKeyboardControl",
    "fullMouseControl"
  ],
  "accessibilityFeature": [
    "alternativeText",
    "tableOfContents"
  ],
  "accessibilitySummary": "Short descriptions are present but long descriptions will be needed for non-visual users",
  "audience": {
    "@type": "EducationalAudience",
    "educationalRole": "students"
  },
  "citation": {
    "@type": "CreativeWork",
    "name": "Community-Driven Data Analysis Training for Biology",
    "url": "https://doi.org/10.1016/j.cels.2018.05.012"
  },
  "copyrightHolder": {
    "@type": "Organization",
    "email": "galaxytrainingnetwork@gmail.com",
    "name": "Galaxy Training Network",
    "url": "https://galaxyproject.org/teach/gtn/"
  },
  "discussionUrl": "https://gitter.im/Galaxy-Training-Network/Lobby",
  "headline": "Galaxy Interactive Environments",
  "inLanguage": {
    "@type": "Language",
    "name": "English",
    "alternateName": "en"
  },
  "interactivityType": "mixed",
  "isAccessibleForFree": true,
  "license": "https://github.com/galaxyproject/training-material/blob/master/LICENSE.md",
  "producer": {
    "@type": "Organization",
    "email": "galaxytrainingnetwork@gmail.com",
    "name": "Galaxy Training Network",
    "url": "https://galaxyproject.org/teach/gtn/"
  },
  "provider": {
    "@type": "Organization",
    "email": "galaxytrainingnetwork@gmail.com",
    "name": "Galaxy Training Network",
    "url": "https://galaxyproject.org/teach/gtn/"
  },
  "sourceOrganization": {
    "@type": "Organization",
    "email": "galaxytrainingnetwork@gmail.com",
    "name": "Galaxy Training Network",
    "url": "https://galaxyproject.org/teach/gtn/"
  },
  "isPartOf": {
    "@type": "CreativeWork",
    "name": "Development in Galaxy",
    "description": "Galaxy is an open-source project. Everyone can contribute to its development with core Galaxy development, integration of softwares in Galaxy environment, ...",
    "url": "https://training.galaxyproject.org//training-material/topics/dev/"
  },
  "courseCode": "dev / interactive-environments / slides",
  "learningResourceType": "slides",
  "name": "Slides for 'Galaxy Interactive Environments' tutorial",
  "url": "https://training.galaxyproject.org//training-material/topics/dev/tutorials/interactive-environments/slides.html",
  "timeRequired": "PT90M",
  "description": "The questions this  addresses are:\n - What are Galaxy Interactive Environments (GIEs)?\n - How to enable GIEs in Galaxy?\n - How to develop your own GIE?\n\n\\nThe objectives are:\n - Implement a Hello-World Galaxy Interactive Environment\n\n",
  "coursePrerequisites": [
    "Docker basics"
  ],
  "hasPart": [

  ],
  "author": [
    {
      "@type": "Person",
      "name": "Saskia Hiltemann"
    },
    {
      "@type": "Person",
      "name": "Björn Grüning"
    },
    {
      "@type": "Person",
      "name": "Helena Rasche"
    }
  ],
  "contributor": [
    {
      "@type": "Person",
      "name": "Saskia Hiltemann"
    },
    {
      "@type": "Person",
      "name": "Björn Grüning"
    },
    {
      "@type": "Person",
      "name": "Helena Rasche"
    }
  ],
  "about": [
    {
      "@type": "CreativeWork",
      "name": "Development in Galaxy",
      "description": "Galaxy is an open-source project. Everyone can contribute to its development with core Galaxy development, integration of softwares in Galaxy environment, ...",
      "url": "https://training.galaxyproject.org//training-material/topics/dev/"
    }
  ]
}
    </script>
    <script type="text/javascript" src="/training-material/assets/js/jquery.slim.min.js"></script>
  </head>
  <body>
    <textarea id="source">
name: inverse
layout: true
class: center, middle, inverse

<div class="my-header"><span>
<a href="/training-material/topics/dev" title="Return to topic page" ><i class="fa fa-level-up" aria-hidden="true"></i></a>

<a class="nav-link" href="https://github.com/galaxyproject/training-material/edit/master/topics/dev/tutorials/interactive-environments/slides.html"><i class="fa fa-pencil" aria-hidden="true"></i></a>

</span></div>

<div class="my-footer"><span>

<img src="/training-material/assets/images/GTN-60px.png" alt="Galaxy Training Network" style="height: 40px;"/>

</span></div>

---

# Galaxy Interactive Environments



---

## Requirements

Before diving into this slide deck, we recommend you to have a look at:





    
- Docker basics
    




.footnote[Tip: press `P` to view the presenter notes]

???
Presenter notes contain extra information which might be useful if you
intend to use these slides for teaching.

Press `P` again to switch presenter notes off

Press `C` to create a new window where the same presentation will be displayed.
This window is linked to the main window. Changing slides on one will cause the
slide to change on the other. Useful when presenting.

---






### &lt;i class=&quot;far fa-question-circle&quot; aria-hidden=&quot;true&quot;&gt;&lt;/i&gt;&lt;span class=&quot;visually-hidden&quot;&gt;question&lt;/span&gt; Questions


- What are Galaxy Interactive Environments (GIEs)?

- How to enable GIEs in Galaxy?

- How to develop your own GIE?


---



### &lt;i class=&quot;fas fa-bullseye&quot; aria-hidden=&quot;true&quot;&gt;&lt;/i&gt;&lt;span class=&quot;visually-hidden&quot;&gt;objectives&lt;/span&gt; Objectives


- Implement a Hello-World Galaxy Interactive Environment


---


# Interactive Environments

---

### Why IEs?

- Embedded access to third-party application inside of Galaxy
- Interactively analyze data, access analysis products within Galaxy

![](../../images/vis_IE_ipython0.png)

- Bring external analysis platform to the data instead of vice-versa
  - no need to download/re-upload your data

---

### Who should use IEs?

- Everyone!
- Programming Environments for Bioinformaticians and Data Scientists
  - Jupyter
  - Rstudio
- Visualization IEs are great for life scientists
  - IOBIO (bam/vcf visualizations)
  - Phinch (metagenomics visualizations)

---

## Types of visualizations in Galaxy

GIE for visualization? Check that it is the right choice for your project

- **Trackster** - built-in genome browser
- **Display applications**
  - UCSC Genome Browser
  - IGV
- **Galaxy tools**
  - JBrowse
  - Krona
- **Visualization plugins**
  - Charts
  - Generic
- **Interactive Environments**
  - Jupyter/Rstudio
  - IOBIO (bam/vcf visualizations)
  - Phinch (metagenomics visualizations)

---

## Which should I use?

![](../../images/which_viz_flowchart.png)


---

### How to launch an IE?

- Can be bound to specific datatypes
  - Available under the visualizations button on the dataset

.image-25[![](../../images/vis_IE_button.png)]

- Or more general-purpose applications (Jupyter/Rstudio)
- IE launcher

.image-25[![](../../images/vis_IE_launcher_menu.png)]
---

### IE Launcher

- Choose between different available docker images
- Attach one or more datasets from history

.image-75[![](../../images/vis_IE_launcher.png)]

---

### How does it work?

- Docker Containers are launched on-demand by users..
- ..and killed automatically when users stop using them

![](../../images/vis_IE_infra.png)

.footnote[ Admin Docs: https://docs.galaxyproject.org/en/master/admin/interactive_environments.html ]

---

### Jupyter

  - General purpose/ multi-dataset
  - Provides special functions to interact with the Galaxy history (get/put datasets)
  - Ability to save and load notebooks

.image-75[![](../../images/vis_IE_ipython1.png)]

---

### Jupyter

![](../../images/vis_IE_ipython2.png)

---

### Jupyter

![](../../images/vis_IE_ipython3.png)

---

### Rstudio

- General purpose/ multi-dataset
- Provides special functions to interact with the Galaxy history
- Ability to save and load workbook and R history object

![](../../images/vis_IE_rstudio.png)

---

### IOBIO

- Visualizes single dataset
- Only available for datasets of specific formats

![](../../images/vis_IE_iobio.png)

---

### IOBIO

![](../../images/vis_IE_iobio2.png)

---

### Phinch

![](../../images/vis_IE_phinch.png)

---

### Admin

- Prerequisites: NodeJs (npm) and Docker; Galaxy user must be able to talk to the docker daemon
- Enable IEs in `galaxy.yml`
  ```bash
  interactive_environment_plugins_directory = config/plugins/interactive_environments
  ```
- Install node proxy
  ```bash
  $ cd $GALAXY/lib/galaxy/web/proxy/js/
  $ npm install .
  ```
- Can configure GIEs to run on another host

.footnote[ Advanced configurations: https://docs.galaxyproject.org/en/master/admin/interactive_environments.html]

---

### Development

- Not hard to build!
- All the magic is in:
  ```bash
  $GALAXY/config/plugins/interactive_environments/$ie_name/
  ```


| Component                          | File                         |
|------------------------------------|------------------------------|
| Visualization Plugin Configuration | ../config/${ie_name}.xml     |
| IE specific Configuration          | ../config/${ie_name}.ini     |
| Mako Template                      | ../templates/${ie_name}.mako |

---

### Development

![](../../images/vis_IE_ipython_components.png)

---

### Hello World Example

- All files in this example available from
  https://github.com/hexylena/hello-world-interactive-environment/
- Create a GIE that shows the directory listing of `import` folder (datasets loaded into GIE by user)

```bash
$ tree $GALAXY_ROOT/config/plugins/interactive_environments/helloworld/
config/plugins/interactive_environments/helloworld/
├── config
│   ├── helloworld.ini
│   ├── helloworld.ini.sample
│   └── helloworld.xml
├── static
│   └── js
│       └── helloworld.js
└── templates
    └── helloworld.mako
```

---

Create GIE plugin XML file `config/helloworld.xml`

```xml
&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;!DOCTYPE interactive_environment SYSTEM &quot;../../interactive_environments.dtd&quot;&gt;
&lt;!-- This is the name which will show up in the User's Browser --&gt;
&lt;interactive_environment name=&quot;HelloWorld&quot;&gt;
  &lt;data_sources&gt;
    &lt;data_source&gt;
      &lt;model_class&gt;HistoryDatasetAssociation&lt;/model_class&gt;

      &lt;!-- filter which types of datasets are appropriate for this GIE --&gt;
      &lt;test type=&quot;isinstance&quot; test_attr=&quot;datatype&quot;
            result_type=&quot;datatype&quot;&gt;tabular.Tabular&lt;/test&gt;
      &lt;test type=&quot;isinstance&quot; test_attr=&quot;datatype&quot;
            result_type=&quot;datatype&quot;&gt;data.Text&lt;/test&gt;
      &lt;to_param param_attr=&quot;id&quot;&gt;dataset_id&lt;/to_param&gt;
    &lt;/data_source&gt;
  &lt;/data_sources&gt;
  &lt;params&gt;
    &lt;param type=&quot;dataset&quot; var_name_in_template=&quot;hda&quot; required=&quot;true&quot;&gt;dataset_id&lt;/param&gt;
  &lt;/params&gt;
  &lt;!-- Be sure that your entrypoint name is correct! --&gt;
  &lt;entry_point entry_point_type=&quot;mako&quot;&gt;helloworld.mako&lt;/entry_point&gt;
&lt;/interactive_environment&gt;
```

---

Set up `.ini` file, which controls docker interaction `config/helloworld.ini.sample`

```ini
[main]
# Unused

[docker]
# Command to execute docker. For example `sudo docker` or `docker-lxc`.
#command = docker {docker_args}

# The docker image name that should be started.
image = hello-ie

# Additional arguments that are passed to the `docker run` command.
#command_inject = --sig-proxy=true -e DEBUG=false

# URL to access the Galaxy API with from the spawn Docker container, if empty
# this falls back to galaxy.yml's galaxy_infrastructure_url and finally to the
# Docker host of the spawned container if that is also not set.
#galaxy_url =

# The Docker hostname. It can be useful to run the Docker daemon on a different
# host than Galaxy.
#docker_hostname = localhost

[..]
```

---

- Create mako template `templates/helloworld.mako`
  - Loads configuration from `ini` file
  - launches docker container,
  - builds a URL to the correct endpoint through Galaxy NodeJS proxy
  - set environment variable `CUSTOM` to be passed to container
  - attach dataset selected by user (`hda`)

```mako
&lt;%namespace name=&quot;ie&quot; file=&quot;ie.mako&quot; /&gt;
&lt;%
# Sets ID and sets up a lot of other variables
ie_request.load_deploy_config()

# Define a volume that will be mounted into the container.
# This is a useful way to provide access to large files in the container,
# if the user knows ahead of time that they will need it.
user_file = ie_request.volume(
    hda.file_name, '/import/file.dat', how='ro')

# Launch the IE. This builds and runs the docker command in the background.
ie_request.launch(
    volumes=[user_file],
    env_override={
        'custom': '42'
    }
)
[..]
```

---

(continued)

```mako
[..]
# Only once the container is launched can we template our URLs. The ie_request
# doesn't have all of the information needed until the container is running.
url = ie_request.url_template('${PROXY_URL}/helloworld/')
%&gt;

&lt;html&gt;
&lt;head&gt;
${ ie.load_default_js() }
&lt;/head&gt;
&lt;body&gt;
&lt;script type=&quot;text/javascript&quot;&gt;
${ ie.default_javascript_variables() }
var url = '${ url }';
${ ie.plugin_require_config() }
requirejs(['interactive_environments', 'plugin/helloworld'], function(){
    load_notebook(url);
});
&lt;/script&gt;
&lt;div id=&quot;main&quot; width=&quot;100%&quot; height=&quot;100%&quot;&gt;
&lt;/div&gt;
&lt;/body&gt;
&lt;/html&gt;
```

---
Lastly we must write the `load_notebook` function, `static/js/helloworld.js`

```javascript
function load_notebook(url){
    $( document ).ready(function() {
        test_ie_availability(url, function(){
            append_notebook(url)
        });
    });
}
```

---

### Hello World Example

- The only thing missing now is the GIE (Docker) container itself
- Container typically consists of:
  - Dockerfile
  - Proxy configuration (e.g. nginx)
  - Custom startup script/entrypoint
  - Script to monitor traffic and kill unused containers
  - The actual application for the users (here: simple python process which serves
    directory contents of `/import` folder of container)

---

```dockerfile
FROM ubuntu:14.04
# These environment variables are passed from Galaxy to the container
# and help you enable connectivity to Galaxy from within the container.
# This means your user can import/export data from/to Galaxy.
ENV DEBIAN_FRONTEND=noninteractive \
    API_KEY=none \
    DEBUG=false \
    PROXY_PREFIX=none \
    GALAXY_URL=none \
    GALAXY_WEB_PORT=10000 \
    HISTORY_ID=none \
    REMOTE_HOST=none

RUN apt-get -qq update &amp;&amp; \
    apt-get install --no-install-recommends -y \
    wget procps nginx python python-pip net-tools nginx

# Our very important scripts. Make sure you've run `chmod +x startup.sh
# monitor_traffic.sh` outside of the container!
ADD ./startup.sh /startup.sh
ADD ./monitor_traffic.sh /monitor_traffic.sh

# /import will be the universal mount-point for IPython
# The Galaxy instance can copy in data that needs to be present to the
# container
RUN mkdir /import

[..]
```

---

(continued)

```dockerfile
[..]
# Nginx configuration
COPY ./proxy.conf /proxy.conf

VOLUME [&quot;/import&quot;]
WORKDIR /import/

# EXTREMELY IMPORTANT! You must expose a SINGLE port on your container.
EXPOSE 80
CMD /startup.sh
```

---

- Proxy configuration (nginx)
  - reverse proxy our directory listing process running on port 8000

```nginx
server {
    listen 80;
    server_name localhost;
    access_log /var/log/nginx/localhost.access.log;

    # Note the trailing slash used everywhere!
    location PROXY_PREFIX/helloworld/ {
        proxy_buffering off;
        proxy_pass         http://127.0.0.1:8000/;
        proxy_redirect     http://127.0.0.1:8000/ PROXY_PREFIX/helloworld/;
    }
}
```

---

- Create the `startup.sh` file which starts our directory listing service

```bash
#!/bin/bash
# First, replace the PROXY_PREFIX value in /proxy.conf with the value from
# the environment variable.
sed -i &quot;s|PROXY_PREFIX|${PROXY_PREFIX}|&quot; /proxy.conf;
# Then copy into the default location for ubuntu+nginx
cp /proxy.conf /etc/nginx/sites-enabled/default;

# Here you would normally start whatever service you want to start. In our
# example we start a simple directory listing service on port 8000
cd /import/ &amp;&amp; python -mSimpleHTTPServer &amp;

# Launch traffic monitor which will automatically kill the container if
# traffic stops
/monitor_traffic.sh &amp;
# And finally launch nginx in foreground mode. This will make debugging
# easier as logs will be available from `docker logs ...`
nginx -g 'daemon off;'
```

---

- Lastly, the script to monitor traffic and shut down if user is no longer connected, `monitor_traffic.sh`

```bash
#!/bin/bash
while true; do
    sleep 60
    if [ `netstat -t | grep -v CLOSE_WAIT | grep ':80' | wc -l` -lt 3 ]
    then
        pkill nginx
    fi
done
```

---

### Hello World Example

- We are now ready to build our container, and try out our new GIE!
- If the container is hosted on a service like Dockerhub or quay.io, it will be automatically
fetched on first run.

```bash
$ cd hello-ie
$ docker build -t hello-ie .
```

![](../../images/vis_IE_helloworld.png)

.footnote[Try it yourself: https://github.com/hexylena/hello-world-interactive-environment]




---
### &lt;i class=&quot;fas fa-key&quot; aria-hidden=&quot;true&quot;&gt;&lt;/i&gt;&lt;span class=&quot;visually-hidden&quot;&gt;keypoints&lt;/span&gt; Key points


- Interactive Environments offer access to third-party applications within Galaxy

- Interactive Environments run in a docker images for sandboxing and easy dependency management







---

## Thank you!

This material is the result of a collaborative work. Thanks to the [Galaxy Training Network](https://wiki.galaxyproject.org/Teach/GTN) and all the contributors!


<div class="contributors-line">


<a href="/training-material/hall-of-fame/shiltemann/" class="contributor-badge"><img src="https://avatars.githubusercontent.com/shiltemann" alt="Saskia Hiltemann">Saskia Hiltemann</a>, <a href="/training-material/hall-of-fame/bgruening/" class="contributor-badge"><img src="https://avatars.githubusercontent.com/bgruening" alt="Björn Grüning">Björn Grüning</a>, <a href="/training-material/hall-of-fame/hexylena/" class="contributor-badge"><img src="https://avatars.githubusercontent.com/hexylena" alt="Helena Rasche">Helena Rasche</a>


</div>



<img src="/training-material/assets/images/GTN.png" alt="Galaxy Training Network" style="height: 100px;"/>


This material is licensed under the <a rel="license" href="https://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 International License</a>.


    </textarea>
	<script src="/training-material/assets/js/remark-latest.min.js" type="text/javascript"></script>
    <script type="text/javascript" src="/training-material/assets/js/theme.js"></script>
    <script type="text/javascript" src="/training-material/assets/js/clipboard.min.js"></script>
    <script type="text/javascript">
      var slideshow = remark.create({navigation: {scroll: false,}});
      var hljs = remark.highlighter.engine;
      var snippets = document.querySelectorAll('code.remark-code');
        [].forEach.call(snippets,function(snippet){
          snippet.firstChild.insertAdjacentHTML('beforebegin','<button class="btn btn-light" data-clipboard-snippet><i class="fa fa-copy"></i>&nbsp;Copy</button>');
        });
      var clipboardSnippets=new ClipboardJS('[data-clipboard-snippet]',{
        target:function(trigger){return trigger.parentElement;
      }});
    </script>

    <script type="text/javascript">
        if(window.location.hostname === "galaxyproject.github.io") {
            // Redirect
            var redirect = "https://training.galaxyproject.org" + window.location.pathname + window.location.search;
            $('body').prepend("<div style='text-align: center'><strong>Note: </strong>This content has a new home at <a href=\"" + redirect + "\">" + redirect + "</a>, which you will be redirected to in 5 seconds.</div>");

            window.setTimeout(function(){
                window.location.href = redirect;
            }, 5000)

        }
    </script>

  </body>
</html>
