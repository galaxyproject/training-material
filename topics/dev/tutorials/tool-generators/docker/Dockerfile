
# Galaxy - Using Galaxy tools to generate new Galaxy tools
#
# To build the docker image, go to root of the training repo and
#    docker build -t tool-generators -f topics/tool-generators/docker/Dockerfile .
# Take a break. Takes a while!
# To run image, make a `planemo --extra_tools` tool directory where you want to run it regularly and then
#    docker run -p "9090:9090" -v mytools:/planemo/mytools/  -t tool-generators
# ToolFactory planemo will be available on localhost:9090
# Toolshed archives you generate can be downloaded and then unpacked under the mytools directory.
# They will be loaded by planemo into the Galaxy it runs and be available in the tool menu the next time you restart the container and planemo
# This allows you to load newly generated tools for testing and refinement.
# WARNING: Save your history as a history or lose your ToolFactory form work when you stop the container.
# Planemo always starts with an empty history.
# A downloaded history can be imported into the new Planemo and the form regenerated by rerunning the job.
# Training material is not yet installed - not sure how to do that in Planemo ?

FROM ubuntu:latest

MAINTAINER Ross Lazarus
ENV TARGDIR "/galaxy-central"
ENV PDIR "/planemo"
RUN apt update -y -qq && apt install -y -qq python3-dev gcc python3-pip build-essential python3-venv python3-wheel nano curl wget git python3-setuptools gnupg curl mercurial \
&& python3 -m pip install --upgrade pip \
&& curl -sS https://dl.yarnpkg.com/debian/pubkey.gpg | apt-key add - \
&& apt upgrade -y \
&& mkdir -p $TARGDIR \
&& curl -L -s https://github.com/galaxyproject/galaxy/archive/dev.tar.gz | tar xzf - --strip-components=1 -C $TARGDIR \
&& git clone --recursive https://github.com/fubar2/planemo.git $PDIR \
&& cd $PDIR \
&& mkdir mytools \
&& rm -rf $PDIR/doc \
&& python3 setup.py build \
&& python3 setup.py install \
&& planemo conda_init --conda_prefix $PDIR/con \
&& hg clone https://fubar@toolshed.g2.bx.psu.edu/repos/fubar/tacrev  /planemo/tacrev \
&& planemo test --galaxy_root $TARGDIR /planemo/tacrev \
&& cp $TARGDIR/config/datatypes_conf.xml.sample $TARGDIR/config/datatypes_conf.xml \
&& sed -i 's/<\/registration>/<datatype extension="tgz" type="galaxy.datatypes.binary:Binary" subclass="true" mimetype="multipart\/x-gzip" display_in_upload="true"\/> <\/registration>/' $TARGDIR/config/datatypes_conf.xml \
&& sed -i 's/<datatype extension="html"/<datatype extension="html" display_in_upload="true"/' $TARGDIR/config/datatypes_conf.xml \
&& sed -i '/-l|-list|--list)/i\\t --dev-wheels|-dev-wheels)\n\t\t shift\n\t\t ;;\n' $TARGDIR/run_tests.sh \
&& apt-get clean && apt-get purge \
&&  rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*
ADD topics/dev/tutorials/tool-generators/docker/welcome.html $TARGDIR/static/welcome.html.sample
ADD topics/dev/tutorials/tool-generators/docker/welcome.html $TARGDIR/static/welcome.html


ENV GALAXY_CONFIG_BRAND "ToolFactory in Planemo"
EXPOSE 9090
ENTRYPOINT ["/usr/local/bin/planemo" ,"tool_factory", "--galaxy_root" ,"/galaxy-central", "--port", "9090", "--host", "0.0.0.0", "--conda_prefix", "/planemo/con", "--extra_tools", "/planemo/mytools"]

