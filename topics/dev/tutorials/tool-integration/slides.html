<!DOCTYPE html>
<html>






  <head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">
    <title>Tool development and integration into Galaxy</title>
    <link rel="stylesheet" href="/training-material/assets/css/slides.css">
    <link rel="stylesheet" href="/training-material/assets/css/font-awesome.css" id="theme">
  </head>
  <body>
    <textarea id="source">
name: inverse
layout: true
class: center, middle, inverse

<div class="my-footer"><span>

<img src="/training-material/assets/images/GTN-60px.png" alt="Galaxy Training Network" style="height: 40px;">

</span></div>

---

# Tool development and integration into Galaxy



---





### <img class="emoji" title=":grey_question:" alt=":grey_question:" src="https://assets-cdn.github.com/images/icons/emoji/unicode/2754.png" height="20" width="20"> Questions


- What is a tool for Galaxy?

- How to build a tool/wrapper with the good practices?

- How to deal with the tool environment?


---

### <img class="emoji" title=":dart:" alt=":dart:" src="https://assets-cdn.github.com/images/icons/emoji/unicode/1f3af.png" height="20" width="20"> Objectives


- Discover what is a wrapper and its structure

- Use the Planemo utilities to develop a good wrapper

- Deal with the dependencies

- Write functional tests

- Make a tool ready for publishing in a ToolShed


---

## A tool in Galaxy

---

### A tool in Galaxy

![](../../images/galaxy_instance_detailed_screenshot.png)

---

### Galaxy tool / wrapper

![](../../images/graphlan_screenshot.png)

```bash
graphlan.py --format "png" --size 7 input_tree.txt png_image.png
```

---

### Wrapper

- Description of the user interface
- Link between the underlying tool and the Galaxy instance
- How to invoke the tool
- Which files and options to pass
- Which files the tool will produce as output

---

### Wrapper

![](../../images/wrapper_layers.png)

???

1. `&lt;inputs&gt;` (datasets and parameters) specified in the tool XML are exposed in the Galaxy tool UI
2. When the user fills the form and click the `Execute` button, Galaxy fills the `&lt;command&gt;` template in the XML with the inputs entered by the user and execute the Cheetah code, producing a script as output
3. Galaxy creates a job for the generated script and executes it somewhere (bowtie is run in this case)
4. Some (not necessarily all) output files become new history datasets, as specified in the `&lt;outputs&gt;` XML tag set

---

### Wrapper

![](../../images/wrapper_big_picture_1.png)

???

- CDATA tags are used to prevent the interpretation of ampersands and less-than signs as XML special characters
- The tool name and description are combined in the left panel (tool menu), keep them short!

---

### Wrapper

![](../../images/wrapper_big_picture_2.png)

---

### Wrapper

![](../../images/wrapper_big_picture_3.png)

---

### Wrapper

Galaxy tool XML format is formally defined in a XML Schema Definition (XSD), used to generate the relative [online documentation](https://docs.galaxyproject.org/en/latest/dev/schema.html)

---

### `command`
#### How to invoke the tool?

```xml
&lt;command&gt;&lt;![CDATA[
graphlan.py
--format $format
#if $dpi
    --dpi $dpi
#end if
--size $size
'$input_tree'
]]&gt;&lt;/command&gt;
```

&lt;small&gt;If the script is provided with the wrapper xml&lt;/small&gt;
```xml
&lt;command&gt;&lt;![CDATA[
python '$__tool_directory__/graphlan.py'
# command params...
]]&gt;&lt;/command&gt;
```

???

- In the first case, `graphlan.py` is expected to be on the PATH when the job executes
- In the second case, `$__tool_directory__` is a special variable which is substituted by Galaxy with the directory where the tool XML is
- The `#if ... #end if` syntax comes from the [Cheetah](https://cheetahtemplate.org/) template language, which has a Python-like syntax

---

### `command`
#### How to pass the parameters?

![](../../images/graphlan_screenshot.png)

---

### `inputs` &gt; `param` to `command`
#### How to pass the parameters?

```xml
&lt;inputs&gt;
    &lt;param name="input_tree" type="data" label="..."/&gt;

    &lt;param argument="--dpi" type="integer" optional="true" label="..."
        help="For non vectorial formats" /&gt;
&lt;/inputs&gt;
```

???

- `name` identifies a parameter
- Parameters can have different types (`data`, `data_collection`, `integer`, `float`, `text`, `select`, `boolean`, `color`, `data_column`,...)
- The content `argument` is automatically added at the end of the displayed help
- When `argument` is specified and `name` is not, `name` is derived from `argument` by removing the initial dashes

---

### `inputs` &gt; `param` to `command`
#### Directly linked to `&lt;command&gt;`

```xml
&lt;command&gt;&lt;![CDATA[
graphlan.py
...
#if $dpi
    --dpi $dpi
#end if
'$input_tree'
...
]]&gt;&lt;/command&gt;
```

---

### `inputs` &gt; `param` &gt; `data`

![](../../images/input_data.png)

```xml
&lt;param name="..." type="data" format="txt" label="..." help="..." /&gt;
```

.footnote[[List of possible formats](https://github.com/galaxyproject/galaxy/blob/dev/config/datatypes_conf.xml.sample)]

---

### `inputs` &gt; `param` &gt; `integer` | `float`

![](../../images/input_integer.png)

```xml
&lt;param name="..." type="integer" value="7" label="..." help="..."/&gt;
```

![](../../images/input_integer_range.png)

```xml
&lt;param name="..." type="float" min="0" max="10" value="1" label="..."
    help="..."/&gt;
```

???

- In the first case, Galaxy creates a text box which accepts only integer values
- In the second case, since *both* `min` and `max` are specified, a slider is shown in addition

---

### `inputs` &gt; `param` &gt; `text`

![](../../images/input_text.png)

```xml
&lt;param name="..." type="text" value="" label="..." help="..."/&gt;
```

---

### `inputs` &gt; `param` &gt; `select`

![](../../images/input_select.png)

```xml
&lt;param name="..." type="select" label="..." help="..."&gt;
    &lt;option value="png" selected="true"&gt;PNG&lt;/option&gt;
    &lt;option value="pdf"&gt;PDF&lt;/option&gt;
    &lt;option value="ps"&gt;PS&lt;/option&gt;
    &lt;option value="eps"&gt;EPS&lt;/option&gt;
    &lt;option value="svg"&gt;SVG&lt;/option&gt;
&lt;/param&gt;
```

If no `option` has `selected="true"`, the first one is selected by default.

---

### `inputs` &gt; `param` &gt; `select`

![](../../images/input_select_checkboxes.png)

```xml
&lt;param name="..." type="select" display="radio" label="..." help="..."&gt;
    &lt;option value="min" selected="true"&gt;Minimum&lt;/option&gt;
    &lt;option value="mean"&gt;Mean&lt;/option&gt;
    &lt;option value="max"&gt;Max&lt;/option&gt;
    &lt;option value="sum"&gt;Sum&lt;/option&gt;
&lt;/param&gt;
```

---

### `inputs` &gt; `param` &gt; `select`

![](../../images/input_select_multiple.png)

```xml
&lt;param name="..." type="select" multiple="true" label="..." help="..."&gt;
    &lt;option value="ld" selected="true"&gt;Length distribution&lt;/option&gt;
    &lt;option value="gc" selected="true"&gt;GC content distribution&lt;/option&gt;
&lt;/param&gt;
```

---

### `inputs` &gt; `param` &gt; `boolean`

![](../../images/input_boolean.png)

```xml
&lt;param name="..." type="boolean" checked="false" truevalue="--log" falsevalue=""
    label="..." help="..." /&gt;
```

---

class: packed

### `inputs` &gt; `param` &gt; `conditional`

.image-75[ ![](../../images/input_conditional.png) ]

```xml
&lt;command&gt;&lt;![CDATA[
#if $fastq_input.selector == 'paired':
    '$fastq_input.input1' '$fastq_input.input2'
#else:
    '$fastq_input.input'
#end if
]]&gt;&lt;/command&gt;
&lt;inputs&gt;
    &lt;conditional name="fastq_input"&gt;
        &lt;param name="selector" type="select" label="Single or paired-end reads?"&gt;
            &lt;option value="paired"&gt;Paired-end&lt;/option&gt;
            &lt;option value="single"&gt;Single-end&lt;/option&gt;
        &lt;/param&gt;
        &lt;when value="paired"&gt;
            &lt;param name="input1" type="data" format="fastq" label="Forward reads" /&gt;
            &lt;param name="input2" type="data" format="fastq" label="Reverse reads" /&gt;
        &lt;/when&gt;
        &lt;when value="single"&gt;
            &lt;param name="input" type="data" format="fastq" label="Single reads" /&gt;
        &lt;/when&gt;
    &lt;/conditional&gt;
&lt;/inputs&gt;
```

---

class: packed

### `inputs` &gt; `param` &gt; `repeat`

![](../../images/input_repeat.png)

```xml
&lt;command&gt;&lt;![CDATA[
#for $i, $s in enumerate( $series )
    rank_of_series=$i
    input_path=${s.input}
    x_column=${s.xcol}
    y_column=${s.ycol}
#end for
]]&gt;&lt;/command&gt;

&lt;inputs&gt;
    &lt;repeat name="series" title="Series"&gt;
        &lt;param name="input" type="data" format="tabular" label="Dataset"/&gt;
        &lt;param name="xcol" type="data_column" data_ref="input" label="Column for x axis"/&gt;
        &lt;param name="ycol" type="data_column" data_ref="input" label="Column for y axis"/&gt;
    &lt;/repeat&gt;
&lt;/inputs&gt;
```

???

It makes sense to use a `&lt;repeat&gt;` block only if it contains multiple related parameters, otherwise adding `multiple="true"` is preferrable.

---

### `outputs`
#### Which files the tool will produce as output?

![](../../images/output.png)

---

### `outputs`

```xml
&lt;outputs&gt;
    &lt;data name="tree" format="txt" label="${tool.name} on ${on_string}: Tree" /&gt;
    &lt;data name="annotation" format="txt"
        label="${tool.name} on ${on_string}: Annotation" /&gt;
&lt;/outputs&gt;
```

???

`${tool.name} on ${on_string}` is the default output label, need to modify this if the tool generates more than 1 output

---

### `outputs` &gt; `filter`
#### Conditional

```xml
&lt;inputs&gt;
    &lt;param type="select" name="format" label="Output format"&gt;
        &lt;option value="png"&gt;PNG&lt;/option&gt;
        &lt;option value="pdf"&gt;PDF&lt;/option&gt;
    &lt;/param&gt;
&lt;/inputs&gt;
&lt;outputs&gt;
    &lt;data name="png_output" format="png" label="${tool.name} on ${on_string}: PNG"&gt;
        &lt;filter&gt;format == "png"&lt;/filter&gt;
    &lt;/data&gt;
    &lt;data name="pdf_output" format="pdf" label="${tool.name} on ${on_string}: PDF"&gt;
        &lt;filter&gt;format == "pdf"&lt;/filter&gt;
    &lt;/data&gt;
&lt;/outputs&gt;
```

???

N.B. If the filter expression raises an Exception, the dataset will NOT be filtered out

---

### `stdio`

Error if tool exit code is not 0 (default):
```xml
&lt;command detect_errors="exit_code"&gt; ... &lt;/command&gt;
```
Error if tool exit code is not 0 or either "Exception:" or "Error:" appears in standard error/output:
```xml
&lt;command detect_errors="aggressive"&gt; ... &lt;/command&gt;
```
If you need more precision:
```xml
&lt;stdio&gt;
    &lt;exit_code range=":-2" level="warning" description="Low disk space" /&gt;
    &lt;exit_code range="1:" level="fatal"  /&gt;
    &lt;regex match="Error:"  level="fatal" /&gt;
&lt;/stdio&gt;
&lt;command&gt; ... &lt;/command&gt;
```

&lt;small&gt;"Warning" level allows to add information to `stderr` without marking the dataset as failed&lt;/small&gt;

---

### `help`

![](../../images/help.png)

```xml
&lt;help&gt;&lt;![CDATA[

**What it does**
GraPhlAn is a software tool for producing high-quality circular
representations of taxonomic and phylogenetic trees. GraPhlAn focuses
on concise, integrative, informative, and publication-ready
representations of phylogenetically- and taxonomically-driven
investigation.

For more information, check the `user manual
&lt; https://bitbucket.org/nsegata/graphlan/overview &gt;`_.

]]&gt;&lt;/help&gt;
```

.footnote[[reStructuredText markup format](http://docutils.sourceforge.net/rst.html)]

---

### `citations`

![](../../images/citations.png)

```xml
&lt;citations&gt;
    &lt;citation type="doi"&gt;10.1093/bioinformatics/bts611&lt;/citation&gt;
    &lt;citation type="doi"&gt;10.1093/nar/gks1219&lt;/citation&gt;
    &lt;citation type="doi"&gt;10.1093/nar/gks1005&lt;/citation&gt;
    &lt;citation type="doi"&gt;10.1093/bioinformatics/btq461&lt;/citation&gt;
    &lt;citation type="doi"&gt;10.1038/nbt.2198&lt;/citation&gt;
&lt;/citations&gt;
```

&lt;small&gt;If no DOI is available, a BibTeX citation can be specified with `type="bibtex"`&lt;/small&gt;

---

### Tips and best practices

Always quote `text` and `data` parameters and output `data`

```xml
&lt;command&gt;&lt;![CDATA[
graphlan.py
...
'$input_tree'
'$png_output_image'
]]&gt;&lt;/command&gt;
```

- For security reasons
- Paths may contain spaces
- Prefer single quotes over double quotes

---

### Tips and best practices

Use `&amp;&amp;` to concatenate multiple commands

```xml
&lt;command&gt;&lt;![CDATA[
graphlan.py
--format '$format'
&amp;&amp;
echo "Yeah it worked!"
]]&gt;&lt;/command&gt;
```

&lt;small&gt;The job will exit on the first error encountered.&lt;/small&gt;

---

### Tips and best practices

Use the `argument` tag when a param name reflects the command line argument

```xml
&lt;param argument="--size" type="integer" value="7" label="..." help="..."/&gt;
```

- It will be printed at the end of the param help section
- No need to write `name="size"`, it is implicit

---

### Tips and best practices

Use sections to group related parameters

![](../../images/input_section.png)

```xml
&lt;section name="advanced" title="Advanced options" expanded="False"&gt;
    &lt;param argument="--size" type="integer" value="7" label="..." help="..."/&gt;
    ...
&lt;/section&gt;
```

---

![](../../images/planemo-logo.png)

&gt; Command-line utilities to assist in building and publishing Galaxy tools.

- [Documentation](https://planemo.readthedocs.io/en/latest/)
- [Tutorial](https://planemo.readthedocs.io/en/latest/writing_standalone.html)

---

###.image-25[![](../../images/planemo-logo.png)]

![](../../images/big_picture.png)

---

###.image-25[![](../../images/planemo-logo.png)]

#### `planemo tool_init`

Creates a skeleton of xml file

```bash
$ mkdir new_tool
$ cd new_tool
$ planemo tool_init --id 'some_short_id' --name 'My super tool'
```

Complicated version:

```bash
$ planemo tool_init --id 'samtools_sort' --name 'Samtools sort' \
          --description 'order of storing aligned sequences' \
          --requirement 'samtools@1.3.1' \
          --example_command "samtools sort -o '1_sorted.bam' '1.bam'" \
          --example_input 1.bam \
          --example_output 1_sorted.bam \
          --test_case \
          --version_command 'samtools --version | head -1' \
          --help_from_command 'samtools sort' \
          --doi '10.1093/bioinformatics/btp352'
```

---

class: packed

###.image-25[![](../../images/planemo-logo.png)]

#### `planemo lint`

Checks the syntax of a wrapper

```bash
$ planemo lint
```

```bash
Linting tool /opt/galaxy/tools/seqtk_seq.xml
Applying linter tests... CHECK
.. CHECK: 1 test(s) found.
Applying linter output... CHECK
.. INFO: 1 outputs found.
Applying linter inputs... CHECK
.. INFO: Found 1 input parameters.
Applying linter help... CHECK
.. CHECK: Tool contains help section.
.. CHECK: Help contains valid reStructuredText.
Applying linter general... CHECK
.. CHECK: Tool defines a version [0.1.0].
.. CHECK: Tool defines a name [Convert to FASTA (seqtk)].
.. CHECK: Tool defines an id [seqtk_seq].
Applying linter command... CHECK
.. INFO: Tool contains a command.
Applying linter citations... CHECK
.. CHECK: Found 1 likely valid citations.
```

---

###.image-25[![](../../images/planemo-logo.png)]

#### `planemo serve`

View your new tool in a local Galaxy instance

```bash
$ planemo serve
```

Open http://127.0.0.1:9090/ in your web browser to view your new tool

---

###.image-25[![](../../images/planemo-logo.png)]

#### Building Galaxy Tools

![](../../images/planemo_tool_building_lint.png)

---

## Functional tests

---

### Functional tests

- Functional testing is a quality assurance (QA) process.
- The tests comfort developers and users that the tools can run across different servers/architectures. And that the latest modifications don't break older features.
- Tools are tested by feeding them inputs and parameters and verifying the outputs (typically a diff)

---

### Functional tests
#### Good practices

1. Build tests using inputs/parameters/outputs
2. Run the tests --&gt; Failed --&gt; Coffee
3. Develop
4. Run the tests --&gt; Failed --&gt; Coffee
5. Develop
6. Run the tests --&gt; Succeed --&gt; Beer

---

### `tests`

```xml
&lt;tests&gt;
    &lt;test&gt;
        &lt;param name="input_tree" value="input_tree.txt"/&gt;
        &lt;param name="format" value="png"/&gt;
        &lt;param name="dpi" value="100"/&gt;
        &lt;param name="size" value="7"/&gt;
        &lt;param name="pad" value="2"/&gt;
        &lt;output name="png_output_image" file="png_image.png" /&gt;
    &lt;/test&gt;
&lt;/tests&gt;
```

&lt;small&gt;`input_tree.txt` and `png_image.png` must be in the `test-data/` directory&lt;/small&gt;

---

### Wrapper directory tree

```
graphlan/
├── graphlan.xml
├── graphlan.py
└── test-data/
    ├── input_tree.txt
    └── png_image.png

```

---

### `tests`
#### Comparison Methods: comparing to an expected result

```xml
&lt;output name="out_file1" file="cf_maf2fasta_concat.dat" ftype="fasta" /&gt;
```

.footnote[[Complete documentation](https://docs.galaxyproject.org/en/latest/dev/schema.html#tool-tests-test)]

---

### `tests`
#### Comparison Methods: comparing to an expected result

```xml
&lt;output ... compare="diff|re_match|sim_size|contains|re_match_multiline" ... /&gt;
```

.footnote[[Complete documentation](https://docs.galaxyproject.org/en/latest/dev/schema.html#tool-tests-test-output)]

---

### `tests`
#### Comparison Methods: comparing to an expected result

```xml
&lt;output ... compare="diff" lines_diff="4" /&gt;
```

.footnote[[Complete documentation](https://docs.galaxyproject.org/en/latest/dev/schema.html#tool-tests-test-output)]

---

### `tests`
#### Comparison Methods: comparing to an expected result

```xml
&lt;output ... compare="sim_size" delta="1000" /&gt;
```

.footnote[[Complete documentation](https://docs.galaxyproject.org/en/latest/dev/schema.html#tool-tests-test-output)]

---

### `tests`
#### Comparison Methods: comparing to an expected result

```xml
&lt;output ... md5="68b329da9893e34099c7d8ad5cb9c940" /&gt;
```

.footnote[[Complete documentation](https://docs.galaxyproject.org/en/latest/dev/schema.html#tool-tests-test-output)]

---

### `tests`
#### Comparison Methods: checking the content

```xml
&lt;output name="out_file1"&gt;
    &lt;assert_contents&gt;
        &lt;has_text text="chr7" /&gt;
        &lt;not_has_text text="chr8" /&gt;
        &lt;has_text_matching expression="1274\d+53" /&gt;
        &lt;has_line_matching expression=".*\s+127489808\s+127494553" /&gt;
        &lt;!-- &amp;#009; is XML escape code for tab --&gt;
        &lt;has_line line="chr7&amp;#009;127471195&amp;#009;127489808" /&gt;
        &lt;has_n_columns n="3" /&gt;
    &lt;/assert_contents&gt;
&lt;/output&gt;
```

.footnote[[Complete documentation](https://docs.galaxyproject.org/en/latest/dev/schema.html#tool-tests-test-output-assert-contents)]

---

### `tests`
#### Comparison Methods: checking the stdout/stderr

```xml
&lt;assert_stdout&gt;
    &lt;has_text text="Step 1... determine cutoff point" /&gt;
    &lt;has_text text="Step 2... estimate parameters of null distribution" /&gt;
&lt;/assert_stdout&gt;
```

.footnote[[Complete documentation](https://docs.galaxyproject.org/en/latest/dev/schema.html#tool-tests-test-output-assert-contents)]

---

### `tests`
#### Tests with conditionals, repeats, sections

```xml
&lt;tests&gt;
    &lt;test&gt;
        &lt;section name="advanced"&gt;
            &lt;repeat name="names"&gt;
                &lt;param name="first" value="Abraham"/&gt;
                &lt;param name="last" value="Lincoln"/&gt;
            &lt;/repeat&gt;
            &lt;repeat name="names"&gt;
                &lt;param name="first" value="Donald"/&gt;
                &lt;param name="last" value="Trump"/&gt;
            &lt;/repeat&gt;
            &lt;conditional name="image"&gt;
                &lt;param name="output_image" value="yes"/&gt;
                &lt;param name="format" value="png"/&gt;
            &lt;/conditional&gt;
        &lt;/section&gt;
        ...
    &lt;/test&gt;
&lt;/tests&gt;
```

---

###.image-25[![](../../images/planemo-logo.png)]

#### `planemo test`

Runs all functional tests

```bash
$ planemo test
```

An HTML report is automatically created with logs in case of failing test

---

###.image-25[![](../../images/planemo-logo.png)]

#### Test Galaxy Tools

![](../../images/planemo_tool_building_test.png)

---

## Dependencies

---

### Dependencies
#### How Galaxy will deal with dependencies?

![](../../images/galaxy_instance.png)

---

### Dependencies
#### Embedded tool

```
graphlan/
├── graphlan.xml
└── graphlan.py

```

```xml
&lt;command&gt;&lt;![CDATA[
$__tool_directory__/graphlan.py
...
]]&gt;&lt;/command&gt;
```

---

### Dependencies
#### External tool

Definition of requirements in `.xml` file

```xml
&lt;requirements&gt;
    &lt;requirement type="package" version="1.66"&gt;biopython&lt;/requirement&gt;
    &lt;requirement type="package" version="1.0.0"&gt;graphlan&lt;/requirement&gt;
&lt;/requirements&gt;
```

Local installation using Conda packages

---

![](../../../../shared/images/conda_logo.png)

Package, dependency and environment management

---

.image-50[![](../../../../shared/images/conda_logo.png)]

- Based on recipes describing how to install the software which are then built for their distribution
- No compilation at installation: binaries with their dependencies, libraries...
- Not restricted to Galaxy

See [Tool Dependencies and Conda](../conda/slides.html)

---

![](../../images/planemo-logo.png)

&gt; Command-line utilities to assist in building and publishing Galaxy tools.

---

### &lt;i class="fa fa-pencil" aria-hidden="true"&gt;&lt;/i&gt; Hands-on

![](../../images/exercise.png)

---

### &lt;i class="fa fa-pencil" aria-hidden="true"&gt;&lt;/i&gt; Hands-on

#### The Goal

.left[ Developing a wrapper for Seqtk: ]

.left[ A tool for processing sequence data in FASTA and FASTQ files ]

---

### &lt;i class="fa fa-pencil" aria-hidden="true"&gt;&lt;/i&gt; Hands-on

#### Steps

#### [http://planemo.readthedocs.io/en/latest/writing_standalone.html ](http://planemo.readthedocs.io/en/latest/writing_standalone.html)
1. [Launching the Appliance](http://planemo.readthedocs.io/en/latest/appliance.html#launching-the-appliance)
2. [The Basics](http://planemo.readthedocs.io/en/latest/writing_standalone.html#the-basics)
3. [Simple Parameters](http://planemo.readthedocs.io/en/latest/writing_standalone.html#simple-parameters)
4. [Conditional Parameters](http://planemo.readthedocs.io/en/latest/writing_standalone.html#conditional-parameters)

---

## Advanced features

---

### Other tags: `configfiles`

Like `command`, uses Cheetah code to write:

- A config file
- A whole script or a module
- Any text file needed for the tool execution

---

class: packed

### `configfiles`

```xml
&lt;command&gt;&lt;![CDATA[ mb $script_nexus ]]&gt;&lt;/command&gt;

&lt;configfiles&gt;
    &lt;configfile name="script_nexus"&gt;&lt;![CDATA[
set autoclose = yes;
execute $input_data;
#if str( $data_type.type ) == "nuc“
    lset nst=$data_type.lset_params.lset_Nst;
#end if
mcmcp ngen=$mcmcp_ngen;
mcmc;
quit
    ]]&gt;&lt;/configfile&gt;
&lt;/configfiles&gt;
```

```bash
set autoclose = yes;
execute dataset_42.dat;
lset nst=2 ;
mcmcp ngen=100000;
mcmc;
quit
```

---

### `macros`

![](../../images/macro.png)

.footnote[[Planemo documents about macros](https://planemo.readthedocs.io/en/latest/writing_advanced.html#macros-reusable-elements)]

---

class: packed

### `macros` &gt; `xml`

macros.xml

```xml
&lt;macros&gt;
    &lt;xml name="requirements"&gt;
        &lt;requirements&gt;
            &lt;requirement type="package" version="2.5.0"&gt;blast&lt;/requirement&gt;
        &lt;/requirements&gt;
    &lt;/xml&gt;
    &lt;xml name="stdio"&gt;
        &lt;stdio&gt;
            &lt;exit_code range="1" level="fatal" /&gt;
        &lt;/stdio&gt;
    &lt;/xml&gt;
&lt;/macros&gt;
```

ncbi_blastn_wrapper.xml

```xml
&lt;macros&gt;
    &lt;import&gt;macros.xml&lt;/import&gt;
&lt;/macros&gt;
&lt;expand macro="requirements"/&gt;
&lt;expand macro="stdio"/&gt;
```

---

### `macros` &gt; `token`

macros.xml

```xml
&lt;macros&gt;
    &lt;token name="@THREADS@"&gt;-num_threads "\${GALAXY_SLOTS:-8}"&lt;/token&gt;
&lt;/macros&gt;
```

ncbi_blastn_wrapper.xml

```xml
&lt;command&gt;
blastn -query '$query' @THREADS@ [...]
&lt;/command&gt;
```

---

### `macros` &gt; `yield`

macros.xml

```xml
&lt;macros&gt;
    &lt;xml name="requirements"&gt;
        &lt;requirements&gt;
            &lt;requirement type="package" version="2.2.0"&gt;trinity&lt;/requirement&gt;
            &lt;yield/&gt;
        &lt;/requirements&gt;
    &lt;/xml&gt;
&lt;/macros&gt;
```

trinity.xml

```xml
&lt;expand macro="requirements"&gt;
    &lt;requirement type="package" version="1.1.2"&gt;bowtie&lt;/requirement&gt;
    &lt;requirement type="set_environment"&gt;TRINITY_MEM_OPTIONS&lt;/requirement&gt;
&lt;/expand&gt;
```

---

### `command` &gt; Reserved Variables

```xml
&lt;command&gt;&lt;![CDATA[
# Email’s numeric ID (id column of galaxy_user table in the database)
echo $__user_id__

# User’s email address
echo $__user_email__

# The galaxy.app.UniverseApplication instance, gives access to all other configuration file variables.
# Should be used as a last resort, may go away in future releases.
echo $__app__.config.user_library_import_dir

# Check a dataset type
#if $input1.is_of_type('gff'):
    echo "input1 type is ${input1.datatype}"
#end if
]]&gt;&lt;/command&gt;
```
.footnote[[Reserved Variables List](https://docs.galaxyproject.org/en/latest/dev/schema.html#reserved-variables)]

---

### Multiple input

```xml
&lt;param name="..." type="data" format="txt" label="..." help="..." /&gt;
```

![](../../images/input_data.png)

Possible to select multiple dataset:

![](../../images/input_data_multiple.png)

- Useful to launch the same tool on multiple datasets independently
- One job per dataset

---

### Multiple input

```xml
&lt;param name="..." type="data" format="txt" multiple="true" label="..." help="..." /&gt;
```

![](../../images/input_data_multiple2.png)

In the command:

```xml
&lt;command&gt;&lt;![CDATA[
...
#for $input in $inputs
    --input "$input"
#end for
]]&gt;&lt;/command&gt;
```

One job for all selected dataset

---

### Multiple output

```xml
&lt;outputs&gt;
    &lt;data name="output" format="txt"&gt;
        &lt;discover_datasets pattern="__designation_and_ext__"
            directory="output_dir" visible="true" /&gt;
    &lt;/data&gt;
&lt;/outputs&gt;
```

- `__designation_and_ext__`: a predefined regexp,

- catches the dataset identifier + the datatype

If the output file extension is not present/usable:

```xml
&lt;outputs&gt;
    &lt;data name="output" format="txt"&gt;
        &lt;discover_datasets pattern="__designation__" format="txt"
            directory="output_dir" visible="true" /&gt;
    &lt;/data&gt;
&lt;/outputs&gt;
```

---

### Dataset collection

To group related datasets, and treat them as a single entity

- `list`: a simple list of datasets
- `paired`: a pair of datasets, `forward` and `reverse` for NGS
- composite: e.g. `list:paired` for a list of dataset pairs

Usage

- Useful to launch a workflow on many samples
- Sample names are kept along the workflow: `element_identifier`
- Galaxy tools are available to manipulate collections

---

.center[### Dataset collection]

.center[Creation from history]

.pull-left[
![](../../images/historyWithCheckboxes.png)
]

.pull-right[
![](../../images/buildPairs.png)
]

---

### Dataset collection

Creation when uploading (&gt;=17.05)

![](../../images/upload_collection.png)

---

### Dataset collection &gt; input

```xml
&lt;param name="inputs" type="data" format="bam" multiple="true" label="Input BAM(s)" /&gt;
```

![](../../images/input_data_collection.png)

Accept only collections:

```xml
&lt;param name="inputs" type="data_collection" collection_type="list|paired|list:paired|..."
    format="bam" label="Input BAM(s)" /&gt;
```

```xml
&lt;command&gt;&lt;![CDATA[
...
#for $input in $inputs
    --input '$input'
    --sample_name '$input.element_identifier'
#end for
]]&gt;&lt;/command&gt;
```

---

### Dataset collection &gt; output

A single paired collection:

```xml
&lt;collection name="paired_output" type="paired" label="Split Pair"&gt;
    &lt;data name="forward" format="txt" /&gt;
    &lt;data name="reverse" format_source="input1" from_work_dir="reverse.txt" /&gt;
&lt;/collection&gt;
```

Unknown number of files:

```xml
&lt;collection name="output" type="list" label="Unknown number of files"&gt;
    &lt;discover_datasets pattern="__name_and_ext__" directory="outputs" /&gt;
&lt;/collection&gt;
```


- `__name_and_ext__`: a predefined regexp,
- catches the dataset identifier + the datatype

---

## Some Config

---

### `job_conf.xml`

![](../../images/job_conf.xml_1.png)

8 is the default value if not set in destination

```bash
blastn -query foo_bar -num_threads 8
```

---

### `job_conf.xml`

![](../../images/job_conf.xml_2.png)

```bash
blastn -query foo_bar -num_threads 4
```

---

### Data tables

- They list all reference data used by tools
- e.g.: Blast databanks, BWA indexes, Fasta files
- Stored in `.loc` files
- Populated by hand or using Data Managers
- Data Managers are dedicated kind of Galaxy tools

---

### Using a data table in a tool

![](../../images/tool_data_table_conf.xml.png)

---

### Datatypes

- Every Galaxy dataset is associated with a datatype
- Datatype can be detected or user specified
- Gain of usability

.footnote[[Documentation: Adding Datatypes](https://galaxyproject.org/admin/datatypes/adding-datatypes/)]

---

.image-50[![](../../images/github_logo.png)]

.image-50[![](../../images/travis_ci_logo.png)]

.image-50[![](../../images/planemo-logo.png)]

.image-50[![](../../../../shared/images/conda_logo.png)]

---

### GitHub side

![](../../images/github_travis_github.png)

---

### Travis CI side

![](../../images/github_travis_travis.png)

---

.image-50[![](../../../../shared/images/ansible_logo.png)]

.image-50[![](../../../../shared/images/conda_logo.png)]

.image-50[![](../../../../shared/images/docker_logo.png)]

---

### Docker Galaxy Flavors

![](../../images/galaxydocker_logo.png)

.footnote[[Docker Galaxy Stable](https://github.com/bgruening/docker-galaxy-stable)]

---

### Docker Galaxy Flavors
#### Dockerfile

```yaml
# Galaxy - My own flavour
# VERSION       0.1

FROM quay.io/bgruening/galaxy:16.07

MAINTAINER Björn A. Grüning, bjoern.gruening@gmail.com

ENV GALAXY_CONFIG_BRAND deepTools

# Adding the tool definitions to the container
ADD my_tool_list.yml $GALAXY_ROOT/my_tool_list.yml

# Install deepTools
RUN install-tools $GALAXY_ROOT/my_tool_list.yml
```

---

### Docker Galaxy Flavors
#### tool_list.yml

```yaml
api_key: admin
galaxy_instance: http://127.0.0.1:8080/
tools:
- name: fastqc
  owner: devteam
  tool_panel_section_id: cshl_library_information
  tool_shed_url: https://toolshed.g2.bx.psu.edu
  revisions:
    - '8c650f7f76e9'  # v0.62
    - 'd2cf2c0c8a11'  # v0.63
- name: suite_deeptools
  owner: bgruening
  tool_panel_section_label: 'deepTools'
  tool_shed_url: https://toolshed.g2.bx.psu.edu
  revisions:
    - '7f5562625ae2'
```

---

### Docker Galaxy Flavors
#### RUN

```bash
docker run -d -p 8080:80 galaxy-deeptools
```

---

## Conclusion

---

### IUC: Intergalactic Utilities Commission

- Lobbyist :)
- Host orphan tools: [GitHub](https://github.com/galaxyproject/tools-iuc)
- [IUC-standards](https://galaxy-iuc-standards.readthedocs.io/)


---

### <img class="emoji" title=":grey_exclamation:" alt=":grey_exclamation:" src="https://assets-cdn.github.com/images/icons/emoji/unicode/2755.png" height="20" width="20"> Key points


- Galaxy Tool Syntax

- Use Planemo

- Use Conda

- Use GitHub

- Use Travis

- No more excuse to develop crappy Galaxy tools



---

## Thank you!

This material is the result of a collaborative work. Thanks the [Galaxy Training Network](https://wiki.galaxyproject.org/Teach/GTN) and all the contributors  (Saskia Hiltemann, Bérénice Batut, Anthony Bretaudeau, John Chilton, Nicola Soranzo, Björn Grüning, Gildas Le Corguillé) !


<img src="/training-material/assets/images/GTN.png" alt="Galaxy Training Network" style="height: 100px;">



.footnote[Found a typo? Something is wrong in this tutorial? <br>Edit it on [GitHub](https://github.com/galaxyproject/training-material/tree/master/topics/dev/tutorials/tool-integration/slides.html)]

    </textarea>
    <script src="/training-material/assets/js/remark-latest.min.js" type="text/javascript">
    </script>
    <script type="text/javascript">
      var slideshow = remark.create({navigation: {scroll: false,}});
      var hljs = remark.highlighter.engine;
    </script>
  </body>
</html>
