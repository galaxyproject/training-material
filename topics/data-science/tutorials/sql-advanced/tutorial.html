<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
        <title>Advanced SQL</title>
        
            <script async defer data-domain="training.galaxyproject.org" src="https://plausible.galaxyproject.eu/js/plausible.js"></script>

        
        <link rel="stylesheet" href="/training-material/assets/css/bootstrap.min.css?v=3">
        <link rel="stylesheet" href="/training-material/assets/css/bootstrap-toc.min.css">
        <link rel="stylesheet" href="/training-material/assets/css/main.css?v=2">
        <script src="https://kit.fontawesome.com/67b3f98409.js" crossorigin="anonymous"></script>
        <link rel="stylesheet" href="/training-material/assets/css/academicons.css">
        <link rel="stylesheet" href="/training-material/assets/css/syntax_highlighting.css">
        <link rel="shortcut icon" href="/training-material/favicon.ico" type="image/x-icon" />
        <link rel="alternate" type="application/atom+xml" href="/training-material/feed.xml" />

        
        
        
        
        
        <meta name="description" content="These lessons will help you get your feet in data science..." />
        <meta property="og:title" content="Galaxy Training: Advanced SQL" />
        <meta property="og:description" content="These lessons will help you get your feet in data science..." />
        <meta property="og:image" content="/training-material/assets/images/GTNLogo1000.png" />
    </head>
    <body data-spy="scroll" data-target="#toc">
        <header>
    <nav class="navbar navbar-expand-md navbar-dark" aria-label="Site Navigation">
        <div class="container">
            <a class="navbar-brand" href="/training-material/">
                <img src="/training-material/assets/images/GTN-60px.png" height="30" alt="Galaxy Training Network logo">
                Galaxy Training!
            </a>

            <button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse" data-target="#top-navbar" aria-controls="top-navbar" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="top-navbar">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        
                        <a class="nav-link" href="/training-material/topics/data-science" title="Go back to list of tutorials">
                            <i class="far fa-folder" aria-hidden="true"></i> Foundations of Data Science
                        </a>
                        
                    </li>
                    <li class="nav-item dropdown">
    <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown" aria-expanded="false" title="Help">
        <i class="far fa-question-circle" aria-hidden="true"></i><span class="visually-hidden">help</span> Help
    </a>
    <div class="dropdown-menu dropdown-menu-right">
        <!-- disable Tess for now
        <form method="get" action="https://tess.elixir-europe.org/materials">
            <input type="text" id="search" name="q" value="" style="margin-left: 0.5em;/*! border-radius: 0px; */">
            <input type="hidden" value="Galaxy Training" name="content_provider">
            <input type="submit" value="Search on TeSS" style="width: 92%;border-radius: 0px;margin: 0.5em;background: #f47d20;border: 0px;padding: 0.25em;" class="">
        </form>
        -->

        <a class="dropdown-item" href="/training-material/faq" title="Check our FAQs">
           <i class="far fa-question-circle" aria-hidden="true"></i><span class="visually-hidden">question</span> FAQs
        </a>
        
        <a class="dropdown-item" href="/training-material/topics/data-science/faqs/" title="Check our FAQs for the Foundations of Data Science topic">
           <i class="far fa-question-circle" aria-hidden="true"></i><span class="visually-hidden">question</span> Topic FAQs
        </a>
        
        <a class="dropdown-item" href="https://help.galaxyproject.org/" title="Discuss on Galaxy Help">
            <i class="far fa-comments" aria-hidden="true"></i><span class="visually-hidden">feedback</span> Galaxy Help Forum
        </a>
        <a class="dropdown-item" href="https://gitter.im/Galaxy-Training-Network/Lobby" title="Discuss on gitter">
           <i class="fab fa-gitter" aria-hidden="true"></i><span class="visually-hidden">gitter</span> Discuss on Gitter
        </a>
    </div>
</li>


                    <li class="nav-item dropdown">
    <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown" aria-expanded="false" title="Extras">
        <i class="far fa-star" aria-hidden="true"></i><span class="visually-hidden">galaxy-star</span> Extras
    </a>
    <div class="dropdown-menu dropdown-menu-right">

        
        <a class="dropdown-item" href="https://github.com/galaxyproject/training-material/edit/main/topics/data-science/tutorials/sql-advanced/tutorial.md" title="Edit on GitHub">
          <i class="fab fa-github" aria-hidden="true"></i><span class="visually-hidden">github</span> Edit on GitHub
        </a>

        <a class="dropdown-item" href="/training-material/stats.html" title="Show view statistics about this repository">
            <i class="fas fa-chart-bar" aria-hidden="true"></i><span class="visually-hidden">galaxy-barchart</span> GTN statistics
        </a>

        <a class="dropdown-item" href="https://plausible.galaxyproject.eu/training.galaxyproject.org?period=12mo&page=/training-material/topics/data-science/tutorials/sql-advanced/tutorial.html" title="Show view statistics of this page">
            <i class="fas fa-chart-bar" aria-hidden="true"></i><span class="visually-hidden">galaxy-barchart</span> Page Metrics
        </a>

        
            <a class="dropdown-item" href="/training-material/feedback.html" title="Show feedback statistics about this repository">
                <i class="fas fa-chart-bar" aria-hidden="true"></i><span class="visually-hidden">galaxy-barchart</span> GTN feedback
            </a>
        

        <div class="dropdown-item">
            <div>
                <i class="fas fa-language" aria-hidden="true"></i><span class="visually-hidden">language</span> Translate this page
            </div>

            <div id="lang-selector">
                
                <strong>Automatic Translations</strong>

<a class="btn btn-info" href="https://translate.google.com/translate?hl=jp&sl=en&tl=fr&u=https%3A%2F%2Ftraining.galaxyproject.org/topics/data-science/tutorials/sql-advanced/tutorial.html&edit-text=&act=url">
                Fran√ßais
                </a>
                
<a class="btn btn-info" href="https://translate.google.com/translate?hl=jp&sl=en&tl=ja&u=https%3A%2F%2Ftraining.galaxyproject.org/topics/data-science/tutorials/sql-advanced/tutorial.html&edit-text=&act=url">
                Êó•Êú¨Ë™û
                </a>
                
<a class="btn btn-info" href="https://translate.google.com/translate?hl=jp&sl=en&tl=es&u=https%3A%2F%2Ftraining.galaxyproject.org/topics/data-science/tutorials/sql-advanced/tutorial.html&edit-text=&act=url">
                Espa√±ol
                </a>
                
<a class="btn btn-info" href="https://translate.google.com/translate?hl=jp&sl=en&tl=pt&u=https%3A%2F%2Ftraining.galaxyproject.org/topics/data-science/tutorials/sql-advanced/tutorial.html&edit-text=&act=url">
                Portugu√™s
                </a>
                
<a class="btn btn-info" href="https://translate.google.com/translate?hl=jp&sl=en&tl=ar&u=https%3A%2F%2Ftraining.galaxyproject.org/topics/data-science/tutorials/sql-advanced/tutorial.html&edit-text=&act=url">
                ÿßŸÑÿπÿ±ÿ®Ÿäÿ©
                </a>
                
                <a class="btn btn-info" href="https://translate.google.com/translate?hl=jp&sl=en&tl=&u=https%3A%2F%2Ftraining.galaxyproject.org/topics/data-science/tutorials/sql-advanced/tutorial.html&edit-text=&act=url" title="">
                And more!
                </a>
            </div>
        </div>

        <div class="dropdown-item">
            <div>
                <i class="fas fa-palette" aria-hidden="true"></i><span class="visually-hidden">gtn-theme</span> Theme
            </div>

            <div id="theme-selector" data-toggle="buttons">
                <label data-value="default" class="btn btn-secondary">
                    <input type="radio" name="options" id="default" autocomplete="off"> Default
                </label>
                <label data-value="night" class="btn btn-secondary">
                    <input type="radio" name="options" id="night" autocomplete="off"> Night
                </label>
                <label data-value="midnight" class="btn btn-secondary">
                    <input type="radio" name="options" id="midnight" autocomplete="off"> Midnight
                </label>
                <label data-value="rainbow" class="btn btn-secondary">
                    <input type="radio" name="options" id="rainbow" autocomplete="off"> Rainbow
                </label>
                <label data-value="progress" class="btn btn-secondary">
                    <input type="radio" name="options" id="progress" autocomplete="off">üè≥Ô∏è‚Äçüåà
                </label>
                <label data-value="halloween" class="btn btn-secondary">
                    <input type="radio" name="options" id="halloween" autocomplete="off"> üéÉ
                </label>
                <label data-value="straya" class="btn btn-secondary">
                    <input type="radio" name="options" id="downunder" autocomplete="off"> üá¶üá∫
                </label>
            </div>

        </div>

        <div class="dropdown-item">
            <div>
                <i class="fas fa-history" aria-hidden="true"></i><span class="visually-hidden">galaxy-rulebuilder-history</span> Previous Versions
            </div>

            
            <div id="archive-selector">
            
                <a class="btn btn-warning" href="https://training.galaxyproject.org/archive/2021-10-01/topics/data-science/tutorials/sql-advanced/tutorial.html" title="Version 2021-10-01">2021-10-01</a>
            
                <a class="btn btn-warning" href="https://training.galaxyproject.org/archive/2021-09-01/topics/data-science/tutorials/sql-advanced/tutorial.html" title="Version 2021-09-01">2021-09-01</a>
            
                <a class="btn btn-warning" href="https://training.galaxyproject.org/archive/2021-08-01/topics/data-science/tutorials/sql-advanced/tutorial.html" title="Version 2021-08-01">2021-08-01</a>
            
                <a class="btn btn-warning" href="https://training.galaxyproject.org/archive/" title="Older Versions">Older Versions</a>
            </div>

        </div>

    </div>
</li>


                    <!-- Search bar-->
                    <li class="nav-item">
                      <div id="navbarSupportedContent" role="search">
                        <!-- Search form -->
                        <form class="form-inline mr-auto" method="GET" action="/training-material/search">
                          <i class="fas fa-search nav-link" aria-hidden="true"></i>
                          <div class="md-form mb-2">
                            <input name="query" class="form-control nicer" type="text" placeholder="Search Tutorials" aria-label="Search">
                          </div>
                        </form>
                      </div>
                    </li>
                </ul>
            </div>
        </div>
    </nav>
</header>

        <div class="container main-content" role="main">
        











<!-- Gitter -->




<script>
  ((window.gitter = {}).chat = {}).options = {
  room: 'Galaxy-Training-Network/Lobby'
  };
</script>
<script src="https://sidecar.gitter.im/dist/sidecar.v1.js" async defer></script>

<script type="application/ld+json">
    


{
  "@context": "http://schema.org",
  "@type": "Course",
  "accessMode": [
    "textual",
    "visual"
  ],
  "accessModeSufficient": [
    "textual",
    "visual"
  ],
  "accessibilityControl": [
    "fullKeyboardControl",
    "fullMouseControl"
  ],
  "accessibilityFeature": [
    "alternativeText",
    "tableOfContents"
  ],
  "accessibilitySummary": "Short descriptions are present but long descriptions will be needed for non-visual users",
  "audience": {
    "@type": "EducationalAudience",
    "educationalRole": "students"
  },
  "citation": {
    "@type": "CreativeWork",
    "name": "Community-Driven Data Analysis Training for Biology",
    "url": "https://doi.org/10.1016/j.cels.2018.05.012"
  },
  "copyrightHolder": {
    "@type": "Organization",
    "email": "galaxytrainingnetwork@gmail.com",
    "name": "Galaxy Training Network",
    "url": "https://galaxyproject.org/teach/gtn/"
  },
  "dateModified": "1970-01-01 00:33:41 +0000",
  "discussionUrl": "https://gitter.im/Galaxy-Training-Network/Lobby",
  "headline": "Advanced SQL",
  "interactivityType": "mixed",
  "isAccessibleForFree": true,
  "isFamilyFriendly": true,
  "license": "https://spdx.org/licenses/CC-BY-4.0.html",
  "producer": {
    "@type": "Organization",
    "email": "galaxytrainingnetwork@gmail.com",
    "name": "Galaxy Training Network",
    "url": "https://galaxyproject.org/teach/gtn/"
  },
  "provider": {
    "@type": "Organization",
    "email": "galaxytrainingnetwork@gmail.com",
    "name": "Galaxy Training Network",
    "url": "https://galaxyproject.org/teach/gtn/"
  },
  "sourceOrganization": {
    "@type": "Organization",
    "email": "galaxytrainingnetwork@gmail.com",
    "name": "Galaxy Training Network",
    "url": "https://galaxyproject.org/teach/gtn/"
  },
  "isPartOf": {
    "@type": "CreativeWork",
    "name": "Foundations of Data Science",
    "description": "These lessons will help you get your feet in data science and give you tools to help you slice and dice your data into results.",
    "url": "https://training.galaxyproject.org//training-material/topics/data-science/"
  },
  "courseCode": "data-science / sql-advanced / hands-on",
  "learningResourceType": "hands-on tutorial",
  "name": "Hands-on for 'Advanced SQL' tutorial",
  "url": "https://training.galaxyproject.org//training-material/topics/data-science/tutorials/sql-advanced/tutorial.html",
  "timeRequired": "PT3H",
  "keywords": "SQL, jupyter-notebook",
  "description": "The questions this  addresses are:\n - How can I calculate sums, averages, and other summary values?\n - How can I combine data from multiple tables?\n - How should I format data in a database, and why?\n - How can I create, modify, and delete tables and data?\n - How can I access databases from programs written in Python?\n\n\\nThe objectives are:\n - Define aggregation and give examples of its use.\n - Write queries that compute aggregated values.\n - Trace the execution of a query that performs aggregation.\n - Explain how missing data is handled during aggregation.\n - Explain the operation of a query that joins two tables.\n - Explain how to restrict the output of a query containing a join to only include meaningful combinations of values.\n - Write queries that join tables on equal keys.\n - Explain what primary and foreign keys are, and why they are useful.\n - Explain what an atomic value is.\n - Distinguish between atomic and non-atomic values.\n - Explain why every value in a database should be atomic.\n - Explain what a primary key is and why every record should have one.\n - Identify primary keys in database tables.\n - Explain why database entries should not contain redundant information.\n - Identify redundant information in databases.\n - Write statements that create tables.\n - Write statements to insert, modify, and delete records.\n - Write short programs that execute SQL queries.\n - Trace the execution of a program that contains an SQL query.\n - Explain why most database applications are written in a general-purpose language rather than in SQL.\n\n",
  "inLanguage": {
    "@type": "Language",
    "name": "English",
    "alternateName": "en"
  },
  "coursePrerequisites": [
    {
      "@type": "Course",
      "url": "https://training.galaxyproject.org//training-material/topics/data-science/tutorials/sql-basic/tutorial.html",
      "name": "Introduction to SQL",
      "description": "Hands-on for 'Introduction to SQL' tutorial",
      "learningResourceType": "hands-on tutorial",
      "interactivityType": "expositive",
      "provider": {
        "@type": "Organization",
        "email": "galaxytrainingnetwork@gmail.com",
        "name": "Galaxy Training Network",
        "url": "https://galaxyproject.org/teach/gtn/"
      }
    }
  ],
  "hasPart": [

  ],
  "author": [
    {
      "@type": "Person",
      "name": "The Carpentries"
    },
    {
      "@type": "Person",
      "name": "Helena Rasche"
    }
  ],
  "contributor": [
    {
      "@type": "Person",
      "name": "The Carpentries"
    },
    {
      "@type": "Person",
      "name": "Helena Rasche"
    }
  ],
  "about": [
    {
      "@type": "CreativeWork",
      "name": "Foundations of Data Science",
      "description": "These lessons will help you get your feet in data science and give you tools to help you slice and dice your data into results.",
      "url": "https://training.galaxyproject.org//training-material/topics/data-science/"
    }
  ],
  "skillLevel": "Introductory"
}
</script>

<section class="tutorial topic-data-science">
    <h1 data-toc-skip>Advanced SQL</h1>
    

    <div class="contributors-line">Authors: <a href="/training-material/hall-of-fame/carpentries/" class="contributor-badge contributor-carpentries"><img src="https://avatars.githubusercontent.com/carpentries?s=27" alt="Avatar">The Carpentries</a><a href="/training-material/hall-of-fame/hexylena/" class="contributor-badge contributor-hexylena"><img src="https://avatars.githubusercontent.com/hexylena?s=27" alt="Avatar">Helena Rasche</a></div>

    <blockquote class="overview">
        <h3>Overview</h3>
        
        <img alt="Creative Commons License" class="float-right" style="border-width:0; display: inline-block; margin:0" src="https://i.creativecommons.org/l/by/4.0/88x31.png" aria-hidden="true" />
        
        <strong><i class="far fa-question-circle" aria-hidden="true"></i> Questions:</strong>
        <ul>
        
        <li><p>How can I calculate sums, averages, and other summary values?</p>
</li>
        
        <li><p>How can I combine data from multiple tables?</p>
</li>
        
        <li><p>How should I format data in a database, and why?</p>
</li>
        
        <li><p>How can I create, modify, and delete tables and data?</p>
</li>
        
        <li><p>How can I access databases from programs written in Python?</p>
</li>
        
        </ul>

        <strong><i class="fas fa-bullseye" aria-hidden="true"></i> Objectives: </strong>
        <ul>
        
        <li><p>Define aggregation and give examples of its use.</p>
</li>
        
        <li><p>Write queries that compute aggregated values.</p>
</li>
        
        <li><p>Trace the execution of a query that performs aggregation.</p>
</li>
        
        <li><p>Explain how missing data is handled during aggregation.</p>
</li>
        
        <li><p>Explain the operation of a query that joins two tables.</p>
</li>
        
        <li><p>Explain how to restrict the output of a query containing a join to only include meaningful combinations of values.</p>
</li>
        
        <li><p>Write queries that join tables on equal keys.</p>
</li>
        
        <li><p>Explain what primary and foreign keys are, and why they are useful.</p>
</li>
        
        <li><p>Explain what an atomic value is.</p>
</li>
        
        <li><p>Distinguish between atomic and non-atomic values.</p>
</li>
        
        <li><p>Explain why every value in a database should be atomic.</p>
</li>
        
        <li><p>Explain what a primary key is and why every record should have one.</p>
</li>
        
        <li><p>Identify primary keys in database tables.</p>
</li>
        
        <li><p>Explain why database entries should not contain redundant information.</p>
</li>
        
        <li><p>Identify redundant information in databases.</p>
</li>
        
        <li><p>Write statements that create tables.</p>
</li>
        
        <li><p>Write statements to insert, modify, and delete records.</p>
</li>
        
        <li><p>Write short programs that execute SQL queries.</p>
</li>
        
        <li><p>Trace the execution of a program that contains an SQL query.</p>
</li>
        
        <li><p>Explain why most database applications are written in a general-purpose language rather than in SQL.</p>
</li>
        
        </ul>

        
        <strong><i class="fas fa-check-circle" aria-hidden="true"></i> Requirements:</strong>
        <ul>
        
        
    <li>
    
        
        
        <a href="/training-material/topics/data-science">Foundations of Data Science</a>
        
            <ul>
                
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                            
                            <li> Introduction to SQL:
                            
                            
                                
                                     <a href="/training-material/topics/data-science/tutorials/sql-basic/tutorial.html"><i class="fas fa-laptop" aria-hidden="true"></i><span class="visually-hidden">tutorial</span> hands-on</a>
                                
                            
                            </li>
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                
            </ul>
        
    
    </li>

        </ul>
        

        
        <div><strong><i class="fas fa-hourglass-half" aria-hidden="true"></i> Time estimation:</strong> 3 hours</div>
        

        
        <div><strong><i class="fas fa-graduation-cap" aria-hidden="true"></i> Level: </strong>
        


 Introductory <span class="visually-hidden">Introductory</span>
<span class="level introductory" title="Introductory Tutorial">
  <i class="fas fa-graduation-cap" aria-hidden="true"></i> <i class="fas fa-graduation-cap" aria-hidden="true"></i> <i class="fas fa-graduation-cap" aria-hidden="true"></i>
</span>

</div>
        

        
        

        
        <div id="supporting-materials"><strong><i class="fa fa-external-link" aria-hidden="true"></i> Supporting Materials:</strong></div>
        <ul class="supporting_material">
            

            

            

            

            
                <li class="btn btn-default supporting_material">


    <a class="topic-icon" href="/training-material/topics/data-science/tutorials/sql-advanced/tutorial.md.ipynb" title="Notebooks" alt="Advanced SQL workflows">
        <i class="far fa-file-code" aria-hidden="true"></i> Jupyter Notebook
    </a>

</li>
            

            
            
            

            
        </ul>
        

        <div><strong><i class="far fa-calendar" aria-hidden="true"></i> Last modification:</strong> Oct 19, 2021 </div>
        <div><strong><i class="fas fa-balance-scale" aria-hidden="true"></i> License:</strong>
            
            <a rel="license" href="http://creativecommons.org/licenses/by/4.0/">Tutorial Content is licensed under Creative Commons Attribution 4.0 International License</a>
            
            <a rel="license" href="https://github.com/galaxyproject/training-material/blob/main/LICENSE.md">The GTN Framework is licensed under MIT</a>
        </div>
    </blockquote>

    <div class="container">
        <div class="row">
            <!-- sidebar, which will move to the top on a small screen -->
            <div class="col-sm-2">
                <nav id="toc" data-toggle="toc" class="sticky-top" aria-label="Table of Contents"></nav>
            </div>
            <div class="col-sm-10">
                
                <blockquote class="comment">
                    <h3><i class="far fa-comment-dots" aria-hidden="true"></i> Best viewed in a Jupyter Notebook</h3>
                    <p>
                        This tutorial is best viewed in a Jupyter notebook! You can load this notebook in Jupyter on one of the UseGalaxy.* servers<!--, or you can click to run it in MyBinder-->
                    </p>
                    <!--
                    <p><b>Launching on MyBinder</b>
                        Click here and the notebook will launch on MyBinder.org
                        <a href="https://mybinder.org/v2/gh/galaxyproject/training-material/main?filepath=training-material%2Ftopics%2Fdata-science%2Ftutorials%2Fsql-advanced%2Ftutorial.md.ipynb" title="Launch notebook on MyBinder"><img src="https://mybinder.org/badge_logo.svg" alt="My Binder Logo"/></a>
                    </p>
                    -->
                    <p><b>Launching the notebook in Jupyter in Galaxy</b>
                        <ol>
                            <li><a href="/training-material/faqs/galaxy/interactive_tools_jupyter_launch.html">Instructions to Launch JupyterLab</a></li>
                            <li>Open a Terminal in JupyterLab with <b>File -> New -> Terminal</b></li>
                            <li>Run <code>wget https://training.galaxyproject.org/training-material/topics/data-science/tutorials/sql-advanced/tutorial.md.ipynb</code></li>
                            <li>Select the notebook that appears in the list of files on the left.</li>
                        </ol>
                    </p>
                    <p><b>Downloading the notebook</b>
                        <ol>
                            <li>Right click this link: <a href="https://training.galaxyproject.org/training-material/topics/data-science/tutorials/sql-advanced/tutorial.md.ipynb">tutorial.ipynb</a></li>
                            <li>Save Link As..</li>
                        </ol>
                    </p>
                </blockquote>
                

                <blockquote class="comment">
  <h3 id="comment-comment"><i class="far fa-comment-dots" aria-hidden="true"></i><span class="visually-hidden">comment</span> Comment</h3>

  <p>This tutorial is <strong>significantly</strong> based on <a href="https://carpentries.org">the Carpentries</a> <a href="https://github.com/swcarpentry/sql-novice-survey/">Databases and SQL</a> lesson, which is licensed CC-BY 4.0.</p>

  <p>Abigail Cabunoc and Sheldon McKay (eds): ‚ÄúSoftware Carpentry: Using Databases and SQL.‚Äù  Version 2017.08, August 2017,
<a href="https://github.com/swcarpentry/sql-novice-survey">github.com/swcarpentry/sql-novice-survey</a>, <a href="https://doi.org/10.5281/zenodo.838776">https://doi.org/10.5281/zenodo.838776</a></p>

  <p>Adaptations have been made to make this work better in a GTN/<span class="notranslate">Galaxy</span> environment.</p>
</blockquote>

<blockquote class="agenda">
  <h3 id="agenda">Agenda</h3>

  <p>In this tutorial, we will cover:</p>

<ol id="markdown-toc">
  <li><a href="#aggregation" id="markdown-toc-aggregation">Aggregation</a>    <ol>
      <li><a href="#averaging-with-null" id="markdown-toc-averaging-with-null">Averaging with NULL</a></li>
    </ol>
  </li>
  <li><a href="#combining-data" id="markdown-toc-combining-data">Combining Data</a></li>
  <li><a href="#data-hygiene" id="markdown-toc-data-hygiene">Data Hygiene</a></li>
  <li><a href="#creating-and-modifying-data" id="markdown-toc-creating-and-modifying-data">Creating and Modifying Data</a></li>
</ol>

</blockquote>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">#</span> <span class="n">This</span> <span class="n">preamble</span> <span class="k">sets</span> <span class="n">up</span> <span class="n">the</span> <span class="k">sql</span> <span class="nv">"magic"</span> <span class="k">for</span> <span class="n">jupyter</span><span class="p">.</span> <span class="n">Use</span> <span class="o">%%</span><span class="k">sql</span> <span class="k">in</span> <span class="n">your</span> <span class="n">cells</span> <span class="k">to</span> <span class="k">write</span> <span class="k">sql</span><span class="o">!</span>
<span class="o">!</span><span class="n">python3</span> <span class="o">-</span><span class="n">m</span> <span class="n">pip</span> <span class="n">install</span> <span class="n">ipython</span><span class="o">-</span><span class="k">sql</span> <span class="n">sqlalchemy</span>
<span class="o">!</span><span class="n">wget</span> <span class="o">-</span><span class="k">c</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">swcarpentry</span><span class="p">.</span><span class="n">github</span><span class="p">.</span><span class="n">io</span><span class="o">/</span><span class="k">sql</span><span class="o">-</span><span class="n">novice</span><span class="o">-</span><span class="n">survey</span><span class="o">/</span><span class="n">files</span><span class="o">/</span><span class="n">survey</span><span class="p">.</span><span class="n">db</span>
<span class="n">import</span> <span class="n">sqlalchemy</span>
<span class="n">engine</span> <span class="o">=</span> <span class="n">sqlalchemy</span><span class="p">.</span><span class="n">create_engine</span><span class="p">(</span><span class="nv">"sqlite:///survey.db"</span><span class="p">)</span>
<span class="o">%</span><span class="n">load_ext</span> <span class="k">sql</span>
<span class="o">%</span><span class="k">sql</span> <span class="n">sqlite</span><span class="p">:</span><span class="o">///</span><span class="n">survey</span><span class="p">.</span><span class="n">db</span>
<span class="o">%</span><span class="n">config</span> <span class="n">SqlMagic</span><span class="p">.</span><span class="n">displaycon</span><span class="o">=</span><span class="k">False</span>
</code></pre></div></div>

<h1 id="aggregation">Aggregation</h1>

<p>We now want to calculate ranges and averages for our data.
We know how to select all of the dates from the <code class="language-plaintext highlighter-rouge">Visited</code> table:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="n">dated</span> <span class="k">FROM</span> <span class="n">Visited</span><span class="p">;</span>
</code></pre></div></div>

<p>but to combine them,
we must use an aggregation function
such as <code class="language-plaintext highlighter-rouge">min</code> or <code class="language-plaintext highlighter-rouge">max</code>.
Each of these functions takes a set of records as input,
and produces a single record as output:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="k">min</span><span class="p">(</span><span class="n">dated</span><span class="p">)</span> <span class="k">FROM</span> <span class="n">Visited</span><span class="p">;</span>
</code></pre></div></div>

<p><img src="../../images/carpentries-sql/sql-aggregation.svg" alt="SQL Aggregation. " loading="lazy" /></p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="k">max</span><span class="p">(</span><span class="n">dated</span><span class="p">)</span> <span class="k">FROM</span> <span class="n">Visited</span><span class="p">;</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">min</code> and <code class="language-plaintext highlighter-rouge">max</code> are just two of
the aggregation functions built into SQL.
Three others are <code class="language-plaintext highlighter-rouge">avg</code>,
<code class="language-plaintext highlighter-rouge">count</code>,
and <code class="language-plaintext highlighter-rouge">sum</code>:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="k">avg</span><span class="p">(</span><span class="n">reading</span><span class="p">)</span> <span class="k">FROM</span> <span class="n">Survey</span> <span class="k">WHERE</span> <span class="n">quant</span> <span class="o">=</span> <span class="s1">'sal'</span><span class="p">;</span>
</code></pre></div></div>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="k">count</span><span class="p">(</span><span class="n">reading</span><span class="p">)</span> <span class="k">FROM</span> <span class="n">Survey</span> <span class="k">WHERE</span> <span class="n">quant</span> <span class="o">=</span> <span class="s1">'sal'</span><span class="p">;</span>
</code></pre></div></div>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="k">sum</span><span class="p">(</span><span class="n">reading</span><span class="p">)</span> <span class="k">FROM</span> <span class="n">Survey</span> <span class="k">WHERE</span> <span class="n">quant</span> <span class="o">=</span> <span class="s1">'sal'</span><span class="p">;</span>
</code></pre></div></div>

<p>We used <code class="language-plaintext highlighter-rouge">count(reading)</code> here,
but we could just as easily have counted <code class="language-plaintext highlighter-rouge">quant</code>
or any other field in the table,
or even used <code class="language-plaintext highlighter-rouge">count(*)</code>,
since the function doesn‚Äôt care about the values themselves,
just how many values there are.</p>

<p>SQL lets us do several aggregations at once.
We can,
for example,
find the range of sensible salinity measurements:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="k">min</span><span class="p">(</span><span class="n">reading</span><span class="p">),</span> <span class="k">max</span><span class="p">(</span><span class="n">reading</span><span class="p">)</span> <span class="k">FROM</span> <span class="n">Survey</span> <span class="k">WHERE</span> <span class="n">quant</span> <span class="o">=</span> <span class="s1">'sal'</span> <span class="k">AND</span> <span class="n">reading</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span>
</code></pre></div></div>

<p>We can also combine aggregated results with raw results,
although the output might surprise you:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="n">person</span><span class="p">,</span> <span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">FROM</span> <span class="n">Survey</span> <span class="k">WHERE</span> <span class="n">quant</span> <span class="o">=</span> <span class="s1">'sal'</span> <span class="k">AND</span> <span class="n">reading</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span>
</code></pre></div></div>

<p>Why does Lake‚Äôs name appear rather than Roerich‚Äôs or Dyer‚Äôs?
The answer is that when it has to aggregate a field,
but isn‚Äôt told how to,
the database manager chooses an actual value from the input set.
It might use the first one processed,
the last one,
or something else entirely.</p>

<p>Another important fact is that when there are no values to aggregate ‚Äî
for example, where there are no rows satisfying the <code class="language-plaintext highlighter-rouge">WHERE</code> clause ‚Äî
aggregation‚Äôs result is ‚Äúdon‚Äôt know‚Äù
rather than zero or some other arbitrary value:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="n">person</span><span class="p">,</span> <span class="k">max</span><span class="p">(</span><span class="n">reading</span><span class="p">),</span> <span class="k">sum</span><span class="p">(</span><span class="n">reading</span><span class="p">)</span> <span class="k">FROM</span> <span class="n">Survey</span> <span class="k">WHERE</span> <span class="n">quant</span> <span class="o">=</span> <span class="s1">'missing'</span><span class="p">;</span>
</code></pre></div></div>

<p>One final important feature of aggregation functions is that
they are inconsistent with the rest of SQL in a very useful way.
If we add two values,
and one of them is null,
the result is null.
By extension,
if we use <code class="language-plaintext highlighter-rouge">sum</code> to add all the values in a set,
and any of those values are null,
the result should also be null.
It‚Äôs much more useful,
though,
for aggregation functions to ignore null values
and only combine those that are non-null.
This behavior lets us write our queries as:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="k">min</span><span class="p">(</span><span class="n">dated</span><span class="p">)</span> <span class="k">FROM</span> <span class="n">Visited</span><span class="p">;</span>
</code></pre></div></div>

<p>instead of always having to filter explicitly:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="k">min</span><span class="p">(</span><span class="n">dated</span><span class="p">)</span> <span class="k">FROM</span> <span class="n">Visited</span> <span class="k">WHERE</span> <span class="n">dated</span> <span class="k">IS</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">;</span>
</code></pre></div></div>

<p>Aggregating all records at once doesn‚Äôt always make sense.
For example,
suppose we suspect that there is a systematic bias in our data,
and that some scientists‚Äô radiation readings are higher than others.
We know that this doesn‚Äôt work:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="n">person</span><span class="p">,</span> <span class="k">count</span><span class="p">(</span><span class="n">reading</span><span class="p">),</span> <span class="n">round</span><span class="p">(</span><span class="k">avg</span><span class="p">(</span><span class="n">reading</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
<span class="k">FROM</span>  <span class="n">Survey</span>
<span class="k">WHERE</span> <span class="n">quant</span> <span class="o">=</span> <span class="s1">'rad'</span><span class="p">;</span>
</code></pre></div></div>

<p>because the database manager selects a single arbitrary scientist‚Äôs name
rather than aggregating separately for each scientist.
Since there are only five scientists,
we could write five queries of the form:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="n">person</span><span class="p">,</span> <span class="k">count</span><span class="p">(</span><span class="n">reading</span><span class="p">),</span> <span class="n">round</span><span class="p">(</span><span class="k">avg</span><span class="p">(</span><span class="n">reading</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
<span class="k">FROM</span>  <span class="n">Survey</span>
<span class="k">WHERE</span> <span class="n">quant</span> <span class="o">=</span> <span class="s1">'rad'</span>
<span class="k">AND</span>   <span class="n">person</span> <span class="o">=</span> <span class="s1">'dyer'</span><span class="p">;</span>
</code></pre></div></div>

<p>but this would be tedious,
and if we ever had a data set with fifty or five hundred scientists,
the chances of us getting all of those queries right is small.</p>

<p>What we need to do is
tell the database manager to aggregate the hours for each scientist separately
using a <code class="language-plaintext highlighter-rouge">GROUP BY</code> clause:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span>   <span class="n">person</span><span class="p">,</span> <span class="k">count</span><span class="p">(</span><span class="n">reading</span><span class="p">),</span> <span class="n">round</span><span class="p">(</span><span class="k">avg</span><span class="p">(</span><span class="n">reading</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
<span class="k">FROM</span>     <span class="n">Survey</span>
<span class="k">WHERE</span>    <span class="n">quant</span> <span class="o">=</span> <span class="s1">'rad'</span>
<span class="k">GROUP</span> <span class="k">BY</span> <span class="n">person</span><span class="p">;</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">GROUP BY</code> does exactly what its name implies:
groups all the records with the same value for the specified field together
so that aggregation can process each batch separately.
Since all the records in each batch have the same value for <code class="language-plaintext highlighter-rouge">person</code>,
it no longer matters that the database manager
is picking an arbitrary one to display
alongside the aggregated <code class="language-plaintext highlighter-rouge">reading</code> values.</p>

<blockquote class="tip">
  <h3 id="tip-know-excel-its-just-a-pivot-table"><i class="far fa-lightbulb" aria-hidden="true"></i><span class="visually-hidden">tip</span> Know Excel? It‚Äôs just a pivot table.</h3>
  <p><code class="language-plaintext highlighter-rouge">GROUP BY</code> is basically just a pivot table for Excel users, it lets you build
nice summary tables which aggregate your results.</p>

  <p>And if you didn‚Äôt already know the Excel equivalent, now you know what to
look for when you need it!</p>
</blockquote>

<p>Just as we can sort by multiple criteria at once,
we can also group by multiple criteria.
To get the average reading by scientist and quantity measured,
for example,
we just add another field to the <code class="language-plaintext highlighter-rouge">GROUP BY</code> clause:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span>   <span class="n">person</span><span class="p">,</span> <span class="n">quant</span><span class="p">,</span> <span class="k">count</span><span class="p">(</span><span class="n">reading</span><span class="p">),</span> <span class="n">round</span><span class="p">(</span><span class="k">avg</span><span class="p">(</span><span class="n">reading</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
<span class="k">FROM</span>     <span class="n">Survey</span>
<span class="k">GROUP</span> <span class="k">BY</span> <span class="n">person</span><span class="p">,</span> <span class="n">quant</span><span class="p">;</span>
</code></pre></div></div>

<p>Note that we have added <code class="language-plaintext highlighter-rouge">quant</code> to the list of fields displayed,
since the results wouldn‚Äôt make much sense otherwise.</p>

<p>Let‚Äôs go one step further and remove all the entries
where we don‚Äôt know who took the measurement:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span>   <span class="n">person</span><span class="p">,</span> <span class="n">quant</span><span class="p">,</span> <span class="k">count</span><span class="p">(</span><span class="n">reading</span><span class="p">),</span> <span class="n">round</span><span class="p">(</span><span class="k">avg</span><span class="p">(</span><span class="n">reading</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
<span class="k">FROM</span>     <span class="n">Survey</span>
<span class="k">WHERE</span>    <span class="n">person</span> <span class="k">IS</span> <span class="k">NOT</span> <span class="k">NULL</span>
<span class="k">GROUP</span> <span class="k">BY</span> <span class="n">person</span><span class="p">,</span> <span class="n">quant</span>
<span class="k">ORDER</span> <span class="k">BY</span> <span class="n">person</span><span class="p">,</span> <span class="n">quant</span><span class="p">;</span>
</code></pre></div></div>

<p>Looking more closely,
this query:</p>

<ol>
  <li>selected records from the <code class="language-plaintext highlighter-rouge">Survey</code> table where the <code class="language-plaintext highlighter-rouge">person</code> field was not null;</li>
  <li>grouped those records into subsets so that the <code class="language-plaintext highlighter-rouge">person</code> and <code class="language-plaintext highlighter-rouge">quant</code> values in each subset were the same;</li>
  <li>ordered those subsets first by <code class="language-plaintext highlighter-rouge">person</code>, and then within each sub-group by <code class="language-plaintext highlighter-rouge">quant</code>; and</li>
  <li>counted the number of records in each subset, calculated the average <code class="language-plaintext highlighter-rouge">reading</code> in each, and chose a <code class="language-plaintext highlighter-rouge">person</code> and <code class="language-plaintext highlighter-rouge">quant</code> value from each (it doesn‚Äôt matter which ones, since they‚Äôre all equal).</li>
</ol>

<blockquote class="question">
  <h3 id="question-question-counting-temperature-readings"><i class="far fa-question-circle" aria-hidden="true"></i><span class="visually-hidden">question</span> Question: Counting Temperature Readings</h3>

  <p>How many temperature readings did Frank Pabodie record,
and what was their average value?</p>

  <blockquote class="solution">
    <h3 id="solution-solution"><i class="far fa-eye" aria-hidden="true"></i><span class="visually-hidden">solution</span> Solution</h3>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>SELECT count(reading), avg(reading) FROM Survey WHERE quant = 'temp' AND person = 'pb';
</code></pre></div>    </div>

    <table>
      <thead>
        <tr>
          <th>count(reading)</th>
          <th>avg(reading)</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>2</td>
          <td>-20.0</td>
        </tr>
      </tbody>
    </table>
  </blockquote>
</blockquote>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">-- Try solutions here!</span>
</code></pre></div></div>

<blockquote class="question">
  <h2 id="averaging-with-null">Averaging with NULL</h2>

  <p>The average of a set of values is the sum of the values
divided by the number of values.
Does this mean that the <code class="language-plaintext highlighter-rouge">avg</code> function returns 2.0 or 3.0
when given the values 1.0, <code class="language-plaintext highlighter-rouge">null</code>, and 5.0?</p>

  <blockquote class="solution">
    <h3 id="solution-solution-1"><i class="far fa-eye" aria-hidden="true"></i><span class="visually-hidden">solution</span> Solution</h3>
    <p>The answer is 3.0.
<code class="language-plaintext highlighter-rouge">NULL</code> is not a value; it is the absence of a value.
As such it is not included in the calculation.</p>

    <p>You can confirm this, by executing this code:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>SELECT AVG(a) FROM (
    SELECT 1 AS a
    UNION ALL SELECT NULL
    UNION ALL SELECT 5);
</code></pre></div>    </div>
  </blockquote>
</blockquote>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">-- Try solutions here!</span>
</code></pre></div></div>

<blockquote class="question">
  <h3 id="question-question-what-does-this-query-do"><i class="far fa-question-circle" aria-hidden="true"></i><span class="visually-hidden">question</span> Question: What Does This Query Do?</h3>

  <p>We want to calculate the difference between
each individual radiation reading
and the average of all the radiation readings.
We write the query:</p>

  <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>SELECT reading - avg(reading) FROM Survey WHERE quant = 'rad';
</code></pre></div>  </div>

  <p>What does this actually produce, and can you think of why?</p>

  <blockquote class="solution">
    <h3 id="solution-solution-2"><i class="far fa-eye" aria-hidden="true"></i><span class="visually-hidden">solution</span> Solution</h3>
    <p>The query produces only one row of results when we what we really want is a result for each of the readings.
The <code class="language-plaintext highlighter-rouge">avg()</code> function produces only a single value, and because it is run first, the table is reduced to a single row.
The <code class="language-plaintext highlighter-rouge">reading</code> value is simply an arbitrary one.</p>

    <p>To achieve what we wanted, we would have to run two queries:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>SELECT avg(reading) FROM Survey WHERE quant='rad';
</code></pre></div>    </div>

    <p>This produces the average value (6.5625), which we can then insert into a second query:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>SELECT reading - 6.5625 FROM Survey WHERE quant = 'rad';
</code></pre></div>    </div>

    <p>This produces what we want, but we can combine this into a single query using subqueries.</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>SELECT reading - (SELECT avg(reading) FROM Survey WHERE quant='rad') FROM Survey WHERE quant = 'rad';
</code></pre></div>    </div>

    <p>This way we don‚Äôt have execute two queries.</p>

    <p>In summary what we have done is to replace <code class="language-plaintext highlighter-rouge">avg(reading)</code> with <code class="language-plaintext highlighter-rouge">(SELECT avg(reading) FROM Survey WHERE quant='rad')</code> in the original query.</p>

  </blockquote>
</blockquote>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">-- Try solutions here!</span>
</code></pre></div></div>

<blockquote class="question">
  <h3 id="question-question-ordering-when-concatenating"><i class="far fa-question-circle" aria-hidden="true"></i><span class="visually-hidden">question</span> Question: Ordering When Concatenating</h3>

  <p>The function <code class="language-plaintext highlighter-rouge">group_concat(field, separator)</code>
concatenates all the values in a field
using the specified separator character
(or ‚Äò,‚Äô if the separator isn‚Äôt specified).
Use this to produce a one-line list of scientists‚Äô names,
such as:</p>

  <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>William Dyer, Frank Pabodie, Anderson Lake, Valentina Roerich, Frank Danforth
</code></pre></div>  </div>

  <p>Can you find a way to order the list by su<span class="notranslate">rna</span>me?</p>
</blockquote>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">-- Try solutions here!</span>
</code></pre></div></div>

<h1 id="combining-data">Combining Data</h1>

<p>In order to submit our data to a web site
that aggregates historical meteorological data,
we might need to format it as
latitude, longitude, date, quantity, and reading.
However,
our latitudes and longitudes are in the <code class="language-plaintext highlighter-rouge">Site</code> table,
while the dates of measurements are in the <code class="language-plaintext highlighter-rouge">Visited</code> table
and the readings themselves are in the <code class="language-plaintext highlighter-rouge">Survey</code> table.
We need to combine these tables somehow.</p>

<p>This figure shows the relations between the tables:</p>

<p><img src="../../images/carpentries-sql/sql-join-structure.svg" alt="Survey Database Structure. " loading="lazy" /></p>

<p>The SQL command to do this is <code class="language-plaintext highlighter-rouge">JOIN</code>.
To see how it works,
let‚Äôs start by joining the <code class="language-plaintext highlighter-rouge">Site</code> and <code class="language-plaintext highlighter-rouge">Visited</code> tables:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">Site</span> <span class="k">JOIN</span> <span class="n">Visited</span><span class="p">;</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">JOIN</code> creates
the cross product
of two tables,
i.e.,
it joins each record of one table with each record of the other table
to give all possible combinations.
Since there are three records in <code class="language-plaintext highlighter-rouge">Site</code>
and eight in <code class="language-plaintext highlighter-rouge">Visited</code>,
the join‚Äôs output has 24 records (3 * 8 = 24) .
And since each table has three fields,
the output has six fields (3 + 3 = 6).</p>

<p>What the join <em>hasn‚Äôt</em> done is
figure out if the records being joined have anything to do with each other.
It has no way of knowing whether they do or not until we tell it how.
To do that,
we add a clause specifying that
we‚Äôre only interested in combinations that have the same site name,
thus we need to use a filter:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">Site</span> <span class="k">JOIN</span> <span class="n">Visited</span> <span class="k">ON</span> <span class="n">Site</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">Visited</span><span class="p">.</span><span class="n">site</span><span class="p">;</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">ON</code> is very similar to <code class="language-plaintext highlighter-rouge">WHERE</code>,
and for all the queries in this lesson you can use them interchangeably.
There are differences in how they affect <a href="https://en.wikipedia.org/wiki/Join_%28SQL%29#Outer_join">outer joins</a>,
but that‚Äôs beyond the scope of this lesson.
Once we add this to our query,
the database manager throws away records
that combined information about two different sites,
leaving us with just the ones we want.</p>

<p>Notice that we used <code class="language-plaintext highlighter-rouge">Table.field</code> to specify field names
in the output of the join.
We do this because tables can have fields with the same name,
and we need to be specific which ones we‚Äôre talking about.
For example,
if we joined the <code class="language-plaintext highlighter-rouge">Person</code> and <code class="language-plaintext highlighter-rouge">Visited</code> tables,
the result would inherit a field called <code class="language-plaintext highlighter-rouge">id</code>
from each of the original tables.</p>

<p>We can now use the same dotted notation
to select the three columns we actually want
out of our join:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="n">Site</span><span class="p">.</span><span class="n">lat</span><span class="p">,</span> <span class="n">Site</span><span class="p">.</span><span class="n">long</span><span class="p">,</span> <span class="n">Visited</span><span class="p">.</span><span class="n">dated</span>
<span class="k">FROM</span>   <span class="n">Site</span> <span class="k">JOIN</span> <span class="n">Visited</span>
<span class="k">ON</span>     <span class="n">Site</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">Visited</span><span class="p">.</span><span class="n">site</span><span class="p">;</span>
</code></pre></div></div>

<p>If joining two tables is good,
joining many tables must be better.
In fact,
we can join any number of tables
simply by adding more <code class="language-plaintext highlighter-rouge">JOIN</code> clauses to our query,
and more <code class="language-plaintext highlighter-rouge">ON</code> tests to filter out combinations of records
that don‚Äôt make sense:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="n">Site</span><span class="p">.</span><span class="n">lat</span><span class="p">,</span> <span class="n">Site</span><span class="p">.</span><span class="n">long</span><span class="p">,</span> <span class="n">Visited</span><span class="p">.</span><span class="n">dated</span><span class="p">,</span> <span class="n">Survey</span><span class="p">.</span><span class="n">quant</span><span class="p">,</span> <span class="n">Survey</span><span class="p">.</span><span class="n">reading</span>
<span class="k">FROM</span>   <span class="n">Site</span> <span class="k">JOIN</span> <span class="n">Visited</span> <span class="k">JOIN</span> <span class="n">Survey</span>
<span class="k">ON</span>     <span class="n">Site</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">Visited</span><span class="p">.</span><span class="n">site</span>
<span class="k">AND</span>    <span class="n">Visited</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">Survey</span><span class="p">.</span><span class="n">taken</span>
<span class="k">AND</span>    <span class="n">Visited</span><span class="p">.</span><span class="n">dated</span> <span class="k">IS</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">;</span>
</code></pre></div></div>

<p>We can tell which records from <code class="language-plaintext highlighter-rouge">Site</code>, <code class="language-plaintext highlighter-rouge">Visited</code>, and <code class="language-plaintext highlighter-rouge">Survey</code>
correspond with each other
because those tables contain
primary keys
and foreign keys.
A primary key is a value,
or combination of values,
that uniquely identifies each record in a table.
A foreign key is a value (or combination of values) from one table
that identifies a unique record in another table.
Another way of saying this is that
a foreign key is the primary key of one table
that appears in some other table.
In our database,
<code class="language-plaintext highlighter-rouge">Person.id</code> is the primary key in the <code class="language-plaintext highlighter-rouge">Person</code> table,
while <code class="language-plaintext highlighter-rouge">Survey.person</code> is a foreign key
relating the <code class="language-plaintext highlighter-rouge">Survey</code> table‚Äôs entries
to entries in <code class="language-plaintext highlighter-rouge">Person</code>.</p>

<p>Most database designers believe that
every table should have a well-defined primary key.
They also believe that this key should be separate from the data itself,
so that if we ever need to change the data,
we only need to make one change in one place.
One easy way to do this is
to create an arbitrary, unique ID for each record
as we add it to the database.
This is actually very common:
those IDs have names like ‚Äústudent numbers‚Äù and ‚Äúpatient numbers‚Äù,
and they almost always turn out to have originally been
a unique record identifier in some database system or other.
As the query below demonstrates,
SQLite <a href="https://www.sqlite.org/lang_createtable.html#rowid">automatically numbers records</a> as they‚Äôre added to tables,
and we can use those record numbers in queries:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="n">rowid</span><span class="p">,</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">Person</span><span class="p">;</span>
</code></pre></div></div>

<blockquote class="question">
  <h3 id="question-question-listing-radiation-readings"><i class="far fa-question-circle" aria-hidden="true"></i><span class="visually-hidden">question</span> Question: Listing Radiation Readings</h3>

  <p>Write a query that lists all radiation readings from the DR-1 site.</p>
  <blockquote class="solution">
    <h3 id="solution-solution-3"><i class="far fa-eye" aria-hidden="true"></i><span class="visually-hidden">solution</span> Solution</h3>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>SELECT Survey.reading
FROM Site JOIN Visited JOIN Survey
ON Site.name = Visited.site
AND Visited.id = Survey.taken
WHERE Site.name = 'DR-1'
AND Survey.quant = 'rad';
</code></pre></div>    </div>

    <table>
      <thead>
        <tr>
          <th>reading</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>9.82</td>
        </tr>
        <tr>
          <td>7.8</td>
        </tr>
        <tr>
          <td>11.25</td>
        </tr>
      </tbody>
    </table>
  </blockquote>
</blockquote>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">-- Try solutions here!</span>
</code></pre></div></div>

<blockquote class="question">
  <h3 id="question-question-wheres-frank"><i class="far fa-question-circle" aria-hidden="true"></i><span class="visually-hidden">question</span> Question: Where‚Äôs Frank?</h3>

  <p>Write a query that lists all sites visited by people named ‚ÄúFrank‚Äù.</p>
  <blockquote class="solution">
    <h3 id="solution-solution-4"><i class="far fa-eye" aria-hidden="true"></i><span class="visually-hidden">solution</span> Solution</h3>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>SELECT DISTINCT Site.name
FROM Site JOIN Visited JOIN Survey JOIN Person
ON Site.name = Visited.site
AND Visited.id = Survey.taken
AND Survey.person = Person.id
WHERE Person.personal = 'Frank';
</code></pre></div>    </div>

    <table>
      <thead>
        <tr>
          <th>name</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>DR-3</td>
        </tr>
      </tbody>
    </table>
  </blockquote>
</blockquote>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">-- Try solutions here!</span>
</code></pre></div></div>

<blockquote class="question">
  <h3 id="question-question-reading-queries"><i class="far fa-question-circle" aria-hidden="true"></i><span class="visually-hidden">question</span> Question: Reading Queries</h3>

  <p>Describe in your own words what the following query produces:</p>

  <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>SELECT Site.name FROM Site JOIN Visited
ON Site.lat &lt; -49.0 AND Site.name = Visited.site AND Visited.dated &gt;= '1932-01-01';
</code></pre></div>  </div>
</blockquote>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">-- Try solutions here!</span>
</code></pre></div></div>

<blockquote class="question">
  <h3 id="question-question-who-has-been-where"><i class="far fa-question-circle" aria-hidden="true"></i><span class="visually-hidden">question</span> Question: Who Has Been Where?</h3>

  <p>Write a query that shows each site with exact location (lat, long) ordered by visited date,
followed by personal name and family name of the person who visited the site
and the type of measurement taken and its reading. Please avoid all null values.
Tip: you should get 15 records with 8 fields.</p>
  <blockquote class="solution">
    <h3 id="solution-solution-5"><i class="far fa-eye" aria-hidden="true"></i><span class="visually-hidden">solution</span> Solution</h3>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>SELECT Site.name, Site.lat, Site.long, Person.personal, Person.family, Survey.quant, Survey.reading, Visited.dated
FROM Site JOIN Visited JOIN Survey JOIN Person
ON Site.name = Visited.site
AND Visited.id = Survey.taken
AND Survey.person = Person.id
WHERE Survey.person IS NOT NULL
AND Visited.dated IS NOT NULL
ORDER BY Visited.dated;
</code></pre></div>    </div>

    <table>
      <thead>
        <tr>
          <th>name</th>
          <th>lat</th>
          <th>long</th>
          <th>personal</th>
          <th>family</th>
          <th>quant</th>
          <th>reading</th>
          <th>dated</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>DR-1</td>
          <td>-49.85</td>
          <td>-128.57</td>
          <td>William</td>
          <td>Dyer</td>
          <td>rad</td>
          <td>9.82</td>
          <td>1927-02-08</td>
        </tr>
        <tr>
          <td>DR-1</td>
          <td>-49.85</td>
          <td>-128.57</td>
          <td>William</td>
          <td>Dyer</td>
          <td>sal</td>
          <td>0.13</td>
          <td>1927-02-08</td>
        </tr>
        <tr>
          <td>DR-1</td>
          <td>-49.85</td>
          <td>-128.57</td>
          <td>William</td>
          <td>Dyer</td>
          <td>rad</td>
          <td>7.8</td>
          <td>1927-02-10</td>
        </tr>
        <tr>
          <td>DR-1</td>
          <td>-49.85</td>
          <td>-128.57</td>
          <td>William</td>
          <td>Dyer</td>
          <td>sal</td>
          <td>0.09</td>
          <td>1927-02-10</td>
        </tr>
        <tr>
          <td>DR-3</td>
          <td>-47.15</td>
          <td>-126.72</td>
          <td>Anderson</td>
          <td>Lake</td>
          <td>sal</td>
          <td>0.05</td>
          <td>1930-01-07</td>
        </tr>
        <tr>
          <td>DR-3</td>
          <td>-47.15</td>
          <td>-126.72</td>
          <td>Frank</td>
          <td>Pabodie</td>
          <td>rad</td>
          <td>8.41</td>
          <td>1930-01-07</td>
        </tr>
        <tr>
          <td>DR-3</td>
          <td>-47.15</td>
          <td>-126.72</td>
          <td>Frank</td>
          <td>Pabodie</td>
          <td>temp</td>
          <td>-21.5</td>
          <td>1930-01-07</td>
        </tr>
        <tr>
          <td>DR-3</td>
          <td>-47.15</td>
          <td>-126.72</td>
          <td>Frank</td>
          <td>Pabodie</td>
          <td>rad</td>
          <td>7.22</td>
          <td>1930-01-12</td>
        </tr>
        <tr>
          <td>DR-3</td>
          <td>-47.15</td>
          <td>-126.72</td>
          <td>Anderson</td>
          <td>Lake</td>
          <td>sal</td>
          <td>0.1</td>
          <td>1930-02-26</td>
        </tr>
        <tr>
          <td>DR-3</td>
          <td>-47.15</td>
          <td>-126.72</td>
          <td>Frank</td>
          <td>Pabodie</td>
          <td>rad</td>
          <td>4.35</td>
          <td>1930-02-26</td>
        </tr>
        <tr>
          <td>DR-3</td>
          <td>-47.15</td>
          <td>-126.72</td>
          <td>Frank</td>
          <td>Pabodie</td>
          <td>temp</td>
          <td>-18.5</td>
          <td>1930-02-26</td>
        </tr>
        <tr>
          <td>MSK-4</td>
          <td>-48.87</td>
          <td>-123.4</td>
          <td>Anderson</td>
          <td>Lake</td>
          <td>rad</td>
          <td>1.46</td>
          <td>1932-01-14</td>
        </tr>
        <tr>
          <td>MSK-4</td>
          <td>-48.87</td>
          <td>-123.4</td>
          <td>Anderson</td>
          <td>Lake</td>
          <td>sal</td>
          <td>0.21</td>
          <td>1932-01-14</td>
        </tr>
        <tr>
          <td>MSK-4</td>
          <td>-48.87</td>
          <td>-123.4</td>
          <td>Valentina</td>
          <td>Roerich</td>
          <td>sal</td>
          <td>22.5</td>
          <td>1932-01-14</td>
        </tr>
        <tr>
          <td>DR-1</td>
          <td>-49.85</td>
          <td>-128.57</td>
          <td>Valentina</td>
          <td>Roerich</td>
          <td>rad</td>
          <td>11.25</td>
          <td>1932-03-22</td>
        </tr>
      </tbody>
    </table>
  </blockquote>
</blockquote>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">-- Try solutions here!</span>
</code></pre></div></div>

<p>A good visual explanation of joins can be found <a href="https://sql-joins.leopard.in.ua/">here</a></p>

<h1 id="data-hygiene">Data Hygiene</h1>

<p>Now that we have seen how joins work, we can see why the relational
model is so useful and how best to use it.  The first rule is that
every value should be atomic, i.e., not
contain parts that we might want to work with separately.  We store
personal and family names in separate columns instead of putting the
entire name in one column so that we don‚Äôt have to use substring
operations to get the name‚Äôs components.  More importantly, we store
the two parts of the name separately because splitting on spaces is
unreliable: just think of a name like ‚ÄúEloise St. Cyr‚Äù or ‚ÄúJan Mikkel
Steubart‚Äù.</p>

<p>The second rule is that every record should have a unique primary key.
This can be a serial number that has no intrinsic meaning,
one of the values in the record (like the <code class="language-plaintext highlighter-rouge">id</code> field in the <code class="language-plaintext highlighter-rouge">Person</code> table),
or even a combination of values:
the triple <code class="language-plaintext highlighter-rouge">(taken, person, quant)</code> from the <code class="language-plaintext highlighter-rouge">Survey</code> table uniquely identifies every measurement.</p>

<p>The third rule is that there should be no redundant information.
For example,
we could get rid of the <code class="language-plaintext highlighter-rouge">Site</code> table and rewrite the <code class="language-plaintext highlighter-rouge">Visited</code> table like this:</p>

<table>
  <thead>
    <tr>
      <th>id</th>
      <th>lat</th>
      <th>long</th>
      <th>dated</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>619</td>
      <td>-49.85</td>
      <td>-128.57</td>
      <td>1927-02-08</td>
    </tr>
    <tr>
      <td>622</td>
      <td>-49.85</td>
      <td>-128.57</td>
      <td>1927-02-10</td>
    </tr>
    <tr>
      <td>734</td>
      <td>-47.15</td>
      <td>-126.72</td>
      <td>1930-01-07</td>
    </tr>
    <tr>
      <td>735</td>
      <td>-47.15</td>
      <td>-126.72</td>
      <td>1930-01-12</td>
    </tr>
    <tr>
      <td>751</td>
      <td>-47.15</td>
      <td>-126.72</td>
      <td>1930-02-26</td>
    </tr>
    <tr>
      <td>752</td>
      <td>-47.15</td>
      <td>-126.72</td>
      <td>None</td>
    </tr>
    <tr>
      <td>837</td>
      <td>-48.87</td>
      <td>-123.40</td>
      <td>1932-01-14</td>
    </tr>
    <tr>
      <td>844</td>
      <td>-49.85</td>
      <td>-128.57</td>
      <td>1932-03-22</td>
    </tr>
  </tbody>
</table>

<p>In fact,
we could use a single table that recorded all the information about each reading in each row,
just as a sp<span class="notranslate">reads</span>heet would.
The problem is that it‚Äôs very hard to keep data organized this way consistent:
if we realize that the date of a particular visit to a particular site is wrong,
we have to change multiple records in the database.
What‚Äôs worse,
we may have to guess which records to change,
since other sites may also have been visited on that date.</p>

<p>The fourth rule is that the units for every value should be stored explicitly.
Our database doesn‚Äôt do this,
and that‚Äôs a problem:
Roerich‚Äôs salinity measurements are several orders of magnitude larger than anyone else‚Äôs,
but we don‚Äôt know if that means she was using parts per million instead of parts per thousand,
or whether there actually was a saline anomaly at that site in 1932.</p>

<p>Stepping back,
data and the tools used to store it have a symbiotic relationship:
we use tables and joins because it‚Äôs efficient,
provided our data is organized a certain way,
but organize our data that way because we have tools to manipulate it efficiently.
As anthropologists say,
the tool shapes the hand that shapes the tool.</p>

<blockquote class="question">
  <h3 id="question-question-identifying-atomic-values"><i class="far fa-question-circle" aria-hidden="true"></i><span class="visually-hidden">question</span> Question: Identifying Atomic Values</h3>

  <p>Which of the following are atomic values? Which are not? Why?</p>

  <ul>
    <li>New Zealand</li>
    <li>87 Turing Avenue</li>
    <li>January 25, 1971</li>
    <li>the XY coordinate (0.5, 3.3)</li>
  </ul>

  <blockquote class="solution">
    <h3 id="solution-solution-6"><i class="far fa-eye" aria-hidden="true"></i><span class="visually-hidden">solution</span> Solution</h3>
    <p>New Zealand is the only clear-cut atomic value.</p>

    <p>The address and the XY coordinate contain more than one piece of information
which should be stored separately:</p>
    <ul>
      <li>House number, street name</li>
      <li>X coordinate, Y coordinate</li>
    </ul>

    <p>The date entry is less clear cut, because it contains month, day, and year elements.
However, there is a <code class="language-plaintext highlighter-rouge">DATE</code> datatype in SQL, and dates should be stored using this format.
If we need to work with the month, day, or year separately, we can use the SQL functions available for our database software
(for example <a href="https://docs.oracle.com/cd/B19306_01/server.102/b14200/functions050.htm"><code class="language-plaintext highlighter-rouge">EXTRACT</code></a> or <a href="http://www.sqlite.org/lang_datefunc.html"><code class="language-plaintext highlighter-rouge">STRFTIME</code></a> for SQLite).</p>
  </blockquote>
</blockquote>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">-- Try solutions here!</span>
</code></pre></div></div>

<blockquote class="question">
  <h3 id="question-question-identifying-a-primary-key"><i class="far fa-question-circle" aria-hidden="true"></i><span class="visually-hidden">question</span> Question: Identifying a Primary Key</h3>

  <p>What is the primary key in this table?
I.e., what value or combination of values uniquely identifies a record?</p>

  <table>
    <thead>
      <tr>
        <th>latitude</th>
        <th>longitude</th>
        <th>date</th>
        <th>temperature</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td>57.3</td>
        <td>-22.5</td>
        <td>2015-01-09</td>
        <td>-14.2</td>
      </tr>
    </tbody>
  </table>

  <blockquote class="solution">
    <h3 id="solution-solution-7"><i class="far fa-eye" aria-hidden="true"></i><span class="visually-hidden">solution</span> Solution</h3>
    <p>Latitude, longitude, and date are all required to uniquely identify the temperature record.</p>
  </blockquote>
</blockquote>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">-- Try solutions here!</span>
</code></pre></div></div>

<h1 id="creating-and-modifying-data">Creating and Modifying Data</h1>

<p>So far we have only looked at how to get information out of a database,
both because that is more frequent than adding information,
and because most other operations only make sense
once queries are understood.
If we want to create and modify data,
we need to know two other sets of commands.</p>

<p>The first pair are <a href="https://www.sqlite.org/lang_createtable.html"><code class="language-plaintext highlighter-rouge">CREATE TABLE</code></a> and <a href="https://www.sqlite.org/lang_droptable.html"><code class="language-plaintext highlighter-rouge">DROP TABLE</code></a>.
While they are written as two words,
they are actually single commands.
The first one creates a new table;
its arguments are the names and types of the table‚Äôs columns.
For example,
the following statements create the four tables in our survey database:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">Person</span><span class="p">(</span><span class="n">id</span> <span class="nb">text</span><span class="p">,</span> <span class="n">personal</span> <span class="nb">text</span><span class="p">,</span> <span class="n">family</span> <span class="nb">text</span><span class="p">);</span>
<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">Site</span><span class="p">(</span><span class="n">name</span> <span class="nb">text</span><span class="p">,</span> <span class="n">lat</span> <span class="nb">real</span><span class="p">,</span> <span class="n">long</span> <span class="nb">real</span><span class="p">);</span>
<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">Visited</span><span class="p">(</span><span class="n">id</span> <span class="nb">integer</span><span class="p">,</span> <span class="n">site</span> <span class="nb">text</span><span class="p">,</span> <span class="n">dated</span> <span class="nb">text</span><span class="p">);</span>
<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">Survey</span><span class="p">(</span><span class="n">taken</span> <span class="nb">integer</span><span class="p">,</span> <span class="n">person</span> <span class="nb">text</span><span class="p">,</span> <span class="n">quant</span> <span class="nb">text</span><span class="p">,</span> <span class="n">reading</span> <span class="nb">real</span><span class="p">);</span>
</code></pre></div></div>

<p>We can get rid of one of our tables using:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">DROP</span> <span class="k">TABLE</span> <span class="n">Survey</span><span class="p">;</span>
</code></pre></div></div>

<p>Be very careful when doing this:
if you drop the wrong table, hope that the person maintaining the database has a backup,
but it‚Äôs better not to have to rely on it.</p>

<p>Different database systems support different data types for table columns,
but most provide the following:</p>

<table>
  <thead>
    <tr>
      <th>data type</th>
      <th>use</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>INTEGER</td>
      <td>a signed integer</td>
    </tr>
    <tr>
      <td>REAL</td>
      <td>a floating point number</td>
    </tr>
    <tr>
      <td>TEXT</td>
      <td>a character string</td>
    </tr>
    <tr>
      <td>BLOB</td>
      <td>a ‚Äúbinary large object‚Äù, such as an image</td>
    </tr>
  </tbody>
</table>

<p>Most databases also support Booleans and date/time values;
SQLite uses the integers 0 and 1 for the former,
and represents the latter as text or numeric fields.</p>

<p>An increasing number of databases also support geographic data types,
such as latitude and longitude.
Keeping track of what particular systems do or do not offer,
and what names they give different data types,
is an unending portability headache.</p>

<blockquote class="tip">
  <h3 id="tip-which-database-should-i-use"><i class="far fa-lightbulb" aria-hidden="true"></i><span class="visually-hidden">tip</span> Which database should I use?</h3>
  <p>SQLite is fantastic for small databases or embedded into applications where
you want to be able to use SQL to query and process data.</p>

  <p>However for any real analysis PostgreSQL is usually the best choice, it
scales incredibly well and can meet a wide range of use cases. It has good
data type support.</p>
</blockquote>

<blockquote class="tip">
  <h3 id="tip-do-you-have-geographic-data"><i class="far fa-lightbulb" aria-hidden="true"></i><span class="visually-hidden">tip</span> Do you have geographic data?</h3>
  <p>Use Postgres. The <a href="https://postgis.net/">PostGIS</a> library is fantastic and industry standard for storing geographic data in a database.</p>
</blockquote>

<p>When we create a table,
we can specify several kinds of constraints on its columns.
For example,
a better definition for the <code class="language-plaintext highlighter-rouge">Survey</code> table would be:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">Survey</span><span class="p">(</span>
    <span class="n">taken</span>   <span class="nb">integer</span> <span class="k">not</span> <span class="k">null</span><span class="p">,</span> <span class="c1">-- where reading taken</span>
    <span class="n">person</span>  <span class="nb">text</span><span class="p">,</span>             <span class="c1">-- may not know who took it</span>
    <span class="n">quant</span>   <span class="nb">text</span> <span class="k">not</span> <span class="k">null</span><span class="p">,</span>    <span class="c1">-- the quantity measured</span>
    <span class="n">reading</span> <span class="nb">real</span> <span class="k">not</span> <span class="k">null</span><span class="p">,</span>    <span class="c1">-- the actual reading</span>
    <span class="k">primary</span> <span class="k">key</span><span class="p">(</span><span class="n">taken</span><span class="p">,</span> <span class="n">quant</span><span class="p">),</span>
    <span class="k">foreign</span> <span class="k">key</span><span class="p">(</span><span class="n">taken</span><span class="p">)</span> <span class="k">references</span> <span class="n">Visited</span><span class="p">(</span><span class="n">id</span><span class="p">),</span>
    <span class="k">foreign</span> <span class="k">key</span><span class="p">(</span><span class="n">person</span><span class="p">)</span> <span class="k">references</span> <span class="n">Person</span><span class="p">(</span><span class="n">id</span><span class="p">)</span>
<span class="p">);</span>
</code></pre></div></div>

<p>Once again,
exactly what constraints are available
and what they‚Äôre called
depends on which database manager we are using.</p>

<p>Once tables have been created,
we can add, change, and remove records using our other set of commands,
<code class="language-plaintext highlighter-rouge">INSERT</code>, <code class="language-plaintext highlighter-rouge">UPDATE</code>, and <code class="language-plaintext highlighter-rouge">DELETE</code>.</p>

<p>Here is an example of inserting rows into the <code class="language-plaintext highlighter-rouge">Site</code> table:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">Site</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">long</span><span class="p">)</span> <span class="k">VALUES</span> <span class="p">(</span><span class="s1">'DR-1'</span><span class="p">,</span> <span class="o">-</span><span class="mi">49</span><span class="p">.</span><span class="mi">85</span><span class="p">,</span> <span class="o">-</span><span class="mi">128</span><span class="p">.</span><span class="mi">57</span><span class="p">);</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">Site</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">long</span><span class="p">)</span> <span class="k">VALUES</span> <span class="p">(</span><span class="s1">'DR-3'</span><span class="p">,</span> <span class="o">-</span><span class="mi">47</span><span class="p">.</span><span class="mi">15</span><span class="p">,</span> <span class="o">-</span><span class="mi">126</span><span class="p">.</span><span class="mi">72</span><span class="p">);</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">Site</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">long</span><span class="p">)</span> <span class="k">VALUES</span> <span class="p">(</span><span class="s1">'MSK-4'</span><span class="p">,</span> <span class="o">-</span><span class="mi">48</span><span class="p">.</span><span class="mi">87</span><span class="p">,</span> <span class="o">-</span><span class="mi">123</span><span class="p">.</span><span class="mi">40</span><span class="p">);</span>
</code></pre></div></div>

<p>We can also insert values into one table directly from another:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">JustLatLong</span><span class="p">(</span><span class="n">lat</span> <span class="nb">real</span><span class="p">,</span> <span class="n">long</span> <span class="nb">real</span><span class="p">);</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">JustLatLong</span> <span class="k">SELECT</span> <span class="n">lat</span><span class="p">,</span> <span class="n">long</span> <span class="k">FROM</span> <span class="n">Site</span><span class="p">;</span>
</code></pre></div></div>

<p>Modifying existing records is done using the <code class="language-plaintext highlighter-rouge">UPDATE</code> statement.
To do this we tell the database which table we want to update,
what we want to change the values to for any or all of the fields,
and under what conditions we should update the values.</p>

<p>For example, if we made a mistake when entering the lat and long values
of the last <code class="language-plaintext highlighter-rouge">INSERT</code> statement above, we can correct it with an update:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">UPDATE</span> <span class="n">Site</span> <span class="k">SET</span> <span class="n">lat</span> <span class="o">=</span> <span class="o">-</span><span class="mi">47</span><span class="p">.</span><span class="mi">87</span><span class="p">,</span> <span class="n">long</span> <span class="o">=</span> <span class="o">-</span><span class="mi">122</span><span class="p">.</span><span class="mi">40</span> <span class="k">WHERE</span> <span class="n">name</span> <span class="o">=</span> <span class="s1">'MSK-4'</span><span class="p">;</span>
</code></pre></div></div>

<p>Be careful to not forget the <code class="language-plaintext highlighter-rouge">WHERE</code> clause or the update statement will
modify <em>all</em> of the records in the database.</p>

<p>Deleting records can be a bit trickier,
because we have to ensure that the database remains inte<span class="notranslate">rna</span>lly consistent.
If all we care about is a single table,
we can use the <code class="language-plaintext highlighter-rouge">DELETE</code> command with a <code class="language-plaintext highlighter-rouge">WHERE</code> clause
that matches the records we want to discard.
For example,
once we realize that Frank Danforth didn‚Äôt take any measurements,
we can remove him from the <code class="language-plaintext highlighter-rouge">Person</code> table like this:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">DELETE</span> <span class="k">FROM</span> <span class="n">Person</span> <span class="k">WHERE</span> <span class="n">id</span> <span class="o">=</span> <span class="s1">'danforth'</span><span class="p">;</span>
</code></pre></div></div>

<p>But what if we removed Anderson Lake instead?
Our <code class="language-plaintext highlighter-rouge">Survey</code> table would still contain seven records
of measurements he‚Äôd taken,
but that‚Äôs never supposed to happen:
<code class="language-plaintext highlighter-rouge">Survey.person</code> is a foreign key into the <code class="language-plaintext highlighter-rouge">Person</code> table,
and all our queries assume there will be a row in the latter
matching every value in the former.</p>

<p>This problem is called referential integrity:
we need to ensure that all references between tables can always be resolved correctly.
One way to do this is to delete all the records
that use <code class="language-plaintext highlighter-rouge">'lake'</code> as a foreign key
before deleting the record that uses it as a primary key.
If our database manager supports it,
we can automate this
using cascading delete.
However,
this technique is outside the scope of this chapter.</p>

<blockquote class="tip">
  <h3 id="tip-hybrid-storage-models"><i class="far fa-lightbulb" aria-hidden="true"></i><span class="visually-hidden">tip</span> Hybrid Storage Models</h3>

  <p>Many applications use a hybrid storage model
instead of putting everything into a database:
the actual data (such as astronomical images) is stored in files,
while the database stores the files‚Äô names,
their modification dates,
the region of the sky they cover,
their spectral characteristics,
and so on.
This is also how most music player software is built:
the database inside the application keeps track of the MP3 files,
but the files themselves live on disk.</p>
</blockquote>

<blockquote class="question">
  <h3 id="question-question-replacing-null"><i class="far fa-question-circle" aria-hidden="true"></i><span class="visually-hidden">question</span> Question: Replacing NULL</h3>

  <p>Write an SQL statement to replace all uses of <code class="language-plaintext highlighter-rouge">null</code> in
<code class="language-plaintext highlighter-rouge">Survey.person</code> with the string <code class="language-plaintext highlighter-rouge">'unknown'</code>.</p>

  <blockquote class="solution">
    <h3 id="solution-solution-8"><i class="far fa-eye" aria-hidden="true"></i><span class="visually-hidden">solution</span> Solution</h3>
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>UPDATE Survey SET person = 'unknown' WHERE person IS NULL;
</code></pre></div>    </div>
  </blockquote>
</blockquote>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">-- Try solutions here!</span>
</code></pre></div></div>

<blockquote class="question">
  <h3 id="question-question-backing-up-with-sql"><i class="far fa-question-circle" aria-hidden="true"></i><span class="visually-hidden">question</span> Question: Backing Up with SQL</h3>

  <p>SQLite has several administrative commands that aren‚Äôt part of the
SQL standard.  One of them is <code class="language-plaintext highlighter-rouge">.dump</code>, which prints the SQL commands
needed to re-create the database.  Another is <code class="language-plaintext highlighter-rouge">.read</code>, which <span class="notranslate">reads</span> a
file created by <code class="language-plaintext highlighter-rouge">.dump</code> and restores the database.  A colleague of
yours thinks that storing dump files (which are text) in version
control is a good way to track and manage changes to the database.
What are the pros and cons of this approach?  (Hint: records aren‚Äôt
stored in any particular order.)</p>

  <blockquote class="solution">
    <h3 id="solution-solution-9"><i class="far fa-eye" aria-hidden="true"></i><span class="visually-hidden">solution</span> Solution</h3>
    <h4 id="advantages">Advantages</h4>
    <ul>
      <li>A version control system will be able to show differences between versions
of the dump file; something it can‚Äôt do for binary files like databases</li>
      <li>A VCS only saves changes between versions, rather than a complete copy of
each version (save disk space)</li>
      <li>The version control log will explain the reason for the changes in each version
of the database</li>
    </ul>

    <h4 id="disadvantages">Disadvantages</h4>
    <ul>
      <li>Artificial differences between commits because records don‚Äôt have a fixed order</li>
    </ul>
  </blockquote>
</blockquote>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">-- Try solutions here!</span>
</code></pre></div></div>



                
                <blockquote class="key_points">
                    <h3><i class="fas fa-key" aria-hidden="true"></i> Key points</h3>
                    <ul>
                        
                        <li><p>Use aggregation functions to combine multiple values.</p>
</li>
                        
                        <li><p>Aggregation functions ignore <code class="language-plaintext highlighter-rouge">null</code> values.</p>
</li>
                        
                        <li><p>Aggregation happens after filtering.</p>
</li>
                        
                        <li><p>Use GROUP BY to combine subsets separately.</p>
</li>
                        
                        <li><p>If no aggregation function is specified for a field, the query may return an arbitrary value for that field.</p>
</li>
                        
                        <li><p>Use JOIN to combine data from two tables.</p>
</li>
                        
                        <li><p>Use table.field notation to refer to fields when doing joins.</p>
</li>
                        
                        <li><p>Every fact should be represented in a database exactly once.</p>
</li>
                        
                        <li><p>A join produces all combinations of records from one table with records from another.</p>
</li>
                        
                        <li><p>A primary key is a field (or set of fields) whose values uniquely identify the records in a table.</p>
</li>
                        
                        <li><p>A foreign key is a field (or set of fields) in one table whose values are a primary key in another table.</p>
</li>
                        
                        <li><p>We can eliminate meaningless combinations of records by matching primary keys and foreign keys between tables.</p>
</li>
                        
                        <li><p>The most common join condition is matching keys.</p>
</li>
                        
                        <li><p>Every value in a database should be atomic.</p>
</li>
                        
                        <li><p>Every record should have a unique primary key.</p>
</li>
                        
                        <li><p>A database should not contain redundant information.</p>
</li>
                        
                        <li><p>Units and similar metadata should be stored with the data.</p>
</li>
                        
                        <li><p>Use CREATE and DROP to create and delete tables.</p>
</li>
                        
                        <li><p>Use INSERT to add data.</p>
</li>
                        
                        <li><p>Use UPDATE to modify existing data.</p>
</li>
                        
                        <li><p>Use DELETE to remove data.</p>
</li>
                        
                        <li><p>It is simpler and safer to modify data when every record has a unique primary key.</p>
</li>
                        
                        <li><p>Do not create dangling references by deleting records that other records refer to.</p>
</li>
                        
                        <li><p>General-purpose languages have libraries for accessing databases.</p>
</li>
                        
                        <li><p>To connect to a database, a program must use a library specific to that database manager.</p>
</li>
                        
                        <li><p>These libraries use a connection-and-cursor model.</p>
</li>
                        
                        <li><p>Programs can read query results in batches or all at once.</p>
</li>
                        
                        <li><p>Queries should be written using parameter substitution, not string formatting.</p>
</li>
                        
                    </ul>
                </blockquote>
                

                <h1>Frequently Asked Questions</h1>
                Have questions about this tutorial? Check out the  <a href="/training-material/topics/data-science/faqs/">FAQ page for the Foundations of Data Science topic</a> to see if your question is listed there.
                If not, please ask your question on the <a href="https://gitter.im/Galaxy-Training-Network/Lobby">GTN Gitter Channel</a> or the
                <a href="https://help.galaxyproject.org">Galaxy Help Forum</a>

                

                

                
                <h1 data-toc-skip>Glossary</h1>
                <dl>
                    
                    
                    <dt>SQL</dt>
                    <dd>Structured Query Language</dd>
                    
                </dl>
                

                <h1>Feedback</h1>
                <p class="text-muted">Did you use this material as an instructor? Feel free to give us feedback on <a href="https://github.com/galaxyproject/training-material/issues/1452" target="_blank">how it went</a>.</p>

                <div id="feedback-button">
                    <img src="/training-material/shared/images/feedback.png" title="Click to activate" alt="Click here to load Google feedback frame" />
                </div>
                <div id="feedback-form">
                </div>
                <script type="text/javascript">
                    (function (window, document) {
                        function onDocumentReady(fn) {
                            if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
                                fn();
                            } else {
                                document.addEventListener('DOMContentLoaded', fn);
                            }
                        }

                        onDocumentReady(function () {
                            $("#feedback-button").click(function(evt){
                                var e = $(evt.target)
                                e.hide();

                                $("#feedback-form").html(`
                                    <iframe id="feedback-google" class="google-form" src="https://docs.google.com/forms/d/e/1FAIpQLSd4VZptFTQ03kHkMz0JyW9b6_S8geU5KjNE_tLM0dixT3ZQmA/viewform?embedded=true&entry.1235803833=Advanced SQL (Foundations of Data Science)">Loading...</iframe>
                                `)
                            })
                        });
                    })(window, document);
                </script>



                <h1>Citing this Tutorial</h1>
                <p>
                    <ol>
                        <li id="citation-text">The Carpentries, Helena Rasche, 2021 <b>Advanced SQL (Galaxy Training Materials)</b>. <a href="https://training.galaxyproject.org/training-material/topics/data-science/tutorials/sql-advanced/tutorial.html">https://training.galaxyproject.org/training-material/topics/data-science/tutorials/sql-advanced/tutorial.html</a> Online; accessed TODAY
                        </li>
                        <li>
                        Batut et al., 2018 <b>Community-Driven Data Analysis Training for Biology</b> Cell Systems <a href="https://doi.org/10.1016%2Fj.cels.2018.05.012">10.1016/j.cels.2018.05.012</a>
                        </li>
                    </ol>
                </p>


                <blockquote class="details">
                  <h3><i class="fa fa-info-circle" aria-hidden="true"></i><span class="visually-hidden">details</span> BibTeX</h3>
                  <p style="display: none;">

                <div class="highlighter-rouge"><div class="highlight"><pre class="highlight">
<code id="citation-code">@misc{data-science-sql-advanced,
author = "The Carpentries and Helena Rasche",
title = "Advanced SQL (Galaxy Training Materials)",
year = "2021",
month = "10",
day = "19"
url = "\url{https://training.galaxyproject.org/training-material/topics/data-science/tutorials/sql-advanced/tutorial.html}",
note = "[Online; accessed TODAY]"
}
@article{Batut_2018,
    doi = {10.1016/j.cels.2018.05.012},
    url = {https://doi.org/10.1016%2Fj.cels.2018.05.012},
    year = 2018,
    month = {jun},
    publisher = {Elsevier {BV}},
    volume = {6},
    number = {6},
    pages = {752--758.e1},
    author = {B{\'{e}}r{\'{e}}nice Batut and Saskia Hiltemann and Andrea Bagnacani and Dannon Baker and Vivek Bhardwaj and Clemens Blank and Anthony Bretaudeau and Loraine Brillet-Gu{\'{e}}guen and Martin {\v{C}}ech and John Chilton and Dave Clements and Olivia Doppelt-Azeroual and Anika Erxleben and Mallory Ann Freeberg and Simon Gladman and Youri Hoogstrate and Hans-Rudolf Hotz and Torsten Houwaart and Pratik Jagtap and Delphine Larivi{\`{e}}re and Gildas Le Corguill{\'{e}} and Thomas Manke and Fabien Mareuil and Fidel Ram{\'{\i}}rez and Devon Ryan and Florian Christoph Sigloch and Nicola Soranzo and Joachim Wolff and Pavankumar Videm and Markus Wolfien and Aisanjiang Wubuli and Dilmurat Yusuf and James Taylor and Rolf Backofen and Anton Nekrutenko and Bj√∂rn Gr√ºning},
    title = {Community-Driven Data Analysis Training for Biology},
    journal = {Cell Systems}
}</code>
                </pre></div></div>
                </p>
                </blockquote>


<script type="text/javascript">
// update the date on load, or leave fallback of 'today'
d = new Date();
document.getElementById("citation-code").innerHTML = document.getElementById("citation-code").innerHTML.replace("TODAY", d.toDateString());
document.getElementById("citation-text").innerHTML = document.getElementById("citation-text").innerHTML.replace("TODAY", d.toDateString());
</script>

                <h3><i class="far fa-thumbs-up" aria-hidden="true"></i> Congratulations on successfully completing this tutorial!</h3>

                

                
                <blockquote class="agenda follow-up">
                    <strong class="follow-up"><i class="fas fa-graduation-cap" aria-hidden="true"></i> Do you want to extend your knowledge? Follow one of our recommended follow-up trainings:</strong>
                    <ul>
                        
    <li>
    
        
        
        <a href="/training-material/topics/data-science">Foundations of Data Science</a>
        
            <ul>
                
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                            
                            <li> SQL with Python:
                            
                            
                                
                                     <a href="/training-material/topics/data-science/tutorials/sql-python/tutorial.html"><i class="fas fa-laptop" aria-hidden="true"></i><span class="visually-hidden">tutorial</span> hands-on</a>
                                
                            
                            </li>
                        
                    
                        
                    
                
            </ul>
        
    
    </li>

                    </ul>
                </blockquote>
                

            </div>
        </div>
    </div>
</section>
<br/>
<br/>
<br/>

        </div>
        
    </body>
    <script type="text/javascript" src="/training-material/assets/js/jquery.slim.min.js"></script>
    <script type="text/javascript" src="/training-material/assets/js/popper.min.js"></script>
    <script type="text/javascript" src="/training-material/assets/js/bootstrap.min.js?v=3"></script>
    <script type="text/javascript" src="/training-material/assets/js/details-element-polyfill.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="/training-material/assets/js/bootstrap-toc.min.js"></script>
    <script type="text/javascript" src="/training-material/assets/js/main.js"></script>
    <script type="text/javascript" src="/training-material/assets/js/theme.js"></script>

    <script type="text/javascript" src="/training-material/assets/js/clipboard.min.js"></script>
    <script type="text/javascript">
    var snippets=document.querySelectorAll('div.highlight');
    [].forEach.call(snippets,function(snippet){
        snippet.firstChild.insertAdjacentHTML('beforebegin','<button class="btn btn-light" data-clipboard-snippet><i class="fa fa-copy"></i>&nbsp;Copy</button>');
    });

    var clipboardSnippets=new ClipboardJS('[data-clipboard-snippet]',{
        target:function(trigger){return trigger.nextElementSibling;
    }});
    </script>
    

    <script type="text/javascript">
        if(window.location.hostname === "galaxyproject.github.io") {
            // Redirect
            var redirect = "https://training.galaxyproject.org" + window.location.pathname + window.location.search;
            $('div.container.main-content').prepend("<div class='alert alert-warning'><strong>Note: </strong>This content has a new home at <a href=\"" + redirect + "\">" + redirect + "</a>, which you will be redirected to in 5 seconds.</div>");

            window.setTimeout(function(){
                window.location.href = redirect;
            }, 5000)

        }
    </script>
</html>
