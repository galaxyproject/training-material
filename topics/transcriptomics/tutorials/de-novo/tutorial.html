<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
        <title>Galaxy Training!</title>
        <link rel="stylesheet" href="/training-material/assets/css/bootstrap.min.css?v=3">
        <link rel="stylesheet" href="/training-material/assets/css/main.css?v=2">
        <link rel="stylesheet" href="/training-material/assets/css/font-awesome.css">
        <link rel="stylesheet" href="/training-material/assets/css/academicons.css">
        <link rel="stylesheet" href="/training-material/assets/css/syntax_highlighting.css">
        <link rel="shortcut icon" href="/training-material/favicon.ico" type="image/x-icon" />
    </head>
    <body>
        



<header>
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand" href="/training-material/">
                <img src="/training-material/assets/images/GTN-60px.png" height="30" alt="Galaxy Training Network logo">
                Galaxy Training!
            </a>

            <button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse" data-target="#top-navbar" aria-controls="top-navbar" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="top-navbar">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="/training-material/topics/transcriptomics" title="Go back to list of tutorials">
                            <i class="fa fa-folder-o" aria-hidden="true"></i> Transcriptomics
                        </a>
                    </li>

                    
                        
                        
                        
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown" aria-expanded="false" title="Introduction slides">
                                    <i class="fa fa-slideshare" aria-hidden="true"></i> Introduction slides
                                </a>
                                <div class="dropdown-menu">
                                    
                                        
                                            
                                                <a class="dropdown-item" href="/training-material/topics/transcriptomics/slides/introduction.html">
                                                    Introduction to Transcriptomics
                                                </a>
                                            
                                        
                                    
                                        
                                            
                                        
                                    
                                        
                                            
                                        
                                    
                                        
                                            
                                        
                                    
                                        
                                            
                                        
                                    
                                </div>
                            </li>
                        
                    

                    

                    

                    
                    <li class="nav-item">
                        <a class="nav-link" href="https://zenodo.org/record/254485#.WKODmRIrKRu" title="Links to data">
                            <i class="fa fa-files-o" aria-hidden="true"></i> Input Dataset
                        </a>
                    </li>
                    

                    
                    <li class="nav-item">
                        <a class="nav-link" href="/training-material/topics/transcriptomics#references" title="References">
                            <i class="fa fa-book" aria-hidden="true"></i> Literature
                        </a>
                    </li>
                    

                    <li class="nav-item dropdown">
    <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown" aria-expanded="false" title="Help">
        <i class="fa fa-life-ring" aria-hidden="true"></i> Help
    </a>
    <div class="dropdown-menu">
        <a class="dropdown-item" href="https://gitter.im/Galaxy-Training-Network/Lobby" title="Chat on Gitter">
            Gitter
        </a>
        <a class="dropdown-item" href="https://biostar.usegalaxy.org/" title="Ask on Biostars">
            Biostars
        </a>
    </div>
</li>


                    <li class="nav-item">
                        <a class="nav-link" href="https://github.com/galaxyproject/training-material/tree/master/topics/transcriptomics/tutorials/de-novo/tutorial.md">
                            <i class="fa fa-github" aria-hidden="true"></i> Edit
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>
</header>

<div class="container main-content">
    <section class="tutorial">
        <h1>De novo transcriptome reconstruction with RNA-Seq</h1>

        <blockquote class="overview">
            <h3>Overview</h3>

            <strong><i class="fa fa-question-circle" aria-hidden="true"></i> Questions</strong>
            <ul>
            
            <li>What genes are differentially expressed between G1E cells and megakaryocytes?</li>
            
            <li>How can we generate a transcriptome de novo from RNA sequencing data?</li>
            
            </ul>

            <strong><i class="fa fa-bullseye" aria-hidden="true"></i> Objectives</strong>
            <ul>
            
            <li>Analysis of RNA sequencing data using a reference genome</li>
            
            <li>Reconstruction of transcripts without reference transcriptome (de novo)</li>
            
            <li>Analysis of differentially expressed genes</li>
            
            </ul>

            
            <strong><i class="fa fa-check-circle" aria-hidden="true"></i> Requirements</strong>
            <ul>
            
                <li>
                    
                    <a href="/training-material/topics//introduction/">Galaxy introduction</a>
                    
                </li>
            
                <li>
                    
                    <a href="/training-material/topics//sequence-analysis/">Quality control</a>
                    
                </li>
            
            
            </ul>
            

            <p><strong><i class="fa fa-hourglass-end" aria-hidden="true"></i> Time estimation:</strong> 6h</p>
        </blockquote>

        <h1 class="no_toc" id="introduction">Introduction</h1>

<p>The data provided here are part of a Galaxy tutorial that analyzes RNA-seq data from a study published by <em>Wu et al.</em> in 2014 <a href="http://genome.cshlp.org/content/early/2014/10/12/gr.164830.113.abstract">DOI:10.1101/gr.164830.113</a>. The goal of this study was to investigate “the dynamics of occupancy and the role in gene regulation of the transcription factor Tal1, a critical regulator of hematopoiesis, at multiple stages of hematopoietic differentiation.” To this end, RNA-seq libraries were constructed from multiple mouse cell types including G1E - a GATA-null immortalized cell line derived from targeted disruption of GATA-1 in mouse embryonic stem cells - and megakaryocytes. This RNA-seq data was used to determine differential gene expression between G1E and megakaryocytes and later correlated with Tal1 occupancy. This dataset (GEO Accession: GSE51338) consists of biological replicate, paired-end, poly(A) selected RNA-seq libraries. Because of the long processing time for the large original files, we have downsampled the original raw data files to include only reads that align to chromosome 19 and a subset of interesting genomic loci identified by Wu <em>et al</em>.</p>

<h1 id="analysis-strategy">Analysis strategy</h1>

<p>The goal of this exercise is to identify what transcripts are present in the G1E and megakaryocyte cellualr states and which transcripts are differentially expressed between the two states. We will use a <em>de novo</em> transcript reconstruction strategy to infer transcript structures from the mapped reads in the absence of the actual annotated transcript structures. This will allow us to identify novel transcripts and novel isoforms of known transcripts, as well as identify differentially expressed transcripts.</p>

<blockquote class="agenda">
  <h3 id="agenda">Agenda</h3>

  <p>In this tutorial, we will deal with:</p>

<ol id="markdown-toc">
  <li><a href="#analysis-strategy" id="markdown-toc-analysis-strategy">Analysis strategy</a>    <ol>
      <li><a href="#data-upload" id="markdown-toc-data-upload">Data upload</a></li>
      <li><a href="#quality-control" id="markdown-toc-quality-control">Quality control</a></li>
    </ol>
  </li>
  <li><a href="#mapping" id="markdown-toc-mapping">Mapping</a></li>
  <li><a href="#de-novo-transcript-reconstruction" id="markdown-toc-de-novo-transcript-reconstruction">De novo transcript reconstruction</a></li>
  <li><a href="#transcriptome-assembly" id="markdown-toc-transcriptome-assembly">Transcriptome assembly</a></li>
  <li><a href="#analysis-of-the-differential-gene-expression" id="markdown-toc-analysis-of-the-differential-gene-expression">Analysis of the differential gene expression</a>    <ol>
      <li><a href="#count-the-number-of-reads-per-transcript" id="markdown-toc-count-the-number-of-reads-per-transcript">Count the number of reads per transcript</a></li>
      <li><a href="#perform-differential-gene-expression-testing" id="markdown-toc-perform-differential-gene-expression-testing">Perform differential gene expression testing</a></li>
    </ol>
  </li>
  <li><a href="#visualization" id="markdown-toc-visualization">Visualization</a></li>
  <li><a href="#workflow" id="markdown-toc-workflow">Workflow</a></li>
</ol>

</blockquote>

<h2 id="data-upload">Data upload</h2>

<p>Due to the large size of this dataset, we have downsampled it to only include reads mapping to chromosome 19 and certain loci with relevance to hematopoeisis. This data is available at <a href="https://zenodo.org/record/583140#.WSW3NhPyub8"><code class="highlighter-rouge">Zenodo</code></a>, where you can find the forward and reverse reads corresponding to replicate RNA-seq libraries from G1E and megakaryocyte cells and an annotation file of RefSeq transcripts we will use to generate our transcriptome database.</p>

<blockquote class="hands_on">
  <h3 id="-hands-on-data-upload"><i class="fa fa-pencil" aria-hidden="true"></i> Hands-on: Data upload</h3>

  <ol>
    <li>Create a new history for this RNA-seq exercise</li>
    <li>Open the data upload manager (Get Data -&gt; Upload file)</li>
    <li>Copy and paste the links for the reads and annotation file</li>
    <li>Select <strong>Paste/Fetch Data</strong></li>
    <li>Paste the link(s) into the text field</li>
    <li>Change the datatype of the read files to <strong>fastqsanger</strong></li>
    <li>Change the datatype of the annotation file to <strong>gtf</strong> and assign the Genome as <strong>mm10</strong></li>
    <li>Press <strong>Start</strong></li>
    <li>
      <p>Rename the files in your history to retain just the necessary information (<em>e.g.</em> “G1E R1 forward reads”)</p>

      <blockquote class="tip">
        <h3 id="-tip-importing-data-via-links"><i class="fa fa-lightbulb-o" aria-hidden="true"></i> Tip: Importing data via links</h3>
        <p>Data available from zenodo: <a href="https://zenodo.org/record/583140"><img src="https://zenodo.org/badge/DOI/10.123/GTNdenovoRNAseq.svg" alt="DOI" /></a></p>

        <p>Below are the links to the read files that can be copied and pasted in the upload manager.</p>

        <pre><code class="language-https://zenodo.org/record/583140/files/G1E_rep1_forward_read_%28SRR549355_1%29">https://zenodo.org/record/583140/files/G1E_rep1_reverse_read_%28SRR549355_2%29
https://zenodo.org/record/583140/files/G1E_rep2_forward_read_%28SRR549356_1%29
https://zenodo.org/record/583140/files/G1E_rep2_reverse_read_%28SRR549356_2%29
https://zenodo.org/record/583140/files/Megakaryocyte_rep1_forward_read_%28SRR549357_1%29
https://zenodo.org/record/583140/files/Megakaryocyte_rep1_reverse_read_%28SRR549357_2%29
https://zenodo.org/record/583140/files/Megakaryocyte_rep2_forward_read_%28SRR549358_1%29
https://zenodo.org/record/583140/files/Megakaryocyte_rep2_reverse_read_%28SRR549358_2%29
https://zenodo.org/record/583140/files/RefSeq_reference_GTF_%28DSv2%29
</code></pre>

        <p>You will need to fetch the link to the annotation file yourself ;)</p>
      </blockquote>
    </li>
  </ol>

</blockquote>

<h2 id="quality-control">Quality control</h2>

<p>For quality control, we use similar tools as described in <a href="/training-material/topics/sequence-analysis/">NGS-QC tutorial</a>: <a href="https://www.bioinformatics.babraham.ac.uk/projects/fastqc/">FastQC</a> and <a href="http://www.usadellab.org/cms/?page=trimmomatic">Trimmomatic</a>.</p>

<blockquote class="hands_on">
  <h3 id="-hands-on-quality-control"><i class="fa fa-pencil" aria-hidden="true"></i> Hands-on: Quality control</h3>

  <ol>
    <li>
      <p><strong>FastQC</strong> <i class="fa fa-wrench" aria-hidden="true"></i>: Run <code class="highlighter-rouge">FastQC</code> on the forward and reverse read files to assess the quality of the reads.</p>

      <blockquote class="question">
        <h3 id="-questions"><i class="fa fa-question-circle" aria-hidden="true"></i> Questions</h3>

        <ol>
          <li>What is the read length?</li>
          <li>
            <p>Is there anything interesting about the quality of the base calls based on the position in the reads?</p>

            <details>
<summary>Click to view answers</summary>
<ol type="1">
<li>The read length is 99 bp</li>
<li>The quality of base calls declines throughout a sequencing run. </li>
</ol>
</details>
          </li>
        </ol>
      </blockquote>
    </li>
    <li>
      <p><strong>Trimmomatic</strong> <i class="fa fa-wrench" aria-hidden="true"></i>: Trim off the low quality bases from the ends of the reads to increase mapping efficiency. Run <code class="highlighter-rouge">Trimmomatic</code> on each pair of forward and reverse reads.</p>

      <p><img src="../../images/trimmomatic.png" alt="Trimmomatic tool input" /></p>
    </li>
    <li>
      <p><strong>FastQC</strong> <i class="fa fa-wrench" aria-hidden="true"></i>: Re-run <code class="highlighter-rouge">FastQC</code> on trimmed reads and inspect the differences.</p>

      <blockquote class="question">
        <h3 id="-questions-1"><i class="fa fa-question-circle" aria-hidden="true"></i> Questions</h3>

        <ol>
          <li>What is the read length?</li>
          <li>
            <p>Is there anything interesting about the quality of the base calls based on the position in the reads?</p>

            <details>
<summary>Click to view answers</summary>
<ol type="1">
<li>The read lengths range from 1 to 99 bp after trimming</li>
<li>The average quality of base calls does not drop off as sharply at the 3' ends of reads.</li>
</ol>
</details>
          </li>
        </ol>
      </blockquote>
      <p><img src="../../images/BeforeAndAfterTrimming.png" alt="Before and after trimming comparison" /></p>
    </li>
  </ol>
</blockquote>

<p>Now that we have trimmed our reads and are fortunate that there is a reference genome assembly for mouse, we will align our trimmed reads to the genome.</p>

<blockquote class="comment">
  <h3 id="-comment"><i class="fa fa-commenting-o" aria-hidden="true"></i> Comment</h3>

  <p>Instead of running a single tool multiple times on all your data, would you rather run a single tool on multiple datasets at once? Check out the <a href="https://galaxyproject.org/tutorials/collections/">dataset collections</a> feature of Galaxy!</p>
</blockquote>

<h1 id="mapping">Mapping</h1>

<p>To make sense of the reads, their positions within mouse genome must be determined. This process is known as aligning or ‘mapping’ the reads to the reference genome.</p>

<blockquote class="comment">
  <h3 id="-comment-1"><i class="fa fa-commenting-o" aria-hidden="true"></i> Comment</h3>

  <p>Do you want to learn more about the principles behind mapping? Follow our <a href="/training-material/topics/sequence-analysis/">training</a></p>
</blockquote>

<p>In the case of a eukaryotic transcriptome, most reads originate from processed mRNAs lacking introns. Therefore, they cannot be simply mapped back to the genome as we normally do for reads derived from DNA sequences. Instead, the reads must be separated into two categories:</p>

<ul>
  <li>Reads contained within mature exons - these align perfectly to the reference genome</li>
  <li>Reads that span splice junctions in the mature mRNA - these align with gaps to the reference genome</li>
</ul>

<p>Spliced mappers have been developed to efficiently map transcript-derived reads against genomes. <a href="https://ccb.jhu.edu/software/hisat2/index.shtml"><code class="highlighter-rouge">HISAT</code></a> is an accurate and fast tool for mapping spliced reads to a genome. Another popular spliced aligner is <a href="https://ccb.jhu.edu/software/tophat/index.shtml"><code class="highlighter-rouge">TopHat</code></a>, but we will be using <code class="highlighter-rouge">HISAT</code> in this tutorial.</p>

<blockquote class="comment">
  <h3 id="-comment-2"><i class="fa fa-commenting-o" aria-hidden="true"></i> Comment</h3>
  <p>As it is sometimes quite difficult to determine which settings correspond to those of other programs, the following table might be helpful to identify the library type:</p>

  <table>
    <thead>
      <tr>
        <th>Library type</th>
        <th><strong>Infer Experiment</strong></th>
        <th><strong>TopHat</strong></th>
        <th><strong>HISAT</strong></th>
        <th><strong>htseq-count</strong></th>
        <th><strong>featureCounts</strong></th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td>PE</td>
        <td>1++,1–,2+-,2-+</td>
        <td>FR Second Strand</td>
        <td>FR</td>
        <td>yes</td>
        <td>1</td>
      </tr>
      <tr>
        <td>PE</td>
        <td>1+-,1-+,2++,2–</td>
        <td>FR First Strand</td>
        <td>RF</td>
        <td>reverse</td>
        <td>2</td>
      </tr>
      <tr>
        <td>SE</td>
        <td>++,–</td>
        <td>FR Second Strand</td>
        <td>F</td>
        <td>yes</td>
        <td>1</td>
      </tr>
      <tr>
        <td>SE</td>
        <td>+-,-+</td>
        <td>FR First Strand</td>
        <td>R</td>
        <td>reverse</td>
        <td>2</td>
      </tr>
      <tr>
        <td>SE,PE</td>
        <td>undecided</td>
        <td>FR Unstranded</td>
        <td>default</td>
        <td>no</td>
        <td>0</td>
      </tr>
    </tbody>
  </table>

</blockquote>

<blockquote class="hands_on">
  <h3 id="-hands-on-spliced-mapping"><i class="fa fa-pencil" aria-hidden="true"></i> Hands-on: Spliced mapping</h3>

  <ol>
    <li><strong>HISAT</strong> <i class="fa fa-wrench" aria-hidden="true"></i>: Run <code class="highlighter-rouge">HISAT</code> on one forward/reverse read pair and modify the following settings:
      <ul>
        <li><strong>Single end or paired reads?</strong>: Individual paired-end reads</li>
        <li><strong>Source for the reference genome to align against</strong>: Use a built-in genome &gt; Mouse (Mus Musculus): mm10</li>
        <li><strong>Spliced alignment parameters</strong>: Specify spliced alignment parameters</li>
        <li><strong>Specify strand-specific information</strong>: First Strand (R/RF)</li>
        <li>
          <p><strong>Transcriptome assembly reporting</strong>: Report alignments tailored for transcript assemblers including StringTie.</p>

          <p><img src="../../images/hisat_tool_form.png" alt="HISAT tool input and parameters" /></p>
        </li>
      </ul>
    </li>
    <li><strong>HISAT</strong> <i class="fa fa-wrench" aria-hidden="true"></i>: Run <code class="highlighter-rouge">HISAT</code> on the remaining forward/reverse read pairs with the same parameters.</li>
  </ol>

</blockquote>

<h1 id="de-novo-transcript-reconstruction">De novo transcript reconstruction</h1>
<p>Now that we have mapped our reads to the mouse genome with <code class="highlighter-rouge">HISAT</code>, we want to determine transcript structures that are represented by the aligned reads. This is called <em>de novo</em> transcriptome reconstruction. This unbiased approach permits the comprehensive identification of all transcripts present in a sample, including annotated genes, novel isoforms of annotated genes, and novel genes. While common gene/transcript databases are quite large, they are not comprehensive, and the <em>de novo</em> transcriptome reconstruction approach ensures complete transcriptome(s) identification from the experimental samples. The leading tool for transcript reconstruction is <code class="highlighter-rouge">Stringtie</code>. Here, we will use <code class="highlighter-rouge">Stringtie</code> to predict transcript structures based on the reads aligned by <code class="highlighter-rouge">HISAT</code>.</p>

<blockquote class="hands_on">
  <h3 id="-hands-on-transcriptome-reconstruction"><i class="fa fa-pencil" aria-hidden="true"></i> Hands-on: Transcriptome reconstruction</h3>

  <ol>
    <li><strong>Stringtie</strong> <i class="fa fa-wrench" aria-hidden="true"></i>: Run <code class="highlighter-rouge">Stringtie</code> on the <code class="highlighter-rouge">HISAT</code> alignments using the default parameters.
      <ul>
        <li>Use batch mode to run all four samples from one tool form.
<img src="../../images/Stringtie.png" alt="Stringtie input and parameters" /></li>
      </ul>
    </li>
  </ol>
</blockquote>

<h1 id="transcriptome-assembly">Transcriptome assembly</h1>

<p>We just generated four transcriptomes with <code class="highlighter-rouge">Stringtie</code> representing each of the four RNA-seq libraries we are analyzing. Since these were generated in the absence of a reference transcriptome, and we ultimately would like to know what transcript structure corresponds to which annotated transcript (if any), we have to make a <strong>transcriptome database</strong>. We will use the tool <code class="highlighter-rouge">Stringtie - Merge</code> to combine redundant transcript structures across the four samples and the RefSeq reference. Once we have merged our transcript structures, we will use <code class="highlighter-rouge">GFFcompare</code> to annotate the transcripts of our newly created transcriptome so we know the relationship of each transcript to the RefSeq reference.</p>

<blockquote class="hands_on">
  <h3 id="-hands-on-transcriptome-assembly"><i class="fa fa-pencil" aria-hidden="true"></i> Hands-on: Transcriptome assembly</h3>

  <ol>
    <li><strong>Stringtie-merge</strong> <i class="fa fa-wrench" aria-hidden="true"></i>: Run <code class="highlighter-rouge">Stringtie-merge</code> on the <code class="highlighter-rouge">Stringtie</code> assembled transcripts along with the RefSeq annotation file we imported earlier.
      <ul>
        <li>Use batch mode to inlcude all four <code class="highlighter-rouge">Stringtie</code> assemblies as “input_gtf”.</li>
        <li>Select the “RefSeq GTF mm10” file as the “guide_gff”.
<img src="../../images/stringtiemergetf.png" alt="Stringtie-merge input and parameters" /></li>
      </ul>
    </li>
    <li><strong>GFFCompare</strong> <i class="fa fa-wrench" aria-hidden="true"></i>: Run <code class="highlighter-rouge">GFFCompare</code> on the <code class="highlighter-rouge">Stringtie-merge</code> generated transcriptome along with the RefSeq annotation file.
      <ul>
        <li>Select the output of <code class="highlighter-rouge">Stringtie-merge</code> as the GTF input.</li>
        <li>Select “Yes” under <code class="highlighter-rouge">Use Reference Annotation" and select the "RefSeq GTF mm10" file as the "Reference Annotation".</code>
<img src="../../images/GFFComparetf.png" alt="GFFCompare input and parameters" /></li>
      </ul>
    </li>
  </ol>

</blockquote>

<blockquote class="comment">
  <h3 id="-note-transcript-categorization-used-by-gffcompare"><i class="fa fa-commenting-o" aria-hidden="true"></i> Note: Transcript categorization used by <code class="highlighter-rouge">GFFcompare</code></h3>

  <table>
    <thead>
      <tr>
        <th style="text-align: center"><strong>Class code</strong></th>
        <th style="text-align: left"><strong>Transcript category</strong></th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td style="text-align: center">=</td>
        <td style="text-align: left">Annotated in reference</td>
      </tr>
      <tr>
        <td style="text-align: center">j</td>
        <td style="text-align: left">Novel isoform of reference</td>
      </tr>
      <tr>
        <td style="text-align: center">u</td>
        <td style="text-align: left">Intergenic</td>
      </tr>
      <tr>
        <td style="text-align: center">x</td>
        <td style="text-align: left">Anti-sense</td>
      </tr>
      <tr>
        <td style="text-align: center">r</td>
        <td style="text-align: left">Repetitive</td>
      </tr>
      <tr>
        <td style="text-align: center">c</td>
        <td style="text-align: left">Contained in exon of reference</td>
      </tr>
      <tr>
        <td style="text-align: center">s</td>
        <td style="text-align: left">Anti-sense spliced intronic</td>
      </tr>
      <tr>
        <td style="text-align: center">e</td>
        <td style="text-align: left">Single exon transfrag overlapping a reference exon and at least 10 bp of a reference intron, indicating a possible pre-mRNA fragment.</td>
      </tr>
      <tr>
        <td style="text-align: center">i</td>
        <td style="text-align: left">A transfrag falling entirely within a reference intron</td>
      </tr>
      <tr>
        <td style="text-align: center">o</td>
        <td style="text-align: left">Generic exonic overlap with a reference transcript</td>
      </tr>
      <tr>
        <td style="text-align: center">p</td>
        <td style="text-align: left">Possible polymerase run-on fragment (within 2Kbases of a reference transcript)</td>
      </tr>
    </tbody>
  </table>
</blockquote>

<h1 id="analysis-of-the-differential-gene-expression">Analysis of the differential gene expression</h1>

<p>We just generated a transriptome database that represents the transcripts present in the G1E and megakaryocytes samples. This database provides the location of our transcripts with non-redundant identifiers, as well as information regarding the origin of the transcript.</p>

<p>We now want to identify which transcripts are differentially expressed between the G1E and megakaryocyte cellular states. To do this we will implement a counting approach using <code class="highlighter-rouge">FeatureCounts</code> to count reads per transcript. Then we will provide this information to <code class="highlighter-rouge">DESeq2</code> to generate normalized transcript counts (abundance estimates) and significance testing for differential expression.</p>

<h2 id="count-the-number-of-reads-per-transcript">Count the number of reads per transcript</h2>

<p>To compare the abundance of transcripts between different cellular states, the first essential step is to quantify the number of reads per transcript. <a href="http://bioinf.wehi.edu.au/featureCounts/"><code class="highlighter-rouge">FeatureCounts</code></a> is one of the most popular tools for counting reads in genomic features. In our case, we’ll be using <code class="highlighter-rouge">FeatureCounts</code> to count reads aligning in exons of our <code class="highlighter-rouge">GFFCompare</code> generated transcriptome database.</p>

<p>The recommended mode is “union”, which counts overlaps even if a read only shares parts of its sequence with a genomic feature and disregards reads that overlap more than one feature.</p>

<blockquote class="hands_on">
  <h3 id="-hands-on-counting-the-number-of-reads-per-transcript"><i class="fa fa-pencil" aria-hidden="true"></i> Hands-on: Counting the number of reads per transcript</h3>

  <ol>
    <li>
      <p><strong>FeatureCounts</strong> <i class="fa fa-wrench" aria-hidden="true"></i>: Run <code class="highlighter-rouge">FeatureCounts</code> on the aligned reads (<code class="highlighter-rouge">HISAT</code> output) using the <code class="highlighter-rouge">GFFCompare</code> transcriptome database as the annotation file.</p>

      <ul>
        <li>Using the batch mode for input selection, choose the four <code class="highlighter-rouge">HISAT</code> aligned read files</li>
        <li><strong>Gene annotation file</strong>:  in your history, then select the <code class="highlighter-rouge">annotated transcripts</code> GTF file output by <code class="highlighter-rouge">GFFCompare</code> (this specifies the “union” mode)</li>
        <li>Expand <strong>Options for paired end reads</strong></li>
        <li><strong>Orientation of the two read from the same pair</strong>: Reverse, Forward (rf)</li>
        <li>Expand <strong>Advanced options</strong></li>
        <li><strong>GFF gene identifier</strong>: enter “transcript_id”</li>
        <li><strong>Strand specificity of the protocol</strong>: select “Stranded (reverse)”
<img src="../../images/featurecountsA.png" alt="FeatureCounts input and parameters" />
<img src="../../images/featurecountsB.png" alt="FeatureCounts advanced parameters" /></li>
      </ul>
    </li>
  </ol>

</blockquote>

<h2 id="perform-differential-gene-expression-testing">Perform differential gene expression testing</h2>

<p>Transcript expression is estimated from read counts, and attempts are made to correct for variability in measurements using replicates. This is absolutely essential to obtaining accurate results. We recommend having at least two biological replicates.</p>

<p><a href="https://bioconductor.org/packages/release/bioc/html/DESeq2.html"><code class="highlighter-rouge">DESeq2</code></a> is a great tool for differential gene expression analysis. It accepts read counts produced by <code class="highlighter-rouge">FeatureCounts</code> and applies size factor normalization:</p>

<ul>
  <li>Computation for each gene of the geometric mean of read counts across all samples</li>
  <li>Division of every gene count by the geometric mean</li>
  <li>Use of the median of these ratios as sample’s size factor for normalization</li>
</ul>

<blockquote class="hands_on">
  <h3 id="-hands-on"><i class="fa fa-pencil" aria-hidden="true"></i> Hands-on:</h3>

  <ol>
    <li><strong>DESeq2</strong> <i class="fa fa-wrench" aria-hidden="true"></i>: Run <code class="highlighter-rouge">DESeq2</code> with the following parameters:
      <ul>
        <li>Specify “G1E” as the first factor level (condition) and select the count files corresponding to the two replicates</li>
        <li>
          <p>Specify “Mega” as the second factor level (condition) and select the count files corresponding to the two replicates</p>

          <blockquote class="comment">
            <h3 id="-comment-3"><i class="fa fa-commenting-o" aria-hidden="true"></i> Comment</h3>

            <p>You can select several files by holding down the CTRL (or COMMAND) key and clicking on the desired files</p>
          </blockquote>
        </li>
        <li><strong>Visualising the analysis results</strong>: Yes</li>
        <li><strong>Output normalized counts table</strong>: Yes
<img src="../../images/deseq2tf.png" alt="DESeq2 input and parameters" /></li>
      </ul>
    </li>
  </ol>
</blockquote>

<p>The first output of <code class="highlighter-rouge">DESeq2</code> is a tabular file. The columns are:</p>

<ol>
  <li>Gene identifiers</li>
  <li>Mean normalized counts, averaged over all samples from both conditions</li>
  <li>Logarithm (base 2) of the fold change (the values correspond to up- or downregulation relative to the condition listed as Factor level 1)</li>
  <li>Standard error estimate for the log2 fold change estimate</li>
  <li><a href="http://data.princeton.edu/wws509/notes/c2s3.html">Wald</a> statistic</li>
  <li><em>p</em>-value for the statistical significance of this change</li>
  <li><em>p</em>-value adjusted for multiple testing with the Benjamini-Hochberg procedure which controls false discovery rate (<a href="http://www.biostathandbook.com/multiplecomparisons.html">FDR</a>)</li>
</ol>

<blockquote class="hands_on">
  <h3 id="-hands-on-1"><i class="fa fa-pencil" aria-hidden="true"></i> Hands-on:</h3>

  <ol>
    <li>
      <p><strong>Filter</strong> <i class="fa fa-wrench" aria-hidden="true"></i>: Run <code class="highlighter-rouge">Filter</code> to extract genes with a significant change in gene expression (adjusted <em>p</em>-value less than 0.05) between treated and untreated samples</p>

      <blockquote class="question">
        <h3 id="-question"><i class="fa fa-question-circle" aria-hidden="true"></i> Question</h3>

        <p>How many transcripts have a significant change in expression between these conditions?</p>

        <details>
<summary>Click to view answers</summary>
To filter, use "c7&lt;0.05". And we get 249 transcripts with a significant change in gene expression between the G1E and megakaryocyte cellular states.
</details>
      </blockquote>
    </li>
    <li>
      <p><strong>Filter</strong> <i class="fa fa-wrench" aria-hidden="true"></i>: Determine how many transcripts are up or down regulated in the G1E state.</p>

      <blockquote class="comment">
        <h3 id="-comments"><i class="fa fa-commenting-o" aria-hidden="true"></i> Comments</h3>
        <p>Rename your datasets for the downstream analyses</p>
      </blockquote>

      <blockquote class="question">
        <h3 id="-question-1"><i class="fa fa-question-circle" aria-hidden="true"></i> Question</h3>

        <p>Are there more upregulated or downregulated genes in the treated samples?</p>

        <details>
<summary>Click to view answers</summary>
To obtain the up-regulated genes in the G1E state, we filter the previously generated file (with the significant change in transcript expression) with the expression "c3&gt;0" (the log2 fold changes must be greater than 0). We obtain 102  genes (40.9% of the genes with a significant change in gene expression). For the down-regulated genes in the G1E state, we did the inverse and we find 149 transcripts (59% of the genes with a significant change in transcript expression).
</details>
      </blockquote>
    </li>
  </ol>
</blockquote>

<p>In addition to the list of genes, <code class="highlighter-rouge">DESeq2</code> outputs a graphical summary of the results, useful to evaluate the quality of the experiment:</p>

<ol>
  <li>
    <p>Histogram of <em>p</em>-values for all tests</p>

    <p><img src="../../images/Deseq2_histogram3.png" alt="DESeq2 histogram" /></p>
  </li>
  <li>
    <p><a href="https://en.wikipedia.org/wiki/MA_plot">MA plot</a>: global view of the relationship between the expression change of conditions (log ratios, M), the average expression strength of the genes (average mean, A), and the ability of the algorithm to detect differential gene expression. The genes that passed the significance threshold (adjusted p-value &lt; 0.1) are colored in red.</p>

    <p><img src="../../images/Deseq2_MAplot3.png" alt="MA plot" /></p>
  </li>
  <li>
    <p>Principal Component Analysis (<a href="https://en.wikipedia.org/wiki/Principal_component_analysis">PCA</a>) and the first two axes</p>

    <p><img src="../../images/Deseq2_PCA3.png" alt="Principal component analysis output" /></p>

    <p>Each replicate is plotted as an individual data point. This type of plot is useful for visualizing the overall effect of experimental covariates and batch effects.</p>
  </li>
  <li>
    <p>Heatmap of sample-to-sample distance matrix: overview over similarities and dissimilarities between samples</p>

    <p><img src="../../images/Deseq2_heatmap3.png" alt="Heatmap of sample-to-sample distance matrix" /></p>
  </li>
  <li>
    <p>Dispersion estimates: gene-wise estimates (black), the fitted values (red), and the final maximum a posteriori estimates used in testing (blue)</p>

    <p><img src="../../images/Deseq2_dispersion3.png" alt="Dispersion estimates" /></p>

    <p>This dispersion plot is typical, with the final estimates shrunk from the gene-wise estimates towards the fitted estimates. Some gene-wise estimates are flagged as outliers and not shrunk towards the fitted value. The amount of shrinkage can be more or less than seen here, depending on the sample size, the number of coefficients, the row mean and the variability of the gene-wise estimates.</p>
  </li>
</ol>

<p>For more information about <code class="highlighter-rouge">DESeq2</code> and its outputs, you can have a look at <a href="https://www.bioconductor.org/packages/release/bioc/manuals/DESeq2/man/DESeq2.pdf"><code class="highlighter-rouge">DESeq2</code> documentation</a>.</p>

<h1 id="visualization">Visualization</h1>
<p>Now that we have a list of transcript expression levels and their differential expression levels, it is time to visually inspect our transcript structures and the reads they were predicted from. It is a good practice to visually inspect (and present) loci with transcripts of interest. Fortunately, there is a built-in genome browser in Galaxy, <strong>Trackster</strong>, that make this task simple (and even fun!).</p>

<p>In this last section, we will convert our aligned read data from BAM format to bigWig format to simplify observing where our stranded RNA-seq data aligned to. We’ll then initiate a session on Trackster, load it with our data, and visually inspect our interesting loci.</p>

<blockquote class="hands_on">
  <h3 id="-hands-on-converting-aligned-read-files-to-bigwig-format"><i class="fa fa-pencil" aria-hidden="true"></i> Hands-on: Converting aligned read files to bigWig format</h3>

  <ol>
    <li><strong>bamCoverage</strong> <i class="fa fa-wrench" aria-hidden="true"></i>: Run <code class="highlighter-rouge">bamCoverage</code> on all four aligned read files (<code class="highlighter-rouge">HISAT</code> output) with the following parameters:
      <ul>
        <li><strong>Bin size in bases</strong>: 1</li>
        <li><strong>Effective genome size</strong>: mm9 (2150570000)</li>
        <li>Expand the <strong>Advanced options</strong></li>
        <li><strong>Only include reads originating from fragments from the forward or reverse strand</strong>: forward
<img src="../../images/bamCoverage_forward.png" alt="bamCoverage input and parameters" /></li>
      </ul>
    </li>
    <li>
      <p><strong>Rename</strong> <i class="fa fa-wrench" aria-hidden="true"></i>: Rename the outputs to reflect the origin of the reads and that they represent the reads mapping to the PLUS strand.</p>
    </li>
    <li><strong>bamCoverage</strong> <i class="fa fa-wrench" aria-hidden="true"></i>: Repeat Step 1 except changing the following parameter:
      <ul>
        <li><strong>Only include reads originating from fragments from the forward or reverse strand</strong>: reverse
<img src="../../images/bamCoverage_reverse.png" alt="bamCoverage input and reverse parameter" /></li>
      </ul>
    </li>
    <li><strong>Rename</strong> <i class="fa fa-wrench" aria-hidden="true"></i>: Rename the outputs to reflect the origin of the reads and that they represent the reads mapping to the MINUS strand.</li>
  </ol>
</blockquote>

<blockquote class="hands_on">
  <h3 id="-hands-on-trackster-based-visualization"><i class="fa fa-pencil" aria-hidden="true"></i> Hands-on: Trackster based visualization</h3>

  <ol>
    <li><strong>Viz</strong> <i class="fa fa-wrench" aria-hidden="true"></i>: On the center console at the top of the Galaxy interface, choose “ Visualization” -&gt; “New track browser”
      <ul>
        <li>Name your visualization someting descriptive under “Browser name:”</li>
        <li>Choose “Mouse Dec. 2011 (GRCm38/mm10) (mm10)” as the “Reference genome build (dbkey)</li>
        <li>Click “Create” to initiate your Trackster session
<img src="../../images/Trackster_opening_window.png" alt="Trackster opening window" /></li>
      </ul>
    </li>
    <li><strong>Viz</strong> <i class="fa fa-wrench" aria-hidden="true"></i>: Click “Add datasets to visualization”
      <ul>
        <li>Select the “RefSeq GTF mm10” file</li>
        <li>Select the output files from <code class="highlighter-rouge">Stringtie</code></li>
        <li>Select the output file from <code class="highlighter-rouge">GFFCompare</code></li>
        <li>Select the output files from <code class="highlighter-rouge">bamCoverage</code></li>
      </ul>
    </li>
    <li>
      <p><i class="fa fa-wrench" aria-hidden="true"></i>: Using the grey labels on the left side of each track, drag and arrange the track order to your preference.</p>
    </li>
    <li><i class="fa fa-wrench" aria-hidden="true"></i>: Hover over the grey label on the left side of the “RefSeq GTF mm10” track and click the “Edit settings” icon.
      <ul>
        <li>Adjust the block color to blue (#0000ff) and antisense strand color to red (#ff0000)</li>
      </ul>
    </li>
    <li>
      <p><i class="fa fa-wrench" aria-hidden="true"></i>: Repeat the previous step on the output files from <code class="highlighter-rouge">StringTie</code> and <code class="highlighter-rouge">GFFCompare</code>.</p>
    </li>
    <li><i class="fa fa-wrench" aria-hidden="true"></i>: Hover over the grey label on the left side of the “G1E R1 plus” track and click the “Edit settings” icon.
      <ul>
        <li>Adjust the color to blue (#0000ff)</li>
      </ul>
    </li>
    <li>
      <p><i class="fa fa-wrench" aria-hidden="true"></i>: Repeat the previous step on the other three bigWig files representing the plus strand.</p>
    </li>
    <li><i class="fa fa-wrench" aria-hidden="true"></i>: Hover over the grey label on the left side of the “G1E R1 minus” track and click the “Edit settings” icon.
      <ul>
        <li>Adjust the color to red (#ff0000)</li>
      </ul>
    </li>
    <li>
      <p><i class="fa fa-wrench" aria-hidden="true"></i>: Repeat the previous step on the other three bigWig files representing the minus strand.</p>
    </li>
    <li><i class="fa fa-wrench" aria-hidden="true"></i>: Adjust the track height of the bigWig files to be consistent for each set of plus strand and minus strand tracks.
<img src="../../images/Hoxb13_locus_screenshot.png" alt="Adjusting the track height" /></li>
    <li><i class="fa fa-wrench" aria-hidden="true"></i>: Direct Trackster to the coordinates: chr11:96191452-96206029, what do you see?</li>
  </ol>

  <blockquote class="question">
    <h3 id="-question-2"><i class="fa fa-question-circle" aria-hidden="true"></i> Question</h3>
    <p>what do you see?</p>
    <details>
   <summary>Click to view answers</summary>
   <ol type="1">
   <li>There are two clusters of transcripts that are exclusively expressed in the G1E background</li>
   <li>The left-most transcript is the Hoxb13 transcript</li>
   <li>The center cluster of transcripts are not present in the RefSeq annotation and are determined by `GFFCompare` to be "u" and "x"</li>
   </ol>
   </details>
  </blockquote>

</blockquote>

<h1 class="no_toc" id="conclusion">Conclusion</h1>

<p>In this tutorial, we have analyzed real RNA sequencing data to extract useful information, such as which genes are up- or down-regulated by depletion of the Pasilla gene and which genes are regulated by the Pasilla gene. To answer these questions, we analyzed RNA sequence datasets using a reference-based RNA-seq data analysis approach. This approach can be sum up with the following scheme:</p>

<p><img src="../../images/schematic_for_RNAseq_de_novo_tutorial.png" alt="RNAseq de novo tutorial workflow" /></p>

<blockquote>
  <h1 id="workflow">Workflow</h1>
  <p>This analysis pipeline can be recreated using the workflow here: <a href="https://tinyurl.com/GTNdenovoRNAseqWorkflow">https://tinyurl.com/GTNdenovoRNAseqWorkflow </a></p>
</blockquote>


        
        <blockquote class="key_points">
            <h3><i class="fa fa-key" aria-hidden="true"></i> Key points</h3>

            <ul>
                
                <li>De novo transcriptome reconstruction is the ideal approach for identifying differentially expressed known and novel transcripts.</li>
                
                <li>Differential gene expression testing is improved with the use of replicate experiments and deep sequence coverage.</li>
                
                <li>Visualizing data on a genome browser is a great way to display interesting patterns of differential expression.</li>
                
            </ul>
        </blockquote>
        

        
        <h1>Useful literature</h1>
        <p>Useful information regarding this type of analysis with descriptions and paper references for the tools used in this tutorial, and literature for this analysis techniques and interpretations can be found <a href="/training-material/topics/transcriptomics#references">here</a>.</p>
        

        <h3><i class="fa fa-thumbs-up" aria-hidden="true"></i> Congratulations on successfully completing this tutorial!</h3>

        <hr>

        <blockquote class="overview">
            <h3><i class="fa fa-comments-o" aria-hidden="true"></i> Feedback</h3>
            Please take a moment and provide your feedback on this tutorial. Your feedback will help guide and improve future revisions to this tutorial.
            <a href="https://tinyurl.com/GTNfeedback">Feedback Form</a>
        </blockquote>
    </section>
</div>


<footer>
    <div class="container">
        <p>
            This material is the result of a collaborative work. Thanks the
            <a href="https://wiki.galaxyproject.org/Teach/GTN">Galaxy Training Network</a>
            and all the <a href="/training-material/hall-of-fame">contributors</a> (Mallory Freeberg, Mo Heydarian)!
        </p>
        <p>
            Found a typo? Something is wrong in this tutorial? Edit it on
            <a href="https://github.com/galaxyproject/training-material/tree/master/topics/transcriptomics/tutorials/de-novo/tutorial.md">GitHub</a>.
        </p>
    </div>
</footer>

    </body>
    <script type="text/javascript" src="/training-material/assets/js/jquery.slim.min.js"></script>
    <script type="text/javascript" src="/training-material/assets/js/popper.min.js"></script>
    <script type="text/javascript" src="/training-material/assets/js/bootstrap.min.js?v=3"></script>
    <script type="text/javascript" src="/training-material/assets/js/details-element-polyfill.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="/training-material/assets/js/main.js"></script>
</html>
